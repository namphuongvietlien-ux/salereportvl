<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Doanh S·ªë 2022-2025</title>
    <!-- Inline favicon to avoid 404s -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQI12NgYGD4DwABBAEAffA6NQAAAABJRU5ErkJggg==" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }

        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            border-color: #cbd5e1;
        }

        .kpi-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #0f172a;
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 0.9em;
            color: #22c55e;
        }

        .kpi-change.negative {
            color: #ef4444;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="month"] {
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        select:hover, input[type="month"]:hover {
            border-color: #94a3b8;
        }

        select:focus, input[type="month"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .chart-fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            color: #3b82f6;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            z-index: 10;
            font-weight: bold;
        }
        
        .chart-fullscreen-btn:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
        }
        
        .chart-fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 20000;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .chart-fullscreen-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .chart-fullscreen-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 1400px;
            max-height: 95vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .chart-fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .chart-fullscreen-header h2 {
            margin: 0;
            color: #1f2937;
            font-size: 1.8em;
        }
        
        .chart-fullscreen-close {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .chart-fullscreen-close:hover {
            background: #dc2626;
        }
        
        .chart-fullscreen-canvas-container {
            width: 100%;
            height: calc(95vh - 150px);
            min-height: 500px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .chart-fullscreen-content {
                padding: 20px;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .chart-fullscreen-header h2 {
                font-size: 1.3em;
            }
            
            .chart-fullscreen-canvas-container {
                height: calc(100vh - 120px);
                min-height: 400px;
            }
            
            .chart-fullscreen-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                top: 15px;
                right: 15px;
            }
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h2 {
            color: #1e293b;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
        }
        
        .timeline-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .timeline-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
            color: #667eea;
        }
        
        .timeline-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.tall {
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #64748b;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: #f8fafc;
            color: #1e293b;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .forecast-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .forecast-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 10000;
            overflow: auto;
        }

        .forecast-modal-content {
            background: white;
            margin: 30px auto;
            max-width: 95%;
            width: 1600px;
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .forecast-modal-header {
            padding: 25px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .forecast-modal-body {
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .detail-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .detail-section h3 {
            color: #1e293b;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-timeline-btn {
            padding: 6px 14px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 8px;
        }
        
        .modal-timeline-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
            color: #667eea;
        }
        
        .modal-timeline-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.95em;
            }
            
            .kpi-container {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .kpi-card {
                padding: 15px;
            }
            
            .kpi-card h3 {
                font-size: 0.75em;
            }
            
            .kpi-value {
                font-size: 1.3em;
            }
            
            .filters {
                padding: 15px;
                gap: 12px;
            }
            
            .filter-group label {
                font-size: 0.8em;
            }
            
            select, input[type="month"] {
                padding: 12px 10px;
                font-size: 16px;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .chart-card h2 {
                font-size: 1.1em;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-container.tall {
                height: 350px;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            /* C·∫£i thi·ªán button tr√™n mobile */
            button {
                padding: 12px 20px !important;
                font-size: 1em !important;
                min-height: 44px;
            }
            
            /* TƒÉng k√≠ch th∆∞·ªõc clickable area */
            [onclick] {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            /* When printing modal, hide everything except modal */
            body.printing-modal #dashboard,
            body.printing-modal .header,
            body.printing-modal #loading {
                display: none !important;
            }
            
            body.printing-modal .forecast-modal {
                display: block !important;
            }
            
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                text-align: center;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Hide non-essential elements */
            .filter-group,
            button[onclick*="export"],
            button[onclick*="print"],
            button[onclick*="close"],
            .loading {
                display: none !important;
            }
            
            /* Page breaks */
            .chart-card,
            .kpi-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .chart-card.full-width {
                page-break-before: auto;
                page-break-after: auto;
            }
            
            /* Better spacing for print */
            .chart-card {
                margin-bottom: 30px;
            }
            
            /* Modal print styles */
            .forecast-modal {
                position: static !important;
                background: white !important;
            }
            
            .forecast-modal-content {
                max-width: 100% !important;
                max-height: 100% !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .forecast-modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Preserve colors */
            .kpi-card,
            .chart-card {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Table styles for print */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }
            
            /* Remove height restrictions for printing */
            .table-container,
            .forecast-modal-body,
            .detail-section {
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Ensure all table rows are visible */
            tbody tr {
                display: table-row !important;
            }
            
            /* Prevent table breaks across pages when possible */
            .detail-section {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* But allow long tables to break */
            .detail-section table {
                page-break-inside: auto;
            }
            
            /* Keep table headers on each page */
            thead {
                display: table-header-group;
            }
            
            tbody {
                display: table-row-group;
            }
            
            /* Footer for print */
            @page {
                margin: 1.5cm;
                @bottom-right {
                    content: "Trang " counter(page) " / " counter(pages);
                }
            }
        }
        
        /* Login Modal Styles */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 30000;
            align-items: center;
            justify-content: center;
        }
        
        .login-modal.hidden {
            display: none;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .login-container h2 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 1.8em;
        }
        
        .login-container p {
            color: #6b7280;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        
        .login-form-group {
            margin-bottom: 20px;
        }
        
        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .login-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .login-form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .login-button {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-button:hover {
            background: #2563eb;
        }
        
        .login-error {
            color: #ef4444;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }
        
        .login-error.show {
            display: block;
        }
        
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            color: #1f2937;
            font-weight: 600;
        }
        
        .user-info .user-role {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
        }
        
        .user-info .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .user-info .logout-btn:hover {
            background: #dc2626;
        }
        
        .permission-restricted {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-container">
            <h2>üîê ƒêƒÉng Nh·∫≠p</h2>
            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p b√°o c√°o doanh s·ªë</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="login-form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <div class="login-error" id="loginError">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng</div>
                <button type="submit" class="login-button">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>
    
    <!-- User Info Bar -->
    <div id="userInfo" class="user-info" style="display: none;">
        <span id="userName">-</span>
        <span class="user-role" id="userRole">-</span>
        <button class="logout-btn" onclick="handleLogout()">ƒêƒÉng Xu·∫•t</button>
    </div>
    
    <div class="dashboard-container">
        <div class="header">
            <h1 data-i18n="title">üìä B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë</h1>
            <p data-i18n="subtitle">Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë theo H·ªá th·ªëng, Nh√£n h√†ng v√† M√£ h√†ng (2022 - 2025)</p>
        </div>

        <div class="loading" id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

        <div id="dashboard" style="display: none;">
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3 data-i18n="totalRevenue">T·ªïng Doanh S·ªë</h3>
                    <div class="kpi-value" id="totalSales">0 ‚Ç´</div>
                    <div class="kpi-change" id="salesChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="yoyGrowth">TƒÉng Tr∆∞·ªüng YoY</h3>
                    <div class="kpi-value" id="yoyGrowth" style="font-size: 2em;">0%</div>
                    <div class="kpi-change" id="yoyTrend">--</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="topDriver">ƒê·ªông L·ª±c TƒÉng Tr∆∞·ªüng</h3>
                    <div class="kpi-value" id="topDriver" style="font-size: 1.3em; line-height: 1.2;">--</div>
                    <div class="kpi-change" id="driverContribution">--</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="totalOrders">T·ªïng S·ªë ƒê∆°n H√†ng</h3>
                    <div class="kpi-value" id="totalOrders">0</div>
                    <div class="kpi-change" id="ordersChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="avgOrderValue">Gi√° Tr·ªã TB/ƒê∆°n</h3>
                    <div class="kpi-value" id="avgOrderValue">0 ‚Ç´</div>
                    <div class="kpi-change" id="avgChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="momGrowth">TƒÉng Tr∆∞·ªüng MoM</h3>
                    <div class="kpi-value" id="momGrowth" style="font-size: 2em;">0%</div>
                    <div class="kpi-change" id="momTrend">--</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="totalProducts">S·ªë S·∫£n Ph·∫©m (L·ªçc)</h3>
                    <div class="kpi-value" id="totalProducts">0</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">T·ªïng: <span id="totalProductsAll">0</span></div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="activeStores">C·ª≠a H√†ng Ho·∫°t ƒê·ªông</h3>
                    <div class="kpi-value" id="activeStores">0</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;"><span data-i18n="average">Trung b√¨nh</span>: <span id="avgOrdersPerStore">0</span> <span data-i18n="orders">ƒë∆°n</span></div>
                </div>
            </div>

            <!-- Key Insights Section -->
            <div class="chart-card full-width" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 25px;">
                <h2 style="color: white; margin-bottom: 20px;" data-i18n="keyInsights">üí° Th√¥ng Tin Quan Tr·ªçng</h2>
                <div id="keyInsights" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="strategicFocus">üéØ Tr·ªçng T√¢m Chi·∫øn L∆∞·ª£c</h3>
                        <p id="strategicFocus" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="marketTrend">üìä Xu H∆∞·ªõng Th·ªã Tr∆∞·ªùng</h3>
                        <p id="marketTrend" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="riskAlert">‚ö†Ô∏è C·∫£nh B√°o R·ªßi Ro</h3>
                        <p id="riskAlert" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="growthOpportunity">üöÄ C∆° H·ªôi TƒÉng Tr∆∞·ªüng</h3>
                        <p id="growthOpportunity" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label data-i18n="fromMonth">T·ª´ th√°ng</label>
                    <input type="month" id="startMonth" value="2023-01">
                </div>
                <div class="filter-group">
                    <label data-i18n="toMonth">ƒê·∫øn th√°ng</label>
                    <input type="month" id="endMonth" value="2025-12">
                </div>
                <div class="filter-group">
                    <label>Timeline nhanh</label>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="setQuickTimeline('1M')" class="timeline-btn">1M</button>
                        <button onclick="setQuickTimeline('3M')" class="timeline-btn">3M</button>
                        <button onclick="setQuickTimeline('6M')" class="timeline-btn">6M</button>
                        <button onclick="setQuickTimeline('1Y')" class="timeline-btn">1Y</button>
                        <button onclick="setQuickTimeline('ALL')" class="timeline-btn active">T·∫•t c·∫£</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label data-i18n="system">H·ªá th·ªëng</label>
                    <select id="systemFilter">
                        <option value="all" data-i18n="allSystems">T·∫•t c·∫£ h·ªá th·ªëng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label data-i18n="brand">Nh√£n h√†ng</label>
                    <select id="brandFilter">
                        <option value="all" data-i18n="allBrands">T·∫•t c·∫£ nh√£n h√†ng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>S·∫£n ph·∫©m</label>
                    <select id="productFilter" style="min-width: 250px;">
                        <option value="all">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                    </select>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <label>&nbsp;</label>
                    <button onclick="printDashboard()" style="
                        padding: 10px 20px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 0.95em;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-right: 10px;
                    ">
                        <span style="font-size: 1.2em;">üñ®Ô∏è</span>
                        In B√°o C√°o
                    </button>
                    <button onclick="exportToPowerPoint()" style="
                        padding: 10px 20px;
                        background: #dc2626;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.95em;
                        font-weight: 600;
                        transition: background 0.3s ease;
                        min-height: 44px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                        <span style="font-size: 1.2em;">üìä</span>
                        <span data-i18n="exportPPT">T·∫£i PowerPoint</span>
                    </button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <select id="languageSelector" onchange="switchLanguage(this.value)" style="
                        padding: 10px 15px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 0.95em;
                        background: white;
                        cursor: pointer;
                        min-height: 44px;
                        font-weight: 600;
                    ">
                        <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>
            </div>

            <div class="chart-grid">
                <div class="filter-group">
                    <label>H·ªá th·ªëng</label>
                    <select id="systemFilter">
                        <option value="all">T·∫•t c·∫£ h·ªá th·ªëng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Nh√£n h√†ng</label>
                    <select id="brandFilter">
                        <option value="all">T·∫•t c·∫£ nh√£n h√†ng</option>
                    </select>
                </div>
            </div>

            <div class="chart-grid">
                <!-- Forecast Section -->
                <div class="chart-card full-width">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('forecastChart', 'üìä D·ª± ƒêo√°n Doanh S·ªë')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2>üîÆ D·ª± ƒêo√°n Doanh S·ªë & S·ªë L∆∞·ª£ng</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o t·ª´ng d·ª± ƒëo√°n ƒë·ªÉ xem chi ti·∫øt theo h·ªá th·ªëng v√† s·∫£n ph·∫©m</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="forecast-card" onclick="showForecastDetail('currentMonth')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üî• D·ª± ƒêo√°n Th√°ng ƒê·∫ßu Ti√™n</h3>
                            <p id="currentMonthForecast" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="currentMonthQtyForecast" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">ƒêang t·∫£i...</p>
                        </div>
                        <div class="forecast-card" onclick="showForecastDetail('nextMonth')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üìÖ D·ª± ƒêo√°n Th√°ng Ti·∫øp Theo</h3>
                            <p id="nextMonthForecast" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="nextMonthQtyForecast" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div class="forecast-card" onclick="showForecastDetail('currentQuarter')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üìä TB Th√°ng Qu√Ω N√†y</h3>
                            <p id="currentQuarterAvg" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="currentQuarterQtyAvg" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div class="forecast-card" onclick="showForecastDetail('nextQuarter')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üéØ TB Th√°ng Qu√Ω T·ªõi</h3>
                            <p id="nextQuarterForecast" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="nextQuarterQtyForecast" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üîÑ Xu H∆∞·ªõng Chu K·ª≥</h3>
                            <p id="seasonalityTrend" style="font-size: 1.3em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="seasonalityDetail" style="font-size: 0.95em; margin-top: 8px; opacity: 0.9;">...</p>
                        </div>
                    </div>
                    <div class="chart-container tall">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('salesTrendChart', 'üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="salesTrend">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o ƒëi·ªÉm d·ªØ li·ªáu ƒë·ªÉ xem chi ti·∫øt th√°ng</p>
                    <div class="chart-container tall">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('brandTrendChart', 'üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="brandTrend">üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o ƒë∆∞·ªùng line ƒë·ªÉ xem chi ti·∫øt brand</p>
                    <div class="chart-container tall">
                        <canvas id="brandTrendChart"></canvas>
                    </div>
                </div>

                <!-- Target Management Section -->
                <div id="targetManagementSection" class="chart-card full-width">
                    <h2>üéØ Qu·∫£n L√Ω Target Doanh S·ªë</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">Nh·∫≠p target t·ªïng ho·∫∑c theo nh√£n h√†ng, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n b·ªï theo t·ª∑ l·ªá v√† kh·∫£ nƒÉng tƒÉng tr∆∞·ªüng</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <!-- Total Target -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 1.1em; margin-bottom: 15px;">üìä Target T·ªïng</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; opacity: 0.9;">Nh·∫≠p Target T·ªïng (VND)</label>
                                <input type="number" id="totalTargetInput" placeholder="Nh·∫≠p s·ªë ti·ªÅn..." 
                                       style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 1.1em; color: #1f2937;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; opacity: 0.9;">Ch·ªçn Th√°ng</label>
                                <input type="month" id="totalTargetMonth" 
                                       style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 1em; color: #1f2937;">
                            </div>
                            <button onclick="setTotalTarget()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ‚úÖ √Åp D·ª•ng Target T·ªïng
                            </button>
                            <button onclick="setBulkTargets()" style="width: 100%; padding: 10px; margin-top: 10px; background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 0.9em;">
                                ‚ö° Set Target H√†ng Lo·∫°t (2025)
                            </button>
                        </div>
                        <!-- Brand Target -->
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 1.1em; margin-bottom: 15px;">üè∑Ô∏è Target Theo Nh√£n H√†ng</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; opacity: 0.9;">Ch·ªçn Nh√£n H√†ng</label>
                                <select id="brandTargetSelect" style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 1em; color: #1f2937;">
                                    <option value="">-- Ch·ªçn nh√£n h√†ng --</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; opacity: 0.9;">Nh·∫≠p Target (VND)</label>
                                <input type="number" id="brandTargetInput" placeholder="Nh·∫≠p s·ªë ti·ªÅn..." 
                                       style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 1.1em; color: #1f2937;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; opacity: 0.9;">Ch·ªçn Th√°ng</label>
                                <input type="month" id="brandTargetMonth" 
                                       style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 1em; color: #1f2937;">
                            </div>
                            <button onclick="setBrandTarget()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ‚úÖ √Åp D·ª•ng Target Nh√£n H√†ng
                            </button>
                        </div>
                    </div>
                    <div id="targetResults" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; display: none;">
                        <h3 style="color: #1f2937; margin-bottom: 15px;">üìã K·∫øt Qu·∫£ Ph√¢n B·ªï Target</h3>
                        <div id="targetResultsContent"></div>
                    </div>
                    
                    <!-- Export/Import Target Data -->
                    <div id="exportImportTargetSection" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px;">üíæ Qu·∫£n L√Ω D·ªØ Li·ªáu Target</h3>
                        <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 15px;">Export/Import target ƒë·ªÉ backup ho·∫∑c chia s·∫ª gi·ªØa c√°c m√°y</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="exportTargetData()" style="padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>üì•</span> Export Target (JSON)
                            </button>
                            <label style="padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>üì§</span> Import Target (JSON)
                                <input type="file" id="targetFileInput" accept=".json" style="display: none;" onchange="importTargetData(event)">
                            </label>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.85em; opacity: 0.9;">
                            <strong>üí° L∆∞u √Ω:</strong> Target ƒë∆∞·ª£c load t·ª´ file <code>targets.json</code> (tr√™n GitHub) v√† localStorage (ch·ªânh s·ª≠a local). 
                            S·ª≠ d·ª•ng Export ƒë·ªÉ t·∫£i file JSON, sau ƒë√≥ commit file <code>targets.json</code> l√™n GitHub ƒë·ªÉ chia s·∫ª v·ªõi m·ªçi ng∆∞·ªùi.
                        </div>
                    </div>
                </div>

                <!-- Target vs Actual Performance Section -->
                <div class="chart-card full-width">
                    <h2>üìä Doanh S·ªë Th·ª±c T·∫ø vs Target</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">So s√°nh doanh s·ªë th·ª±c t·∫ø v·ªõi target theo h·ªá th·ªëng v√† nh√£n h√†ng</p>
                    
                    <div style="margin: 20px 0; display: flex; gap: 15px; align-items: center;">
                        <label style="font-weight: 600; color: #374151;">Ch·ªçn Th√°ng:</label>
                        <input type="month" id="targetVsActualMonth" 
                               style="padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1em; min-width: 200px;">
                        <button onclick="updateTargetVsActual()" 
                                style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            üîç Xem B√°o C√°o
                        </button>
                    </div>
                    
                    <div id="targetVsActualContent" style="display: none;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                                <h3 style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">üéØ Target T·ªïng</h3>
                                <p id="summaryTotalTarget" style="font-size: 1.5em; font-weight: 700; margin: 0;">0 ‚Ç´</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; color: white;">
                                <h3 style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">üí∞ Doanh S·ªë Th·ª±c T·∫ø</h3>
                                <p id="summaryTotalActual" style="font-size: 1.5em; font-weight: 700; margin: 0;">0 ‚Ç´</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; color: white;">
                                <h3 style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">üìà % ƒê·∫°t ƒê∆∞·ª£c</h3>
                                <p id="summaryAchievement" style="font-size: 1.5em; font-weight: 700; margin: 0;">0%</p>
                            </div>
                        </div>
                        
                        <!-- Chart - Using HTML Progress Bars for Better Readability -->
                        <div style="margin-bottom: 30px; position: relative;">
                            <button class="chart-fullscreen-btn" onclick="openChartFullscreen('targetVsActualChartContainer', 'üìä Doanh S·ªë Th·ª±c T·∫ø vs Target', true)" title="Xem to√†n m√†n h√¨nh" style="position: absolute; top: 0; right: 0;">‚õ∂</button>
                            <h3 style="color: #1f2937; margin-bottom: 15px;">üìä Bi·ªÉu ƒê·ªì So S√°nh</h3>
                            <div id="targetVsActualChartContainer" style="background: white; padding: 25px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <!-- Will be populated by JavaScript with HTML progress bars -->
                            </div>
                        </div>
                        
                        <!-- Detailed Table -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="color: #1f2937; margin-bottom: 15px;">üìã B·∫£ng Chi Ti·∫øt Theo H·ªá Th·ªëng & Nh√£n H√†ng</h3>
                            <div class="table-container" style="max-height: 600px; overflow: auto;">
                                <table id="targetVsActualTable" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead id="targetVsActualTableHead" style="position: sticky; top: 0; background: white; z-index: 10;">
                                        <!-- Will be populated by JavaScript -->
                                    </thead>
                                    <tbody id="targetVsActualTableBody">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('systemChart', 'üè¢ Doanh S·ªë Theo H·ªá Th·ªëng')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="systemSales">üè¢ Doanh S·ªë Theo H·ªá Th·ªëng</h2>
                    <p style="color: #666; font-size: 0.85em; margin-top: 5px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</p>
                    <div class="chart-container">
                        <canvas id="systemChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('brandChart', 'üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="brandSales">üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng</h2>
                    <p style="color: #666; font-size: 0.85em; margin-top: 5px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</p>
                    <div class="chart-container">
                        <canvas id="brandChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('yearComparisonChart', 'üìä So S√°nh Doanh S·ªë Theo NƒÉm')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="yearComparison">üìä So S√°nh Doanh S·ªë Theo NƒÉm</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o c·ªôt nƒÉm ƒë·ªÉ xem chi ti·∫øt theo h·ªá th·ªëng v√† th√°ng</p>
                    <div class="chart-container">
                        <canvas id="yearComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Year Drill-Down Modal -->
                <div id="yearDrillDownModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
                    <div style="background: white; margin: 50px auto; max-width: 95%; width: 1400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="drillDownTitle" style="margin: 0; color: #1f2937;">üìä Chi Ti·∫øt NƒÉm 2024</h2>
                            <button onclick="closeYearDrillDown()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                        </div>
                        <div style="padding: 30px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                                <div>
                                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Doanh S·ªë Theo Th√°ng</h3>
                                    <div style="height: 300px;">
                                        <canvas id="drillDownMonthlyChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <h3 style="color: #10b981; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng</h3>
                                    <div style="height: 300px;">
                                        <canvas id="drillDownSystemChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <h3 style="color: #6366f1; margin-bottom: 15px;">üìä B·∫£ng Chi Ti·∫øt: Doanh S·ªë Theo H·ªá Th·ªëng & Th√°ng</h3>
                            <div class="table-container" style="max-height: 500px; overflow: auto;">
                                <table id="drillDownTable" style="width: 100%; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: white; z-index: 20;">
                                        <tr>
                                            <th style="position: sticky; left: 0; background: white; z-index: 21; text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">#</th>
                                            <th style="position: sticky; left: 50px; background: white; z-index: 21; text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; box-shadow: 2px 0 5px rgba(0,0,0,0.05); min-width: 200px;">H·ªá Th·ªëng</th>
                                            <th style="position: sticky; left: 250px; background: white; z-index: 21; text-align: right; padding: 12px; border-bottom: 2px solid #e5e7eb; box-shadow: 2px 0 5px rgba(0,0,0,0.05); min-width: 150px;">T·ªïng NƒÉm</th>
                                            <th style="text-align: center; padding: 12px; border-bottom: 2px solid #e5e7eb;" colspan="12">Doanh S·ªë Theo Th√°ng</th>
                                        </tr>
                                        <tr id="monthHeaderRow" style="background: #f9fafb;">
                                            <th style="position: sticky; left: 0; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>
                                            <th style="position: sticky; left: 50px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>
                                            <th style="position: sticky; left: 250px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="drillDownTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Universal Drill-Down Modal -->
                <div id="drillDownModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
                    <div style="background: white; margin: 50px auto; max-width: 95%; width: 1400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="modalTitle" style="margin: 0; color: #1f2937;">üìä Chi Ti·∫øt</h2>
                            <button onclick="closeDrillDownModal()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                        </div>
                        <div id="modalContent" style="padding: 30px;">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- SKU Analysis Modal -->
                <div id="skuAnalysisModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 15000; overflow: auto;">
                    <div style="background: white; margin: 30px auto; max-width: 90%; width: 1200px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); overflow: hidden;">
                        <div style="padding: 25px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="skuModalTitle" style="margin: 0; font-size: 1.4em; font-weight: 700;">üìä Ph√¢n T√≠ch SKU</h2>
                            <button onclick="closeSKUModal()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                        </div>
                        <div style="padding: 30px;">
                            <div style="margin-bottom: 25px;">
                                <div style="height: 400px;">
                                    <canvas id="skuAnalysisChart"></canvas>
                                </div>
                            </div>
                            <div class="table-container" style="max-height: 500px; overflow: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <table id="skuDetailTable" style="width: 100%; border-collapse: collapse; background: white;">
                                    <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); color: white; z-index: 10;">
                                        <tr>
                                            <th style="padding: 15px 12px; text-align: left; font-weight: 600;">#</th>
                                            <th style="padding: 15px 12px; text-align: left; font-weight: 600; min-width: 300px;">T√™n S·∫£n Ph·∫©m</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600;">T·ªïng S·ªë L∆∞·ª£ng</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600;">Doanh S·ªë</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600;">% T·ªïng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="skuDetailTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('topProductsChart', 'üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="topProducts">üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o s·∫£n ph·∫©m ƒë·ªÉ xem doanh s·ªë theo th√°ng</p>
                    <div class="chart-container tall">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                    <div class="table-container" style="margin-top: 20px; max-height: 500px; overflow: auto;">
                        <table id="topProductsTable" style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; z-index: 10;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">#</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 250px;">T√™n S·∫£n Ph·∫©m</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">T·ªïng S·ªë L∆∞·ª£ng</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Doanh S·ªë</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">% T·ªïng</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <button class="chart-fullscreen-btn" onclick="openChartFullscreen('storeActivityChart', 'üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng')" title="Xem to√†n m√†n h√¨nh">‚õ∂</button>
                    <h2 data-i18n="storePerformance">üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng</h2>
                    <div class="chart-container">
                        <canvas id="storeActivityChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="topStores">üèÜ Top 30 C·ª≠a H√†ng Theo T·∫ßn Su·∫•t ƒê·∫∑t H√†ng</h2>
                    <div class="table-container">
                        <table id="storeFrequencyTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>C·ª≠a H√†ng</th>
                                    <th class="number">S·ªë L·∫ßn ƒê·∫∑t</th>
                                    <th class="number">T·ªïng ƒê∆°n H√†ng</th>
                                    <th class="number">T·ªïng Doanh Thu</th>
                                    <th class="number">TB/ƒê∆°n</th>
                                </tr>
                            </thead>
                            <tbody id="storeFrequencyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="growthAnalysis">üìä Ph√¢n T√≠ch Nguy√™n Nh√¢n Thay ƒê·ªïi Doanh S·ªë (2024 vs 2025)</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #10b981; margin-bottom: 15px;" data-i18n="topGrowthSKU">üìà Top 10 M√£ H√†ng TƒÉng Tr∆∞·ªüng M·∫°nh Nh·∫•t</h3>
                            <div class="table-container">
                                <table id="topGrowthSKUTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>M√£ H√†ng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">TƒÉng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topGrowthSKUTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #ef4444; margin-bottom: 15px;" data-i18n="topDeclineSKU">üìâ Top 10 M√£ H√†ng Gi·∫£m Nhi·ªÅu Nh·∫•t</h3>
                            <div class="table-container">
                                <table id="topDeclineSKUTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>M√£ H√†ng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">Gi·∫£m</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topDeclineSKUTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
                        <div>
                            <h3 style="color: #3b82f6; margin-bottom: 15px;" data-i18n="topGrowthSystem">üè¢ Top H·ªá Th·ªëng TƒÉng Tr∆∞·ªüng</h3>
                            <div class="table-container">
                                <table id="topGrowthSystemTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">TƒÉng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topGrowthSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #f59e0b; margin-bottom: 15px;" data-i18n="topDeclineSystem">üè¢ Top H·ªá Th·ªëng Gi·∫£m</h3>
                            <div class="table-container">
                                <table id="topDeclineSystemTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">Gi·∫£m</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topDeclineSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; flex: 1; min-width: 200px;">üìä Ph√¢n T√≠ch S·∫£n Ph·∫©m Theo NƒÉm & D·ª± ƒêo√°n (S·ªë L∆∞·ª£ng)</h2>
                        <button id="toggleYearlyTable" onclick="toggleYearlyProductTable()" style="
                            padding: 10px 20px;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.95em;
                            transition: background 0.3s ease;
                            min-height: 44px;
                            font-weight: 600;
                        ">
                        ">
                            <span id="toggleIcon">‚ñº</span> Thu g·ªçn
                        </button>
                    </div>
                    <div id="yearlyTableContainer" class="table-container" style="transition: all 0.3s ease; overflow: hidden;">
                        <table id="yearlyProductTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nh√£n H√†ng</th>
                                    <th>NƒÉm</th>
                                    <th class="number">S·ªë L∆∞·ª£ng</th>
                                    <th class="number">T·ªïng Doanh Thu (VAT)</th>
                                    <th class="number">TƒÉng Tr∆∞·ªüng</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyProductTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Frequency Analysis Section -->
        <div class="chart-card full-width" id="orderFrequencyAnalysis" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #1f2937;">üîç Ph√¢n T√≠ch T·∫ßn Su·∫•t ƒê·∫∑t H√†ng</h2>
                <button onclick="analyzeOrderFrequency()" style="
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 1em;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üîÑ Ph√¢n T√≠ch Ngay
                </button>
            </div>
            
            <div id="orderFrequencyResults" style="display: none;">
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin: 0 0 8px 0; opacity: 0.9;">T·ªïng H·ªá Th·ªëng</h4>
                        <p id="totalSystems" style="font-size: 1.8em; font-weight: 700; margin: 0;">0</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin: 0 0 8px 0; opacity: 0.9;">TB ƒê·∫∑t H√†ng/Th√°ng</h4>
                        <p id="avgOrdersPerMonth" style="font-size: 1.8em; font-weight: 700; margin: 0;">0</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin: 0 0 8px 0; opacity: 0.9;">H·ªá Th·ªëng B·∫•t Th∆∞·ªùng</h4>
                        <p id="abnormalSystems" style="font-size: 1.8em; font-weight: 700; margin: 0;">0</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin: 0 0 8px 0; opacity: 0.9;">C·∫ßn Ki·ªÉm Tra</h4>
                        <p id="systemsNeedCheck" style="font-size: 1.8em; font-weight: 700; margin: 0;">0</p>
                    </div>
                </div>

                <!-- Alert Section -->
                <div id="abnormalAlert" style="display: none; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span style="font-size: 1.5em; margin-right: 10px;">‚ö†Ô∏è</span>
                        <h3 style="color: #92400e; margin: 0;">Ph√°t Hi·ªán B·∫•t Th∆∞·ªùng Trong T·∫ßn Su·∫•t ƒê·∫∑t H√†ng</h3>
                    </div>
                    <p style="color: #92400e; margin: 0;">
                        M·ªôt s·ªë h·ªá th·ªëng c√≥ t·∫ßn su·∫•t ƒë·∫∑t h√†ng b·∫•t th∆∞·ªùng (qu√° th∆∞·ªùng xuy√™n ho·∫∑c qu√° √≠t). 
                        Vui l√≤ng ki·ªÉm tra b·∫£ng chi ti·∫øt b√™n d∆∞·ªõi ƒë·ªÉ c√≥ h√†nh ƒë·ªông ph√π h·ª£p.
                    </p>
                </div>

                <!-- Detailed Analysis Table -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                    <!-- Normal Systems -->
                    <div>
                        <h3 style="color: #059669; margin-bottom: 15px;">‚úÖ H·ªá Th·ªëng B√¨nh Th∆∞·ªùng</h3>
                        <div class="table-container" style="max-height: 400px;">
                            <table style="font-size: 0.9em;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>H·ªá Th·ªëng</th>
                                        <th class="number">L·∫ßn/Th√°ng</th>
                                        <th class="number">Tr·∫°ng Th√°i</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="normalSystemsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Abnormal Systems -->
                    <div>
                        <h3 style="color: #dc2626; margin-bottom: 15px;">üö® C·∫ßn Ki·ªÉm Tra</h3>
                        <div class="table-container" style="max-height: 400px;">
                            <table style="font-size: 0.9em;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>H·ªá Th·ªëng</th>
                                        <th class="number">L·∫ßn/Th√°ng</th>
                                        <th class="number">V·∫•n ƒê·ªÅ</th>
                                        <th>SP Bi·∫øn ƒê·ªông</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="abnormalSystemsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Product Trend Summary -->
                <div id="productTrendSummary" style="display: none; margin-bottom: 25px;">
                    <h3 style="color: #1f2937; margin-bottom: 15px;">üìä T√≥m T·∫Øt Bi·∫øn ƒê·ªông S·∫£n Ph·∫©m</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #dcfdf7; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <h4 style="color: #065f46; margin: 0 0 10px 0;">üìà S·∫£n Ph·∫©m TƒÉng M·∫°nh</h4>
                            <div id="increasingProductsList" style="font-size: 0.9em;"></div>
                        </div>
                        <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <h4 style="color: #991b1b; margin: 0 0 10px 0;">üìâ S·∫£n Ph·∫©m Gi·∫£m M·∫°nh</h4>
                            <div id="decreasingProductsList" style="font-size: 0.9em;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forecast Detail Modal -->
        <div id="forecastDetailModal" class="forecast-modal">
            <div class="forecast-modal-content">
                <div class="forecast-modal-header">
                    <h2 id="forecastModalTitle">üìä Chi Ti·∫øt D·ª± ƒêo√°n</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="printForecastDetail()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">üñ®Ô∏è In</button>
                        <button onclick="closeForecastDetail()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                    </div>
                </div>
                <div class="forecast-modal-body">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="color: #1e40af; margin: 0;">üìà T·ªïng Quan D·ª± ƒêo√°n</h3>
                            <button id="stockoutAnalysisBtn" onclick="analyzeStockouts()" style="
                                padding: 8px 16px;
                                background: #ef4444;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.9em;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                üîç Ph√¢n T√≠ch ƒê·ª©t H√†ng
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmin(200px, 1fr)); gap: 15px;">
                            <div>
                                <p style="color: #64748b; font-size: 0.85em; margin: 0;">T·ªïng Doanh S·ªë</p>
                                <p id="forecastTotalSales" style="font-size: 1.4em; font-weight: 700; color: #1e40af; margin: 5px 0 0 0;">0 ‚Ç´</p>
                            </div>
                            <div>
                                <p style="color: #64748b; font-size: 0.85em; margin: 0;">T·ªïng S·ªë L∆∞·ª£ng</p>
                                <p id="forecastTotalQty" style="font-size: 1.4em; font-weight: 700; color: #10b981; margin: 5px 0 0 0;">0</p>
                            </div>
                            <div id="stockoutAdjustment" style="display: none;">
                                <p style="color: #64748b; font-size: 0.85em; margin: 0;">ƒêi·ªÅu Ch·ªânh ƒê·ª©t H√†ng</p>
                                <p id="stockoutAdjustmentValue" style="font-size: 1.4em; font-weight: 700; margin: 5px 0 0 0;">0 ‚Ç´</p>
                            </div>
                        </div>
                    </div>

                    <div id="stockoutAnalysisSection" style="display: none; background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #92400e; margin: 0;">‚ö†Ô∏è Ph√¢n T√≠ch S·∫£n Ph·∫©m ƒê·ª©t H√†ng</h3>
                            <button onclick="clearAllStockoutProducts()" style="
                                padding: 8px 16px;
                                background: #dc2626;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-size: 0.9em;
                                font-weight: 600;
                                cursor: pointer;
                            ">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
                        </div>
                        <div id="stockoutContent"></div>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-section">
                            <h3>üè¢ Chi Ti·∫øt Theo H·ªá Th·ªëng</h3>
                            <div class="table-container" style="max-height: 500px;">
                                <table id="forecastSystemTable" style="font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">S·ªë L∆∞·ª£ng</th>
                                            <th class="number">Doanh S·ªë</th>
                                            <th class="number" style="background: #fef3c7;">ƒê·ª©t H√†ng</th>
                                            <th class="number">% T·ªïng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="forecastSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>üè∑Ô∏è Chi Ti·∫øt Theo Nh√£n H√†ng (Top 20)</h3>
                            <div class="table-container" style="max-height: 500px;">
                                <table id="forecastBrandTable" style="font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Nh√£n H√†ng</th>
                                            <th class="number">S·ªë L∆∞·ª£ng</th>
                                            <th class="number">Doanh S·ªë</th>
                                            <th class="number" style="background: #fef3c7;">ƒê·ª©t H√†ng</th>
                                            <th class="number">% T·ªïng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="forecastBrandTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section" style="margin-top: 25px;">
                        <h3>üì¶ Chi Ti·∫øt Theo S·∫£n Ph·∫©m (Top 50)</h3>
                        <div class="table-container" style="max-height: 600px;">
                            <table id="forecastProductTable" style="font-size: 0.85em;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>T√™n R√∫t G·ªçn SP</th>
                                        <th>Nh√£n H√†ng</th>
                                        <th class="number">S·ªë L∆∞·ª£ng</th>
                                        <th class="number">Doanh S·ªë</th>
                                        <th class="number" style="background: #fef3c7;">ƒê·ª©t H√†ng</th>
                                        <th class="number">% T·ªïng</th>
                                    </tr>
                                </thead>
                                <tbody id="forecastProductTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Frequency Drill-Down Modal -->
    <div id="orderFrequencyDrillModal" style="
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 20000;
        overflow: auto;
    ">
        <div style="
            background: white;
            margin: 20px auto;
            max-width: 95%;
            width: 1600px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        ">
            <!-- Modal Header -->
            <div style="
                padding: 25px 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 3px solid #4f46e5;
            ">
                <h2 id="drillModalTitle" style="
                    margin: 0;
                    font-size: 1.4em;
                    font-weight: 700;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                ">üîç Ph√¢n T√≠ch Chi Ti·∫øt H·ªá Th·ªëng</h2>
                <button onclick="closeOrderFrequencyDrill()" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 2px solid rgba(255,255,255,0.3);
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 1em;
                    font-weight: 600;
                    backdrop-filter: blur(10px);
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚úï ƒê√≥ng</button>
            </div>

            <!-- Breadcrumb Navigation -->
            <div id="drillBreadcrumb" style="
                padding: 15px 30px;
                background: #f8fafc;
                border-bottom: 1px solid #e2e8f0;
                font-size: 0.9em;
                color: #64748b;
            "></div>

            <!-- Modal Body -->
            <div style="padding: 30px;">
                <!-- Dynamic Content Area -->
                <div id="drillModalContent">
                    <!-- System Level Analysis -->
                    <div id="systemLevelContent" style="display: none;">
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.2em;">üìä Ph√¢n T√≠ch SKU Trong H·ªá Th·ªëng</h3>
                            
                            <!-- Summary Cards -->
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                                gap: 15px;
                                margin-bottom: 25px;
                            ">
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
                                    padding: 20px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
                                ">
                                    <div style="font-size: 2em; margin-bottom: 8px;">‚ö†Ô∏è</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: #92400e;" id="abnormalSKUCount">0</div>
                                    <div style="color: #92400e; font-size: 0.9em; font-weight: 600;">SKU B·∫•t Th∆∞·ªùng</div>
                                </div>
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #dcfce7 0%, #22c55e 100%);
                                    padding: 20px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
                                ">
                                    <div style="font-size: 2em; margin-bottom: 8px;">üìà</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: #14532d;" id="increasingSKUCount">0</div>
                                    <div style="color: #14532d; font-size: 0.9em; font-weight: 600;">SKU TƒÉng Tr∆∞·ªüng</div>
                                </div>
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #fee2e2 0%, #ef4444 100%);
                                    padding: 20px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                                ">
                                    <div style="font-size: 2em; margin-bottom: 8px;">üìâ</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: #7f1d1d;" id="decreasingSKUCount">0</div>
                                    <div style="color: #7f1d1d; font-size: 0.9em; font-weight: 600;">SKU Gi·∫£m</div>
                                </div>
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #e0e7ff 0%, #6366f1 100%);
                                    padding: 20px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                                ">
                                    <div style="font-size: 2em; margin-bottom: 8px;">üéØ</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: #312e81;" id="totalSKUCount">0</div>
                                    <div style="color: #312e81; font-size: 0.9em; font-weight: 600;">T·ªïng SKU</div>
                                </div>
                            </div>

                            <!-- SKU Analysis Chart -->
                            <div style="
                                background: white;
                                border-radius: 12px;
                                padding: 20px;
                                margin-bottom: 25px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                border: 1px solid #e2e8f0;
                            ">
                                <h4 style="color: #1e40af; margin-bottom: 15px; text-align: center;">üìà Top SKU Theo Doanh S·ªë (Click ƒë·ªÉ xem chi ti·∫øt CH)</h4>
                                <div style="height: 400px;">
                                    <canvas id="skuAnalysisSystemChart"></canvas>
                                </div>
                            </div>

                            <!-- SKU Analysis Table -->
                            <div class="table-container" style="
                                max-height: 600px;
                                overflow: auto;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                border: 1px solid #e2e8f0;
                            ">
                                <table id="skuAnalysisTable" style="
                                    width: 100%;
                                    border-collapse: collapse;
                                    background: white;
                                ">
                                    <thead style="
                                        position: sticky;
                                        top: 0;
                                        background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
                                        color: white;
                                        z-index: 10;
                                    ">
                                        <tr>
                                            <th style="padding: 15px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #1e3a8a;">#</th>
                                            <th style="padding: 15px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #1e3a8a; min-width: 250px;">T√™n S·∫£n Ph·∫©m (R√∫t G·ªçn)</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #1e3a8a;">Trung B√¨nh<br/>Tr∆∞·ªõc</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #1e3a8a;">Trung B√¨nh<br/>G·∫ßn ƒê√¢y</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #1e3a8a;">Thay ƒê·ªïi<br/>(%)</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #1e3a8a;">Xu H∆∞·ªõng</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #1e3a8a;">M·ª©c ƒê·ªô</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #1e3a8a;">Chi Ti·∫øt</th>
                                        </tr>
                                    </thead>
                                    <tbody id="skuAnalysisTableBody">
                                        <!-- Dynamic SKU data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SKU Level Analysis -->
                    <div id="skuLevelContent" style="display: none;">
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.2em;">üè™ Ph√¢n T√≠ch Chi Ti·∫øt Theo C·ª≠a H√†ng</h3>
                            
                            <!-- Store Performance Summary -->
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                                gap: 15px;
                                margin-bottom: 25px;
                            ">
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #f0f9ff 0%, #0ea5e9 100%);
                                    padding: 18px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
                                ">
                                    <div style="font-size: 1.8em; margin-bottom: 6px;">üè™</div>
                                    <div style="font-size: 1.4em; font-weight: 700; color: #0c4a6e;" id="skuActiveStoreCount">0</div>
                                    <div style="color: #0c4a6e; font-size: 0.85em; font-weight: 600;">C·ª≠a H√†ng Ho·∫°t ƒê·ªông</div>
                                </div>
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 100%);
                                    padding: 18px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
                                ">
                                    <div style="font-size: 1.8em; margin-bottom: 6px;">‚ö°</div>
                                    <div style="font-size: 1.4em; font-weight: 700; color: #92400e;" id="skuAvgOrderFreq">0</div>
                                    <div style="color: #92400e; font-size: 0.85em; font-weight: 600;">TB T·∫ßn Su·∫•t/Th√°ng</div>
                                </div>
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #ecfdf5 0%, #10b981 100%);
                                    padding: 18px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                                ">
                                    <div style="font-size: 1.8em; margin-bottom: 6px;">üéØ</div>
                                    <div style="font-size: 1.4em; font-weight: 700; color: #064e3b;" id="skuTopStoreCount">0</div>
                                    <div style="color: #064e3b; font-size: 0.85em; font-weight: 600;">CH Hi·ªáu Qu·∫£ Cao</div>
                                </div>
                                <div class="summary-card" style="
                                    background: linear-gradient(135deg, #fef2f2 0%, #dc2626 100%);
                                    padding: 18px;
                                    border-radius: 12px;
                                    text-align: center;
                                    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
                                ">
                                    <div style="font-size: 1.8em; margin-bottom: 6px;">‚ö†Ô∏è</div>
                                    <div style="font-size: 1.4em; font-weight: 700; color: #7f1d1d;" id="skuLowStoreCount">0</div>
                                    <div style="color: #7f1d1d; font-size: 0.85em; font-weight: 600;">CH C·∫ßn Ch√∫ √ù</div>
                                </div>
                            </div>

                            <!-- Store Analysis Chart -->
                            <div style="
                                background: white;
                                border-radius: 12px;
                                padding: 20px;
                                margin-bottom: 25px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                border: 1px solid #e2e8f0;
                            ">
                                <h4 style="color: #1e40af; margin-bottom: 15px; text-align: center;">üìä Ph√¢n T√≠ch C·ª≠a H√†ng Theo Th√°ng</h4>
                                <canvas id="storeAnalysisChart" style="max-height: 400px;"></canvas>
                            </div>

                            <!-- Store Analysis Table -->
                            <div class="table-container" style="
                                max-height: 600px;
                                overflow: auto;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                border: 1px solid #e2e8f0;
                            ">
                                <table id="storeAnalysisTable" style="
                                    width: 100%;
                                    border-collapse: collapse;
                                    background: white;
                                ">
                                    <thead style="
                                        position: sticky;
                                        top: 0;
                                        background: linear-gradient(135deg, #059669 0%, #047857 100%);
                                        color: white;
                                        z-index: 10;
                                    ">
                                        <tr>
                                            <th style="padding: 15px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #065f46;">#</th>
                                            <th style="padding: 15px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #065f46; min-width: 180px;">C·ª≠a H√†ng</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #065f46;">T·∫ßn Su·∫•t<br/>Tr∆∞·ªõc</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #065f46;">T·∫ßn Su·∫•t<br/>G·∫ßn ƒê√¢y</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #065f46;">Thay ƒê·ªïi<br/>(%)</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #065f46;">T·ªïng SL<br/>6 Th√°ng</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #065f46;">Xu H∆∞·ªõng</th>
                                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid #065f46;">Khuy·∫øn Ngh·ªã</th>
                                        </tr>
                                    </thead>
                                    <tbody id="storeAnalysisTableBody">
                                        <!-- Dynamic store data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================================
        // DEBUG LOGGING SAFETY (avoid CORS on deployed sites)
        // - Many debug snippets post to http://127.0.0.1:7243/ingest/...
        // - On Vercel/GitHub Pages this is blocked by browser PNA/CORS.
        // - We keep instrumentation for local dev, but no-op it on remote.
        // ==========================================================
        (function () {
            try {
                const host = (location && location.hostname) ? location.hostname : '';
                const isLocalHost =
                    host === 'localhost' ||
                    host === '127.0.0.1' ||
                    host === '::1' ||
                    host.endsWith('.local');

                if (!isLocalHost && typeof window !== 'undefined' && typeof window.fetch === 'function') {
                    const originalFetch = window.fetch.bind(window);
                    window.fetch = function (...args) {
                        try {
                            const url = args && args[0] ? String(args[0]) : '';
                            if (url.startsWith('http://127.0.0.1:7243/ingest/')) {
                                return Promise.resolve(new Response(null, { status: 204 }));
                            }
                        } catch (_) { /* ignore */ }
                        return originalFetch(...args);
                    };
                    console.log('‚ÑπÔ∏è Debug ingest logging disabled on non-local host:', host);
                }
            } catch (_) { /* ignore */ }
        })();
        // Ph√¢n t√≠ch v√† hi·ªÉn th·ªã d·ªØ li·ªáu chi ti·∫øt theo c·ª≠a h√†ng cho b·∫£ng Store Analysis
        function populateStoreAnalysisTable(systemName, skuName) {
            const storeAnalysis = [];
            const storeData = {};
            // Thu th·∫≠p d·ªØ li·ªáu t·ª´ng c·ª≠a h√†ng cho SKU n√†y
            allData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG']?.trim();
                const product = row['T√äN SP']?.trim();
                const store = row['C·ª¨A H√ÄNG']?.trim();
                const month = row.monthKey;
                const quantity = parseFloat(row.soLuong) || 0;
                if (system === systemName && product === skuName && store && quantity > 0) {
                    if (!storeData[store]) storeData[store] = {};
                    if (!storeData[store][month]) storeData[store][month] = 0;
                    storeData[store][month] += quantity;
                }
            });

            // Ph√¢n t√≠ch t·ª´ng c·ª≠a h√†ng
            Object.keys(storeData).forEach(store => {
                const monthlyData = storeData[store];
                const months = Object.keys(monthlyData).sort();
                const quantities = months.map(m => monthlyData[m]);
                if (months.length >= 2) {
                    const totalQty = quantities.reduce((a, b) => a + b, 0);
                    const avgQty = totalQty / quantities.length;
                    const orderFreq = months.length;
                    // So s√°nh g·∫ßn ƒë√¢y vs tr∆∞·ªõc ƒë√≥
                    const recentMonths = months.slice(-3);
                    const recentQty = recentMonths.map(m => monthlyData[m]);
                    const recentAvg = recentQty.reduce((a, b) => a + b, 0) / recentQty.length;
                    const earlierMonths = months.slice(0, -3);
                    const earlierQty = earlierMonths.length > 0 ? earlierMonths.map(m => monthlyData[m]) : [];
                    const earlierAvg = earlierQty.length > 0 ? earlierQty.reduce((a, b) => a + b, 0) / earlierQty.length : 0;
                    const changePercent = earlierAvg > 0 ? ((recentAvg - earlierAvg) / earlierAvg) * 100 : 0;
                    let trend = '‚Üí';
                    let recommendation = '';
                    if (changePercent > 20) {
                        trend = 'üìà';
                        recommendation = 'TƒÉng m·∫°nh - ƒê·∫©y m·∫°nh b√°n h√†ng';
                    } else if (changePercent > 5) {
                        trend = 'üìà';
                        recommendation = 'TƒÉng nh·∫π - Theo d√µi';
                    } else if (changePercent < -20) {
                        trend = 'üìâ';
                        recommendation = 'Gi·∫£m m·∫°nh - Ki·ªÉm tra nguy√™n nh√¢n';
                    } else if (changePercent < -5) {
                        trend = 'üìâ';
                        recommendation = 'Gi·∫£m nh·∫π - Theo d√µi th√™m';
                    }
                    if (orderFreq <= 2 && avgQty < 10) {
                        recommendation = 'T·∫ßn su·∫•t th·∫•p - C√≥ th·ªÉ ng∆∞ng cung c·∫•p';
                    }
                    storeAnalysis.push({
                        store,
                        earlierAvg,
                        recentAvg,
                        changePercent,
                        totalQty,
                        orderFreq,
                        trend,
                        recommendation,
                        monthCount: months.length
                    });
                }
            });
            // S·∫Øp x·∫øp theo % thay ƒë·ªïi gi·∫£m d·∫ßn
            storeAnalysis.sort((a, b) => b.changePercent - a.changePercent);
            // Render b·∫£ng
            const tbody = document.getElementById('storeAnalysisTableBody');
            tbody.innerHTML = '';
            storeAnalysis.forEach((store, index) => {
                const rowColor = store.changePercent > 20 ? '#ecfdf5' : store.changePercent < -20 ? '#fef2f2' : store.orderFreq <= 2 ? '#fefbf2' : '#ffffff';
                const row = `
                    <tr style="background: ${rowColor}; border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; text-align: center; font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px; max-width: 180px; word-wrap: break-word;"><strong>${store.store}</strong><div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">${store.monthCount} th√°ng data ‚Ä¢ T·ªïng: ${store.totalQty}</div></td>
                        <td style="padding: 12px; text-align: center;">${store.earlierAvg.toFixed(0)}</td>
                        <td style="padding: 12px; text-align: center;">${store.recentAvg.toFixed(0)}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${store.changePercent > 0 ? '#059669' : '#dc2626'};">${store.changePercent > 0 ? '+' : ''}${store.changePercent.toFixed(1)}%</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;">${store.totalQty}</td>
                        <td style="padding: 12px; text-align: center; font-size: 1.2em;">${store.trend}</td>
                        <td style="padding: 12px; font-size: 0.85em; max-width: 200px;">${store.recommendation}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        let allData = [];
        
        // Authentication & Permission System
        let currentUser = null;
        let usersData = null;
        
        // Load users from users.json
        async function loadUsers() {
            try {
                const response = await fetch('users.json?v=' + Date.now());
                if (response.ok) {
                    usersData = await response.json();
                    console.log('‚úÖ Users loaded:', usersData.users.length);
                } else {
                    console.error('‚ö†Ô∏è Could not load users.json');
                    // Fallback: allow access without login (for development)
                    usersData = { users: [] };
                }
            } catch (e) {
                console.error('‚ùå Error loading users:', e);
                usersData = { users: [] };
            }
        }
        
        // Check if user is logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('üîç Parsed saved user:', {
                        username: currentUser.username,
                        name: currentUser.name,
                        role: currentUser.role,
                        hasPermissions: !!currentUser.permissions,
                        editTarget: currentUser.permissions?.editTarget
                    });
                    // Verify user still exists in users.json
                    if (usersData && usersData.users) {
                        const userExists = usersData.users.find(u => u.username === currentUser.username);
                        if (userExists) {
                            console.log('üîç Found user in usersData:', {
                                username: userExists.username,
                                role: userExists.role,
                                editTarget: userExists.permissions?.editTarget,
                                importExport: userExists.permissions?.importExport
                            });
                            // Merge with latest user data (preserve permissions from users.json)
                            currentUser = { 
                                ...userExists,  // Start with users.json data (has correct permissions)
                                ...currentUser, // Then apply saved user data (but permissions from users.json take priority)
                                permissions: userExists.permissions // Explicitly use permissions from users.json
                            };
                            console.log('‚úÖ User session found (merged):', {
                                name: currentUser.name,
                                role: currentUser.role,
                                editTarget: currentUser.permissions?.editTarget,
                                importExport: currentUser.permissions?.importExport
                            });
                            // #region agent log
                            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2175',message:'User session found and merged',data:{currentUserName:currentUser.name,editTarget:currentUser.permissions?.editTarget,importExport:currentUser.permissions?.importExport},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'P3'})}).catch(()=>{});
                            // #endregion
                            showDashboard();
                            return true;
                        } else {
                            console.warn('‚ö†Ô∏è User not found in usersData:', currentUser.username);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                }
            }
            showLogin();
            return false;
        }
        
        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!usersData || !usersData.users) {
                errorDiv.textContent = 'H·ªá th·ªëng ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.';
                errorDiv.classList.add('show');
                return;
            }
            
            const user = usersData.users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = { ...user };
                delete currentUser.password; // Don't store password
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('‚úÖ Login successful for:', currentUser.name);
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2205',message:'Login successful',data:{currentUserName:currentUser.name,allDataLength:allData.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
                // #endregion
                showDashboard();
                // Load data if not already loaded
                if (!allData || allData.length === 0) {
                    console.log('üì• Loading data after login...');
                    loadAllData();
                } else {
                    console.log('‚úÖ Data already loaded, updating dashboard...');
                    updateDashboard();
                }
            } else {
                errorDiv.classList.add('show');
                setTimeout(() => errorDiv.classList.remove('show'), 3000);
            }
        }
        
        // Handle logout
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLogin();
        }
        
        // Show login modal
        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }
        
        // Show dashboard
        function showDashboard() {
            console.log('üìä showDashboard() called for user:', currentUser?.name);
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2230',message:'showDashboard called',data:{currentUserName:currentUser?.name,allDataLength:allData.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name || currentUser.username;
            document.getElementById('userRole').textContent = getRoleLabel(currentUser.role);
            
            // If data is already loaded, update dashboard immediately
            if (allData && allData.length > 0) {
                console.log('‚úÖ Data already loaded, updating dashboard...');
                updateDashboard();
            } else {
                console.log('‚è≥ Data not loaded yet, will be loaded by initializeAuth...');
            }
            
            // Apply permissions after a short delay to ensure DOM is ready
            setTimeout(() => {
                applyPermissions();
            }, 200);
        }
        
        // Get role label
        function getRoleLabel(role) {
            const labels = {
                'admin': 'üëë Admin',
                'supervisor': 'üëî Supervisor',
                'sales': 'üíº Sales'
            };
            return labels[role] || role;
        }
        
        // Apply permissions - hide/show UI elements
        function applyPermissions() {
            console.log('üîí applyPermissions() called', {
                hasCurrentUser: !!currentUser,
                userName: currentUser?.name,
                userRole: currentUser?.role,
                hasPermissions: !!currentUser?.permissions,
                editTarget: currentUser?.permissions?.editTarget,
                importExport: currentUser?.permissions?.importExport,
                viewAll: currentUser?.permissions?.viewAll
            });
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2308',message:'applyPermissions called',data:{hasCurrentUser:!!currentUser,userName:currentUser?.name,userRole:currentUser?.role,editTarget:currentUser?.permissions?.editTarget,importExport:currentUser?.permissions?.importExport},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'P1'})}).catch(()=>{});
            // #endregion
            
            if (!currentUser || !currentUser.permissions) {
                console.warn('‚ö†Ô∏è No currentUser or permissions in applyPermissions()');
                return;
            }
            
            const perms = currentUser.permissions;
            
            // Hide import/export section if not allowed
            if (!perms.importExport) {
                console.log('üîí Hiding import/export section (no importExport permission)');
                setTimeout(() => {
                    const exportImportSection = document.getElementById('exportImportTargetSection');
                    if (exportImportSection) {
                        exportImportSection.style.display = 'none';
                    }
                }, 100);
            } else {
                console.log('‚úÖ Showing import/export section (has importExport permission)');
            }
            
            // Hide target management inputs if not allowed to edit
            if (!perms.editTarget) {
                console.warn('‚ö†Ô∏è Hiding target inputs (no editTarget permission)');
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2330',message:'Hiding target inputs - no editTarget',data:{userName:currentUser?.name,editTarget:perms.editTarget},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'P2'})}).catch(()=>{});
                // #endregion
                setTimeout(() => {
                    const targetCard = document.getElementById('targetManagementSection');
                    if (targetCard) {
                        // Hide all input fields and buttons
                        const inputs = targetCard.querySelectorAll('input[type="number"], input[type="month"], button[onclick*="Target"], button[onclick*="setBulkTargets"]');
                        inputs.forEach(input => {
                            input.style.display = 'none';
                        });
                        // Show read-only message
                        const readOnlyMsg = document.createElement('div');
                        readOnlyMsg.style.cssText = 'padding: 15px; background: #fef3c7; border-radius: 8px; color: #92400e; margin-top: 15px;';
                        readOnlyMsg.textContent = '‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a target. Vui l√≤ng li√™n h·ªá Admin.';
                        if (!targetCard.querySelector('.read-only-msg')) {
                            readOnlyMsg.className = 'read-only-msg';
                            targetCard.appendChild(readOnlyMsg);
                        }
                    }
                }, 100);
            } else {
                console.log('‚úÖ Showing target inputs (has editTarget permission)');
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2350',message:'Showing target inputs - has editTarget',data:{userName:currentUser?.name,editTarget:perms.editTarget},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'P1'})}).catch(()=>{});
                // #endregion
                // Remove read-only message if exists
                setTimeout(() => {
                    const targetCard = document.getElementById('targetManagementSection');
                    if (targetCard) {
                        const readOnlyMsg = targetCard.querySelector('.read-only-msg');
                        if (readOnlyMsg) {
                            readOnlyMsg.remove();
                        }
                        // Show all inputs
                        const inputs = targetCard.querySelectorAll('input[type="number"], input[type="month"], button[onclick*="Target"], button[onclick*="setBulkTargets"]');
                        inputs.forEach(input => {
                            input.style.display = '';
                        });
                    }
                }, 100);
            }
        }
        
        // Normalize store name for comparison (uppercase, trim)
        function normalizeStoreNameForCompare(storeName) {
            if (!storeName) return '';
            return String(storeName).trim().toUpperCase();
        }
        
        // Filter data based on user permissions
        function filterDataByPermissions(data) {
            if (!currentUser || !currentUser.permissions) {
                console.log('‚ö†Ô∏è No currentUser or permissions, returning all data');
                return data;
            }
            
            const perms = currentUser.permissions;
            
            // Admin and supervisor can see all
            if (perms.viewAll) {
                console.log(`‚úÖ User ${currentUser.name} has viewAll permission, returning all ${data.length} rows`);
                return data;
            }
            
            // Sales can only see their assigned systems/stores
            // Normalize store names in permissions
            const normalizedStores = perms.stores && perms.stores.length > 0 
                ? perms.stores.map(s => normalizeStoreNameForCompare(s))
                : [];
            const normalizedSystems = perms.systems && perms.systems.length > 0
                ? perms.systems.map(s => String(s).trim())
                : [];
            
            console.log(`üîí Filtering data for ${currentUser.name}:`, {
                totalRows: data.length,
                allowedStores: normalizedStores.length,
                allowedSystems: normalizedSystems.length,
                sampleStores: normalizedStores.slice(0, 5)
            });
            
            // Check for Fujitsu data specifically
            const fujitsuData = data.filter(row => {
                const system = row['H·ªÜ TH·ªêNG'] ? String(row['H·ªÜ TH·ªêNG']).trim() : '';
                return system && system.toUpperCase().includes('FUJITSU');
            });
            if (fujitsuData.length > 0) {
                const fujitsuStores = [...new Set(fujitsuData.map(r => normalizeStoreNameForCompare(r['C·ª¨A H√ÄNG'])))];
                const fujitsuSystems = [...new Set(fujitsuData.map(r => String(r['H·ªÜ TH·ªêNG']).trim()))];
                console.log(`üîç Fujitsu data found: ${fujitsuData.length} rows`, {
                    systems: fujitsuSystems,
                    stores: fujitsuStores.slice(0, 10),
                    userAllowedStores: normalizedStores.slice(0, 10),
                    hasMatchingStores: fujitsuStores.some(s => normalizedStores.includes(s))
                });
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2358',message:'Fujitsu data check',data:{fujitsuDataLength:fujitsuData.length,fujitsuStores:fujitsuStores.slice(0,5),userAllowedStores:normalizedStores.slice(0,5)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H'})}).catch(()=>{});
                // #endregion
            }
            
            const filtered = data.filter(row => {
                const system = row['H·ªÜ TH·ªêNG'] ? String(row['H·ªÜ TH·ªêNG']).trim() : '';
                const store = normalizeStoreNameForCompare(row['C·ª¨A H√ÄNG']);
                
                // Check if system is allowed
                if (normalizedSystems.length > 0) {
                    if (!system || !normalizedSystems.includes(system)) {
                        return false;
                    }
                }
                
                // Check if store is allowed (if specified)
                if (normalizedStores.length > 0) {
                    if (!store || !normalizedStores.includes(store)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Check if Fujitsu data was filtered out
            const filteredFujitsu = filtered.filter(row => {
                const system = row['H·ªÜ TH·ªêNG'] ? String(row['H·ªÜ TH·ªêNG']).trim() : '';
                return system && system.toUpperCase().includes('FUJITSU');
            });
            if (fujitsuData.length > 0 && filteredFujitsu.length === 0) {
                console.warn(`‚ö†Ô∏è Fujitsu data filtered out: ${fujitsuData.length} rows ‚Üí 0 rows`);
                console.warn('Reason: User does not have permissions for Fujitsu stores');
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2390',message:'Fujitsu filtered out',data:{fujitsuDataLength:fujitsuData.length,filteredFujitsuLength:0,userName:currentUser.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H'})}).catch(()=>{});
                // #endregion
            }
            
            console.log(`üîí Data filtered: ${data.length} ‚Üí ${filtered.length} rows (${currentUser.name})`);
            if (filtered.length === 0 && data.length > 0) {
                console.warn('‚ö†Ô∏è All data filtered out! Checking sample store names from data:');
                const sampleStores = [...new Set(data.slice(0, 100).map(r => normalizeStoreNameForCompare(r['C·ª¨A H√ÄNG'])))].slice(0, 10);
                console.warn('Sample stores in data:', sampleStores);
                console.warn('Allowed stores:', normalizedStores.slice(0, 10));
            }
            return filtered;
        }
        let charts = {};
        let forecastDetailsData = {}; // Store forecast details

        // Format currency
        function formatCurrency(value) {
            // #region agent log
            console.log('[DEBUG formatCurrency]', { value, type: typeof value, isNaN: isNaN(value), isFinite: isFinite(value) });
            // #endregion
            if (value === null || value === undefined || isNaN(value) || !isFinite(value)) {
                // #region agent log
                console.warn('[DEBUG formatCurrency] Invalid value:', { value, type: typeof value });
                // #endregion
                return '0 ‚Ç´';
            }
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format number
        function formatNumber(value) {
            return new Intl.NumberFormat('vi-VN').format(value);
        }

        // Shorten product name for better display
        function shortenProductName(fullName) {
            if (!fullName) return 'N/A';
            
            // Normalize spacing first - replace multiple spaces with single space
            const normalizedName = fullName.trim().replace(/\s+/g, ' ');
            
            // Check lookup table with normalized name
            if (productNameLookup[normalizedName]) {
                return productNameLookup[normalizedName];
            }
            
            // Try exact match from original name
            const trimmedName = fullName.trim();
            if (productNameLookup[trimmedName]) {
                return productNameLookup[trimmedName];
            }
            
            // Try fuzzy matching - look for similar keys in lookup table
            const lookupKeys = Object.keys(productNameLookup);
            for (const key of lookupKeys) {
                // Normalize lookup key too
                const normalizedKey = key.replace(/\s+/g, ' ').trim();
                if (normalizedKey === normalizedName) {
                    console.log(`‚úÖ Fuzzy match found: "${normalizedName}" -> "${productNameLookup[key]}"`);
                    return productNameLookup[key];
                }
            }
            
            // Debug: Log when lookup fails for key products
            if (normalizedName.includes('Pin Fujitsu') || normalizedName.includes('Baking Soda')) {
                console.log(`üîç Lookup miss for: "${normalizedName}"`);
                // Try to find similar keys
                const similarKeys = lookupKeys.filter(key => 
                    key.includes('Pin Fujitsu') || key.includes('Baking Soda')
                ).slice(0, 2);
                console.log(`üìù Similar keys:`, similarKeys);
            }
            
            // Fallback: Remove content in parentheses (product codes)
            let name = fullName.replace(/\s*\([^)]*\)\s*/g, ' ');
            
            // Remove extra whitespace
            name = name.replace(/\s+/g, ' ').trim();
            
            // If still too long, take first 50 characters
            if (name.length > 50) {
                name = name.substring(0, 47) + '...';
            }
            
            return name;
        }

        // Parse date from filename
        function parseFilename(filename) {
            const match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return new Date(match[1], parseInt(match[2]) - 1, match[3]);
            }
            return null;
        }

        // Load product name lookup table
        let productNameLookup = {};
        let productBrandLookup = {}; // Th√™m lookup cho NHAN (brand)
        async function loadProductNameLookup() {
            return new Promise((resolve) => {
                Papa.parse('ten_sp_nhan.csv', {
                    download: true,
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        results.data.forEach(row => {
                            const tenSP = (row['TEN SP'] || '').trim();
                            const tenRutGon = (row['TEN RUT GON'] || '').trim();
                            const nhan = (row['NHAN'] || '').trim();
                            if (tenSP && tenRutGon) {
                                // Store both original and normalized versions
                                productNameLookup[tenSP] = tenRutGon;
                                productBrandLookup[tenSP] = nhan || 'N/A';
                                
                                // Also store normalized version
                                const normalizedKey = tenSP.replace(/\s+/g, ' ');
                                if (normalizedKey !== tenSP) {
                                    productNameLookup[normalizedKey] = tenRutGon;
                                    productBrandLookup[normalizedKey] = nhan || 'N/A';
                                }
                            }
                        });
                        console.log('Loaded', Object.keys(productNameLookup).length, 'product name mappings with brands (including normalized)');
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error loading product lookup:', error);
                        resolve(); // Continue even if lookup fails
                    }
                });
            });
        }

        // ==========================================
        // DANH S√ÅCH M√É H√ÄNG LO·∫†I TR·ª™ KH·ªéI D·ª∞ KI·∫æN 2026
        // Th√™m/b·ªõt m√£ h√†ng v√†o danh s√°ch n√†y ƒë·ªÉ lo·∫°i tr·ª´ kh·ªèi forecast
        // ==========================================
        const EXCLUDED_SKUS_FROM_FORECAST = [
            '1.81 KG',
            'R03(4B)AAA',
            'LR03(4B)AAA',
            'LR03(2B)AAA',
            'LR6(8B)AA',
            'LR03(6B)AAA',
            'LR03(8B)AAA',
            'R6(4S)F-GP-AA(8117)',
            'KHAC_Xe ƒë·ªì ch∆°i - FBG74',
            'R14(2B)',
            'NUOC HOA PURE GAME',
            'NUOC HOA GET READY'
        ];
        
        // T·ª∑ l·ªá tƒÉng tr∆∞·ªüng ƒë·∫∑c bi·ªát cho t·ª´ng th∆∞∆°ng hi·ªáu (ghi ƒë√® t√≠nh to√°n t·ª± ƒë·ªông)
        const BRAND_CUSTOM_GROWTH = {
            'COLEMAN': 0.30  // Coleman tƒÉng tr∆∞·ªüng 30%
        };

        // ==========================================
        // TRANSLATIONS / NG√îN NG·ªÆ
        // ==========================================
        const translations = {
            vi: {
                title: 'üìä B√°o C√°o Doanh S·ªë  Vi·ªát Li√™n',
                subtitle: 'Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë b√°n h√†ng t·ª´ 2022-2025',
                totalRevenue: 'T·ªïng Doanh Thu',
                totalOrders: 'S·ªë ƒê∆°n H√†ng',
                avgOrderValue: 'Gi√° Tr·ªã TB/ƒê∆°n',
                totalProducts: 'S·∫£n Ph·∫©m',
                activeStores: 'C·ª≠a H√†ng Ho·∫°t ƒê·ªông',
                average: 'Trung b√¨nh',
                orders: 'ƒë∆°n',
                fromMonth: 'T·ª´ th√°ng',
                toMonth: 'ƒê·∫øn th√°ng',
                system: 'H·ªá th·ªëng',
                brand: 'Nh√£n h√†ng',
                allSystems: 'T·∫•t c·∫£ h·ªá th·ªëng',
                allBrands: 'T·∫•t c·∫£ nh√£n h√†ng',
                exportPPT: 'T·∫£i PowerPoint',
                salesTrend: 'üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng',
                brandTrend: 'üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng',
                systemSales: 'üè¢ Doanh S·ªë Theo H·ªá Th·ªëng',
                brandSales: 'üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng',
                yearComparison: 'üìä So S√°nh Doanh S·ªë Theo NƒÉm',
                topProducts: 'üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y',
                storePerformance: 'üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng',
                topStores: 'üèÜ Top 30 C·ª≠a H√†ng Theo T·∫ßn Su·∫•t ƒê·∫∑t H√†ng',
                growthAnalysis: 'üìä Ph√¢n T√≠ch Nguy√™n Nh√¢n Thay ƒê·ªïi Doanh S·ªë (2024 vs 2025)',
                topGrowthSKU: 'üìà Top 10 M√£ H√†ng TƒÉng Tr∆∞·ªüng M·∫°nh Nh·∫•t',
                topDeclineSKU: 'üìâ Top 10 M√£ H√†ng Gi·∫£m Nhi·ªÅu Nh·∫•t',
                topGrowthSystem: 'üè¢ Top H·ªá Th·ªëng TƒÉng Tr∆∞·ªüng',
                topDeclineSystem: 'üè¢ Top H·ªá Th·ªëng Gi·∫£m',
                brandYearComparison: 'üìä So S√°nh Doanh S·ªë Theo NƒÉm (Nh√£n H√†ng)',
                yoyGrowth: 'TƒÉng Tr∆∞·ªüng YoY',
                momGrowth: 'TƒÉng Tr∆∞·ªüng MoM',
                topDriver: 'ƒê·ªông L·ª±c TƒÉng Tr∆∞·ªüng',
                keyInsights: 'üí° Th√¥ng Tin Quan Tr·ªçng',
                strategicFocus: 'üéØ Tr·ªçng T√¢m Chi·∫øn L∆∞·ª£c',
                marketTrend: 'üìä Xu H∆∞·ªõng Th·ªã Tr∆∞·ªùng',
                riskAlert: '‚ö†Ô∏è C·∫£nh B√°o R·ªßi Ro',
                growthOpportunity: 'üöÄ C∆° H·ªôi TƒÉng Tr∆∞·ªüng'
            },
            en: {
                title: 'üìä Sales Report - Viet Lien',
                subtitle: 'Detailed sales analysis from 2022-2025',
                totalRevenue: 'Total Revenue',
                totalOrders: 'Total Orders',
                avgOrderValue: 'Avg Order Value',
                totalProducts: 'Products',
                activeStores: 'Active Stores',
                average: 'Average',
                orders: 'orders',
                fromMonth: 'From month',
                toMonth: 'To month',
                system: 'System',
                brand: 'Brand',
                allSystems: 'All systems',
                allBrands: 'All brands',
                exportPPT: 'Export PowerPoint',
                salesTrend: 'üìà Monthly Sales Trend',
                brandTrend: 'üè∑Ô∏è Sales Trend by Brand',
                systemSales: 'üè¢ Sales by System',
                brandSales: 'üè∑Ô∏è Sales by Brand',
                yearComparison: 'üìä Year-over-Year Comparison',
                topProducts: 'üîù Top 20 Best-Selling Products',
                storePerformance: 'üè™ Store Performance - Active Stores by Month',
                topStores: 'üèÜ Top 30 Stores by Order Frequency',
                growthAnalysis: 'üìä Sales Change Analysis (2024 vs 2025)',
                topGrowthSKU: 'üìà Top 10 Growing SKUs',
                topDeclineSKU: 'üìâ Top 10 Declining SKUs',
                topGrowthSystem: 'üè¢ Top Growing Systems',
                topDeclineSystem: 'üè¢ Top Declining Systems',
                brandYearComparison: 'üìä Year-over-Year Comparison (By Brand)',
                yoyGrowth: 'YoY Growth',
                momGrowth: 'MoM Growth',
                topDriver: 'Top Growth Driver',
                keyInsights: 'üí° Key Insights',
                strategicFocus: 'üéØ Strategic Focus',
                marketTrend: 'üìä Market Trend',
                riskAlert: '‚ö†Ô∏è Risk Alert',
                growthOpportunity: 'üöÄ Growth Opportunity'
            }
        };

        let currentLanguage = localStorage.getItem('dashboardLanguage') || 'vi';

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('dashboardLanguage', lang);
            document.documentElement.lang = lang;
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update select options
            const systemFilter = document.getElementById('systemFilter');
            if (systemFilter && systemFilter.options[0]) {
                systemFilter.options[0].textContent = translations[lang].allSystems;
            }
            
            const brandFilter = document.getElementById('brandFilter');
            if (brandFilter && brandFilter.options[0]) {
                brandFilter.options[0].textContent = translations[lang].allBrands;
            }
            
            // Re-render charts with new language
            updateDashboard();
        }

        function initLanguage() {
            const selector = document.getElementById('languageSelector');
            if (selector) {
                selector.value = currentLanguage;
            }
            switchLanguage(currentLanguage);
        }

        // Load CUSTOMERS lookup table
        let customersLookup = {};
        async function loadCustomers() {
            return new Promise((resolve) => {
                Papa.parse('CUSTOMERS.csv', {
                    download: true,
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        results.data.forEach(row => {
                            const nam = parseInt(row['NAM']);
                            const systemCode = (row['SYSTEM CODE'] || '').trim();
                            const heThong = (row['HE THONG'] || '').trim();
                            if (nam && systemCode && heThong) {
                                const key = `${nam}_${systemCode}`;
                                customersLookup[key] = heThong;
                            }
                        });
                        console.log('Loaded', Object.keys(customersLookup).length, 'customer system mappings');
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error loading customers:', error);
                        resolve(); // Continue even if lookup fails
                    }
                });
            });
        }

        // Load all CSV files
        async function loadAllData() {
            console.log('üöÄ Starting loadAllData()...');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2631',message:'loadAllData started',data:{hasCurrentUser:!!currentUser,currentUserName:currentUser?.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            // Load lookup tables first
            await loadProductNameLookup();
            await loadCustomers();
            await loadProductNameLookup();
            // CH·ªà L·∫§Y FILE CU·ªêI TH√ÅNG (lo·∫°i b·ªè file trung gian ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
            const files = [
                // 2022 (needed for Baking Soda in MEGA stores)
                '2022-09-30_DS_30.09.2022.csv',
                '2022-12-31_DS_31.12.22.csv',
                '2023-01-31_DS_31.01.2023.csv', '2023-02-28_DS_28.02.23.csv', '2023-03-31_DS_31.03.2023.csv',
                '2023-04-30_DS_30.04.2023.csv', '2023-05-27_DS_27.05.2023.csv', '2023-06-30_DS_30.06.2023.csv',
                '2023-07-31_DS_31.07.2023.csv', '2023-08-31_DS_31.08.2023.csv', '2023-09-30_DS_30.09.2023.csv',
                '2023-10-31_DS_31.10.2023.csv', '2023-11-30_DS_30.11.2023.csv', '2023-12-31_DS_31.12.2023.csv',
                '2024-01-31_DS_31.01.2024.csv', '2024-02-29_DS_29.02.24.csv', '2024-03-30_DS_30.03.2024.csv',
                '2024-04-30_DS_30.04.2024.csv', '2024-05-31_DS_31.05.2024.csv', '2024-06-30_DS_30.06.2024.csv',
                '2024-07-31_DS_31.07.2024.csv', '2024-08-31_DS_31.08.2024.csv', '2024-09-30_DS_30.09.2024.csv',
                '2024-10-31_DS_31.10.2024.csv', '2024-11-30_DS_30.11.2024.csv', '2024-12-31_DS_31.12.2024.csv',
                '2025-01-24_DS_24.01.25.csv', '2025-02-28_DS_28.02.25.csv', '2025-03-31_DS_31.03.25.csv',
                '2025-04-30_DS_30.4.25.csv', '2025-05-31_DS_31.05.25.csv', '2025-06-30_DS_30.06.25.csv',
                '2025-07-28_DS_28.07.25.csv', '2025-08-31_DS_31.08.25.csv', '2025-09-30_DS_30.09.25 .csv',
                '2025-10-31_DS_31.10.25 .csv', 
                // Th√°ng 11: Ch·ªâ l·∫•y file 30/11 (b·ªè file 22/11)
                '2025-11-30_DS_30.11.25.csv',
                // Th√°ng 12: Ch·ªâ l·∫•y file 31/12 (b·ªè file 15/12 v√† 22/12)
                '2025-12-31_DS_31.12.25.csv'
            ];

            const promises = files.map(filename => {
                return new Promise((resolve, reject) => {
                    const date = parseFilename(filename);
                    // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi + cache buster
                    const filePath = 'CSV_Output_Latest_Only/' + filename + '?v=' + Date.now();
                    
                    Papa.parse(filePath, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        encoding: 'UTF-8',
                        complete: function(results) {
                            // Debug: log t√™n c·ªôt ƒë·ªÉ ki·ªÉm tra
                            if (results.data.length > 0 && filename.includes('2025-11-30')) {
                                console.log('Column names in CSV:', Object.keys(results.data[0]));
                            }
                            
                            const data = results.data
                                // B∆∞·ªõc 1: L·ªçc b·ªè header rows (NGAY = "NGAY")
                                .filter(row => row.NGAY && row.NGAY !== 'NGAY')
                                // B∆∞·ªõc 2: Map v√† merge v·ªõi lookups (gi·ªëng Excel Power Query)
                                .map(row => {
                                    const sl = parseFloat(row.SL) || 0;
                                    const donGia = parseFloat(row['ƒê∆†N GI√Å']) || 0;
                                    // C√¥ng th·ª©c Power Query: VAT = SL * ƒê∆†N GI√Å * 1.1
                                    const calculatedVAT = sl * donGia * 1.1;
                                    
                                    const tenSP = (row['T√äN SP'] || '').trim();
                                    const maKH = (row['MA KH'] || '').toString().trim();
                                    
                                    // QUAN TR·ªåNG: D√πng NHAN t·ª´ ten_sp_nhan (kh√¥ng d√πng NH√ÉN H√ÄNG t·ª´ CSV)
                                    const nhanHang = productBrandLookup[tenSP] || 'N/A';
                                    
                                    // Merge v·ªõi CUSTOMERS: NAM + MA KH -> HE THONG
                                    const customerKey = `${date.getFullYear()}_${maKH}`;
                                    const heThongFromCustomers = customersLookup[customerKey] || null;
                                    
                                    // L·∫•y M√É HH t·ª´ c·ªôt th·ª© 8 (index 7)
                                    const maHH = (row['M√É HH'] || row['MA HH'] || '').toString().trim();
                                    
                                    return {
                                        'SO HD': row['SO HD'],
                                        'NGAY': row.NGAY,
                                        'MA KH': maKH,
                                        'M√É HH': maHH,
                                        'T√äN SP': tenSP,
                                        'NH√ÉN H√ÄNG': nhanHang, // T·ª´ NHAN trong ten_sp_nhan
                                        'H·ªÜ TH·ªêNG': heThongFromCustomers, // T·ª´ CUSTOMERS, kh√¥ng ph·∫£i CSV g·ªëc
                                        'C·ª¨A H√ÄNG': row['C·ª¨A H√ÄNG'],
                                        month: date,
                                        monthKey: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                                        year: date.getFullYear(),
                                        vat: calculatedVAT,
                                        thanhTien: parseFloat(row['TH√ÄNH TI·ªÄN']) || 0,
                                        soLuong: sl,
                                        donGia: donGia,
                                        // Key ƒë·ªÉ dedup: SO HD + NGAY + M√É HH + T√äN SP + SL
                                        duplicateKey: `${row['SO HD']}_${row.NGAY}_${maHH}_${tenSP}_${sl}`
                                    };
                                });
                            resolve(data);
                        },
                        error: function(error) {
                            console.error(`Error loading ${filename}:`, error);
                            resolve([]);
                        }
                    });
                });
            });

            const results = await Promise.all(promises);
            const rawData = results.flat();
            
            console.log('Raw data loaded:', rawData.length, 'rows');
            
            // DEDUP theo Excel Power Query: Group by SO HD + NGAY + M√É HH + T√äN SP + SL
            // Gi·ªØ d√≤ng ƒê·∫¶U TI√äN (Table.FirstN(_,1))
            const uniqueMap = new Map();
            let duplicateCount = 0;
            rawData.forEach(row => {
                const key = row.duplicateKey;
                if (!uniqueMap.has(key)) {
                    uniqueMap.set(key, row);
                } else {
                    duplicateCount++;
                }
            });
            
            const afterDedup = Array.from(uniqueMap.values());
            console.log('After dedup:', afterDedup.length, 'rows (removed', duplicateCount, 'duplicates)');
            
            // L·ªåC H·ªÜ TH·ªêNG != null (t·ª´ CUSTOMERS)
            const afterSystemFilter = afterDedup.filter(row => row['H·ªÜ TH·ªêNG'] !== null);
            console.log('Filter H·ªÜ TH·ªêNG not null:', afterSystemFilter.length, 'rows');
            
            // L·ªåC B·ªé NH√ÉN H√ÄNG = "N/A"
            allData = afterSystemFilter.filter(row => row['NH√ÉN H√ÄNG'] !== 'N/A' && row['NH√ÉN H√ÄNG'] !== '');
            console.log('After filter NH√ÉN H√ÄNG:', allData.length, 'rows');
            
            // T√≠nh t·ªïng VAT ƒë·ªÉ debug
            const totalVAT = allData.reduce((sum, row) => sum + row.vat, 0);
            console.log('üí∞ Total VAT (all data):', totalVAT.toLocaleString('vi-VN'), 'VND');
            
            // Debug th√°ng 11/2025 c·ª• th·ªÉ
            const nov2025 = allData.filter(row => row.monthKey === '2025-11');
            const nov2025VAT = nov2025.reduce((sum, row) => sum + row.vat, 0);
            console.log('üìÖ Nov 2025:', nov2025.length, 'rows, VAT:', nov2025VAT.toLocaleString('vi-VN'), 'VND');
            
            // Debug th√°ng 4/2025 c·ª• th·ªÉ
            const apr2025Raw = rawData.filter(row => row.monthKey === '2025-04');
            const apr2025Final = allData.filter(row => row.monthKey === '2025-04');
            const apr2025VAT = apr2025Final.reduce((sum, row) => sum + row.vat, 0);
            console.log('üìÖ Apr 2025: Raw:', apr2025Raw.length, '‚Üí Final:', apr2025Final.length, 'rows, VAT:', apr2025VAT.toLocaleString('vi-VN'), 'VND');
            
            console.log('‚úÖ Data loaded, updating UI...');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2800',message:'Data loaded, updating UI',data:{allDataLength:allData.length,hasCurrentUser:!!currentUser},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            initializeFilters();
            initLanguage();
            // Load targets (async) and then update dashboard
            loadTargets().then(() => {
                console.log('‚úÖ Targets loaded, calling updateDashboard()...');
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:2810',message:'Calling updateDashboard',data:{allDataLength:allData.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                updateDashboard();
                // Update forecast display after targets are loaded
                setTimeout(() => {
                    updateForecastDisplayWithTargets();
                    setDefaultTargetVsActualMonth();
                }, 500);
            }).catch((e) => {
                console.error('‚ùå Error loading targets:', e);
                // If loadTargets fails, still update dashboard
                updateDashboard();
            });
        }
        
        // Initialize authentication
        async function initializeAuth() {
            await loadUsers();
            checkAuth();
        }

        // Initialize filters
        function initializeFilters() {
            const systems = [...new Set(allData.map(d => d['H·ªÜ TH·ªêNG']))].filter(Boolean).sort();
            const brands = [...new Set(allData.map(d => d['NH√ÉN H√ÄNG']))].filter(Boolean).sort();
            
            // Get unique shortened product names
            const products = [...new Set(allData.map(d => shortenProductName(d['T√äN SP'])))].filter(Boolean).sort();

            const systemSelect = document.getElementById('systemFilter');
            systems.forEach(system => {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = system;
                systemSelect.appendChild(option);
            });

            const brandSelect = document.getElementById('brandFilter');
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            const productSelect = document.getElementById('productFilter');
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productSelect.appendChild(option);
            });

            // Add event listeners with cascading update
            document.getElementById('startMonth').addEventListener('change', updateDashboard);
            document.getElementById('endMonth').addEventListener('change', updateDashboard);
            document.getElementById('systemFilter').addEventListener('change', () => {
                updateCascadingFilters();
                updateDashboard();
            });
            document.getElementById('brandFilter').addEventListener('change', () => {
                updateCascadingFilters();
                updateDashboard();
            });
            document.getElementById('productFilter').addEventListener('change', updateDashboard);
        }

        // Update cascading filters based on current selection
        function updateCascadingFilters() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const selectedSystem = document.getElementById('systemFilter').value;
            const selectedBrand = document.getElementById('brandFilter').value;
            const selectedProduct = document.getElementById('productFilter').value;

            // Filter data based on current selections
            let filteredData = allData.filter(row => {
                if (startMonth && row.monthKey < startMonth) return false;
                if (endMonth && row.monthKey > endMonth) return false;
                if (selectedSystem !== 'all' && row['H·ªÜ TH·ªêNG'] !== selectedSystem) return false;
                if (selectedBrand !== 'all' && row['NH√ÉN H√ÄNG'] !== selectedBrand) return false;
                return true;
            });

            // Update brand dropdown based on selected system
            if (selectedSystem !== 'all') {
                const availableBrands = [...new Set(filteredData.map(d => d['NH√ÉN H√ÄNG']))].filter(Boolean).sort();
                const brandSelect = document.getElementById('brandFilter');
                const currentBrand = brandSelect.value;
                
                brandSelect.innerHTML = '<option value="all">T·∫•t c·∫£ nh√£n h√†ng</option>';
                availableBrands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    if (brand === currentBrand) option.selected = true;
                    brandSelect.appendChild(option);
                });
            }

            // Update product dropdown based on selected system and brand (using shortened names)
            const availableProducts = [...new Set(filteredData.map(d => shortenProductName(d['T√äN SP'])))].filter(Boolean).sort();
            const productSelect = document.getElementById('productFilter');
            const currentProduct = productSelect.value;
            
            productSelect.innerHTML = '<option value="all">T·∫•t c·∫£ s·∫£n ph·∫©m</option>';
            availableProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                if (product === currentProduct) option.selected = true;
                productSelect.appendChild(option);
            });
        }

        // Quick timeline filter
        function setQuickTimeline(period) {
            const latestDate = new Date('2025-12-01');
            let startDate;
            
            switch(period) {
                case '1M':
                    startDate = new Date(latestDate);
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate = new Date(latestDate);
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
                case '6M':
                    startDate = new Date(latestDate);
                    startDate.setMonth(startDate.getMonth() - 6);
                    break;
                case '1Y':
                    startDate = new Date(latestDate);
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case 'ALL':
                    startDate = new Date('2023-01-01');
                    break;
            }
            
            const startMonth = startDate.toISOString().substring(0, 7);
            const endMonth = '2025-12';
            
            document.getElementById('startMonth').value = startMonth;
            document.getElementById('endMonth').value = endMonth;
            
            // Update button states
            document.querySelectorAll('.timeline-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateDashboard();
        }

        // Filter data
        function filterData() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const system = document.getElementById('systemFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const product = document.getElementById('productFilter').value;

            return allData.filter(row => {
                if (startMonth && row.monthKey < startMonth) return false;
                if (endMonth && row.monthKey > endMonth) return false;
                if (system !== 'all' && row['H·ªÜ TH·ªêNG'] !== system) return false;
                if (brand !== 'all' && row['NH√ÉN H√ÄNG'] !== brand) return false;
                if (product !== 'all' && shortenProductName(row['T√äN SP']) !== product) return false;
                return true;
            });
        }

        // Update KPIs
        function updateKPIs(data) {
            const totalSales = data.reduce((sum, row) => sum + row.vat, 0);
            const uniqueOrders = new Set(data.map(d => d['SO HD']).filter(Boolean)).size;
            const avgOrder = uniqueOrders > 0 ? totalSales / uniqueOrders : 0;
            
            // ƒê·∫øm s·∫£n ph·∫©m unique theo filter hi·ªán t·∫°i
            console.log('Sample row keys:', data.length > 0 ? Object.keys(data[0]) : 'No data');
            console.log('Sample row M√É HH:', data.length > 0 ? data[0]['M√É HH'] : 'No data');
            
            const productCodes = data.map(d => d['M√É HH']).filter(Boolean);
            const uniqueProducts = new Set(productCodes).size;
            
            console.log('Product codes sample (first 10):', productCodes.slice(0, 10));
            console.log('Unique products:', uniqueProducts);
            
            // ƒê·∫øm t·ªïng s·∫£n ph·∫©m trong to√†n b·ªô d·ªØ li·ªáu (kh√¥ng filter)
            const allProductCodes = allData.map(d => d['M√É HH']).filter(Boolean);
            const totalAllProducts = new Set(allProductCodes).size;
            
            const systems = data.map(d => d['H·ªÜ TH·ªêNG'] || d.H·ªÜ_TH·ªêNG || d['HE THONG']).filter(Boolean);
            const uniqueSystems = new Set(systems).size;
            
            const brands = data.map(d => d['NH√ÉN H√ÄNG'] || d.NH√ÉN_H√ÄNG || d['NHAN HANG']).filter(Boolean);
            const uniqueBrands = new Set(brands).size;
            
            // Calculate unique stores
            const stores = data.map(d => d['C·ª¨A H√ÄNG']).filter(Boolean);
            const uniqueStores = new Set(stores).size;
            
            // Calculate average orders per store
            const avgOrdersPerStore = uniqueStores > 0 ? uniqueOrders / uniqueStores : 0;
            
            console.log('KPI Debug:', {
                totalRows: data.length,
                totalRowsAll: allData.length,
                uniqueProducts: uniqueProducts,
                totalAllProducts: totalAllProducts,
                sampleProduct: productCodes[0],
                uniqueSystems: uniqueSystems,
                uniqueBrands: uniqueBrands,
                uniqueStores: uniqueStores
            });

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalOrders').textContent = formatNumber(uniqueOrders);
            document.getElementById('avgOrderValue').textContent = formatCurrency(avgOrder);
            document.getElementById('totalProducts').textContent = formatNumber(uniqueProducts);
            document.getElementById('totalProductsAll').textContent = formatNumber(totalAllProducts);
            document.getElementById('activeStores').textContent = formatNumber(uniqueStores);
            document.getElementById('avgOrdersPerStore').textContent = formatNumber(Math.round(avgOrdersPerStore));

            // Calculate YoY growth and trends
            const currentYear = 2025;
            const previousYear = 2024;
            
            const currentYearData = allData.filter(d => d.year === currentYear);
            const previousYearData = allData.filter(d => d.year === previousYear);
            
            const currentSales = currentYearData.reduce((sum, row) => sum + row.vat, 0);
            const previousSales = previousYearData.reduce((sum, row) => sum + row.vat, 0);
            const yoyGrowth = previousSales > 0 ? ((currentSales - previousSales) / previousSales * 100) : 0;
            
            document.getElementById('yoyGrowth').textContent = `${yoyGrowth >= 0 ? '+' : ''}${yoyGrowth.toFixed(1)}%`;
            document.getElementById('yoyGrowth').style.color = yoyGrowth >= 0 ? '#10b981' : '#ef4444';
            document.getElementById('yoyTrend').textContent = `${formatCurrency(Math.abs(currentSales - previousSales))} ${yoyGrowth >= 0 ? 'tƒÉng' : 'gi·∫£m'}`;
            document.getElementById('yoyTrend').className = yoyGrowth >= 0 ? 'kpi-change' : 'kpi-change negative';
            
            // Calculate MoM growth (most recent 2 months)
            const allMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            if (allMonths.length >= 2) {
                const lastMonth = allMonths[allMonths.length - 1];
                const prevMonth = allMonths[allMonths.length - 2];
                
                const lastMonthSales = allData.filter(d => d.monthKey === lastMonth).reduce((sum, row) => sum + row.vat, 0);
                const prevMonthSales = allData.filter(d => d.monthKey === prevMonth).reduce((sum, row) => sum + row.vat, 0);
                const momGrowth = prevMonthSales > 0 ? ((lastMonthSales - prevMonthSales) / prevMonthSales * 100) : 0;
                
                document.getElementById('momGrowth').textContent = `${momGrowth >= 0 ? '+' : ''}${momGrowth.toFixed(1)}%`;
                document.getElementById('momGrowth').style.color = momGrowth >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('momTrend').textContent = `${lastMonth} vs ${prevMonth}`;
            }
            
            // Find top growth driver (brand or system)
            const brandGrowth = {};
            currentYearData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandGrowth[brand]) brandGrowth[brand] = 0;
                brandGrowth[brand] += row.vat;
            });
            previousYearData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandGrowth[brand]) brandGrowth[brand] = 0;
                brandGrowth[brand] -= row.vat;
            });
            
            const topGrowthBrand = Object.entries(brandGrowth)
                .filter(([brand, growth]) => growth > 0)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (topGrowthBrand) {
                document.getElementById('topDriver').textContent = topGrowthBrand[0];
                const contribution = currentSales > 0 ? (topGrowthBrand[1] / (currentSales - previousSales) * 100) : 0;
                document.getElementById('driverContribution').textContent = `+${formatCurrency(topGrowthBrand[1])} (${contribution.toFixed(0)}% ƒë√≥ng g√≥p)`;
                document.getElementById('driverContribution').className = 'kpi-change';
            }
            
            // Generate Key Insights for Leadership
            generateKeyInsights(allData);

            const salesChangeEl = document.getElementById('salesChange');
            salesChangeEl.textContent = `${yoyGrowth >= 0 ? '+' : ''}${yoyGrowth.toFixed(1)}% vs nƒÉm tr∆∞·ªõc`;
            salesChangeEl.className = yoyGrowth >= 0 ? 'kpi-change' : 'kpi-change negative';
        }
        
        // Generate actionable insights for leadership decisions
        function generateKeyInsights(data) {
            const current2025 = data.filter(d => d.year === 2025);
            const previous2024 = data.filter(d => d.year === 2024);
            
            // 1. Strategic Focus: Identify strongest growth segment
            const brandPerf = {};
            current2025.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandPerf[brand]) brandPerf[brand] = { current: 0, previous: 0 };
                brandPerf[brand].current += row.vat;
            });
            previous2024.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandPerf[brand]) brandPerf[brand] = { current: 0, previous: 0 };
                brandPerf[brand].previous += row.vat;
            });
            
            const brandGrowths = Object.entries(brandPerf)
                .map(([brand, perf]) => ({
                    brand,
                    growth: perf.previous > 0 ? ((perf.current - perf.previous) / perf.previous * 100) : 0,
                    value: perf.current
                }))
                .sort((a, b) => b.growth - a.growth);
            
            const topBrand = brandGrowths[0];
            const focusMessage = topBrand ? 
                `T·∫≠p trung v√†o ${topBrand.brand} (tƒÉng ${topBrand.growth.toFixed(0)}%, ƒë√≥ng g√≥p ${formatCurrency(topBrand.value)})` :
                'Ph√¢n t√≠ch th√™m ƒë·ªÉ x√°c ƒë·ªãnh tr·ªçng t√¢m';
            document.getElementById('strategicFocus').textContent = focusMessage;
            
            // 2. Market Trend: Month-over-month momentum
            const months = [...new Set(data.map(d => d.monthKey))].sort();
            const recentMonths = months.slice(-6);
            const monthlyGrowth = [];
            
            for (let i = 1; i < recentMonths.length; i++) {
                const currMonth = recentMonths[i];
                const prevMonth = recentMonths[i-1];
                const currSales = data.filter(d => d.monthKey === currMonth).reduce((s, r) => s + r.vat, 0);
                const prevSales = data.filter(d => d.monthKey === prevMonth).reduce((s, r) => s + r.vat, 0);
                const growth = prevSales > 0 ? ((currSales - prevSales) / prevSales * 100) : 0;
                monthlyGrowth.push(growth);
            }
            
            const avgMoMGrowth = monthlyGrowth.length > 0 ? 
                monthlyGrowth.reduce((a, b) => a + b, 0) / monthlyGrowth.length : 0;
            const trendDirection = avgMoMGrowth > 5 ? 'TƒÉng tr∆∞·ªüng m·∫°nh' : 
                                    avgMoMGrowth > 0 ? 'TƒÉng tr∆∞·ªüng ·ªïn ƒë·ªãnh' : 
                                    avgMoMGrowth > -5 ? 'Suy gi·∫£m nh·∫π' : 'Suy gi·∫£m nghi√™m tr·ªçng';
            const trendMessage = `${trendDirection} (TB MoM: ${avgMoMGrowth.toFixed(1)}%)`;
            document.getElementById('marketTrend').textContent = trendMessage;
            
            // 3. Risk Alert: Declining segments
            const decliningBrands = brandGrowths.filter(b => b.growth < -10).slice(0, 2);
            const riskMessage = decliningBrands.length > 0 ?
                `Ch√∫ √Ω: ${decliningBrands.map(b => `${b.brand} (${b.growth.toFixed(0)}%)`).join(', ')}` :
                'Kh√¥ng c√≥ c·∫£nh b√°o ƒë√°ng k·ªÉ';
            document.getElementById('riskAlert').textContent = riskMessage;
            
            // 4. Growth Opportunity: Underperforming with potential
            const systemPerf = {};
            current2025.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemPerf[system]) systemPerf[system] = { stores: new Set(), sales: 0 };
                systemPerf[system].stores.add(row['C·ª¨A H√ÄNG']);
                systemPerf[system].sales += row.vat;
            });
            
            const systemOpportunities = Object.entries(systemPerf)
                .map(([system, perf]) => ({
                    system,
                    avgPerStore: perf.sales / perf.stores.size,
                    sales: perf.sales,
                    stores: perf.stores.size
                }))
                .sort((a, b) => a.avgPerStore - b.avgPerStore)
                .slice(0, 2);
            
            const oppMessage = systemOpportunities.length > 0 ?
                `Ti·ªÅm nƒÉng t·∫°i ${systemOpportunities[0].system} (${formatCurrency(systemOpportunities[0].avgPerStore)}/c·ª≠a h√†ng)` :
                'ƒêang t·ªëi ∆∞u h√≥a to√†n b·ªô h·ªá th·ªëng';
            document.getElementById('growthOpportunity').textContent = oppMessage;
        }

        // Create Forecast Chart with predictions
        function createForecastChart(data) {
            // For sales users, data should already be filtered by permissions in updateDashboard()
            // But ensure we only use data from stores they have access to
            console.log('üìä createForecastChart() called with', data.length, 'rows');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:3324',message:'createForecastChart started',data:{dataLength:data.length,hasCurrentUser:!!currentUser,userName:currentUser?.name,viewAll:currentUser?.permissions?.viewAll},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F1'})}).catch(()=>{});
            // #endregion
            
            // Group data by month
            const monthlyData = {};
            data.forEach(row => {
                const key = row.monthKey;
                if (!monthlyData[key]) {
                    monthlyData[key] = { vat: 0, qty: 0 };
                }
                monthlyData[key].vat += row.vat;
                monthlyData[key].qty += row.soLuong || 0;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const historicalSales = sortedMonths.map(m => monthlyData[m].vat);
            const historicalQty = sortedMonths.map(m => monthlyData[m].qty);

            // Calculate forecasts using moving average with trend
            const forecastMonths = 3; // Forecast next 3 months
            const movingAvgWindow = 3;
            
            // Calculate trend from last 6 months
            const recentMonths = Math.min(6, sortedMonths.length);
            const recentData = historicalSales.slice(-recentMonths);
            const recentQtyData = historicalQty.slice(-recentMonths);
            
            // Linear regression for trend
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumQtyY = 0, sumQtyXY = 0;
            for (let i = 0; i < recentData.length; i++) {
                sumX += i;
                sumY += recentData[i];
                sumXY += i * recentData[i];
                sumX2 += i * i;
                sumQtyY += recentQtyData[i];
                sumQtyXY += i * recentQtyData[i];
            }
            
            const n = recentData.length;
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const slopeQty = (n * sumQtyXY - sumX * sumQtyY) / (n * sumX2 - sumX * sumX);
            const interceptQty = (sumQtyY - slopeQty * sumX) / n;

            // Calculate seasonality (monthly patterns)
            const monthlyPattern = {};
            sortedMonths.forEach((monthKey, idx) => {
                const monthNum = new Date(monthKey + '-01').getMonth(); // 0-11
                if (!monthlyPattern[monthNum]) {
                    monthlyPattern[monthNum] = [];
                }
                monthlyPattern[monthNum].push(historicalSales[idx]);
            });

            // Average by month
            const seasonalityFactors = {};
            Object.keys(monthlyPattern).forEach(month => {
                const avg = monthlyPattern[month].reduce((a, b) => a + b, 0) / monthlyPattern[month].length;
                seasonalityFactors[month] = avg;
            });
            
            const overallAvg = Object.values(seasonalityFactors).reduce((a, b) => a + b, 0) / Object.keys(seasonalityFactors).length;
            Object.keys(seasonalityFactors).forEach(month => {
                seasonalityFactors[month] = seasonalityFactors[month] / overallAvg; // Normalize
            });

            // Generate forecast months
            const lastMonthKey = sortedMonths[sortedMonths.length - 1];
            const lastDate = new Date(lastMonthKey + '-01');
            const forecastLabels = [];
            const forecastSales = [];
            const forecastQty = [];
            
            for (let i = 1; i <= forecastMonths; i++) {
                const nextDate = new Date(lastDate);
                nextDate.setMonth(nextDate.getMonth() + i);
                const nextMonthKey = nextDate.toISOString().substring(0, 7);
                forecastLabels.push(nextMonthKey);
                
                // Trend forecast
                const trendValue = slope * (recentData.length - 1 + i) + intercept;
                const trendQtyValue = slopeQty * (recentQtyData.length - 1 + i) + interceptQty;
                
                // Apply seasonality
                const monthNum = nextDate.getMonth();
                const seasonalFactor = seasonalityFactors[monthNum] || 1;
                
                forecastSales.push(trendValue * seasonalFactor);
                forecastQty.push(trendQtyValue * seasonalFactor);
            }

            // Current month forecast (first forecast month)
            const currentMonthForecastSales = forecastSales[0];
            const currentMonthForecastQty = forecastQty[0];
            const currentMonthLabel = forecastLabels[0]; // Get the month label for first forecast
            
            // Update forecast KPIs - Current Month (first forecast month)
            // Format month label: "2026-01" -> "Th√°ng 1/2026"
            const [currentYear, currentMonth] = currentMonthLabel.split('-');
            const currentMonthDisplay = `Th√°ng ${parseInt(currentMonth)}/${currentYear}`;
            document.getElementById('currentMonthForecast').textContent = formatCurrency(currentMonthForecastSales);
            
            // Get target for current month (user-specific for sales, total for admin/supervisor)
            const currentMonthTarget = getUserTarget(currentMonthLabel);
            let currentMonthQtyText = `${currentMonthDisplay} - SL: ${formatNumber(Math.round(currentMonthForecastQty))}`;
            if (currentMonthTarget > 0) {
                const achievementPercent = (currentMonthForecastSales / currentMonthTarget * 100).toFixed(1);
                currentMonthQtyText += ` | Target: ${formatCurrency(currentMonthTarget)} (${achievementPercent}%)`;
            }
            document.getElementById('currentMonthQtyForecast').textContent = currentMonthQtyText;
            
            // Update forecast KPIs - Next Month (second forecast month)
            const nextMonthForecastSales = forecastSales[1] || forecastSales[0];
            const nextMonthForecastQty = forecastQty[1] || forecastQty[0];
            const nextMonthLabel = forecastLabels[1] || forecastLabels[0];
            const [nextYear, nextMonth] = nextMonthLabel.split('-');
            const nextMonthDisplay = `Th√°ng ${parseInt(nextMonth)}/${nextYear}`;
            document.getElementById('nextMonthForecast').textContent = formatCurrency(nextMonthForecastSales);
            
            // Get target for next month (user-specific for sales, total for admin/supervisor)
            const nextMonthTarget = getUserTarget(nextMonthLabel);
            let nextMonthQtyText = `${nextMonthDisplay} - SL: ${formatNumber(Math.round(nextMonthForecastQty))}`;
            if (nextMonthTarget > 0) {
                const achievementPercent = (nextMonthForecastSales / nextMonthTarget * 100).toFixed(1);
                nextMonthQtyText += ` | Target: ${formatCurrency(nextMonthTarget)} (${achievementPercent}%)`;
            }
            document.getElementById('nextMonthQtyForecast').textContent = nextMonthQtyText;

            // Current quarter average
            const currentQuarterMonths = sortedMonths.slice(-3);
            const currentQuarterSales = currentQuarterMonths.map(m => monthlyData[m].vat);
            const currentQuarterQtyData = currentQuarterMonths.map(m => monthlyData[m].qty);
            const currentQtrAvg = currentQuarterSales.reduce((a, b) => a + b, 0) / currentQuarterSales.length;
            const currentQtrQtyAvg = currentQuarterQtyData.reduce((a, b) => a + b, 0) / currentQuarterQtyData.length;
            
            document.getElementById('currentQuarterAvg').textContent = formatCurrency(currentQtrAvg);
            document.getElementById('currentQuarterQtyAvg').textContent = `S·ªë l∆∞·ª£ng: ${formatNumber(Math.round(currentQtrQtyAvg))}`;
            
            // Next quarter forecast (average of next 3 forecast months)
            const nextQtrForecast = forecastSales.reduce((a, b) => a + b, 0) / forecastSales.length;
            const nextQtrQtyForecast = forecastQty.reduce((a, b) => a + b, 0) / forecastQty.length;
            
            document.getElementById('nextQuarterForecast').textContent = formatCurrency(nextQtrForecast);
            
            // Calculate average target for next quarter if all forecast months have targets (user-specific)
            const nextQtrTargets = forecastLabels.map(monthKey => getUserTarget(monthKey)).filter(t => t > 0);
            let nextQtrQtyText = `S·ªë l∆∞·ª£ng: ${formatNumber(Math.round(nextQtrQtyForecast))}`;
            if (nextQtrTargets.length > 0) {
                const avgTarget = nextQtrTargets.reduce((a, b) => a + b, 0) / nextQtrTargets.length;
                const achievementPercent = (nextQtrForecast / avgTarget * 100).toFixed(1);
                nextQtrQtyText += ` | Target TB: ${formatCurrency(avgTarget)} (${achievementPercent}%)`;
            }
            document.getElementById('nextQuarterQtyForecast').textContent = nextQtrQtyText;

            // Seasonality trend analysis
            const lastMonthSales = historicalSales[historicalSales.length - 1];
            const nextMonthForecast = forecastSales[0];
            const change = ((nextMonthForecast - lastMonthSales) / lastMonthSales) * 100;
            
            let trendIcon = '‚Üí';
            let trendText = '·ªîn ƒë·ªãnh';
            if (change > 5) {
                trendIcon = 'üìà';
                trendText = 'TƒÉng';
            } else if (change < -5) {
                trendIcon = 'üìâ';
                trendText = 'Gi·∫£m';
            }
            
            document.getElementById('seasonalityTrend').textContent = `${trendIcon} ${trendText}`;
            document.getElementById('seasonalityDetail').textContent = `D·ª± ki·∫øn ${change > 0 ? '+' : ''}${change.toFixed(1)}% so v·ªõi th√°ng hi·ªán t·∫°i`;

            // Calculate detailed forecasts by system, brand, and product
            calculateDetailedForecasts(data, sortedMonths, currentMonthForecastSales, currentMonthForecastQty, nextMonthForecastSales, nextMonthForecastQty, currentQtrAvg, currentQtrQtyAvg, nextQtrForecast, nextQtrQtyForecast);

            // Create chart
            const ctx = document.getElementById('forecastChart');
            if (charts.forecastChart) {
                charts.forecastChart.destroy();
            }

            const allLabels = [...sortedMonths, ...forecastLabels];
            const allSalesData = [...historicalSales, ...Array(forecastMonths).fill(null)];
            // Fix: forecastData should align with forecastLabels - first forecast value should be at the first forecast label position
            // Structure: [null for all historical, forecastSales[0] for first forecast label, forecastSales[1] for second, ...]
            const forecastData = [...Array(sortedMonths.length).fill(null), ...forecastSales];
            
            // Create connection line from last historical month to first forecast month
            const lastHistoricalValue = historicalSales[historicalSales.length - 1];
            const firstForecastValue = forecastSales[0];
            const connectionData = [...Array(sortedMonths.length - 1).fill(null), lastHistoricalValue, firstForecastValue, ...Array(forecastMonths - 1).fill(null)];
            
            // Create target line for forecast months (user-specific)
            const targetDataLine = forecastLabels.map(monthKey => {
                return getUserTarget(monthKey) || null;
            });
            const targetLineData = [...Array(sortedMonths.length).fill(null), ...targetDataLine];

            charts.forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Doanh S·ªë Th·ª±c T·∫ø',
                            data: allSalesData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'D·ª± ƒêo√°n',
                            data: forecastData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: true,
                            tension: 0.4,
                            pointStyle: 'triangle',
                            pointRadius: 6
                        },
                        {
                            label: 'K·∫øt N·ªëi',
                            data: connectionData,
                            borderColor: '#f97316',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        },
                        {
                            label: 'Target',
                            data: targetLineData,
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const monthKey = sortedMonths[index];
                            // Pass current filtered data to drill-down
                            const currentData = currentFilteredData.length > 0 ? currentFilteredData : allData;
                            showMonthDrillDown(monthKey, currentData);
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calculate detailed forecasts by system, brand, and product
        function calculateDetailedForecasts(data, sortedMonths, currentMonthForecastSales, currentMonthForecastQty, nextMonthForecastSales, nextMonthForecastQty, currentQtrAvg, currentQtrQtyAvg, nextQtrForecast, nextQtrQtyForecast) {
            // Data should already be filtered by permissions, but log for debugging
            console.log('üìä calculateDetailedForecasts() called with', data.length, 'rows');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:3630',message:'calculateDetailedForecasts started',data:{dataLength:data.length,hasCurrentUser:!!currentUser,userName:currentUser?.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F2'})}).catch(()=>{});
            // #endregion
            
            // Get recent months data for proportion calculation
            const recentMonthsCount = Math.min(3, sortedMonths.length);
            const recentMonths = sortedMonths.slice(-recentMonthsCount);
            
            // Filter data for recent months (data is already filtered by permissions)
            const recentData = data.filter(row => recentMonths.includes(row.monthKey));
            
            // Calculate proportions by system
            const systemData = {};
            recentData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || 'Unknown';
                if (!systemData[system]) {
                    systemData[system] = { vat: 0, qty: 0 };
                }
                systemData[system].vat += row.vat;
                systemData[system].qty += row.soLuong || 0;
            });
            
            // Calculate proportions by brand
            const brandData = {};
            recentData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'] || 'Unknown';
                if (!brandData[brand]) {
                    brandData[brand] = { vat: 0, qty: 0 };
                }
                brandData[brand].vat += row.vat;
                brandData[brand].qty += row.soLuong || 0;
            });
            
            // Calculate proportions by product
            const productData = {};
            recentData.forEach(row => {
                const product = row['T√äN SP'] || 'Unknown';
                const brand = row['NH√ÉN H√ÄNG'] || 'Unknown';
                if (!productData[product]) {
                    productData[product] = { vat: 0, qty: 0, brand: brand };
                }
                productData[product].vat += row.vat;
                productData[product].qty += row.soLuong || 0;
            });
            
            // Get totals
            const totalRecentSales = Object.values(systemData).reduce((sum, item) => sum + item.vat, 0);
            const totalRecentQty = Object.values(systemData).reduce((sum, item) => sum + item.qty, 0);
            
            // Store detailed forecast data
            forecastDetailsData = {
                currentMonth: {
                    totalSales: currentMonthForecastSales,
                    totalQty: currentMonthForecastQty,
                    systems: {},
                    brands: {},
                    products: {}
                },
                nextMonth: {
                    totalSales: nextMonthForecastSales,
                    totalQty: nextMonthForecastQty,
                    systems: {},
                    brands: {},
                    products: {}
                },
                currentQuarter: {
                    totalSales: currentQtrAvg,
                    totalQty: currentQtrQtyAvg,
                    systems: {},
                    brands: {},
                    products: {}
                },
                nextQuarter: {
                    totalSales: nextQtrForecast,
                    totalQty: nextQtrQtyForecast,
                    systems: {},
                    brands: {},
                    products: {}
                }
            };
            
            // Calculate forecast for each entity using proportions
            ['currentMonth', 'nextMonth', 'currentQuarter', 'nextQuarter'].forEach(period => {
                const forecastSales = forecastDetailsData[period].totalSales;
                const forecastQty = forecastDetailsData[period].totalQty;
                
                // By system
                Object.keys(systemData).forEach(system => {
                    const proportion = systemData[system].vat / totalRecentSales;
                    const qtyProportion = systemData[system].qty / totalRecentQty;
                    forecastDetailsData[period].systems[system] = {
                        sales: forecastSales * proportion,
                        qty: forecastQty * qtyProportion
                    };
                });
                
                // By brand
                Object.keys(brandData).forEach(brand => {
                    const proportion = brandData[brand].vat / totalRecentSales;
                    const qtyProportion = brandData[brand].qty / totalRecentQty;
                    forecastDetailsData[period].brands[brand] = {
                        sales: forecastSales * proportion,
                        qty: forecastQty * qtyProportion
                    };
                });
                
                // By product
                Object.keys(productData).forEach(product => {
                    const proportion = productData[product].vat / totalRecentSales;
                    const qtyProportion = productData[product].qty / totalRecentQty;
                    forecastDetailsData[period].products[product] = {
                        sales: forecastSales * proportion,
                        qty: forecastQty * qtyProportion,
                        brand: productData[product].brand
                    };
                });
            });
        }

        // Apply manual adjustments from stockout and new products
        function applyManualAdjustments(periodType) {
            // Clone the original forecast data
            const detail = JSON.parse(JSON.stringify(forecastDetailsData[periodType]));
            
            // Initialize adjustment tracking
            detail.adjustments = {
                systems: {},
                brands: {},
                products: {}
            };
            
            // Only apply adjustments for currentMonth
            if (periodType !== 'currentMonth' || !manualStockoutProducts || manualStockoutProducts.length === 0) {
                return detail;
            }
            
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const surgeFactor = 1.25;
            
            // Helper function: Count working days (Mon-Sat, exclude Sunday) between two dates
            function countWorkingDays(startDay, endDay, year, month) {
                let workingDays = 0;
                for (let day = startDay; day <= endDay; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                    if (dayOfWeek !== 0) { // Exclude Sunday
                        workingDays++;
                    }
                }
                return workingDays;
            }
            
            // Count total working days in month (for proper proportion calculation)
            const totalWorkingDaysInMonth = countWorkingDays(1, daysInMonth, today.getFullYear(), today.getMonth());
            
            console.log(`üìÖ Working days calculation: ${totalWorkingDaysInMonth} working days in month`);
            console.log(`üìã Processing ${manualStockoutProducts.length} manual products`);
            
            // Process each manual product
            manualStockoutProducts.forEach(prod => {
                console.log(`üîç Processing product: ${prod.name}, isNew: ${prod.isNew}`);
                
                if (prod.isNew) {
                    // New products: only count working days after launch
                    console.log(`üÜï New product: ${prod.name}`);
                    console.log(`üí∞ Input avgMonthlySales: ${prod.avgMonthlySales.toLocaleString()} VND`);
                    console.log(`üì¶ Input avgMonthlyQty: ${prod.avgMonthlyQty.toLocaleString()} units`);
                    console.log(`üè™ Selected systems: ${prod.systems.map(s => s.name).join(', ')}`);
                    console.log(`üìä Total stores: ${prod.totalStores}`);
                    
                    const workingDaysAfterLaunch = countWorkingDays(prod.restockDay, daysInMonth, today.getFullYear(), today.getMonth());
                    const adjustedSales = (prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysAfterLaunch;
                    const adjustedQty = (prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysAfterLaunch;
                    
                    console.log(`üóìÔ∏è Working days after launch (${prod.restockDay}/1): ${workingDaysAfterLaunch} days`);
                    console.log(`üìà Calculated adjustment: ${adjustedSales.toLocaleString()} VND`);
                    
                    // Add to total
                    detail.totalSales += adjustedSales;
                    detail.totalQty += adjustedQty;
                    
                    // For new products, add to selected systems
                    prod.systems.forEach(sys => {
                        if (!detail.systems[sys.name]) {
                            detail.systems[sys.name] = { sales: 0, qty: 0 };
                        }
                        // Distribute proportionally to stores
                        const systemShare = adjustedSales * (sys.storeCount / prod.totalStores);
                        const systemQtyShare = adjustedQty * (sys.storeCount / prod.totalStores);
                        detail.systems[sys.name].sales += systemShare;
                        detail.systems[sys.name].qty += systemQtyShare;
                        
                        // Track adjustment
                        if (!detail.adjustments.systems[sys.name]) {
                            detail.adjustments.systems[sys.name] = { sales: 0, qty: 0 };
                        }
                        detail.adjustments.systems[sys.name].sales += systemShare;
                        detail.adjustments.systems[sys.name].qty += systemQtyShare;
                    });
                    
                    // Add to brand
                    if (!detail.brands[prod.brand]) {
                        detail.brands[prod.brand] = { sales: 0, qty: 0 };
                    }
                    detail.brands[prod.brand].sales += adjustedSales;
                    detail.brands[prod.brand].qty += adjustedQty;
                    
                    // Track brand adjustment
                    if (!detail.adjustments.brands[prod.brand]) {
                        detail.adjustments.brands[prod.brand] = { sales: 0, qty: 0 };
                    }
                    detail.adjustments.brands[prod.brand].sales += adjustedSales;
                    detail.adjustments.brands[prod.brand].qty += adjustedQty;
                    
                    // Add to product
                    if (!detail.products[prod.name]) {
                        detail.products[prod.name] = { sales: 0, qty: 0, brand: prod.brand };
                    }
                    detail.products[prod.name].sales += adjustedSales;
                    detail.products[prod.name].qty += adjustedQty;
                    
                    // Track product adjustment
                    if (!detail.adjustments.products[prod.name]) {
                        detail.adjustments.products[prod.name] = { sales: 0, qty: 0 };
                    }
                    detail.adjustments.products[prod.name].sales += adjustedSales;
                    detail.adjustments.products[prod.name].qty += adjustedQty;
                } else {
                    // For STOCKOUT products: Calculate net adjustment (working days only)
                    console.log(`üíî Stockout product: ${prod.name}`);
                    console.log(`üìä Product avgMonthlySales (TOTAL): ${prod.avgMonthlySales.toLocaleString()} VND`);
                    
                    // Use outOfStockDay if available, otherwise use currentDay
                    const stockoutStartDay = prod.outOfStockDay || currentDay;
                    console.log(`üóìÔ∏è outOfStockDay: ${stockoutStartDay}, restockDay: ${prod.restockDay}, currentDay: ${currentDay}`);
                    
                    // 1. Lost sales during stockout (t·ª´ ng√†y h·∫øt h√†ng ‚Üí ng√†y v·ªÅ h√†ng, ch·ªâ t√≠nh ng√†y l√†m vi·ªác)
                    const workingDaysLost = countWorkingDays(stockoutStartDay, prod.restockDay - 1, today.getFullYear(), today.getMonth());
                    const lostSales = -(prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysLost;
                    const lostQty = -(prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysLost;
                    
                    console.log(`üìâ Lost: ${workingDaysLost} working days (from day ${stockoutStartDay} to ${prod.restockDay - 1}) = ${lostSales.toLocaleString()} VND`);
                    
                    // 2. Surge sales after restock (t·ª´ ng√†y v·ªÅ h√†ng ‚Üí cu·ªëi th√°ng, ch·ªâ t√≠nh ng√†y l√†m vi·ªác)
                    const workingDaysAfterRestock = countWorkingDays(prod.restockDay, daysInMonth, today.getFullYear(), today.getMonth());
                    const surgeSales = (prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysAfterRestock * surgeFactor;
                    const surgeQty = (prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysAfterRestock * surgeFactor;
                    
                    // 3. Normal sales for the remaining period (baseline, ch·ªâ t√≠nh ng√†y l√†m vi·ªác)
                    const normalSalesForPeriod = (prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysAfterRestock;
                    const normalQtyForPeriod = (prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysAfterRestock;
                    
                    // 4. Net adjustment = Lost + (Surge - Normal)
                    // This represents: -lost during stockout + extra surge after restock
                    const adjustedSales = lostSales + (surgeSales - normalSalesForPeriod);
                    const adjustedQty = lostQty + (surgeQty - normalQtyForPeriod);
                    
                    console.log(`üìä Net adjustment: ${adjustedSales.toLocaleString()} VND (${adjustedSales < 0 ? 'LOSS' : 'GAIN'})`);
                    console.log(`üí° This adjustment will be DISTRIBUTED across systems based on actual sales data`);
                    
                    // Add to total
                    detail.totalSales += adjustedSales;
                    detail.totalQty += adjustedQty;
                    
                    // Find the product in existing forecast
                    console.log(`üîç Looking for product "${prod.name}" in forecast...`);
                    console.log(`üìã Available products:`, Object.keys(detail.products).slice(0, 5));
                    
                    if (detail.products[prod.name]) {
                        console.log(`‚úÖ Found product in forecast, applying adjustment...`);
                        detail.products[prod.name].sales += adjustedSales;
                        detail.products[prod.name].qty += adjustedQty;
                        
                        // Track product adjustment
                        if (!detail.adjustments.products[prod.name]) {
                            detail.adjustments.products[prod.name] = { sales: 0, qty: 0 };
                        }
                        detail.adjustments.products[prod.name].sales += adjustedSales;
                        detail.adjustments.products[prod.name].qty += adjustedQty;
                        
                        // Add to brand
                        const brand = detail.products[prod.name].brand;
                        if (detail.brands[brand]) {
                            detail.brands[brand].sales += adjustedSales;
                            detail.brands[brand].qty += adjustedQty;
                            
                            // Track brand adjustment
                            if (!detail.adjustments.brands[brand]) {
                                detail.adjustments.brands[brand] = { sales: 0, qty: 0 };
                            }
                            detail.adjustments.brands[brand].sales += adjustedSales;
                            detail.adjustments.brands[brand].qty += adjustedQty;
                        }
                        
                        // Distribute to systems based on product's current distribution
                        // Calculate product's system distribution from recent data
                        const productSystemDistribution = {};
                        let productTotalInSystems = 0;
                        
                        // Get recent months for distribution (use filtered data for sales users)
                        const dataForDistribution = currentFilteredData.length > 0 ? currentFilteredData : allData;
                        const sortedMonths = [...new Set(dataForDistribution.map(d => d.monthKey))].sort();
                        const recentMonths = sortedMonths.slice(-3);
                        
                        dataForDistribution.forEach(row => {
                            if (recentMonths.includes(row.monthKey) && 
                                shortenProductName(row['T√äN SP']) === prod.name) {
                                const system = row['H·ªÜ TH·ªêNG'];
                                if (system) {
                                    if (!productSystemDistribution[system]) {
                                        productSystemDistribution[system] = 0;
                                    }
                                    productSystemDistribution[system] += row.vat || 0;
                                    productTotalInSystems += row.vat || 0;
                                }
                            }
                        });
                        
                        console.log(`üìä System distribution for ${prod.name}:`, productSystemDistribution);
                        console.log(`üí∞ Total in systems: ${productTotalInSystems}`);
                        
                        // Fallback: if no recent data, use current forecast's system distribution
                        if (productTotalInSystems === 0) {
                            console.warn(`No recent system distribution for ${prod.name}, using forecast proportions`);
                            Object.entries(detail.systems).forEach(([system, sysData]) => {
                                productSystemDistribution[system] = sysData.sales;
                                productTotalInSystems += sysData.sales;
                            });
                        }
                        
                        // Distribute adjustment to systems proportionally
                        if (productTotalInSystems > 0) {
                            Object.entries(productSystemDistribution).forEach(([system, systemSales]) => {
                                const systemProportion = systemSales / productTotalInSystems;
                                const systemAdjustment = adjustedSales * systemProportion;
                                const systemQtyAdjustment = adjustedQty * systemProportion;
                                
                                if (detail.systems[system]) {
                                    detail.systems[system].sales += systemAdjustment;
                                    detail.systems[system].qty += systemQtyAdjustment;
                                    
                                    // Track system adjustment
                                    if (!detail.adjustments.systems[system]) {
                                        detail.adjustments.systems[system] = { sales: 0, qty: 0 };
                                    }
                                    detail.adjustments.systems[system].sales += systemAdjustment;
                                    detail.adjustments.systems[system].qty += systemQtyAdjustment;
                                }
                            });
                        } else {
                            console.error(`Cannot distribute adjustment for ${prod.name}: no system data found`);
                        }
                    } else {
                        console.warn(`‚ùå Product "${prod.name}" not found in forecast. Creating new entry...`);
                        // Create new product entry if not exists
                        detail.products[prod.name] = {
                            sales: adjustedSales,
                            qty: adjustedQty,
                            brand: prod.brand
                        };
                        
                        // Track product adjustment
                        detail.adjustments.products[prod.name] = {
                            sales: adjustedSales,
                            qty: adjustedQty
                        };
                        
                        // Add to brand
                        if (!detail.brands[prod.brand]) {
                            detail.brands[prod.brand] = { sales: 0, qty: 0 };
                        }
                        detail.brands[prod.brand].sales += adjustedSales;
                        detail.brands[prod.brand].qty += adjustedQty;
                        
                        // Track brand adjustment
                        if (!detail.adjustments.brands[prod.brand]) {
                            detail.adjustments.brands[prod.brand] = { sales: 0, qty: 0 };
                        }
                        detail.adjustments.brands[prod.brand].sales += adjustedSales;
                        detail.adjustments.brands[prod.brand].qty += adjustedQty;
                        
                        // Distribute to all systems proportionally (since product not in forecast)
                        const totalSystemSales = Object.values(detail.systems).reduce((sum, sys) => sum + sys.sales, 0);
                        if (totalSystemSales > 0) {
                            Object.entries(detail.systems).forEach(([system, sysData]) => {
                                const proportion = sysData.sales / totalSystemSales;
                                const systemAdjustment = adjustedSales * proportion;
                                const systemQtyAdjustment = adjustedQty * proportion;
                                
                                detail.systems[system].sales += systemAdjustment;
                                detail.systems[system].qty += systemQtyAdjustment;
                                
                                if (!detail.adjustments.systems[system]) {
                                    detail.adjustments.systems[system] = { sales: 0, qty: 0 };
                                }
                                detail.adjustments.systems[system].sales += systemAdjustment;
                                detail.adjustments.systems[system].qty += systemQtyAdjustment;
                            });
                        }
                    }
                }
            });
            
            return detail;
        }
        
        // Clear all stockout products
        function clearAllStockoutProducts() {
            if (manualStockoutProducts.length === 0) {
                alert('Danh s√°ch ƒë√£ tr·ªëng');
                return;
            }
            
            if (confirm(`X√≥a t·∫•t c·∫£ ${manualStockoutProducts.length} s·∫£n ph·∫©m trong danh s√°ch?`)) {
                manualStockoutProducts = [];
                
                // Re-render the list
                const today = new Date();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                renderStockoutProductsList(today.getDate(), daysInMonth);
                
                // Refresh modal if open
                refreshForecastModalIfOpen();
            }
        }

        // Show forecast detail modal
        function showForecastDetail(type) {
            if (!forecastDetailsData || !forecastDetailsData[type]) {
                alert('D·ªØ li·ªáu d·ª± ƒëo√°n ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i!');
                return;
            }
            
            // Store current type for refresh
            currentForecastType = type;
            
            // Apply manual adjustments (stockout and new products)
            const detail = applyManualAdjustments(type);
            
            // Set title based on type
            const titles = {
                'currentMonth': 'üî• Chi Ti·∫øt D·ª± ƒêo√°n Th√°ng N√†y (Th√°ng 1/2026)',
                'nextMonth': 'üìÖ Chi Ti·∫øt D·ª± ƒêo√°n Th√°ng Ti·∫øp Theo',
                'currentQuarter': 'üìä Chi Ti·∫øt TB Th√°ng Qu√Ω N√†y (3 th√°ng)',
                'nextQuarter': 'üéØ Chi Ti·∫øt TB Th√°ng Qu√Ω T·ªõi (d·ª± ƒëo√°n)'
            };
            document.getElementById('forecastModalTitle').textContent = titles[type];
            
            // Update summary
            document.getElementById('forecastTotalSales').textContent = formatCurrency(detail.totalSales);
            document.getElementById('forecastTotalQty').textContent = formatNumber(Math.round(detail.totalQty));
            
            // Get user-specific target for this forecast period
            // Calculate forecast month labels based on current date and forecast type
            let forecastTarget = 0;
            let forecastTargetPercent = '-';
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1; // 1-12
            
            if (type === 'currentMonth') {
                // Current month forecast is next month (first forecast month)
                const forecastDate = new Date(currentYear, currentMonth, 1); // Next month
                const currentMonthLabel = `${forecastDate.getFullYear()}-${String(forecastDate.getMonth() + 1).padStart(2, '0')}`;
                forecastTarget = getUserTarget(currentMonthLabel);
                if (forecastTarget > 0) {
                    forecastTargetPercent = ((detail.totalSales / forecastTarget) * 100).toFixed(1);
                }
            } else if (type === 'nextMonth') {
                // Next month forecast is second forecast month
                const forecastDate = new Date(currentYear, currentMonth + 1, 1); // Month after next
                const nextMonthLabel = `${forecastDate.getFullYear()}-${String(forecastDate.getMonth() + 1).padStart(2, '0')}`;
                forecastTarget = getUserTarget(nextMonthLabel);
                if (forecastTarget > 0) {
                    forecastTargetPercent = ((detail.totalSales / forecastTarget) * 100).toFixed(1);
                }
            } else if (type === 'nextQuarter') {
                // Average target for next quarter forecast months (next 3 months)
                const nextQtrTargets = [];
                for (let i = 1; i <= 3; i++) {
                    const forecastDate = new Date(currentYear, currentMonth + i - 1, 1);
                    const monthKey = `${forecastDate.getFullYear()}-${String(forecastDate.getMonth() + 1).padStart(2, '0')}`;
                    const target = getUserTarget(monthKey);
                    if (target > 0) {
                        nextQtrTargets.push(target);
                    }
                }
                if (nextQtrTargets.length > 0) {
                    forecastTarget = nextQtrTargets.reduce((a, b) => a + b, 0) / nextQtrTargets.length;
                    if (forecastTarget > 0) {
                        forecastTargetPercent = ((detail.totalSales / forecastTarget) * 100).toFixed(1);
                    }
                }
            }
            
            // Update target display if element exists
            const forecastTargetElement = document.getElementById('forecastTarget');
            if (forecastTargetElement) {
                if (forecastTarget > 0) {
                    const targetColor = parseFloat(forecastTargetPercent) >= 100 ? '#10b981' : parseFloat(forecastTargetPercent) >= 80 ? '#f59e0b' : '#ef4444';
                    forecastTargetElement.innerHTML = `
                        <div style="margin-top: 10px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid ${targetColor};">
                            <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">üéØ Target (${currentUser?.name || 'User'}):</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: ${targetColor};">
                                ${formatCurrency(forecastTarget)} 
                                <span style="font-size: 0.9em; margin-left: 10px;">(${forecastTargetPercent}%)</span>
                            </div>
                        </div>
                    `;
                    forecastTargetElement.style.display = 'block';
                } else {
                    forecastTargetElement.style.display = 'none';
                }
            }
            
            // Calculate total adjustment
            let totalAdjustment = 0;
            if (detail.adjustments) {
                Object.values(detail.adjustments.products).forEach(adj => {
                    totalAdjustment += adj.sales;
                });
            }
            
            // Show/hide adjustment
            const adjustmentDiv = document.getElementById('stockoutAdjustment');
            const adjustmentValueDiv = document.getElementById('stockoutAdjustmentValue');
            if (Math.abs(totalAdjustment) > 1000) {
                adjustmentDiv.style.display = 'block';
                const color = totalAdjustment > 0 ? '#10b981' : '#ef4444';
                const sign = totalAdjustment > 0 ? '+' : '';
                adjustmentValueDiv.style.color = color;
                adjustmentValueDiv.textContent = `${sign}${formatCurrency(totalAdjustment)}`;
            } else {
                adjustmentDiv.style.display = 'none';
            }
            
            // Populate system table
            const systemTableBody = document.getElementById('forecastSystemTableBody');
            systemTableBody.innerHTML = '';
            const sortedSystems = Object.entries(detail.systems).sort((a, b) => b[1].sales - a[1].sales);
            sortedSystems.forEach(([system, data], idx) => {
                const percentage = (data.sales / detail.totalSales * 100).toFixed(1);
                const adjustment = detail.adjustments?.systems?.[system]?.sales || 0;
                console.log(`üè¢ System ${system}: adjustment = ${adjustment}`);
                const adjustmentDisplay = adjustment > 0 ? 
                    `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(adjustment)}</span>` : 
                    adjustment < 0 ?
                    `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(adjustment)}</span>` :
                    '<span style="color: #9ca3af;">-</span>';
                const row = `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${system}</td>
                        <td class="number">${formatNumber(Math.round(data.qty))}</td>
                        <td class="number">${formatCurrency(data.sales)}</td>
                        <td class="number" style="background: #fffbeb;">${adjustmentDisplay}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
                systemTableBody.innerHTML += row;
            });
            
            // Add TOTAL row for system table
            const totalSystemQty = Object.values(detail.systems).reduce((sum, data) => sum + data.qty, 0);
            const totalSystemSales = Object.values(detail.systems).reduce((sum, data) => sum + data.sales, 0);
            const totalSystemAdjustment = Object.values(detail.adjustments?.systems || {}).reduce((sum, adj) => sum + (adj?.sales || 0), 0);
            const totalAdjustmentDisplay = totalSystemAdjustment > 0 ? 
                `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(totalSystemAdjustment)}</span>` : 
                totalSystemAdjustment < 0 ?
                `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(totalSystemAdjustment)}</span>` :
                '<span style="color: #9ca3af;">-</span>';
            
            const totalRow = `
                <tr style="border-top: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600;">
                    <td style="text-align: center;">üìä</td>
                    <td style="color: #1f2937;"><strong>TOTAL</strong></td>
                    <td class="number" style="color: #1f2937;">${formatNumber(Math.round(totalSystemQty))}</td>
                    <td class="number" style="color: #1f2937;">${formatCurrency(totalSystemSales)}</td>
                    <td class="number" style="background: #fef3c7; color: #1f2937;">${totalAdjustmentDisplay}</td>
                    <td class="number" style="color: #1f2937;">100.0%</td>
                </tr>
            `;
            systemTableBody.innerHTML += totalRow;
            
            // Populate brand table (top 20)
            const brandTableBody = document.getElementById('forecastBrandTableBody');
            brandTableBody.innerHTML = '';
            const sortedBrands = Object.entries(detail.brands).sort((a, b) => b[1].sales - a[1].sales).slice(0, 20);
            sortedBrands.forEach(([brand, data], idx) => {
                const percentage = (data.sales / detail.totalSales * 100).toFixed(1);
                const adjustment = detail.adjustments?.brands?.[brand]?.sales || 0;
                const adjustmentDisplay = adjustment > 0 ? 
                    `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(adjustment)}</span>` : 
                    adjustment < 0 ?
                    `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(adjustment)}</span>` :
                    '<span style="color: #9ca3af;">-</span>';
                const row = `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${brand}</td>
                        <td class="number">${formatNumber(Math.round(data.qty))}</td>
                        <td class="number">${formatCurrency(data.sales)}</td>
                        <td class="number" style="background: #fffbeb;">${adjustmentDisplay}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
                brandTableBody.innerHTML += row;
            });
            
            // Populate product table (top 50)
            const productTableBody = document.getElementById('forecastProductTableBody');
            productTableBody.innerHTML = '';
            const sortedProducts = Object.entries(detail.products).sort((a, b) => b[1].sales - a[1].sales).slice(0, 50);
            sortedProducts.forEach(([product, data], idx) => {
                const percentage = (data.sales / detail.totalSales * 100).toFixed(1);
                const adjustment = detail.adjustments?.products?.[product]?.sales || 0;
                const adjustmentDisplay = adjustment > 0 ? 
                    `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(adjustment)}</span>` : 
                    adjustment < 0 ?
                    `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(adjustment)}</span>` :
                    '<span style="color: #9ca3af;">-</span>';
                // Force apply shortened name
                const displayName = shortenProductName(product);
                const row = `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${displayName}</td>
                        <td>${data.brand}</td>
                        <td class="number">${formatNumber(Math.round(data.qty))}</td>
                        <td class="number">${formatCurrency(data.sales)}</td>
                        <td class="number" style="background: #fffbeb;">${adjustmentDisplay}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
                productTableBody.innerHTML += row;
            });
            
            // Add TOTAL row for product table
            const totalProductQty = Object.values(detail.products).reduce((sum, data) => sum + data.qty, 0);
            const totalProductSales = Object.values(detail.products).reduce((sum, data) => sum + data.sales, 0);
            const totalProductAdjustment = Object.values(detail.adjustments?.products || {}).reduce((sum, adj) => sum + (adj?.sales || 0), 0);
            const totalProductAdjustmentDisplay = totalProductAdjustment > 0 ? 
                `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(totalProductAdjustment)}</span>` : 
                totalProductAdjustment < 0 ?
                `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(totalProductAdjustment)}</span>` :
                '<span style="color: #9ca3af;">-</span>';
            
            const totalProductRow = `
                <tr style="border-top: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600;">
                    <td style="text-align: center;">üìä</td>
                    <td style="color: #1f2937;"><strong>TOTAL</strong></td>
                    <td style="color: #1f2937;"><strong>ALL BRANDS</strong></td>
                    <td class="number" style="color: #1f2937;">${formatNumber(Math.round(totalProductQty))}</td>
                    <td class="number" style="color: #1f2937;">${formatCurrency(totalProductSales)}</td>
                    <td class="number" style="background: #fef3c7; color: #1f2937;">${totalProductAdjustmentDisplay}</td>
                    <td class="number" style="color: #1f2937;">100.0%</td>
                </tr>
            `;
            productTableBody.innerHTML += totalProductRow;
            
            // Show modal
            document.getElementById('forecastDetailModal').style.display = 'block';
        }

        // Close forecast detail modal
        function closeForecastDetail() {
            document.getElementById('forecastDetailModal').style.display = 'none';
            // Reset stockout analysis
            document.getElementById('stockoutAnalysisSection').style.display = 'none';
            document.getElementById('stockoutAdjustment').style.display = 'none';
            manualStockoutProducts = []; // Clear the list
            currentForecastType = null; // Clear current type
        }

        // Global variable for stockout products list
        let manualStockoutProducts = [];
        let availableProducts = [];

        // Analyze stockouts (product gaps) - MANUAL SELECTION
        function analyzeStockouts() {
            // Use filtered data for sales users (only their stores)
            const dataToUse = currentFilteredData.length > 0 ? currentFilteredData : allData;
            console.log('üîç analyzeStockouts() using', dataToUse.length, 'rows (filtered for sales users)');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4321',message:'analyzeStockouts started',data:{dataLength:dataToUse.length,usingFilteredData:currentFilteredData.length>0,hasCurrentUser:!!currentUser},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F4'})}).catch(()=>{});
            // #endregion
            
            if (!dataToUse || dataToUse.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch');
                return;
            }
            
            // Get current month info
            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            const sortedMonths = [...new Set(dataToUse.map(d => d.monthKey))].sort();
            const recentMonths = sortedMonths.slice(-6, -1); // Last 5 months
            
            // Get all available products with their average sales (from filtered data)
            const productData = {};
            
            dataToUse.forEach(row => {
                const product = row['T√äN SP'];
                const month = row.monthKey;
                
                if (!product || !recentMonths.includes(month)) return;
                
                const shortName = shortenProductName(product);
                
                if (!productData[shortName]) {
                    productData[shortName] = {
                        name: shortName,
                        fullName: product,
                        brand: row['NH√ÉN H√ÄNG'],
                        system: row['H·ªÜ TH·ªêNG'],
                        monthsWithSales: new Set(),
                        totalSales: 0,
                        totalQty: 0
                    };
                }
                
                productData[shortName].monthsWithSales.add(month);
                productData[shortName].totalSales += row.vat || 0;
                productData[shortName].totalQty += row.soLuong || 0;
            });
            
            // Calculate averages and prepare product list
            availableProducts = Object.values(productData).map(prod => {
                const monthsCount = prod.monthsWithSales.size;
                const avgMonthlySales = prod.totalSales / monthsCount;
                const avgMonthlyQty = prod.totalQty / monthsCount;
                
                // For stockout products, we'll use the TOTAL sales (distributed across systems)
                // The distribution will be calculated later based on actual system sales data
                return {
                    name: prod.name,
                    fullName: prod.fullName,
                    brand: prod.brand,
                    system: prod.system,
                    avgMonthlySales: avgMonthlySales, // Total monthly sales across all systems
                    avgMonthlyQty: avgMonthlyQty,     // Total monthly qty across all systems
                    systemData: null // Will be populated when needed
                };
            }).filter(p => p.avgMonthlySales > 500000) // Min 500K VND total
            .sort((a, b) => b.avgMonthlySales - a.avgMonthlySales);
            
            // Display manual input form
            displayStockoutForm(currentDay, daysInMonth, currentMonthKey);
        }
        
        // Display form to manually add stockout products
        function displayStockoutForm(currentDay, daysInMonth, currentMonthKey) {
            const content = document.getElementById('stockoutContent');
            const today = new Date();
            const minDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
            const maxDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            content.innerHTML = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0 0 10px 0; color: #1e40af;"><strong>üìù Th√™m S·∫£n Ph·∫©m ƒê·ª©t H√†ng Th·ªß C√¥ng</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #1e3a8a;">
                        Ch·ªçn m√£ s·∫£n ph·∫©m v√† ng√†y d·ª± ki·∫øn v·ªÅ h√†ng ƒë·ªÉ h·ªá th·ªëng t√≠nh to√°n l·∫°i d·ª± ƒëo√°n doanh s·ªë th√°ng n√†y.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ch·ªçn S·∫£n Ph·∫©m</label>
                            <select id="stockoutProductSelect" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                                <option value="">-- Ch·ªçn m√£ s·∫£n ph·∫©m --</option>
                                ${availableProducts.map(p => 
                                    `<option value="${p.name}" data-brand="${p.brand}" data-sales="${p.avgMonthlySales}" data-qty="${p.avgMonthlyQty}">
                                        ${p.name} - ${p.brand} (TB: ${formatCurrency(p.avgMonthlySales)}/th√°ng)
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ng√†y H·∫øt H√†ng</label>
                            <input type="date" id="stockoutOutOfStockDate" 
                                   min="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01" 
                                   max="${maxDate}" 
                                   value="${minDate}"
                                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ng√†y V·ªÅ H√†ng</label>
                            <input type="date" id="stockoutRestockDate" 
                                   min="${minDate}" 
                                   max="${maxDate}" 
                                   value="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-20"
                                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div>
                            <button onclick="addStockoutProduct()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                ‚ûï Th√™m
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0 0 10px 0; color: #92400e;"><strong>üÜï Th√™m M√£ H√†ng M·ªõi</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #78350f;">
                        D·ª± ƒëo√°n doanh s·ªë n·∫øu v·ªÅ th√™m m√£ h√†ng m·ªõi cho c√°c h·ªá th·ªëng.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">T√™n S·∫£n Ph·∫©m M·ªõi</label>
                                <input type="text" id="newProductName" placeholder="Nh·∫≠p t√™n m√£ h√†ng m·ªõi..." 
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Nh√£n H√†ng</label>
                                <input type="text" id="newProductBrand" placeholder="Nh·∫≠p nh√£n h√†ng..." 
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">SL TB/C·ª≠a H√†ng</label>
                                <input type="number" id="newProductAvgQty" placeholder="S·ªë l∆∞·ª£ng..." value="10" min="1"
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Gi√° B√°n (VND)</label>
                                <input type="number" id="newProductPrice" placeholder="Gi√°..." value="50000" min="0"
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ng√†y Ra M·∫Øt</label>
                                <input type="date" id="newProductLaunchDate" 
                                       min="${minDate}" 
                                       max="${maxDate}" 
                                       value="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-15"
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Ch·ªçn H·ªá Th·ªëng B√°n H√†ng</label>
                            <div id="systemCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="addNewProduct()" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1em;">
                                ‚ûï Th√™m M√£ M·ªõi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="stockoutProductsList"></div>
            `;
            
            // Populate system checkboxes
            populateSystemCheckboxes();
            
            // Show section
            document.getElementById('stockoutAnalysisSection').style.display = 'block';
            
            // Render existing products if any
            renderStockoutProductsList(currentDay, daysInMonth);
        }
        
        // Populate system checkboxes with store counts
        function populateSystemCheckboxes() {
            const container = document.getElementById('systemCheckboxes');
            
            if (!allData || allData.length === 0) {
                container.innerHTML = '<p style="color: #ef4444; padding: 10px;">‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc.</p>';
                return;
            }
            
            // Get unique systems and their store counts from the most recent month
            const systemStores = {};
            const sortedMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            const recentMonth = sortedMonths[sortedMonths.length - 1];
            
            allData.forEach(row => {
                // Only use recent month data for accurate store counts
                if (row.monthKey !== recentMonth) return;
                
                const system = row['H·ªÜ TH·ªêNG'];
                const store = row['C·ª¨A H√ÄNG']; // FIX: Use 'C·ª¨A H√ÄNG' column name
                
                if (!system || !store) return;
                
                if (!systemStores[system]) {
                    systemStores[system] = new Set();
                }
                systemStores[system].add(store);
            });
            
            // Check if we got any systems
            if (Object.keys(systemStores).length === 0) {
                container.innerHTML = '<p style="color: #ef4444; padding: 10px;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h·ªá th·ªëng n√†o trong d·ªØ li·ªáu.</p>';
                console.error('No systems found. Sample data:', allData[0]);
                return;
            }
            
            // Sort by store count
            const sortedSystems = Object.entries(systemStores)
                .map(([system, stores]) => ({ system, storeCount: stores.size }))
                .sort((a, b) => b.storeCount - a.storeCount);
            
            // Render checkboxes
            container.innerHTML = sortedSystems.map(({ system, storeCount }) => `
                <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 4px; cursor: pointer; border: 1px solid #e5e7eb; transition: background 0.2s;" 
                       onmouseover="this.style.background='#f3f4f6'" 
                       onmouseout="this.style.background='white'">
                    <input type="checkbox" value="${system}" data-stores="${storeCount}" 
                           style="margin-right: 8px; cursor: pointer; width: 18px; height: 18px;">
                    <span style="flex: 1; font-size: 0.9em;">
                        <strong>${system}</strong>
                        <span style="color: #6b7280; font-size: 0.85em; margin-left: 5px;">(${storeCount} CH)</span>
                    </span>
                </label>
            `).join('');
            
            console.log('Populated', sortedSystems.length, 'systems with checkboxes');
        }
        
        // Add new product to forecast
        function addNewProduct() {
            const nameInput = document.getElementById('newProductName');
            const brandInput = document.getElementById('newProductBrand');
            const avgQtyInput = document.getElementById('newProductAvgQty');
            const priceInput = document.getElementById('newProductPrice');
            const launchDateInput = document.getElementById('newProductLaunchDate');
            const checkboxes = document.querySelectorAll('#systemCheckboxes input[type="checkbox"]:checked');
            
            // Validation
            if (!nameInput.value.trim()) {
                alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
                return;
            }
            
            if (!brandInput.value.trim()) {
                alert('Vui l√≤ng nh·∫≠p nh√£n h√†ng');
                return;
            }
            
            if (!avgQtyInput.value || avgQtyInput.value <= 0) {
                alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng trung b√¨nh/c·ª≠a h√†ng');
                return;
            }
            
            if (!priceInput.value || priceInput.value <= 0) {
                alert('Vui l√≤ng nh·∫≠p gi√° b√°n');
                return;
            }
            
            if (checkboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ªá th·ªëng');
                return;
            }
            
            if (!launchDateInput.value) {
                alert('Vui l√≤ng ch·ªçn ng√†y ra m·∫Øt');
                return;
            }
            
            // Calculate total stores and forecast
            let totalStores = 0;
            const selectedSystems = [];
            
            checkboxes.forEach(cb => {
                const storeCount = parseInt(cb.getAttribute('data-stores'));
                totalStores += storeCount;
                selectedSystems.push({
                    name: cb.value,
                    storeCount: storeCount
                });
            });
            
            // Calculate based on user input (monthly target)
            const avgQty = parseFloat(avgQtyInput.value);
            const price = parseFloat(priceInput.value);
            const launchDate = new Date(launchDateInput.value);
            
            // User input represents MONTHLY target per store
            // Total monthly quantity = stores √ó monthly avg qty/store
            const totalMonthlyQty = totalStores * avgQty;
            const totalMonthlySales = totalMonthlyQty * price;
            
            console.log(`üÜï New Product Calculation:`);
            console.log(`üìä ${totalStores} stores √ó ${avgQty} pcs/store/month = ${totalMonthlyQty} pcs/month`);
            console.log(`üí∞ ${totalMonthlyQty} pcs √ó ${price.toLocaleString()} VND = ${totalMonthlySales.toLocaleString()} VND/month`);
            
            // This will be the monthly sales target
            const avgMonthlyQty = totalMonthlyQty;
            const avgMonthlySales = totalMonthlySales;
            
            // Check if already added
            if (manualStockoutProducts.find(p => p.name === nameInput.value.trim() && p.isNew)) {
                alert('S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong danh s√°ch');
                return;
            }
            
            // Add to list with special flag for new products
            manualStockoutProducts.push({
                name: nameInput.value.trim(),
                brand: brandInput.value.trim(),
                avgMonthlySales: avgMonthlySales,
                avgMonthlyQty: avgMonthlyQty,
                restockDate: launchDate,
                restockDay: launchDate.getDate(),
                isNew: true,
                systems: selectedSystems,
                totalStores: totalStores,
                avgQtyPerStore: avgQty,
                price: price
            });
            
            // Re-render list
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            renderStockoutProductsList(currentDay, daysInMonth);
            
            // Refresh forecast modal if it's open
            refreshForecastModalIfOpen();
            
            // Reset form
            nameInput.value = '';
            brandInput.value = '';
            avgQtyInput.value = '10';
            priceInput.value = '50000';
            launchDateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-15`;
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Add product to stockout list
        function addStockoutProduct() {
            const select = document.getElementById('stockoutProductSelect');
            const outOfStockDateInput = document.getElementById('stockoutOutOfStockDate');
            const restockDateInput = document.getElementById('stockoutRestockDate');
            
            if (!select.value) {
                alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m');
                return;
            }
            
            if (!outOfStockDateInput.value) {
                alert('Vui l√≤ng ch·ªçn ng√†y h·∫øt h√†ng');
                return;
            }
            
            if (!restockDateInput.value) {
                alert('Vui l√≤ng ch·ªçn ng√†y v·ªÅ h√†ng');
                return;
            }
            
            const productName = select.value;
            const option = select.options[select.selectedIndex];
            const brand = option.getAttribute('data-brand');
            const avgSales = parseFloat(option.getAttribute('data-sales'));
            const avgQty = parseFloat(option.getAttribute('data-qty'));
            const outOfStockDate = new Date(outOfStockDateInput.value);
            const restockDate = new Date(restockDateInput.value);
            
            // Validate dates
            if (restockDate <= outOfStockDate) {
                alert('Ng√†y v·ªÅ h√†ng ph·∫£i sau ng√†y h·∫øt h√†ng');
                return;
            }
            
            // Check if already added
            if (manualStockoutProducts.find(p => p.name === productName)) {
                alert('S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong danh s√°ch');
                return;
            }
            
            // Add to list
            manualStockoutProducts.push({
                name: productName,
                brand: brand,
                avgMonthlySales: avgSales,
                avgMonthlyQty: avgQty,
                outOfStockDate: outOfStockDate,
                outOfStockDay: outOfStockDate.getDate(),
                restockDate: restockDate,
                restockDay: restockDate.getDate()
            });
            
            // Get current day info
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            // Re-render list
            renderStockoutProductsList(currentDay, daysInMonth);
            
            // Refresh forecast modal if it's open
            refreshForecastModalIfOpen();
            
            // Reset form
            select.value = '';
            dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-20`;
        }
        
        // Remove product from stockout list
        function removeStockoutProduct(index) {
            manualStockoutProducts.splice(index, 1);
            
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            renderStockoutProductsList(currentDay, daysInMonth);
            
            // Refresh forecast modal if it's open
            refreshForecastModalIfOpen();
        }
        
        // Refresh forecast modal if currently open
        let currentForecastType = null;
        
        function refreshForecastModalIfOpen() {
            const modal = document.getElementById('forecastDetailModal');
            if (modal && modal.style.display === 'block' && currentForecastType) {
                // Re-render the modal with updated data
                showForecastDetail(currentForecastType);
            }
        }
        
        // Render stockout products list with calculations
        function renderStockoutProductsList(currentDay, daysInMonth) {
            const listDiv = document.getElementById('stockoutProductsList');
            
            if (manualStockoutProducts.length === 0) {
                listDiv.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #9ca3af; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">
                        <p style="margin: 0; font-size: 1.1em;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong danh s√°ch</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em;">Ch·ªçn s·∫£n ph·∫©m v√† ng√†y v·ªÅ h√†ng ·ªü tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    </div>
                `;
                document.getElementById('stockoutAdjustment').style.display = 'none';
                return;
            }
            
            // Calculate for each product
            const surgeFactor = 1.25; // 25% increase
            let totalAdjustedSales = 0;
            let totalAdjustedQty = 0;
            let totalMissedSales = 0;
            
            const productsWithCalc = manualStockoutProducts.map(prod => {
                const remainingDays = Math.max(0, daysInMonth - prod.restockDay + 1);
                const daysPassed = Math.min(currentDay, prod.restockDay);
                
                const missedSales = (prod.avgMonthlySales / daysInMonth) * daysPassed;
                const adjustedSales = (prod.avgMonthlySales / daysInMonth) * remainingDays * surgeFactor;
                const adjustedQty = (prod.avgMonthlyQty / daysInMonth) * remainingDays * surgeFactor;
                
                totalMissedSales += missedSales;
                totalAdjustedSales += adjustedSales;
                totalAdjustedQty += adjustedQty;
                
                return {
                    ...prod,
                    remainingDays,
                    daysPassed,
                    missedSales,
                    adjustedSales,
                    adjustedQty
                };
            });
            
            const today = new Date();
            const currentMonthName = today.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' });
            
            // Separate new products from stockout products
            const stockoutProds = productsWithCalc.filter(p => !p.isNew);
            const newProds = productsWithCalc.filter(p => p.isNew);
            
            listDiv.innerHTML = `
                ${manualStockoutProducts.some(p => !p.isNew) ? `
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0 0 10px 0; color: #92400e;"><strong>‚ö†Ô∏è Danh s√°ch ${stockoutProds.length} s·∫£n ph·∫©m ƒë·ª©t h√†ng ${currentMonthName}</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #78350f;">
                        üìÖ <strong>H√¥m nay:</strong> Ng√†y ${currentDay}/${today.getMonth() + 1}/${today.getFullYear()} 
                        (C√≤n ${daysInMonth - currentDay} ng√†y trong th√°ng)
                    </p>
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; color: #78350f;">
                        üìà <strong>H·ªá s·ªë tƒÉng:</strong> +25% (c·ª≠a h√†ng ƒë·∫∑t d·ªìn ƒë∆°n sau khi h·∫øt h√†ng)
                    </p>
                </div>
                ` : ''}
                
                ${manualStockoutProducts.some(p => p.isNew) ? `
                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                    <p style="margin: 0 0 10px 0; color: #065f46;"><strong>üÜï Danh s√°ch ${newProds.length} m√£ h√†ng m·ªõi d·ª± ki·∫øn ra m·∫Øt</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #047857;">
                        üí° D·ª± ƒëo√°n d·ª±a tr√™n s·ªë l∆∞·ª£ng c·ª≠a h√†ng √ó SL trung b√¨nh/c·ª≠a h√†ng √ó gi√° b√°n
                    </p>
                </div>
                ` : ''}
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">Doanh s·ªë ƒë√£ m·∫•t</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #ef4444;">${formatCurrency(totalMissedSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">D·ª± ƒëo√°n c√≤n l·∫°i (+25%)</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #10b981;">${formatCurrency(totalAdjustedSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">S·ªë l∆∞·ª£ng ∆∞·ªõc t√≠nh</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #3b82f6;">${formatNumber(Math.round(totalAdjustedQty))}</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 400px; overflow: auto;">
                    <table style="width: 100%; background: white; font-size: 0.85em;">
                        <thead style="position: sticky; top: 0; background: white;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">#</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Lo·∫°i</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">S·∫£n Ph·∫©m</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Nh√£n</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">H·ªá Th·ªëng</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">ƒê√£ M·∫•t</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">Ra M·∫Øt/V·ªÅ</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">C√≤n L·∫°i</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">DS D·ª± ƒêo√°n</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">SL D·ª± ƒêo√°n</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">X√≥a</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsWithCalc.map((prod, idx) => {
                                const systemInfo = prod.isNew ? 
                                    prod.systems.map(s => `${s.name} (${s.storeCount})`).join(', ') : 
                                    '-';
                                const typeLabel = prod.isNew ? 
                                    '<span style="background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: 600;">M·ªöI</span>' :
                                    '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: 600;">ƒê·ª®T</span>';
                                    
                                return `
                                <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? '#fafafa' : 'white'};">
                                    <td style="padding: 8px;">${idx + 1}</td>
                                    <td style="padding: 8px;">${typeLabel}</td>
                                    <td style="padding: 8px; font-weight: 600; color: #1f2937;">${prod.name}</td>
                                    <td style="padding: 8px; color: #6b7280;">${prod.brand}</td>
                                    <td style="padding: 8px; font-size: 0.8em; color: #6b7280; max-width: 200px;" title="${systemInfo}">${prod.isNew ? `${prod.totalStores} CH` : '-'}</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444; font-weight: 600;">${prod.missedSales > 0 ? '-' + formatCurrency(prod.missedSales) : '-'}</td>
                                    <td style="padding: 8px; text-align: center; color: #059669;">${prod.restockDay}/${today.getMonth() + 1}</td>
                                    <td style="padding: 8px; text-align: center; color: #6b7280;">${prod.remainingDays}d</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 700; color: #10b981;">${formatCurrency(prod.adjustedSales)}</td>
                                    <td style="padding: 8px; text-align: right; color: #3b82f6;">${formatNumber(Math.round(prod.adjustedQty))}</td>
                                    <td style="padding: 8px; text-align: center;">
                                        <button onclick="removeStockoutProduct(${idx})" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #f0fdf4; border-radius: 8px; font-size: 0.85em; color: #166534;">
                    <strong>üí° Gi·∫£i th√≠ch:</strong> 
                    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                        <li><strong>ƒê·ª©t h√†ng:</strong> D·ª± ƒëo√°n doanh s·ªë ƒë∆∞·ª£c t√≠nh d·ª±a tr√™n trung b√¨nh 5 th√°ng g·∫ßn nh·∫•t, 
                        ƒëi·ªÅu ch·ªânh theo s·ªë ng√†y c√≤n l·∫°i sau khi v·ªÅ h√†ng, v√† tƒÉng th√™m 25% do c·ª≠a h√†ng c√≥ xu h∆∞·ªõng ƒë·∫∑t nhi·ªÅu h∆°n sau khi h·∫øt h√†ng.</li>
                        <li><strong>M√£ m·ªõi:</strong> D·ª± ƒëo√°n = S·ªë c·ª≠a h√†ng √ó SL TB/c·ª≠a h√†ng √ó Gi√° √ó (S·ªë ng√†y c√≤n l·∫°i / T·ªïng ng√†y trong th√°ng)</li>
                    </ul>
                </div>
            `;
            
            // Show adjustment in summary
            document.getElementById('stockoutAdjustment').style.display = 'block';
            document.getElementById('stockoutAdjustmentValue').textContent = '+' + formatCurrency(totalAdjustedSales);
        }

        // Print forecast detail
        function printForecastDetail() {
            // Mark body as printing modal only
            document.body.classList.add('printing-modal');
            
            // Hide buttons and other non-print elements temporarily
            const modal = document.getElementById('forecastDetailModal');
            const buttons = modal.querySelectorAll('button');
            const stockoutBtn = document.getElementById('stockoutAnalysisBtn');
            
            buttons.forEach(btn => btn.style.display = 'none');
            if (stockoutBtn) stockoutBtn.style.display = 'none';
            
            // Expand all table containers to show all content
            const tableContainers = modal.querySelectorAll('.table-container');
            const originalStyles = [];
            
            tableContainers.forEach((container, index) => {
                // Store original styles
                originalStyles[index] = {
                    maxHeight: container.style.maxHeight,
                    overflow: container.style.overflow,
                    height: container.style.height
                };
                
                // Remove height restrictions
                container.style.maxHeight = 'none';
                container.style.overflow = 'visible';
                container.style.height = 'auto';
            });
            
            // Also expand modal body
            const modalBody = modal.querySelector('.forecast-modal-body');
            let originalBodyStyle = null;
            if (modalBody) {
                originalBodyStyle = {
                    maxHeight: modalBody.style.maxHeight,
                    overflow: modalBody.style.overflow
                };
                modalBody.style.maxHeight = 'none';
                modalBody.style.overflow = 'visible';
            }
            
            // Wait a moment for DOM to update, then print
            setTimeout(() => {
                window.print();
                
                // Restore everything
                setTimeout(() => {
                    buttons.forEach(btn => btn.style.display = '');
                    if (stockoutBtn) stockoutBtn.style.display = '';
                    
                    // Restore table container styles
                    tableContainers.forEach((container, index) => {
                        if (originalStyles[index]) {
                            container.style.maxHeight = originalStyles[index].maxHeight;
                            container.style.overflow = originalStyles[index].overflow;
                            container.style.height = originalStyles[index].height;
                        }
                    });
                    
                    // Restore modal body
                    if (modalBody && originalBodyStyle) {
                        modalBody.style.maxHeight = originalBodyStyle.maxHeight;
                        modalBody.style.overflow = originalBodyStyle.overflow;
                    }
                    
                    document.body.classList.remove('printing-modal');
                }, 100);
            }, 50);
        }
        
        // Print dashboard
        function printDashboard() {
            // Add print timestamp
            const now = new Date();
            const timestamp = now.toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Create temporary print info
            const printInfo = document.createElement('div');
            printInfo.id = 'printInfo';
            printInfo.style.cssText = 'display: none; text-align: center; padding: 10px; font-size: 0.9em; color: #666;';
            printInfo.innerHTML = `<p>B√°o c√°o ƒë∆∞·ª£c in ng√†y: ${timestamp}</p>`;
            
            document.body.insertBefore(printInfo, document.body.firstChild);
            
            // Show print info only during print
            const printStyle = document.createElement('style');
            printStyle.id = 'printStyle';
            printStyle.textContent = '@media print { #printInfo { display: block !important; } }';
            document.head.appendChild(printStyle);
            
            // Print
            window.print();
            
            // Clean up
            setTimeout(() => {
                printInfo.remove();
                printStyle.remove();
            }, 100);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('forecastDetailModal');
            if (event.target === modal) {
                closeForecastDetail();
            }
        }

        // Create Sales Trend Chart
        function createSalesTrendChart(data) {
            const monthlyData = {};
            data.forEach(row => {
                const key = row.monthKey;
                if (!monthlyData[key]) {
                    monthlyData[key] = 0;
                }
                monthlyData[key] += row.vat;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const values = sortedMonths.map(month => monthlyData[month]);
            
            // T√≠nh trung b√¨nh
            const average = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            const averageData = new Array(values.length).fill(average);

            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (charts.salesTrend) {
                charts.salesTrend.destroy();
            }

            charts.salesTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        order: 2
                    },
                    {
                        label: 'Trung B√¨nh',
                        data: averageData,
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const monthKey = sortedMonths[index];
                            showMonthDrillDown(monthKey, data);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Trung B√¨nh') {
                                        return 'Trung b√¨nh: ' + formatCurrency(context.parsed.y);
                                    }
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create brand trend chart (multi-line chart for top brands)
        function createBrandTrendChart(data) {
            // Check if filtering by specific brand
            const brandFilter = document.getElementById('brandFilter').value;
            const isFilteredByBrand = brandFilter && brandFilter !== 'all';
            
            // Group by brand and month
            const brandMonthData = {};
            const allMonths = new Set();
            
            data.forEach(row => {
                const brand = (row['NH√ÉN H√ÄNG'] || 'N/A').trim();
                const monthKey = row.monthKey;
                const vat = row.vat || 0;
                
                if (!brand || brand === 'N/A') return;
                
                allMonths.add(monthKey);
                
                if (!brandMonthData[brand]) {
                    brandMonthData[brand] = {};
                }
                
                if (!brandMonthData[brand][monthKey]) {
                    brandMonthData[brand][monthKey] = 0;
                }
                
                brandMonthData[brand][monthKey] += vat;
            });
            
            // Calculate total per brand and get top 10
            const brandTotals = Object.entries(brandMonthData).map(([brand, months]) => {
                const total = Object.values(months).reduce((sum, val) => sum + val, 0);
                return { brand, months, total };
            }).sort((a, b) => b.total - a.total).slice(0, 10);
            
            // Sort months chronologically
            const sortedMonths = Array.from(allMonths).sort();
            
            // Color palette for brands
            const colors = [
                '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
                '#fee140', '#30cfd0', '#a8edea', '#ff6b6b', '#c44569'
            ];
            
            const datasets = brandTotals.map((brandData, index) => ({
                label: brandData.brand,
                data: sortedMonths.map(month => brandData.months[month] || 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                order: 2
            }));
            
            // Th√™m ƒë∆∞·ªùng trung b√¨nh n·∫øu ƒëang l·ªçc theo 1 brand c·ª• th·ªÉ
            if (isFilteredByBrand && brandTotals.length === 1) {
                const brandData = brandTotals[0];
                const values = sortedMonths.map(month => brandData.months[month] || 0);
                const average = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                const averageData = new Array(values.length).fill(average);
                
                datasets.push({
                    label: 'Trung B√¨nh',
                    data: averageData,
                    borderColor: '#ef4444',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: false,
                    order: 1
                });
            }
            
            const ctx = document.getElementById('brandTrendChart').getContext('2d');
            
            if (charts.brandTrend) {
                charts.brandTrend.destroy();
            }
            
            charts.brandTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        // #region agent log (DISABLED to reduce traffic)
                        // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4247',message:'onClick triggered',data:{activeElementsLength:activeElements.length,hasSortedMonths:typeof sortedMonths !== 'undefined',sortedMonthsLength:sortedMonths?.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                        // #endregion
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            const pointIndex = activeElements[0].index;
                            // #region agent log (DISABLED to reduce traffic)
                            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4250',message:'Click indices extracted',data:{datasetIndex,pointIndex,brandTotalsLength:brandTotals.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                            // #endregion
                            if (datasetIndex < brandTotals.length) {
                                const brandName = brandTotals[datasetIndex].brand;
                                // Get the monthKey from the clicked point
                                const monthKey = sortedMonths[pointIndex];
                                // #region agent log (DISABLED to reduce traffic)
                                // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4254',message:'Extracted brand and month',data:{brandName,monthKey,pointIndex,sortedMonthsLength:sortedMonths.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B,C'})}).catch(()=>{});
                                // #endregion
                                showBrandDrillDown(brandName, monthKey);
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Trung B√¨nh') {
                                        return 'Trung b√¨nh: ' + formatCurrency(context.parsed.y);
                                    }
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create System Chart
        function createSystemChart(data) {
            const systemData = {};
            data.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) {
                    systemData[system] = 0;
                }
                systemData[system] += row.vat;
            });

            const sorted = Object.entries(systemData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('systemChart').getContext('2d');
            
            if (charts.system) {
                charts.system.destroy();
            }

            charts.system = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                            '#a8edea', '#fed6e3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const systemName = sorted[index][0];
                            console.log('System clicked (Main SystemChart):', systemName);
                            // Truy·ªÅn lu√¥n data ƒë√£ filter hi·ªán t·∫°i ƒë·ªÉ SKU breakdown b√°m theo filter
                            showSystemDrillDown(systemName, data);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Brand Chart
        function createBrandChart(data) {
            const brandData = {};
            data.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) {
                    brandData[brand] = 0;
                }
                brandData[brand] += row.vat;
            });

            const sorted = Object.entries(brandData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('brandChart').getContext('2d');
            
            if (charts.brand) {
                charts.brand.destroy();
            }

            charts.brand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const brandName = sorted[index][0];
                            console.log('Brand clicked:', brandName);
                            showBrandDrillDown(brandName);
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Year Comparison Chart
        function createYearComparisonChart(data) {
            // Group data by year and brand
            const yearBrandData = {};
            const brands = new Set();
            
            data.forEach(row => {
                const year = row.year;
                const brand = row['NH√ÉN H√ÄNG'] || 'Kh√°c';
                
                brands.add(brand);
                
                if (!yearBrandData[year]) {
                    yearBrandData[year] = {};
                }
                if (!yearBrandData[year][brand]) {
                    yearBrandData[year][brand] = 0;
                }
                yearBrandData[year][brand] += row.vat;
            });

            const years = Object.keys(yearBrandData).sort();
            const brandArray = Array.from(brands).sort();
            
            // Generate colors for brands
            const brandColors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
                '#fa709a', '#fee140', '#30cfd0', '#330867', '#a8edea', '#fed6e3',
                '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#ff6e7f', '#bfe9ff',
                '#fdcbf1', '#e6dee9', '#c1dfc4', '#deecdd', '#fbc2eb', '#a6c1ee'
            ];
            
            // Create datasets for each brand
            const datasets = brandArray.map((brand, idx) => {
                return {
                    label: brand,
                    data: years.map(year => yearBrandData[year][brand] || 0),
                    backgroundColor: brandColors[idx % brandColors.length],
                    borderWidth: 0
                };
            });

            const ctx = document.getElementById('yearComparisonChart').getContext('2d');
            
            if (charts.yearComparison) {
                charts.yearComparison.destroy();
            }

            charts.yearComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        // #region agent log (DISABLED to reduce traffic)
                        // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4499',message:'Year comparison chart onClick',data:{activeElementsLength:activeElements.length,hasBrandArray:typeof brandArray !== 'undefined',brandArrayLength:brandArray?.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,D'})}).catch(()=>{});
                        // #endregion
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const datasetIndex = activeElements[0].datasetIndex;
                            const selectedYear = parseInt(years[index]);
                            // #region agent log (DISABLED to reduce traffic)
                            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4502',message:'Click indices extracted',data:{index,datasetIndex,selectedYear,hasBrandArray:typeof brandArray !== 'undefined',brandArrayLength:brandArray?.length,selectedBrand:brandArray?.[datasetIndex]},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                            // #endregion
                            // Get brand name if datasetIndex is valid (when clicking on a specific bar segment)
                            const selectedBrand = (datasetIndex !== undefined && datasetIndex !== null && brandArray && brandArray[datasetIndex]) ? brandArray[datasetIndex] : null;
                            // If clicking on a specific bar segment (has datasetIndex), filter by both year and brand
                            // If clicking on the bar area but not a specific segment, just filter by year
                            showYearDrillDown(selectedYear, selectedBrand);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 11 },
                                padding: 10,
                                boxWidth: 12,
                                usePointStyle: true
                            },
                            onClick: (e, legendItem, legend) => {
                                // #region agent log (DISABLED to reduce traffic)
                                // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4510',message:'Legend clicked',data:{legendItemIndex:legendItem.datasetIndex,legendItemText:legendItem.text,hasBrandArray:typeof brandArray !== 'undefined',selectedBrand:brandArray?.[legendItem.datasetIndex]},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                                // #endregion
                                // Prevent default toggle behavior
                                e.stopPropagation();
                                // Get the brand name from the clicked legend item
                                const clickedBrand = brandArray && brandArray[legendItem.datasetIndex] ? brandArray[legendItem.datasetIndex] : null;
                                if (clickedBrand) {
                                    // Filter by this brand - show all years for this brand
                                    showYearDrillDown(null, clickedBrand);
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = formatCurrency(context.parsed.y);
                                    return `${label}: ${value}`;
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(item => {
                                        total += item.parsed.y;
                                    });
                                    return 'T·ªïng: ' + formatCurrency(total);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Show Year Drill-Down Modal
        let drillDownCharts = {};
        let yearDrillDownResizeHandler = null;
        
        function showYearDrillDown(year, brandName = null) {
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4555',message:'showYearDrillDown called',data:{year,brandName,hasCurrentFilteredData:currentFilteredData.length > 0,currentFilteredDataLength:currentFilteredData.length,allDataLength:allData.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
            // #endregion
            // Filter data for selected year - use current filtered data if available
            const baseData = currentFilteredData.length > 0 ? currentFilteredData : allData;
            let yearData = baseData;
            
            // Filter by year if provided
            if (year !== null) {
                yearData = yearData.filter(d => d.year === year);
            }
            
            // Filter by brand if provided
            if (brandName) {
                yearData = yearData.filter(d => {
                    const rowBrand = (d['NH√ÉN H√ÄNG'] || '').trim();
                    return rowBrand === brandName;
                });
            }
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4568',message:'After filtering',data:{year,brandName,yearDataLength:yearData.length,uniqueBrands:Array.from(new Set(yearData.map(d => d['NH√ÉN H√ÄNG']))).slice(0, 5),uniqueYears:Array.from(new Set(yearData.map(d => d.year)))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
            // #endregion

            // #region agent log
            console.log('[DEBUG YearDrillDown] year', year, 'baseData years:', [...new Set(baseData.map(d => d.year))], 'yearData rows:', yearData.length);
            // #endregion

            // L∆∞u context ƒë·ªÉ c√°c drill-down kh√°c (system, brand, SKU) c√≥ th·ªÉ gi·ªØ nguy√™n filter theo nƒÉm
            currentDrillDownContext = {
                type: 'year',
                year,
                brandName: brandName,
                baseData: yearData
            };
            
            // Update title
            let title = 'üìä Chi Ti·∫øt';
            if (year !== null && brandName) {
                title = `üìä Chi Ti·∫øt NƒÉm ${year} - ${brandName}`;
            } else if (year !== null) {
                title = `üìä Chi Ti·∫øt NƒÉm ${year}`;
            } else if (brandName) {
                title = `üìä Chi Ti·∫øt Nh√£n H√†ng: ${brandName}`;
            }
            document.getElementById('drillDownTitle').textContent = title;
            
            // 1. Create Monthly Chart
            // If year is null but we have data, determine the year(s) from data
            // For brand-only filter, we might have multiple years, so group by year-month
            const monthlyDataByYear = {};
            yearData.forEach(row => {
                const rowYear = row.year;
                const month = row.monthKey.substring(5, 7); // Get MM from YYYY-MM
                const yearMonthKey = `${rowYear}-${month}`;
                if (!monthlyDataByYear[yearMonthKey]) monthlyDataByYear[yearMonthKey] = 0;
                monthlyDataByYear[yearMonthKey] += row.vat;
            });
            
            // If year is specified, show only that year's monthly data
            // If year is null, aggregate all months across all years
            const monthlyData = {};
            if (year !== null) {
                // Filter by specific year
                yearData.forEach(row => {
                    if (row.year === year) {
                        const month = row.monthKey.substring(5, 7);
                        if (!monthlyData[month]) monthlyData[month] = 0;
                        monthlyData[month] += row.vat;
                    }
                });
            } else {
                // Aggregate across all years - sum all months regardless of year
                yearData.forEach(row => {
                    const month = row.monthKey.substring(5, 7);
                    if (!monthlyData[month]) monthlyData[month] = 0;
                    monthlyData[month] += row.vat;
                });
            }
            
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            const monthlyValues = months.map(m => monthlyData[m] || 0);
            const monthLabels = months.map(m => `Th√°ng ${parseInt(m)}`);
            
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4634',message:'Creating monthly chart',data:{year,brandName,yearDataLength:yearData.length,monthlyValues,hasCanvas:!!document.getElementById('drillDownMonthlyChart')},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            
            const monthCtx = document.getElementById('drillDownMonthlyChart');
            if (!monthCtx) {
                // #region agent log (DISABLED to reduce traffic)
                // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4638',message:'Canvas element not found',data:{year,brandName},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
                // #endregion
                console.error('drillDownMonthlyChart canvas not found');
                return;
            }
            
            if (drillDownCharts.monthly) drillDownCharts.monthly.destroy();
            try {
                drillDownCharts.monthly = new Chart(monthCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: monthlyValues,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const monthKey = months[index];
                            // Use the year from function parameter, or get from yearData if year is null
                            let selectedYearForClick = year;
                            if (selectedYearForClick === null && yearData.length > 0) {
                                // Get year from first data row
                                selectedYearForClick = yearData[0].year;
                            }
                            if (selectedYearForClick) {
                                console.log('Month chart clicked:', `${selectedYearForClick}-${monthKey.padStart(2, '0')}`);
                                // Use current filtered data for drill-down
                                const currentData = currentFilteredData.length > 0 ? currentFilteredData : allData;
                                showMonthDrillDown(`${selectedYearForClick}-${monthKey.padStart(2, '0')}`, currentData);
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });
            } catch (error) {
                // #region agent log (DISABLED to reduce traffic)
                // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4682',message:'Error creating monthly chart',data:{year,brandName,error:error.message,errorStack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
                // #endregion
                console.error('Error creating monthly chart:', error);
            }
            
            // 2. Create System Chart (Top 10)
            const systemData = {};
            yearData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = 0;
                systemData[system] += row.vat;
            });
            
            const sortedSystems = Object.entries(systemData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const systemCtx = document.getElementById('drillDownSystemChart').getContext('2d');
            if (drillDownCharts.system) drillDownCharts.system.destroy();
            drillDownCharts.system = new Chart(systemCtx, {
                type: 'bar',
                data: {
                    labels: sortedSystems.map(s => s[0]),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sortedSystems.map(s => s[1]),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const systemName = sortedSystems[index][0];
                            console.log('System chart clicked (YearDrillDown):', { systemName, year });
                            // Truy·ªÅn d·ªØ li·ªáu ƒë√£ filter theo nƒÉm ƒë·ªÉ gi·ªØ ƒë√∫ng context
                            showSystemDrillDown(systemName, yearData);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.x)
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });
            
            // 3. Create Detailed Table (System x Month)
            const systemMonthData = {};
            yearData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                const month = row.monthKey.substring(5, 7);
                
                if (!systemMonthData[system]) {
                    systemMonthData[system] = { total: 0, months: {} };
                }
                if (!systemMonthData[system].months[month]) {
                    systemMonthData[system].months[month] = 0;
                }
                
                systemMonthData[system].months[month] += row.vat;
                systemMonthData[system].total += row.vat;
            });
            
            const sortedSystemsForTable = Object.entries(systemMonthData)
                .sort((a, b) => b[1].total - a[1].total);
            
            // Build month header
            let monthHeaderHTML = '<th style="position: sticky; left: 0; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>';
            monthHeaderHTML += '<th style="position: sticky; left: 50px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>';
            monthHeaderHTML += '<th style="position: sticky; left: 250px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>';
            months.forEach(m => {
                monthHeaderHTML += `<th style="text-align: right; padding: 8px; border-bottom: 1px solid #e5e7eb; font-size: 0.85em; background: #f9fafb;">T${parseInt(m)}</th>`;
            });
            document.getElementById('monthHeaderRow').innerHTML = monthHeaderHTML;
            
            // Build table rows
            let tableHTML = '';
            sortedSystemsForTable.forEach((entry, index) => {
                const [system, data] = entry;
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="position: sticky; left: 0; background: white; z-index: 10; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${index + 1}</td>
                        <td style="position: sticky; left: 50px; background: white; z-index: 10; padding: 10px; font-weight: 600; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${system}</td>
                        <td style="position: sticky; left: 250px; background: white; z-index: 10; padding: 10px; text-align: right; font-weight: 600; color: #3b82f6; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${formatCurrency(data.total)}</td>
                `;
                
                months.forEach(m => {
                    const value = data.months[m] || 0;
                    const bgColor = value > 0 ? 'rgba(59, 130, 246, ' + Math.min(value / data.total, 0.3) + ')' : 'transparent';
                    tableHTML += `<td style="padding: 8px; text-align: right; font-size: 0.9em; background: ${bgColor};">${value > 0 ? formatCurrency(value) : '-'}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            document.getElementById('drillDownTableBody').innerHTML = tableHTML;
            
            // Show modal
            document.getElementById('yearDrillDownModal').style.display = 'block';
            
            // Remove existing resize handler if any
            if (yearDrillDownResizeHandler) {
                window.removeEventListener('resize', yearDrillDownResizeHandler);
            }
            
            // Create resize handler for charts
            yearDrillDownResizeHandler = () => {
                if (drillDownCharts.monthly) {
                    drillDownCharts.monthly.resize();
                }
                if (drillDownCharts.system) {
                    drillDownCharts.system.resize();
                }
            };
            
            // Add resize listener
            window.addEventListener('resize', yearDrillDownResizeHandler);
            
            // Resize charts after modal is displayed to ensure proper rendering
            // Use setTimeout to ensure DOM has updated
            setTimeout(() => {
                // #region agent log (DISABLED to reduce traffic)
                // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:4841',message:'Resizing charts after modal display',data:{hasMonthlyChart:!!drillDownCharts.monthly,hasSystemChart:!!drillDownCharts.system},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
                // #endregion
                yearDrillDownResizeHandler();
            }, 100);
        }
        
        function closeYearDrillDown() {
            document.getElementById('yearDrillDownModal').style.display = 'none';
            if (drillDownCharts.monthly) drillDownCharts.monthly.destroy();
            if (drillDownCharts.system) drillDownCharts.system.destroy();
            // Remove resize listener
            if (yearDrillDownResizeHandler) {
                window.removeEventListener('resize', yearDrillDownResizeHandler);
                yearDrillDownResizeHandler = null;
            }
        }

        // Universal Drill-Down Modal Functions
        let modalCharts = {};
        let currentDrillDownContext = null; // Store current drill-down context for timeline filtering
        
        function closeDrillDownModal() {
            document.getElementById('drillDownModal').style.display = 'none';
            Object.values(modalCharts).forEach(chart => chart && chart.destroy());
            modalCharts = {};
            currentDrillDownContext = null;
        }
        
        // Apply timeline filter to drill-down
        function applyDrillDownTimeline(period) {
            if (!currentDrillDownContext) return;
            
            // Calculate date range
            const now = new Date();
            let startDate = null;
            
            if (period !== 'ALL') {
                startDate = new Date(now);
                switch(period) {
                    case '1M':
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case '3M':
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                    case '6M':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '1Y':
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                }
            }
            
            // Re-call the drill-down function with filtered data
            const ctx = currentDrillDownContext;
            let filteredData = ctx.baseData;
            
            if (startDate) {
                const startKey = startDate.toISOString().substring(0, 7);
                filteredData = filteredData.filter(d => d.monthKey >= startKey);
            }
            
            // Update active button
            document.querySelectorAll('.modal-timeline-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Re-render based on type
            switch(ctx.type) {
                case 'system':
                    renderSystemDrillDown(ctx.name, filteredData);
                    break;
                case 'brand':
                    renderBrandDrillDown(ctx.name, filteredData);
                    break;
                case 'product':
                    renderProductDrillDown(ctx.name, ctx.key, filteredData);
                    break;
                case 'store':
                    renderStoreDrillDown(ctx.name, filteredData);
                    break;
            }
        }
        
        // Month Drill-Down
        function showMonthDrillDown(monthKey, filteredData) {
            // Use provided filteredData, or current filtered data, or allData as fallback
            const baseData = filteredData || (currentFilteredData.length > 0 ? currentFilteredData : allData);
            const monthData = baseData.filter(d => d.monthKey === monthKey);
            const [year, month] = monthKey.split('-');
            const monthName = `Th√°ng ${parseInt(month)}/${year}`;
            
            document.getElementById('modalTitle').textContent = `üìä Chi Ti·∫øt ${monthName}`;
            
            // Top Systems
            const systemData = {};
            monthData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = 0;
                systemData[system] += row.vat;
            });
            const topSystems = Object.entries(systemData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Brands
            const brandData = {};
            monthData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += row.vat;
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Products
            const productData = {};
            monthData.forEach(row => {
                const product = shortenProductName(row['T√äN SP']);
                if (!productData[product]) productData[product] = { sales: 0, qty: 0 };
                productData[product].sales += row.vat;
                productData[product].qty += row.soLuong || 0;
            });
            const topProducts = Object.entries(productData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3 style="color: #3b82f6; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng</h3>
                        <div style="height: 300px;"><canvas id="modalChart1"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè∑Ô∏è Top 10 Nh√£n H√†ng</h3>
                        <div style="height: 300px;"><canvas id="brandDrillChart"></canvas></div>
                    </div>
                </div>
                <div>
                    <h3 style="color: #f59e0b; margin-bottom: 15px;">üîù Top 10 S·∫£n Ph·∫©m</h3>
                    <div class="table-container" style="max-height: 400px; overflow: auto;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr>
                                    <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb;">#</th>
                                    <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb;">S·∫£n Ph·∫©m</th>
                                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">S·ªë L∆∞·ª£ng</th>
                                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Doanh S·ªë</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topProducts.map((p, i) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;">${i + 1}</td>
                                        <td style="padding: 10px;">${p[0]}</td>
                                        <td style="padding: 10px; text-align: right;">${formatNumber(p[1].qty)}</td>
                                        <td style="padding: 10px; text-align: right; font-weight: 600; color: #3b82f6;">${formatCurrency(p[1].sales)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            // Create charts
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: topSystems.map(s => s[0]),
                        datasets: [{ data: topSystems.map(s => s[1]), backgroundColor: '#3b82f6' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
                
                const ctx2 = document.getElementById('brandDrillChart').getContext('2d');
                modalCharts.chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topBrands.map(b => b[0]),
                        datasets: [{ data: topBrands.map(b => b[1]), backgroundColor: '#10b981' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
            }, 100);
        }

        // ==========================================
        // ORDER FREQUENCY DRILL-DOWN FUNCTIONS
        // ==========================================
        
        // Global variables for drill-down state
        let currentDrillState = {
            level: 'overview', // 'overview' | 'system' | 'sku'
            systemName: null,
            skuName: null,
            data: {}
        };

        // Open system-level drill-down
        function drillDownToSystem(systemName) {
            document.getElementById('modalTitle').textContent = `üè¢ Chi Ti·∫øt: ${systemName}`;
            
            // Monthly trend
            const monthlyData = {};
            systemData.forEach(row => {
                if (!monthlyData[row.monthKey]) monthlyData[row.monthKey] = 0;
                monthlyData[row.monthKey] += row.vat;
            });
            const months = Object.keys(monthlyData).sort();
            
            // Top Brands
            const brandData = {};
            systemData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += row.vat;
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Stores
            const storeData = {};
            systemData.forEach(row => {
                const store = row['C·ª¨A H√ÄNG'];
                if (!storeData[store]) storeData[store] = { sales: 0, orders: new Set() };
                storeData[store].sales += row.vat;
                storeData[store].orders.add(row['SO HD']);
            });
            const topStores = Object.entries(storeData)
                .map(([store, data]) => [store, data.sales, data.orders.size])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h3>
                    <div style="height: 250px;"><canvas id="modalChart1"></canvas></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè∑Ô∏è Top 10 Nh√£n H√†ng</h3>
                        <div style="height: 300px;"><canvas id="systemBrandChart"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üè™ Top 10 C·ª≠a H√†ng</h3>
                        <div class="table-container" style="max-height: 300px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">C·ª≠a H√†ng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">ƒê∆°n</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">Doanh S·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topStores.map((s, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px;">${i + 1}</td>
                                            <td style="padding: 8px;">${s[0]}</td>
                                            <td style="padding: 8px; text-align: right;">${s[2]}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #3b82f6;">${formatCurrency(s[1])}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh S·ªë',
                            data: months.map(m => monthlyData[m] || 0),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.y) }}},
                        scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
                
                const ctx2 = document.getElementById('systemBrandChart').getContext('2d');
                modalCharts.chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topBrands.map(b => b[0]),
                        datasets: [{ data: topBrands.map(b => b[1]), backgroundColor: '#10b981' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
            }, 100);
        }
        
        // Brand Drill-Down
        function showBrandDrillDown(brandName, monthKey = null) {
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:5058',message:'showBrandDrillDown called',data:{brandName,monthKey,hasCurrentFilteredData:currentFilteredData.length > 0,currentFilteredDataLength:currentFilteredData.length,allDataLength:allData.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            // Use current filtered data if available, otherwise use allData
            const baseData = currentFilteredData.length > 0 ? currentFilteredData : allData;
            // Filter by brand (normalize both sides for consistent matching)
            let brandData = baseData.filter(d => {
                const rowBrand = (d['NH√ÉN H√ÄNG'] || '').trim();
                return rowBrand === brandName;
            });
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:5065',message:'After brand filter',data:{brandDataLength:brandData.length,monthKey},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            // If monthKey is provided, filter by that specific month
            if (monthKey) {
                const beforeMonthFilter = brandData.length;
                brandData = brandData.filter(d => d.monthKey === monthKey);
                // #region agent log (DISABLED to reduce traffic)
                // const sampleMonthKeys = brandData.slice(0, 5).map(d => d.monthKey);
                // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:5068',message:'After month filter',data:{beforeMonthFilter,afterMonthFilter:brandData.length,monthKey,uniqueMonthKeys:Array.from(new Set(brandData.map(d => d.monthKey))),sampleMonthKeys},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
            }
            currentDrillDownContext = {
                type: 'brand',
                name: brandName,
                baseData: brandData
            };
            renderBrandDrillDown(brandName, brandData, monthKey);
        }
        
        function renderBrandDrillDown(brandName, brandData, monthKey = null) {
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:5078',message:'renderBrandDrillDown called',data:{brandName,monthKey,brandDataLength:brandData.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            // Update modal title to include month if filtering by specific month
            let title = `üè∑Ô∏è Chi Ti·∫øt: ${brandName}`;
            if (monthKey) {
                const [year, month] = monthKey.split('-');
                const monthName = `Th√°ng ${parseInt(month)}/${year}`;
                title = `üè∑Ô∏è Chi Ti·∫øt: ${brandName} - ${monthName}`;
            }
            document.getElementById('modalTitle').textContent = title;
            
            // Monthly trend
            const monthlyData = {};
            brandData.forEach(row => {
                if (!monthlyData[row.monthKey]) monthlyData[row.monthKey] = 0;
                monthlyData[row.monthKey] += row.vat;
            });
            const months = Object.keys(monthlyData).sort();
            // #region agent log (DISABLED to reduce traffic)
            // fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:5094',message:'Monthly data aggregated',data:{monthKey,months,monthlyDataKeys:Object.keys(monthlyData),monthlyDataValues:Object.values(monthlyData)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            
            // Top Systems
            const systemData = {};
            brandData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = 0;
                systemData[system] += row.vat;
            });
            const topSystems = Object.entries(systemData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Products
            // Group products by shortened name ONLY (g·ªôp c√°c m√£ HH 453G l·∫°i th√†nh m·ªôt d√≤ng)
            const productData = {};
            brandData.forEach(row => {
                const product = shortenProductName(row['T√äN SP']);
                if (!product) return;
                if (!productData[product]) productData[product] = { sales: 0, qty: 0 };
                productData[product].sales += row.vat;
                productData[product].qty += row.soLuong || 0;
            });
            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 15);
            
            let html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h3>
                    <div style="height: 250px;"><canvas id="modalChart1"></canvas></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng</h3>
                        <div style="height: 300px;"><canvas id="systemChart1"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üîù Top 15 S·∫£n Ph·∫©m</h3>
                        <div class="table-container" style="max-height: 300px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">S·∫£n Ph·∫©m</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">Doanh S·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topProducts.map((p, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; font-size: 0.9em;">${i + 1}</td>
                                            <td style="padding: 8px; font-size: 0.9em;">${p[0]}</td>
                                            <td style="padding: 8px; text-align: right; font-size: 0.9em;">${formatNumber(p[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #3b82f6; font-size: 0.9em;">${formatCurrency(p[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh S·ªë',
                            data: months.map(m => monthlyData[m] || 0),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.y) }}},
                        scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
                
                const ctx2 = document.getElementById('systemChart1').getContext('2d');
                modalCharts.chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topSystems.map(s => s[0]),
                        datasets: [{ data: topSystems.map(s => s[1]), backgroundColor: '#10b981' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
            }, 100);
        }
        
        // Product Drill-Down
        function showProductDrillDown(productName, productKey) {
            // Use current filtered data if available, otherwise use allData
            const baseData = currentFilteredData.length > 0 ? currentFilteredData : allData;
            // Filter data for this product (using shortened name)
            const productData = baseData.filter(d => {
                const shortName = shortenProductName(d['T√äN SP']);
                return shortName === productName;
            });
            
            if (productData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu cho s·∫£n ph·∫©m n√†y');
                return;
            }
            
            currentDrillDownContext = {
                type: 'product',
                name: productName,
                key: productKey,
                baseData: productData
            };
            renderProductDrillDown(productName, productKey, productData);
        }
        
        function renderProductDrillDown(productName, productKey, productData) {
            document.getElementById('modalTitle').textContent = `üì¶ Chi Ti·∫øt: ${productName}`;
            
            // Get all SKUs for this product
            const skus = [...new Set(productData.map(d => d['M√É HH']))].filter(Boolean);
            const skuText = skus.length > 0 ? ` (SKU: ${skus.slice(0, 3).join(', ')}${skus.length > 3 ? '...' : ''})` : '';
            
            // Monthly trend
            const monthlyData = {};
            productData.forEach(row => {
                if (!monthlyData[row.monthKey]) monthlyData[row.monthKey] = { sales: 0, qty: 0 };
                monthlyData[row.monthKey].sales += row.vat;
                monthlyData[row.monthKey].qty += row.soLuong || 0;
            });
            const months = Object.keys(monthlyData).sort();
            
            // Top Systems buying this product
            const systemData = {};
            productData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = { sales: 0, qty: 0 };
                systemData[system].sales += row.vat;
                systemData[system].qty += row.soLuong || 0;
            });
            const topSystems = Object.entries(systemData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            // Top Stores
            const storeData = {};
            productData.forEach(row => {
                const store = row['C·ª¨A H√ÄNG'];
                if (!storeData[store]) storeData[store] = { sales: 0, qty: 0, orders: new Set() };
                storeData[store].sales += row.vat;
                storeData[store].qty += row.soLuong || 0;
                storeData[store].orders.add(row['SO HD']);
            });
            const topStores = Object.entries(storeData)
                .map(([store, data]) => [store, data.sales, data.qty, data.orders.size])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Calculate total stats
            const totalSales = productData.reduce((sum, row) => sum + row.vat, 0);
            const totalQty = productData.reduce((sum, row) => sum + (row.soLuong || 0), 0);
            const avgPrice = totalQty > 0 ? totalSales / totalQty : 0;
            const brand = productData[0]['NH√ÉN H√ÄNG'] || 'N/A';
            
            let html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Th∆∞∆°ng Hi·ªáu</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${brand}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng Doanh S·ªë</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(totalSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng S·ªë L∆∞·ª£ng</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatNumber(totalQty)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Gi√° TB</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(avgPrice)}</div>
                        </div>
                    </div>
                    ${skuText ? `<div style="font-size: 0.85em; margin-top: 10px; opacity: 0.8;">${skuText}</div>` : ''}
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Doanh S·ªë & S·ªë L∆∞·ª£ng Theo Th√°ng</h3>
                    <div style="height: 300px;"><canvas id="modalChart1"></canvas></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng Mua</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">H·ªá Th·ªëng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">Doanh S·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topSystems.map((s, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px;">${i + 1}</td>
                                            <td style="padding: 8px; font-weight: 600;">${s[0]}</td>
                                            <td style="padding: 8px; text-align: right;">${formatNumber(s[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #10b981;">${formatCurrency(s[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üèÜ Top 10 C·ª≠a H√†ng Mua</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">C·ª≠a H√†ng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">DS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topStores.map((s, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; font-size: 0.9em;">${i + 1}</td>
                                            <td style="padding: 8px; font-size: 0.9em;">${s[0]}</td>
                                            <td style="padding: 8px; text-align: right; font-size: 0.9em;">${formatNumber(s[2])}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #f59e0b; font-size: 0.9em;">${formatCurrency(s[1])}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Doanh S·ªë',
                                data: months.map(m => monthlyData[m].sales),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'S·ªë L∆∞·ª£ng',
                                data: months.map(m => monthlyData[m].qty),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.label === 'Doanh S·ªë') {
                                            return 'Doanh s·ªë: ' + formatCurrency(context.parsed.y);
                                        } else {
                                            return 'S·ªë l∆∞·ª£ng: ' + formatNumber(context.parsed.y);
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Doanh S·ªë (VNƒê)'
                                },
                                ticks: {
                                    callback: (v) => formatCurrency(v)
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'S·ªë L∆∞·ª£ng'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: (v) => formatNumber(v)
                                }
                            }
                        }
                    }
                });
            }, 100);
        }

        // Store Drill-Down
        function showStoreDrillDown(storeName) {
            const storeData = allData.filter(d => d['C·ª¨A H√ÄNG'] === storeName);
            
            if (storeData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu cho c·ª≠a h√†ng n√†y');
                return;
            }
            
            currentDrillDownContext = {
                type: 'store',
                name: storeName,
                baseData: storeData
            };
            renderStoreDrillDown(storeName, storeData);
        }
        
        function renderStoreDrillDown(storeName, storeData) {
            document.getElementById('modalTitle').textContent = `üè™ Chi Ti·∫øt C·ª≠a H√†ng: ${storeName}`;
            
            // Calculate totals
            let totalSales = 0;
            let totalQty = 0;
            const uniqueOrders = new Set();
            
            storeData.forEach(row => {
                totalSales += row.vat || 0;
                totalQty += row.soLuong || 0;
                uniqueOrders.add(row['SO HD']);
            });
            
            const avgOrderValue = uniqueOrders.size > 0 ? totalSales / uniqueOrders.size : 0;
            
            // Monthly data
            const monthlyData = {};
            storeData.forEach(row => {
                const month = row.monthKey;
                if (!monthlyData[month]) {
                    monthlyData[month] = { sales: 0, qty: 0 };
                }
                monthlyData[month].sales += row.vat || 0;
                monthlyData[month].qty += row.soLuong || 0;
            });
            
            const months = Object.keys(monthlyData).sort();
            
            // Top brands
            const brandData = {};
            storeData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'] || 'Unknown';
                if (!brandData[brand]) {
                    brandData[brand] = { sales: 0, qty: 0 };
                }
                brandData[brand].sales += row.vat || 0;
                brandData[brand].qty += row.soLuong || 0;
            });
            
            const topBrands = Object.entries(brandData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            // Top products
            const productData = {};
            storeData.forEach(row => {
                const product = row['T√äN SP'] || 'Unknown';
                if (!productData[product]) {
                    productData[product] = { sales: 0, qty: 0 };
                }
                productData[product].sales += row.vat || 0;
                productData[product].qty += row.soLuong || 0;
            });
            
            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            const html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng Doanh S·ªë</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(totalSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng S·ªë L∆∞·ª£ng</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatNumber(totalQty)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">S·ªë ƒê∆°n H√†ng</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatNumber(uniqueOrders.size)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Gi√° TB/ƒê∆°n</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(avgOrderValue)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Doanh S·ªë Theo Th√°ng</h3>
                    <div style="height: 300px;"><canvas id="modalChart1"></canvas></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè∑Ô∏è Top 10 Nh√£n H√†ng</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">Nh√£n H√†ng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">DS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topBrands.map((b, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px;">${i + 1}</td>
                                            <td style="padding: 8px; font-weight: 600;">${b[0]}</td>
                                            <td style="padding: 8px; text-align: right;">${formatNumber(b[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #10b981;">${formatCurrency(b[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üì¶ Top 10 S·∫£n Ph·∫©m</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">S·∫£n Ph·∫©m</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">DS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topProducts.map((p, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; font-size: 0.9em;">${i + 1}</td>
                                            <td style="padding: 8px; font-size: 0.85em;">${p[0]}</td>
                                            <td style="padding: 8px; text-align: right; font-size: 0.9em;">${formatNumber(p[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #f59e0b; font-size: 0.9em;">${formatCurrency(p[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh S·ªë',
                            data: months.map(m => monthlyData[m].sales),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => 'Doanh s·ªë: ' + formatCurrency(context.parsed.y)
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (v) => formatCurrency(v)
                                }
                            }
                        }
                    }
                });
            }, 100);
        }

        // Create Top Products Chart
        function createTopProductsChart(data) {
            const productData = {};
            data.forEach(row => {
                const fullName = (row['T√äN SP'] || '').trim();
                const brand = (row['NH√ÉN H√ÄNG'] || '').trim();
                
                // Skip invalid records
                if (!fullName) {
                    return;
                }
                
                // Get shortened name for grouping
                const shortName = shortenProductName(fullName);
                
                // Group by T√äN R√öT G·ªåN (shortened name)
                if (!productData[shortName]) {
                    productData[shortName] = {
                        name: shortName,
                        brand: brand || 'N/A',
                        sales: 0,
                        quantity: 0
                    };
                }
                // #region agent log
                if (shortName === '453 G' || shortName.includes('453')) {
                    console.log('[DEBUG TopProducts] Aggregating sales for 453 G', {
                        shortName,
                        rowVat: row.vat,
                        rowVatType: typeof row.vat,
                        currentSales: productData[shortName].sales,
                        currentSalesType: typeof productData[shortName].sales
                    });
                }
                // #endregion
                const vatValue = Number(row.vat) || 0;
                productData[shortName].sales += vatValue;
                productData[shortName].quantity += row.soLuong || 0;
            });

            const sorted = Object.entries(productData)
                .filter(item => item[1].sales > 0)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 20);
            // #region agent log
            const topProduct = sorted.find(s => s[1].name === '453 G' || s[1].name.includes('453'));
            if (topProduct) {
                console.log('[DEBUG TopProducts] Sorted 453 G data', {
                    name: topProduct[1].name,
                    sales: topProduct[1].sales,
                    salesType: typeof topProduct[1].sales,
                    isNaN: isNaN(topProduct[1].sales),
                    isFinite: isFinite(topProduct[1].sales),
                    index: sorted.indexOf(topProduct)
                });
            }
            // #endregion

            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }

            if (sorted.length === 0) {
                // Handle case when no data available
                ctx.canvas.parentNode.innerHTML = '<p style="text-align: center; padding: 50px; color: #666;">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
                return;
            }

            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[1].name), // Already shortened name
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sorted.map(s => s[1].sales),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const productInfo = sorted[index];
                            showProductDrillDown(productInfo[1].name, productInfo[0]);
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return sorted[index][1].name;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    // #region agent log
                                    const productName = sorted[index] ? sorted[index][1].name : 'unknown';
                                    const logData = {
                                        index: index,
                                        productName: productName,
                                        contextRaw: context.raw,
                                        contextRawType: typeof context.raw,
                                        contextParsedX: context.parsed ? context.parsed.x : undefined,
                                        contextParsedY: context.parsed ? context.parsed.y : undefined,
                                        sortedSales: sorted[index] ? sorted[index][1].sales : undefined,
                                        sortedSalesType: sorted[index] ? typeof sorted[index][1].sales : undefined
                                    };
                                    if (productName === '453 G' || productName.includes('453')) {
                                        console.log('[DEBUG Tooltip] 453 G - Initial context:', logData);
                                    }
                                    // #endregion
                                    // L·∫•y tr·ª±c ti·∫øp value t·ª´ dataset ƒë·ªÉ tr√°nh NaN
                                    let salesValue = context.raw;
                                    if (typeof salesValue !== 'number' || !isFinite(salesValue)) {
                                        salesValue = Number(sorted[index][1].sales) || 0;
                                    }
                                    // #region agent log
                                    if (productName === '453 G' || productName.includes('453')) {
                                        console.log('[DEBUG Tooltip] 453 G - Final salesValue:', {salesValue, type: typeof salesValue, isNaN: isNaN(salesValue), isFinite: isFinite(salesValue)});
                                    }
                                    // #endregion
                                    return [
                                        'M√£: ' + sorted[index][0],
                                        'Doanh s·ªë: ' + formatCurrency(salesValue),
                                        'S·ªë l∆∞·ª£ng: ' + formatNumber(sorted[index][1].quantity)
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Update top products table below chart
            updateTopProductsTable(sorted, data);
            
            // Update yearly product analysis table
            updateYearlyProductTable(data);
            
            // Update store frequency table
            updateStoreFrequencyTable(data);
        }

        // Update Top Products Table
        function updateTopProductsTable(sortedProducts, filteredData) {
            const tbody = document.getElementById('topProductsTableBody');
            if (!tbody) return;
            
            // Calculate total sales for percentage calculation
            const totalSales = filteredData.reduce((sum, row) => sum + (row.vat || 0), 0);
            
            tbody.innerHTML = '';
            
            sortedProducts.forEach((product, index) => {
                const productInfo = product[1];
                const sales = productInfo.sales || 0;
                const quantity = productInfo.quantity || 0;
                const percentage = totalSales > 0 ? (sales / totalSales * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e5e7eb';
                row.innerHTML = `
                    <td style="padding: 12px; text-align: center; color: #667eea; font-weight: 600;">${index + 1}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 600; color: #1e293b;">${productInfo.name}</div>
                        <div style="font-size: 0.85em; color: #64748b; margin-top: 2px;">SL: ${formatNumber(quantity)}</div>
                    </td>
                    <td style="padding: 12px; text-align: center; color: #475569;">${formatNumber(quantity)}</td>
                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #3b82f6;">${formatCurrency(sales)}</td>
                    <td style="padding: 12px; text-align: center; color: #10b981; font-weight: 600;">${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Create Store Activity Chart (Active stores per month by system)
        function createStoreActivityChart(data) {
            // Group by month and system to count unique stores
            const monthStoreData = {}; // Total stores per month
            const systemMonthStoreData = {}; // Stores per month per system
            
            data.forEach(row => {
                const monthKey = row.monthKey;
                const store = (row['C·ª¨A H√ÄNG'] || '').trim();
                const system = (row['H·ªÜ TH·ªêNG'] || '').trim();
                
                if (!monthKey || !store) return;
                
                // Track total stores
                if (!monthStoreData[monthKey]) {
                    monthStoreData[monthKey] = new Set();
                }
                monthStoreData[monthKey].add(store);
                
                // Track stores per system
                if (system) {
                    if (!systemMonthStoreData[system]) {
                        systemMonthStoreData[system] = {};
                    }
                    if (!systemMonthStoreData[system][monthKey]) {
                        systemMonthStoreData[system][monthKey] = new Set();
                    }
                    systemMonthStoreData[system][monthKey].add(store);
                }
            });
            
            // Get sorted months
            const sortedMonths = Object.keys(monthStoreData).sort();
            
            // Prepare datasets
            const datasets = [];
            
            // Color palette for systems
            const systemColors = [
                { border: '#3b82f6', bg: '#3b82f640' },
                { border: '#10b981', bg: '#10b98140' },
                { border: '#f59e0b', bg: '#f59e0b40' },
                { border: '#ef4444', bg: '#ef444440' },
                { border: '#8b5cf6', bg: '#8b5cf640' },
                { border: '#ec4899', bg: '#ec489940' },
                { border: '#14b8a6', bg: '#14b8a640' },
                { border: '#f97316', bg: '#f9731640' }
            ];
            
            let colorIndex = 0;
            
            // Add system datasets
            Object.keys(systemMonthStoreData).sort().forEach(system => {
                const systemData = systemMonthStoreData[system];
                const storeCounts = sortedMonths.map(month => 
                    systemData[month] ? systemData[month].size : 0
                );
                
                const color = systemColors[colorIndex % systemColors.length];
                colorIndex++;
                
                datasets.push({
                    label: system,
                    data: storeCounts,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                });
            });
            
            // Add total dataset (thicker line, always on top)
            const totalStoreCounts = sortedMonths.map(month => monthStoreData[month].size);
            datasets.push({
                label: 'T·ªïng c·ª≠a h√†ng',
                data: totalStoreCounts,
                borderColor: '#1e293b',
                backgroundColor: '#1e293b20',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderDash: [5, 5]
            });
            
            const ctx = document.getElementById('storeActivityChart').getContext('2d');
            
            if (charts.storeActivity) {
                charts.storeActivity.destroy();
            }
            
            charts.storeActivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' c·ª≠a h√†ng';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Update Store Frequency Table
        function updateStoreFrequencyTable(data) {
            // Group by store
            const storeData = {};
            
            data.forEach(row => {
                const store = (row['C·ª¨A H√ÄNG'] || '').trim();
                const soHD = row['SO HD'];
                const vat = row.vat || 0;
                
                if (!store) return;
                
                if (!storeData[store]) {
                    storeData[store] = {
                        store: store,
                        orderDates: new Set(), // Count unique order dates/times
                        totalOrders: new Set(), // Count unique SO HD
                        totalSales: 0
                    };
                }
                
                // Count frequency by unique (SO HD + NGAY) combinations
                const dateKey = row.monthKey + '_' + soHD;
                storeData[store].orderDates.add(dateKey);
                storeData[store].totalOrders.add(soHD);
                storeData[store].totalSales += vat;
            });
            
            // Convert to array and sort by order frequency
            const sorted = Object.values(storeData)
                .map(s => ({
                    store: s.store,
                    frequency: s.orderDates.size, // Number of unique orders
                    totalOrders: s.totalOrders.size,
                    totalSales: s.totalSales,
                    avgPerOrder: s.totalOrders.size > 0 ? s.totalSales / s.totalOrders.size : 0
                }))
                .sort((a, b) => b.frequency - a.frequency)
                .slice(0, 30);
            
            const tbody = document.getElementById('storeFrequencyTableBody');
            tbody.innerHTML = '';
            
            sorted.forEach((storeInfo, index) => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showStoreDrillDown(storeInfo.store);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${storeInfo.store}</td>
                    <td class="number" style="font-weight: 600; color: #667eea;">${formatNumber(storeInfo.frequency)}</td>
                    <td class="number">${formatNumber(storeInfo.totalOrders)}</td>
                    <td class="number" style="background: #fffbeb; color: #d97706;">${formatCurrency(storeInfo.totalSales)}</td>
                    <td class="number">${formatCurrency(storeInfo.avgPerOrder)}</td>
                `;
                row.title = 'Click ƒë·ªÉ xem chi ti·∫øt c·ª≠a h√†ng';
            });
        }

        // Analyze growth contributors and detractors (2024 vs 2025)
        let systemSKUDetails = {}; // Store SKU details per system for expansion
        
        function analyzeGrowthDrivers(data) {
            // Filter data for 2024 and 2025
            const data2024 = data.filter(row => row.year === 2024);
            const data2025 = data.filter(row => row.year === 2025);
            
            // Analyze by SKU
            const skuData2024 = {};
            const skuData2025 = {};
            
            data2024.forEach(row => {
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!sku) return;
                if (!skuData2024[sku]) skuData2024[sku] = 0;
                skuData2024[sku] += row.vat || 0;
            });
            
            data2025.forEach(row => {
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!sku) return;
                if (!skuData2025[sku]) skuData2025[sku] = 0;
                skuData2025[sku] += row.vat || 0;
            });
            
            // Calculate SKU changes
            const skuChanges = [];
            const allSkus = new Set([...Object.keys(skuData2024), ...Object.keys(skuData2025)]);
            
            allSkus.forEach(sku => {
                const val2024 = skuData2024[sku] || 0;
                const val2025 = skuData2025[sku] || 0;
                const change = val2025 - val2024;
                const changePercent = val2024 > 0 ? ((change / val2024) * 100) : 0;
                
                if (Math.abs(change) > 1000000) { // Only significant changes > 1M
                    skuChanges.push({
                        sku: sku,
                        val2024: val2024,
                        val2025: val2025,
                        change: change,
                        changePercent: changePercent
                    });
                }
            });
            
            // Top growth and decline SKUs
            const topGrowth = skuChanges.filter(s => s.change > 0).sort((a, b) => b.change - a.change).slice(0, 10);
            const topDecline = skuChanges.filter(s => s.change < 0).sort((a, b) => a.change - b.change).slice(0, 10);
            
            // Analyze by System WITH SKU DETAILS
            const systemData2024 = {};
            const systemData2025 = {};
            const systemSKUData2024 = {}; // Track SKUs per system
            const systemSKUData2025 = {};
            
            data2024.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || '';
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!system || !sku) return;
                
                if (!systemData2024[system]) systemData2024[system] = 0;
                systemData2024[system] += row.vat || 0;
                
                if (!systemSKUData2024[system]) systemSKUData2024[system] = {};
                if (!systemSKUData2024[system][sku]) systemSKUData2024[system][sku] = 0;
                systemSKUData2024[system][sku] += row.vat || 0;
            });
            
            data2025.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || '';
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!system || !sku) return;
                
                if (!systemData2025[system]) systemData2025[system] = 0;
                systemData2025[system] += row.vat || 0;
                
                if (!systemSKUData2025[system]) systemSKUData2025[system] = {};
                if (!systemSKUData2025[system][sku]) systemSKUData2025[system][sku] = 0;
                systemSKUData2025[system][sku] += row.vat || 0;
            });
            
            // Calculate System changes with SKU breakdown
            const systemChanges = [];
            const allSystems = new Set([...Object.keys(systemData2024), ...Object.keys(systemData2025)]);
            
            systemSKUDetails = {}; // Reset
            
            allSystems.forEach(system => {
                const val2024 = systemData2024[system] || 0;
                const val2025 = systemData2025[system] || 0;
                const change = val2025 - val2024;
                const changePercent = val2024 > 0 ? ((change / val2024) * 100) : 0;
                
                // Calculate SKU changes within this system
                const skuChangesInSystem = [];
                const systemSkus2024 = systemSKUData2024[system] || {};
                const systemSkus2025 = systemSKUData2025[system] || {};
                const allSystemSkus = new Set([...Object.keys(systemSkus2024), ...Object.keys(systemSkus2025)]);
                
                allSystemSkus.forEach(sku => {
                    const skuVal2024 = systemSkus2024[sku] || 0;
                    const skuVal2025 = systemSkus2025[sku] || 0;
                    const skuChange = skuVal2025 - skuVal2024;
                    const skuChangePercent = skuVal2024 > 0 ? ((skuChange / skuVal2024) * 100) : 0;
                    
                    if (Math.abs(skuChange) > 500000) { // Significant change > 500K
                        skuChangesInSystem.push({
                            sku: sku,
                            val2024: skuVal2024,
                            val2025: skuVal2025,
                            change: skuChange,
                            changePercent: skuChangePercent
                        });
                    }
                });
                
                // Sort and store top SKUs for this system
                systemSKUDetails[system] = skuChangesInSystem.sort((a, b) => Math.abs(b.change) - Math.abs(a.change)).slice(0, 10);
                
                systemChanges.push({
                    system: system,
                    val2024: val2024,
                    val2025: val2025,
                    change: change,
                    changePercent: changePercent
                });
            });
            
            const topGrowthSystem = systemChanges.filter(s => s.change > 0).sort((a, b) => b.change - a.change).slice(0, 5);
            const topDeclineSystem = systemChanges.filter(s => s.change < 0).sort((a, b) => a.change - b.change).slice(0, 5);
            
            // Update tables
            updateGrowthTable('topGrowthSKUTableBody', topGrowth, 'sku', null);
            updateGrowthTable('topDeclineSKUTableBody', topDecline, 'sku', null);
            updateGrowthTable('topGrowthSystemTableBody', topGrowthSystem, 'system', true);
            updateGrowthTable('topDeclineSystemTableBody', topDeclineSystem, 'system', true);
        }
        
        function updateGrowthTable(tableBodyId, data, type, expandable) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #94a3b8; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td>';
                return;
            }
            
            data.forEach((item, index) => {
                const name = type === 'sku' ? item.sku : item.system;
                const changePercent = item.changePercent;
                const isPositive = item.change > 0;
                const percentColor = isPositive ? '#10b981' : '#ef4444';
                const percentIcon = isPositive ? '‚Üë' : '‚Üì';
                
                const systemId = type === 'system' ? name.replace(/[^a-zA-Z0-9]/g, '_') : null;
                const expandIcon = expandable && systemSKUDetails[name] && systemSKUDetails[name].length > 0 
                    ? `<span id="icon_${systemId}" style="cursor: pointer; display: inline-block; width: 16px; margin-right: 5px;" onclick="toggleSystemSKUs('${systemId}', '${tableBodyId}')">‚ñ∂</span>` 
                    : '';
                
                const row = tbody.insertRow();
                row.setAttribute('data-system-row', systemId);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align: left; font-weight: 500;">${expandIcon}${name}</td>
                    <td class="number" style="color: #64748b;">${formatCurrency(item.val2024)}</td>
                    <td class="number" style="color: #1e293b; font-weight: 600;">${formatCurrency(item.val2025)}</td>
                    <td class="number" style="color: ${percentColor}; font-weight: 700;">
                        ${percentIcon} ${formatCurrency(Math.abs(item.change))}
                        <br><span style="font-size: 0.85em;">(${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%)</span>
                    </td>
                `;
                
                // Add SKU detail rows (hidden by default)
                if (expandable && systemSKUDetails[name] && systemSKUDetails[name].length > 0) {
                    systemSKUDetails[name].forEach(skuData => {
                        const skuRow = tbody.insertRow();
                        skuRow.setAttribute('data-system-sku', systemId);
                        skuRow.style.display = 'none';
                        
                        const skuIsPositive = skuData.change > 0;
                        const skuPercentColor = skuIsPositive ? '#10b981' : '#ef4444';
                        const skuPercentIcon = skuIsPositive ? '‚Üë' : '‚Üì';
                        
                        skuRow.innerHTML = `
                            <td style="background: #f9fafb;"></td>
                            <td style="padding-left: 30px; background: #f9fafb; color: #666; font-size: 0.9em; text-align: left;">${skuData.sku}</td>
                            <td class="number" style="background: #f9fafb; color: #94a3b8; font-size: 0.85em;">${formatCurrency(skuData.val2024)}</td>
                            <td class="number" style="background: #f9fafb; color: #64748b; font-size: 0.85em;">${formatCurrency(skuData.val2025)}</td>
                            <td class="number" style="background: #f9fafb; color: ${skuPercentColor}; font-size: 0.85em;">
                                ${skuPercentIcon} ${formatCurrency(Math.abs(skuData.change))}
                                <br><span style="font-size: 0.9em;">(${skuData.changePercent >= 0 ? '+' : ''}${skuData.changePercent.toFixed(1)}%)</span>
                            </td>
                        `;
                    });
                }
            });
        }
        
        // Toggle system SKU details
        function toggleSystemSKUs(systemId, tableBodyId) {
            const icon = document.getElementById(`icon_${systemId}`);
            const tbody = document.getElementById(tableBodyId);
            const skuRows = tbody.querySelectorAll(`tr[data-system-sku="${systemId}"]`);
            
            if (icon.textContent === '‚ñ∂') {
                // Expand
                icon.textContent = '‚ñº';
                skuRows.forEach(row => row.style.display = '');
            } else {
                // Collapse
                icon.textContent = '‚ñ∂';
                skuRows.forEach(row => row.style.display = 'none');
            }
        }

        // Update Yearly Product Analysis Table with Forecast
        function updateYearlyProductTable(data) {
            // Group by Brand > Year > SKU to get detailed breakdown
            const brandYearData = {};
            
            data.forEach(row => {
                const brand = (row['NH√ÉN H√ÄNG'] || 'N/A').trim();
                const year = row.year;
                const vat = row.vat || 0;
                const quantity = row.soLuong || 0;
                const fullName = (row['T√äN SP'] || '').trim();
                const sku = shortenProductName(fullName);
                
                if (year < 2023 || year > 2025 || !sku) return;
                
                if (!brandYearData[brand]) {
                    brandYearData[brand] = {
                        brand: brand,
                        years: { 
                            2023: { vat: 0, qty: 0, skus: {} }, 
                            2024: { vat: 0, qty: 0, skus: {} }, 
                            2025: { vat: 0, qty: 0, skus: {} } 
                        }
                    };
                }
                
                brandYearData[brand].years[year].vat += vat;
                brandYearData[brand].years[year].qty += quantity;
                
                // Track SKU details
                if (!brandYearData[brand].years[year].skus[sku]) {
                    brandYearData[brand].years[year].skus[sku] = { vat: 0, qty: 0 };
                }
                brandYearData[brand].years[year].skus[sku].vat += vat;
                brandYearData[brand].years[year].skus[sku].qty += quantity;
            });
            
            // Create rows: each brand gets 3 years + forecast (2026)
            const brandRows = [];
            Object.values(brandYearData).forEach(brandData => {
                const years = [2023, 2024, 2025];
                const yearRows = [];
                let totalVAT = 0;
                
                years.forEach(year => {
                    const yearData = brandData.years[year];
                    const vat = yearData.vat;
                    const qty = yearData.qty;
                    
                    if (vat === 0) return; // Skip years with no data
                    
                    totalVAT += vat;
                    
                    // Calculate growth vs previous year
                    let growthRate = null;
                    let growthText = '-';
                    if (year > 2023) {
                        const prevYear = year - 1;
                        const prevVat = brandData.years[prevYear].vat;
                        if (prevVat > 0) {
                            growthRate = ((vat - prevVat) / prevVat) * 100;
                            const growthIcon = growthRate > 0 ? 'üìà' : 'üìâ';
                            const growthColor = growthRate > 0 ? '#10b981' : '#ef4444';
                            growthText = `<span style="color: ${growthColor}; font-weight: 600;">${growthIcon} ${growthRate.toFixed(1)}%</span>`;
                        }
                    }
                    
                    yearRows.push({
                        brand: brandData.brand,
                        year: year,
                        vat: vat,
                        qty: qty,
                        growthText: growthText,
                        growthRate: growthRate || 0,
                        isForecast: false,
                        skus: yearData.skus // Include SKU details
                    });
                });
                
                // Calculate 2026 forecast if we have at least 2 years of data
                if (yearRows.length >= 2) {
                    const growthRates = [];
                    for (let i = 1; i < yearRows.length; i++) {
                        const prev = yearRows[i-1];
                        const curr = yearRows[i];
                        if (prev.vat > 0) {
                            growthRates.push((curr.vat - prev.vat) / prev.vat);
                        }
                    }
                    
                    if (growthRates.length > 0) {
                        // Check if brand has custom growth rate
                        let avgGrowth = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                        let isCustomGrowth = false;
                        
                        if (BRAND_CUSTOM_GROWTH[brandData.brand] !== undefined) {
                            avgGrowth = BRAND_CUSTOM_GROWTH[brandData.brand];
                            isCustomGrowth = true;
                        }
                        
                        const lastYear = yearRows[yearRows.length - 1];
                        const forecast2026VAT = lastYear.vat * (1 + avgGrowth);
                        const forecast2026Qty = lastYear.qty * (1 + avgGrowth);
                        
                        // Calculate forecast for each SKU based on 2025 data (excluding locked SKUs)
                        const forecast2026SKUs = {};
                        let excludedVAT = 0; // Track excluded SKU values
                        let excludedQty = 0;
                        
                        if (lastYear.skus) {
                            Object.entries(lastYear.skus).forEach(([sku, skuData]) => {
                                // Check if SKU is in exclusion list
                                if (EXCLUDED_SKUS_FROM_FORECAST.includes(sku)) {
                                    // Keep 2025 values for excluded SKUs (no growth)
                                    forecast2026SKUs[sku] = {
                                        vat: skuData.vat,
                                        qty: skuData.qty,
                                        excluded: true // Mark as excluded
                                    };
                                    excludedVAT += skuData.vat;
                                    excludedQty += skuData.qty;
                                } else {
                                    // Apply growth for non-excluded SKUs
                                    forecast2026SKUs[sku] = {
                                        vat: skuData.vat * (1 + avgGrowth),
                                        qty: skuData.qty * (1 + avgGrowth),
                                        excluded: false
                                    };
                                }
                            });
                        }
                        
                        // Adjust brand total: only grow non-excluded portion
                        const nonExcludedVAT = lastYear.vat - excludedVAT;
                        const nonExcludedQty = lastYear.qty - excludedQty;
                        const adjustedForecast2026VAT = (nonExcludedVAT * (1 + avgGrowth)) + excludedVAT;
                        const adjustedForecast2026Qty = (nonExcludedQty * (1 + avgGrowth)) + excludedQty;
                        
                        // Create growth text
                        let growthDisplayText = `<span style="color: #667eea; font-weight: 600;">üîÆ ${(avgGrowth * 100).toFixed(1)}%</span>`;
                        if (isCustomGrowth) {
                            growthDisplayText += ' <span style="color: #f59e0b; font-size: 0.85em;">‚öôÔ∏è (t√πy ch·ªânh)</span>';
                        }
                        if (EXCLUDED_SKUS_FROM_FORECAST.length > 0) {
                            growthDisplayText += ` <span style="color: #94a3b8; font-size: 0.85em;">(lo·∫°i tr·ª´ ${EXCLUDED_SKUS_FROM_FORECAST.length} m√£)</span>`;
                        }
                        
                        yearRows.push({
                            brand: brandData.brand,
                            year: 2026,
                            vat: adjustedForecast2026VAT,
                            qty: adjustedForecast2026Qty,
                            growthText: growthDisplayText,
                            growthRate: avgGrowth * 100,
                            isForecast: true,
                            skus: forecast2026SKUs // Include forecasted SKUs
                        });
                    }
                }
                
                if (yearRows.length > 0) {
                    brandRows.push({
                        brand: brandData.brand,
                        totalVAT: totalVAT,
                        rows: yearRows
                    });
                }
            });
            
            // Sort by brand total VAT descending
            brandRows.sort((a, b) => b.totalVAT - a.totalVAT);
            
            const tbody = document.getElementById('yearlyProductTableBody');
            tbody.innerHTML = '';
            
            let rowIndex = 0;
            brandRows.forEach((brandGroup) => {
                const brandId = brandGroup.brand.replace(/[^a-zA-Z0-9]/g, '_');
                
                // First row: Brand header with total
                const headerRow = tbody.insertRow();
                headerRow.setAttribute('data-brand-header', brandId);
                rowIndex++;
                
                headerRow.innerHTML = `
                    <td>${rowIndex}</td>
                    <td colspan="5" style="font-weight: 700; color: #667eea; cursor: pointer;" onclick="toggleBrand('${brandId}')">
                        <span id="icon_${brandId}" style="display: inline-block; width: 20px;">‚ñº</span>
                        ${brandGroup.brand} 
                        <span style="color: #d97706; font-size: 0.9em;">(T·ªïng: ${formatCurrency(brandGroup.totalVAT)})</span>
                    </td>
                `;
                
                // Year rows
                brandGroup.rows.forEach((rowData) => {
                    const row = tbody.insertRow();
                    row.setAttribute('data-brand-row', brandId);
                    rowIndex++;
                    
                    const yearLabel = rowData.isForecast ? '2026 (D·ª± ki·∫øn)' : rowData.year;
                    const rowStyle = rowData.isForecast ? 'background: #f0f9ff; font-style: italic;' : '';
                    const yearId = `${brandId}_${rowData.year}`;
                    
                    // Add expand icon for years with SKU data
                    const hasSkus = rowData.skus && Object.keys(rowData.skus).length > 0;
                    const expandIcon = hasSkus ? `<span id="icon_${yearId}" style="cursor: pointer; display: inline-block; width: 16px;" onclick="toggleYearSkus('${yearId}'); event.stopPropagation();">‚ñ∂</span> ` : '';
                    
                    row.innerHTML = `
                        <td style="${rowStyle}">${rowIndex}</td>
                        <td style="padding-left: 30px; ${rowStyle}"></td>
                        <td style="${rowStyle}">${expandIcon}${yearLabel}</td>
                        <td class="number" style="${rowStyle}">${rowData.qty > 0 ? formatNumber(Math.round(rowData.qty)) : '-'}</td>
                        <td class="number" style="background: #fffbeb; font-weight: 600; color: #d97706;">${formatCurrency(rowData.vat)}</td>
                        <td class="number" style="${rowStyle}">${rowData.growthText}</td>
                    `;
                    
                    // Add SKU detail rows (hidden by default)
                    if (hasSkus) {
                        const skuArray = Object.entries(rowData.skus)
                            .map(([sku, data]) => ({ sku, ...data }))
                            .sort((a, b) => b.vat - a.vat);
                        
                        skuArray.forEach((skuData) => {
                            const skuRow = tbody.insertRow();
                            skuRow.setAttribute('data-year-sku', yearId);
                            skuRow.style.display = 'none';
                            rowIndex++;
                            
                            // Add lock icon for excluded SKUs
                            const lockIcon = skuData.excluded ? '<span style="color: #94a3b8; margin-right: 4px;" title="M√£ n√†y ƒë∆∞·ª£c lo·∫°i tr·ª´ kh·ªèi d·ª± ki·∫øn">üîí</span>' : '';
                            const skuStyle = skuData.excluded ? 'background: #f1f5f9;' : 'background: #f9fafb;';
                            const valueStyle = skuData.excluded ? 'background: #e2e8f0; color: #64748b;' : 'background: #fef3c7; color: #92400e;';
                            
                            skuRow.innerHTML = `
                                <td style="${skuStyle}">${rowIndex}</td>
                                <td style="padding-left: 50px; ${skuStyle} color: #666; font-size: 0.9em;" colspan="2">${lockIcon}${skuData.sku}</td>
                                <td class="number" style="${skuStyle} color: #666;">${formatNumber(Math.round(skuData.qty))}</td>
                                <td class="number" style="${valueStyle}">${formatCurrency(skuData.vat)}</td>
                                <td style="${skuStyle}">${skuData.excluded ? '<span style="color: #94a3b8; font-size: 0.85em;">Lo·∫°i tr·ª´</span>' : ''}</td>
                            `;
                        });
                    }
                });
            });
        }
        
        // Toggle year SKUs visibility
        function toggleYearSkus(yearId) {
            const icon = document.getElementById(`icon_${yearId}`);
            const skuRows = document.querySelectorAll(`tr[data-year-sku="${yearId}"]`);
            
            if (icon.textContent === '‚ñ∂') {
                // Expand
                icon.textContent = '‚ñº';
                skuRows.forEach(row => row.style.display = '');
            } else {
                // Collapse
                icon.textContent = '‚ñ∂';
                skuRows.forEach(row => row.style.display = 'none');
            }
        }
        
        // Toggle individual brand visibility
        function toggleBrand(brandId) {
            const icon = document.getElementById(`icon_${brandId}`);
            const rows = document.querySelectorAll(`tr[data-brand-row="${brandId}"]`);
            
            if (icon.textContent === '‚ñº') {
                // Collapse
                icon.textContent = '‚ñ∂';
                rows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                icon.textContent = '‚ñº';
                rows.forEach(row => row.style.display = '');
            }
        }

        // Toggle yearly product table visibility
        function toggleYearlyProductTable() {
            const container = document.getElementById('yearlyTableContainer');
            const icon = document.getElementById('toggleIcon');
            const button = document.getElementById('toggleYearlyTable');
            
            if (container.style.maxHeight === '0px') {
                // Expand
                container.style.maxHeight = '2000px';
                container.style.opacity = '1';
                icon.textContent = '‚ñº';
                button.innerHTML = '<span id="toggleIcon">‚ñº</span> Thu g·ªçn';
            } else {
                // Collapse
                container.style.maxHeight = '0px';
                container.style.opacity = '0';
                icon.textContent = '‚ñ∂';
                button.innerHTML = '<span id="toggleIcon">‚ñ∂</span> M·ªü r·ªông';
            }
        }

        // Update dashboard
        // Store current filtered data globally for drill-down functions
        let currentFilteredData = [];

        function updateDashboard() {
            console.log('üìä updateDashboard() called');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:7452',message:'updateDashboard started',data:{allDataLength:allData.length,hasCurrentUser:!!currentUser},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
            
            let data = filterData();
            console.log(`üìä After filterData(): ${data.length} rows`);
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:7455',message:'After filterData',data:{filteredDataLength:data.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
            
            // Apply permission-based filtering
            data = filterDataByPermissions(data);
            console.log(`üìä After filterDataByPermissions(): ${data.length} rows`);
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:7460',message:'After filterDataByPermissions',data:{finalDataLength:data.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
            
            currentFilteredData = data; // Store for drill-down functions
            
            if (data.length === 0) {
                console.warn('‚ö†Ô∏è No data to display after filtering!');
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:7465',message:'No data after filtering',data:{allDataLength:allData.length,currentUser:currentUser?.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
            }
            
            updateKPIs(data);
            createForecastChart(data);
            createSalesTrendChart(data);
            createBrandTrendChart(data);
            createSystemChart(data);
            createBrandChart(data);
            createYearComparisonChart(data);
            createTopProductsChart(data);
            createStoreActivityChart(data);
            analyzeGrowthDrivers(data);
            
            console.log('‚úÖ updateDashboard() completed');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:7480',message:'updateDashboard completed',data:{finalDataLength:data.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
        }

        // Export to PowerPoint
        async function exportToPowerPoint() {
            const pptx = new PptxGenJS();
            
            // Set presentation properties
            pptx.author = 'Sales Dashboard';
            pptx.company = 'Vi·ªát Li√™n';
            pptx.title = 'B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë 2022-2025';
            
            // Slide 1: Title
            const slide1 = pptx.addSlide();
            slide1.background = { color: '667eea' };
            slide1.addText('üìä B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë', {
                x: 0.5, y: 2.0, w: 9, h: 1,
                fontSize: 44, bold: true, color: 'FFFFFF', align: 'center'
            });
            slide1.addText('Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë theo H·ªá th·ªëng, Nh√£n h√†ng v√† M√£ h√†ng (2022 - 2025)', {
                x: 0.5, y: 3.2, w: 9, h: 0.5,
                fontSize: 18, color: 'FFFFFF', align: 'center'
            });
            slide1.addText(new Date().toLocaleDateString('vi-VN'), {
                x: 0.5, y: 4.5, w: 9, h: 0.3,
                fontSize: 14, color: 'FFFFFF', align: 'center', italic: true
            });
            
            // Slide 2: KPIs
            const slide2 = pptx.addSlide();
            slide2.addText('üìà T·ªïng Quan Doanh S·ªë', {
                x: 0.5, y: 0.3, w: 9, h: 0.5,
                fontSize: 32, bold: true, color: '1e293b'
            });
            
            const kpiData = [
                ['Ch·ªâ S·ªë', 'Gi√° Tr·ªã'],
                ['T·ªïng Doanh S·ªë', document.getElementById('totalSales').textContent],
                ['T·ªïng S·ªë ƒê∆°n H√†ng', document.getElementById('totalOrders').textContent],
                ['Gi√° Tr·ªã TB/ƒê∆°n', document.getElementById('avgOrderValue').textContent],
                ['S·ªë S·∫£n Ph·∫©m', document.getElementById('totalProducts').textContent],
                ['S·ªë H·ªá Th·ªëng', document.getElementById('totalSystems').textContent],
                ['S·ªë Nh√£n H√†ng', document.getElementById('totalBrands').textContent],
                ['C·ª≠a H√†ng Ho·∫°t ƒê·ªông', document.getElementById('activeStores').textContent]
            ];
            
            slide2.addTable(kpiData, {
                x: 1.0, y: 1.2, w: 8, h: 3.5,
                fontSize: 16,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' },
                fontFace: 'Arial'
            });
            
            // Slide 3: Sales Trend Chart
            if (charts.salesTrend) {
                const slide3 = pptx.addSlide();
                slide3.addText('üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.salesTrend.toBase64Image();
                slide3.addImage({ data: chartImage, x: 0.5, y: 1.0, w: 9, h: 4.5 });
            }
            
            // Slide 4: System Chart
            if (charts.system) {
                const slide4 = pptx.addSlide();
                slide4.addText('üè¢ Doanh S·ªë Theo H·ªá Th·ªëng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.system.toBase64Image();
                slide4.addImage({ data: chartImage, x: 1.5, y: 1.0, w: 7, h: 4.5 });
            }
            
            // Slide 5: Brand Trend Chart
            if (charts.brandTrend) {
                const slide5 = pptx.addSlide();
                slide5.addText('üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.brandTrend.toBase64Image();
                slide5.addImage({ data: chartImage, x: 0.5, y: 1.0, w: 9, h: 4.5 });
            }
            
            // Slide 6: Year Comparison
            if (charts.yearComparison) {
                const slide6 = pptx.addSlide();
                slide6.addText('üìä So S√°nh Doanh S·ªë Theo NƒÉm', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.yearComparison.toBase64Image();
                slide6.addImage({ data: chartImage, x: 1.0, y: 1.0, w: 8, h: 4.5 });
            }
            
            // Slide 7: Growth Analysis
            const slide7 = pptx.addSlide();
            slide7.addText('üìä Ph√¢n T√≠ch TƒÉng Tr∆∞·ªüng 2024 vs 2025', {
                x: 0.5, y: 0.3, w: 9, h: 0.5,
                fontSize: 28, bold: true, color: '1e293b'
            });
            
            // Top growth SKUs
            const growthSKURows = Array.from(document.getElementById('topGrowthSKUTableBody').rows).slice(0, 5);
            const growthSKUData = [['#', 'M√£ H√†ng', 'TƒÉng']];
            growthSKURows.forEach(row => {
                const cells = row.cells;
                if (cells.length >= 3) {
                    growthSKUData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[4].textContent.replace(/\n/g, ' ')
                    ]);
                }
            });
            
            slide7.addText('üìà Top 5 M√£ H√†ng TƒÉng Tr∆∞·ªüng', {
                x: 0.5, y: 1.0, w: 4.5, h: 0.3,
                fontSize: 14, bold: true, color: '10b981'
            });
            slide7.addTable(growthSKUData, {
                x: 0.5, y: 1.4, w: 4.5, h: 2.0,
                fontSize: 11,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' }
            });
            
            // Top decline SKUs
            const declineSKURows = Array.from(document.getElementById('topDeclineSKUTableBody').rows).slice(0, 5);
            const declineSKUData = [['#', 'M√£ H√†ng', 'Gi·∫£m']];
            declineSKURows.forEach(row => {
                const cells = row.cells;
                if (cells.length >= 3) {
                    declineSKUData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[4].textContent.replace(/\n/g, ' ')
                    ]);
                }
            });
            
            slide7.addText('üìâ Top 5 M√£ H√†ng Gi·∫£m', {
                x: 5.5, y: 1.0, w: 4.5, h: 0.3,
                fontSize: 14, bold: true, color: 'ef4444'
            });
            slide7.addTable(declineSKUData, {
                x: 5.5, y: 1.4, w: 4.5, h: 2.0,
                fontSize: 11,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' }
            });
            
            // Save the presentation
            const fileName = `BaoCao_DoanSo_${new Date().toISOString().slice(0,10)}.pptx`;
            await pptx.writeFile({ fileName: fileName });
            
            alert('‚úÖ ƒê√£ t·∫£i xu·ªëng file PowerPoint: ' + fileName);
        }

        // Order Frequency Analysis
        function analyzeOrderFrequency() {
            if (!allData || allData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch');
                return;
            }

            // Group data by system and month to analyze individual patterns
            const systemData = {};
            const allMonths = [...new Set(allData.map(row => row.monthKey))].sort();

            // Build detailed data for each system
            allData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || 'Unknown';
                const month = row.monthKey;
                const sales = row.vat || 0;
                
                if (!systemData[system]) {
                    systemData[system] = {
                        monthlyOrders: {},
                        monthlySales: {},
                        totalMonths: 0,
                        activePeriods: []
                    };
                }
                
                if (!systemData[system].monthlyOrders[month]) {
                    systemData[system].monthlyOrders[month] = 0;
                    systemData[system].monthlySales[month] = 0;
                }
                
                systemData[system].monthlyOrders[month]++;
                systemData[system].monthlySales[month] += sales;
            });

            // Analyze each system individually
            const systemAnalysis = [];
            let totalAbnormalSystems = 0;

            Object.entries(systemData).forEach(([system, data]) => {
                const months = Object.keys(data.monthlyOrders);
                const orderCounts = Object.values(data.monthlyOrders);
                const salesValues = Object.values(data.monthlySales);
                
                if (months.length < 3) return; // Skip systems with too little data
                
                // Calculate system's own baseline (historical average)
                const avgOrdersPerMonth = orderCounts.reduce((a, b) => a + b, 0) / orderCounts.length;
                const avgSalesPerMonth = salesValues.reduce((a, b) => a + b, 0) / salesValues.length;
                
                // Calculate standard deviation for this system
                const orderVariance = orderCounts.reduce((sum, count) => sum + Math.pow(count - avgOrdersPerMonth, 2), 0) / orderCounts.length;
                const orderStdDev = Math.sqrt(orderVariance);
                
                const salesVariance = salesValues.reduce((sum, sales) => sum + Math.pow(sales - avgSalesPerMonth, 2), 0) / salesValues.length;
                const salesStdDev = Math.sqrt(salesVariance);
                
                // Define thresholds based on system's own pattern (¬±2œÉ)
                const orderLowerThreshold = Math.max(0, avgOrdersPerMonth - 2 * orderStdDev);
                const orderUpperThreshold = avgOrdersPerMonth + 2 * orderStdDev;
                
                // Find abnormal months for this system
                const abnormalMonths = [];
                months.forEach((month, idx) => {
                    const orders = orderCounts[idx];
                    const sales = salesValues[idx];
                    
                    if (orders < orderLowerThreshold || orders > orderUpperThreshold) {
                        abnormalMonths.push({
                            month,
                            orders,
                            sales,
                            deviation: Math.abs(orders - avgOrdersPerMonth) / (orderStdDev || 1)
                        });
                    }
                });
                
                // Analyze trends (last 3 months vs previous average)
                const recentMonths = months.slice(-3);
                const recentOrders = recentMonths.map(m => data.monthlyOrders[m]);
                const recentAvg = recentOrders.reduce((a, b) => a + b, 0) / recentOrders.length;
                
                const earlierMonths = months.slice(0, -3);
                const earlierOrders = earlierMonths.map(m => data.monthlyOrders[m]);
                const earlierAvg = earlierOrders.length > 0 ? 
                    earlierOrders.reduce((a, b) => a + b, 0) / earlierOrders.length : avgOrdersPerMonth;
                
                // Determine system status
                let status = 'normal';
                let issues = [];
                let suggestions = [];
                
                if (abnormalMonths.length > months.length * 0.3) {
                    status = 'abnormal';
                    issues.push('Pattern kh√¥ng ·ªïn ƒë·ªãnh');
                    suggestions.push('Ki·ªÉm tra quy tr√¨nh ƒë·∫∑t h√†ng v√† k·∫ø ho·∫°ch kinh doanh');
                }
                
                if (recentAvg < earlierAvg * 0.7) {
                    status = 'abnormal';
                    issues.push('Gi·∫£m t·∫ßn su·∫•t g·∫ßn ƒë√¢y');
                    suggestions.push('Ki·ªÉm tra t√¨nh tr·∫°ng kinh doanh, c√≥ th·ªÉ c√≥ v·∫•n ƒë·ªÅ v·ªÅ d√≤ng ti·ªÅn');
                }
                
                if (recentAvg > earlierAvg * 1.5) {
                    status = 'abnormal';
                    issues.push('TƒÉng ƒë·ªôt bi·∫øn g·∫ßn ƒë√¢y');
                    suggestions.push('Ki·ªÉm tra kh·∫£ nƒÉng t·ªìn kho, c√≥ th·ªÉ c·∫ßn t·ªëi ∆∞u h√≥a k·∫ø ho·∫°ch ƒë·∫∑t h√†ng');
                }
                
                // Check for zero-order months
                const zeroMonths = months.filter(m => data.monthlyOrders[m] === 0);
                if (zeroMonths.length > 0) {
                    status = 'abnormal';
                    issues.push(`${zeroMonths.length} th√°ng kh√¥ng ƒë·∫∑t h√†ng`);
                    suggestions.push('Ki·ªÉm tra t√¨nh tr·∫°ng ho·∫°t ƒë·ªông c·ªßa h·ªá th·ªëng');
                }
                
                if (status === 'abnormal') {
                    totalAbnormalSystems++;
                }
                
                systemAnalysis.push({
                    system,
                    avgOrdersPerMonth: avgOrdersPerMonth.toFixed(1),
                    avgSalesPerMonth: avgSalesPerMonth,
                    totalMonths: months.length,
                    abnormalMonths: abnormalMonths.length,
                    recentTrend: ((recentAvg - earlierAvg) / earlierAvg * 100).toFixed(1),
                    status,
                    issues: issues.join(', '),
                    suggestions: suggestions.join(' | '),
                    stability: orderStdDev < avgOrdersPerMonth * 0.3 ? '·ªîn ƒë·ªãnh' : 'Bi·∫øn ƒë·ªông',
                    lastMonthOrders: data.monthlyOrders[months[months.length - 1]] || 0
                });
            });

            // Update UI
            document.getElementById('totalSystems').textContent = systemAnalysis.length;
            document.getElementById('avgOrdersPerMonth').textContent = 
                (systemAnalysis.reduce((sum, s) => sum + parseFloat(s.avgOrdersPerMonth), 0) / systemAnalysis.length).toFixed(1);
            document.getElementById('abnormalSystems').textContent = totalAbnormalSystems;
            document.getElementById('systemsNeedCheck').textContent = totalAbnormalSystems;

            // Show/hide alert
            const alertDiv = document.getElementById('abnormalAlert');
            if (totalAbnormalSystems > 0) {
                alertDiv.style.display = 'block';
            } else {
                alertDiv.style.display = 'none';
            }

            // Separate normal and abnormal systems
            const normalSystems = systemAnalysis.filter(s => s.status === 'normal');
            const abnormalSystems = systemAnalysis.filter(s => s.status === 'abnormal');

            // Populate normal systems table
            const normalTableBody = document.getElementById('normalSystemsTableBody');
            normalTableBody.innerHTML = '';
            normalSystems
                .sort((a, b) => parseFloat(b.avgOrdersPerMonth) - parseFloat(a.avgOrdersPerMonth))
                .forEach((stat, idx) => {
                    const row = `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>
                                <span style="cursor: pointer; color: #3b82f6; font-weight: 600; text-decoration: underline;" 
                                      onclick="drillDownToSystem('${stat.system.replace(/'/g, "\\'")}')" 
                                      title="Click ƒë·ªÉ xem chi ti·∫øt SKU">
                                    ${stat.system}
                                </span>
                            </td>
                            <td class="number">${stat.avgOrdersPerMonth}</td>
                            <td class="number">
                                <span style="color: #10b981; font-weight: 600;">‚úì ${stat.stability}</span>
                            </td>
                            <td style="text-align: center;">
                                <button onclick="drillDownToSystem('${stat.system.replace(/'/g, "\\'")}')" style="
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 0.8em;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'"
                                   title="Xem chi ti·∫øt s·∫£n ph·∫©m">
                                    üëÅÔ∏è Xem SKU
                                </button>
                            </td>
                        </tr>
                    `;
                    normalTableBody.innerHTML += row;
                });

            // Populate abnormal systems table
            const abnormalTableBody = document.getElementById('abnormalSystemsTableBody');
            abnormalTableBody.innerHTML = '';
            abnormalSystems
                .sort((a, b) => b.abnormalMonths - a.abnormalMonths)
                .forEach((stat, idx) => {
                    const severityColor = stat.abnormalMonths > stat.totalMonths * 0.5 ? '#dc2626' : '#f59e0b';
                    const row = `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>
                                <span style="cursor: pointer; color: #3b82f6; font-weight: 600; text-decoration: underline;" 
                                      onclick="drillDownToSystem('${stat.system.replace(/'/g, "\\'")}')" 
                                      title="Click ƒë·ªÉ xem chi ti·∫øt SKU">
                                    ${stat.system}
                                </span>
                            </td>
                            <td class="number" style="color: ${severityColor}; font-weight: 600;">${stat.avgOrdersPerMonth}</td>
                            <td class="number" style="color: ${severityColor}; font-weight: 600;">${stat.issues}</td>
                            <td style="font-size: 0.85em; max-width: 200px;">${stat.suggestions}</td>
                            <td style="text-align: center;">
                                <button onclick="drillDownToSystem('${stat.system.replace(/'/g, "\\'")}')" style="
                                    background: #ef4444;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 0.8em;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'"
                                   title="Ph√¢n t√≠ch chi ti·∫øt theo SKU">
                                    üîç Chi Ti·∫øt
                                </button>
                            </td>
                        </tr>
                    `;
                    abnormalTableBody.innerHTML += row;
                });

            // Show results
            document.getElementById('orderFrequencyResults').style.display = 'block';
            
            // Scroll to results
            document.getElementById('orderFrequencyAnalysis').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });

            console.log('üìä Individual System Analysis Complete:', {
                totalSystems: systemAnalysis.length,
                normalSystems: normalSystems.length,
                abnormalSystems: abnormalSystems.length,
                analysisMethod: 'Individual system historical pattern analysis'
            });
        }

        // ==========================================
        // ORDER FREQUENCY DRILL-DOWN FUNCTIONS
        // ==========================================
        
        // Open system-level drill-down
        function drillDownToSystem(systemName) {
            console.log('drillDownToSystem called with:', systemName);
            currentDrillState.level = 'system';
            currentDrillState.systemName = systemName;
            currentDrillState.skuName = null;
            
            // Update modal title and breadcrumb
            document.getElementById('drillModalTitle').textContent = `üîç Ph√¢n T√≠ch SKU - ${systemName}`;
            document.getElementById('drillBreadcrumb').innerHTML = `
                <span onclick="backToDrillOverview()" style="color: #3b82f6; cursor: pointer; text-decoration: underline;">üìä T·ªïng Quan</span>
                <span style="margin: 0 8px; color: #9ca3af;">‚Ä∫</span>
                <span style="color: #374151; font-weight: 600;">${systemName}</span>
            `;
            
            // Show system level content
            document.getElementById('systemLevelContent').style.display = 'block';
            document.getElementById('skuLevelContent').style.display = 'none';
            
            // Analyze SKU data for this system
            analyzeSKUData(systemName);
            
            // Show modal
            document.getElementById('orderFrequencyDrillModal').style.display = 'block';
        }

        // Analyze SKU-level data for a specific system
        function analyzeSKUData(systemName) {
            console.log('analyzeSKUData called with:', systemName);
            const skuAnalysis = [];
            const systemData = {};
            
            // Collect all SKU data for this system
            console.log('allData length:', allData.length);
            console.log('Sample row:', allData[0]);
            let matchedRows = 0;
            
            allData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG']?.trim();
                const product = row['T√äN SP']?.trim();
                const store = row['MA KH']?.trim();
                const month = row.monthKey;
                const quantity = parseFloat(row.soLuong) || 0;
                
                if (system === systemName && product && store && quantity > 0) {
                    matchedRows++;
                    if (!systemData[product]) {
                        systemData[product] = {};
                    }
                    if (!systemData[product][month]) {
                        systemData[product][month] = 0;
                    }
                    systemData[product][month] += quantity;
                }
            });
            
            console.log('Matched rows for system', systemName, ':', matchedRows);
            console.log('Products found:', Object.keys(systemData).length);

            // Analyze each SKU's trend
            Object.keys(systemData).forEach(product => {
                const monthlyData = systemData[product];
                const months = Object.keys(monthlyData).sort();
                const quantities = months.map(m => monthlyData[m]);
                
                if (months.length >= 3) { // Need at least 3 months of data
                    const totalQty = quantities.reduce((a, b) => a + b, 0);
                    const avgQty = totalQty / quantities.length;
                    
                    // Recent vs earlier comparison
                    const recentMonths = months.slice(-3);
                    const recentQty = recentMonths.map(m => monthlyData[m]);
                    const recentAvg = recentQty.reduce((a, b) => a + b, 0) / recentQty.length;
                    
                    const earlierMonths = months.slice(0, -3);
                    const earlierQty = earlierMonths.length > 0 ? 
                        earlierMonths.map(m => monthlyData[m]) : [];
                    const earlierAvg = earlierQty.length > 0 ? 
                        earlierQty.reduce((a, b) => a + b, 0) / earlierQty.length : recentAvg;
                    
                    const changePercent = earlierAvg > 0 ? ((recentAvg - earlierAvg) / earlierAvg * 100) : 0;
                    
                    // Calculate volatility
                    const variance = quantities.reduce((sum, qty) => sum + Math.pow(qty - avgQty, 2), 0) / quantities.length;
                    const stdDev = Math.sqrt(variance);
                    const volatility = avgQty > 0 ? (stdDev / avgQty * 100) : 0;
                    
                    // Determine trend and level
                    let trend = '‚Üí';
                    let level = 'normal';
                    if (Math.abs(changePercent) > 50) level = 'high';
                    else if (Math.abs(changePercent) > 25) level = 'medium';
                    
                    if (changePercent > 15) trend = 'üìà';
                    else if (changePercent < -15) trend = 'üìâ';
                    
                    skuAnalysis.push({
                        product: shortenProductName(product),
                        fullProduct: product,
                        earlierAvg,
                        recentAvg,
                        changePercent,
                        trend,
                        level,
                        totalQty,
                        volatility,
                        monthCount: months.length
                    });
                }
            });

            // Sort by absolute change percentage
            skuAnalysis.sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
            
            // Update summary cards
            const increasing = skuAnalysis.filter(s => s.changePercent > 15);
            const decreasing = skuAnalysis.filter(s => s.changePercent < -15);
            const abnormal = skuAnalysis.filter(s => Math.abs(s.changePercent) > 25);
            
            console.log('SKU Analysis Summary:', {
                total: skuAnalysis.length,
                increasing: increasing.length,
                decreasing: decreasing.length,
                abnormal: abnormal.length
            });
            
            document.getElementById('totalSKUCount').textContent = skuAnalysis.length;
            document.getElementById('increasingSKUCount').textContent = increasing.length;
            document.getElementById('decreasingSKUCount').textContent = decreasing.length;
            document.getElementById('abnormalSKUCount').textContent = abnormal.length;
            
            // Populate SKU table
            const tbody = document.getElementById('skuAnalysisTableBody');
            tbody.innerHTML = '';
            
            skuAnalysis.forEach((sku, index) => {
                const levelColors = {
                    'normal': '#f3f4f6',
                    'medium': '#fef3c7',
                    'high': '#fee2e2'
                };
                
                const levelLabels = {
                    'normal': 'Th∆∞·ªùng',
                    'medium': 'Trung B√¨nh',
                    'high': 'Cao'
                };
                
                const row = `
                    <tr style="background: ${levelColors[sku.level]}; border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; text-align: center; font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px; max-width: 250px; word-wrap: break-word;">
                            <strong>${sku.product}</strong>
                            <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                                ${sku.monthCount} th√°ng data ‚Ä¢ T·ªïng: ${formatNumber(sku.totalQty)}
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">${formatNumber(Math.round(sku.earlierAvg))}</td>
                        <td style="padding: 12px; text-align: center;">${formatNumber(Math.round(sku.recentAvg))}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${sku.changePercent > 0 ? '#059669' : '#dc2626'};">
                            ${sku.changePercent > 0 ? '+' : ''}${sku.changePercent.toFixed(1)}%
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 1.2em;">${sku.trend}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 0.8em;
                                font-weight: 600;
                                background: ${sku.level === 'high' ? '#fee2e2' : sku.level === 'medium' ? '#fef3c7' : '#f0f9ff'};
                                color: ${sku.level === 'high' ? '#991b1b' : sku.level === 'medium' ? '#92400e' : '#1e40af'};
                            ">${levelLabels[sku.level]}</span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="drillDownToSKU('${systemName}', '${sku.fullProduct.replace(/'/g, "\\'")}')" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.8em;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                üëÅÔ∏è Xem CH
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Store data for potential further drill-down
            currentDrillState.data.skus = skuAnalysis;
            
            // Create SKU chart in system drill modal
            const chartData = skuAnalysis.slice(0, 20).map(sku => [sku.fullProduct, { 
                revenue: sku.totalQty * 1000, // Approximate revenue 
                quantity: sku.totalQty 
            }]);
            
            createSKUChart(chartData, 'system', 'skuAnalysisSystemChart');
            console.log('‚úÖ Called createSKUChart for system drill-down modal with', chartData.length, 'SKUs');
        }

        // Open SKU-level drill-down (store analysis)
        function drillDownToSKU(systemName, skuName) {
            currentDrillState.level = 'sku';
            currentDrillState.systemName = systemName;
            currentDrillState.skuName = skuName;

            const shortName = shortenProductName(skuName);

            // Update modal title and breadcrumb
            document.getElementById('drillModalTitle').textContent = `üè™ Ph√¢n T√≠ch C·ª≠a H√†ng - ${shortName}`;
            document.getElementById('drillBreadcrumb').innerHTML = `
                <span onclick="backToDrillOverview()" style="color: #3b82f6; cursor: pointer; text-decoration: underline;">üìä T·ªïng Quan</span>
                <span style="margin: 0 8px; color: #9ca3af;">‚Ä∫</span>
                <span onclick="drillDownToSystem('${systemName}')" style="color: #3b82f6; cursor: pointer; text-decoration: underline;">${systemName}</span>
                <span style="margin: 0 8px; color: #9ca3af;">‚Ä∫</span>
                <span style="color: #374151; font-weight: 600;">${shortName}</span>
            `;

            // Show SKU level content
            document.getElementById('systemLevelContent').style.display = 'none';
            document.getElementById('skuLevelContent').style.display = 'block';

            // Ph√¢n t√≠ch v√† hi·ªÉn th·ªã b·∫£ng c·ª≠a h√†ng t·ª± ƒë·ªông
            populateStoreAnalysisTable(systemName, skuName);
        }

        // Analyze store-level data for a specific SKU
        function analyzeStoreData(systemName, skuName) {
            const storeAnalysis = [];
            const storeData = {};
            
            // Collect store data for this SKU
            allData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG']?.trim();
                const product = row['T√äN SP']?.trim();
                const store = row['MA KH']?.trim();
                const month = row.monthKey;
                const quantity = parseFloat(row.soLuong) || 0;
                
                if (system === systemName && product === skuName && store && quantity > 0) {
                    if (!storeData[store]) {
                        storeData[store] = {};
                    }
                    if (!storeData[store][month]) {
                        storeData[store][month] = 0;
                    }
                    storeData[store][month] += quantity;
                }
            });

            // Analyze each store's performance
            Object.keys(storeData).forEach(store => {
                const monthlyData = storeData[store];
                const months = Object.keys(monthlyData).sort();
                const quantities = months.map(m => monthlyData[m]);
                
                if (months.length >= 2) { // Need at least 2 months of data
                    const totalQty = quantities.reduce((a, b) => a + b, 0);
                    const avgQty = totalQty / quantities.length;
                    const orderFreq = months.length; // Number of months with orders
                    
                    // Recent vs earlier comparison
                    const recentMonths = months.slice(-2);
                    const recentQty = recentMonths.map(m => monthlyData[m]);
                    const recentAvg = recentQty.reduce((a, b) => a + b, 0) / recentQty.length;
                    const recentFreq = recentMonths.length;
                    
                    const earlierMonths = months.slice(0, -2);
                    const earlierQty = earlierMonths.length > 0 ? 
                        earlierMonths.map(m => monthlyData[m]) : [];
                    const earlierAvg = earlierQty.length > 0 ? 
                        earlierQty.reduce((a, b) => a + b, 0) / earlierQty.length : recentAvg;
                    const earlierFreq = earlierMonths.length;
                    
                    const changePercent = earlierAvg > 0 ? ((recentAvg - earlierAvg) / earlierAvg * 100) : 0;
                    
                    // Determine trend and recommendation
                    let trend = '‚Üí';
                    let recommendation = '‚úÖ Duy tr√¨ hi·ªán t·∫°i';
                    
                    if (changePercent > 30) {
                        trend = 'üìà';
                        recommendation = 'üéØ Hi·ªáu qu·∫£ cao - C√≥ th·ªÉ tƒÉng stock';
                    } else if (changePercent > 10) {
                        trend = 'üìà';
                        recommendation = '‚úÖ TƒÉng tr∆∞·ªüng ·ªïn ƒë·ªãnh';
                    } else if (changePercent < -30) {
                        trend = 'üìâ';
                        recommendation = '‚ö†Ô∏è Gi·∫£m m·∫°nh - C·∫ßn ki·ªÉm tra nguy√™n nh√¢n';
                    } else if (changePercent < -10) {
                        trend = 'üìâ';
                        recommendation = '‚ö†Ô∏è Gi·∫£m nh·∫π - Theo d√µi th√™m';
                    }
                    
                    // Low frequency warning
                    if (orderFreq <= 2 && avgQty < 10) {
                        recommendation = 'üîç T·∫ßn su·∫•t th·∫•p - C√≥ th·ªÉ ng∆∞ng cung c·∫•p';
                    }
                    
                    storeAnalysis.push({
                        store,
                        earlierFreq,
                        recentFreq,
                        changePercent,
                        totalQty,
                        avgQty,
                        orderFreq,
                        trend,
                        recommendation,
                        monthCount: months.length
                    });
                }
            });

            // Sort by change percentage (descending)
            storeAnalysis.sort((a, b) => b.changePercent - a.changePercent);
            
            // Update summary cards
            const activeStores = storeAnalysis.length;
            const topStores = storeAnalysis.filter(s => s.changePercent > 20).length;
            const lowStores = storeAnalysis.filter(s => s.changePercent < -20 || s.orderFreq <= 2).length;
            const avgFreq = activeStores > 0 ? storeAnalysis.reduce((sum, s) => sum + s.orderFreq, 0) / activeStores : 0;
            
            document.getElementById('activeStoreCount').textContent = activeStores;
            document.getElementById('topStoreCount').textContent = topStores;
            document.getElementById('lowStoreCount').textContent = lowStores;
            document.getElementById('avgOrderFreq').textContent = avgFreq.toFixed(1);
            
            // Populate store table
            const tbody = document.getElementById('storeAnalysisTableBody');
            tbody.innerHTML = '';
            
            storeAnalysis.forEach((store, index) => {
                const rowColor = store.changePercent > 20 ? '#ecfdf5' : 
                                 store.changePercent < -20 ? '#fef2f2' : 
                                 store.orderFreq <= 2 ? '#fefbf2' : '#ffffff';
                
                const row = `
                    <tr style="background: ${rowColor}; border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; text-align: center; font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px;">
                            <strong>${store.store}</strong>
                            <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                                ${store.monthCount} th√°ng ‚Ä¢ TB: ${formatNumber(Math.round(store.avgQty))}/th√°ng
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">${store.earlierFreq}</td>
                        <td style="padding: 12px; text-align: center;">${store.recentFreq}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${store.changePercent > 0 ? '#059669' : '#dc2626'};">
                            ${store.changePercent > 0 ? '+' : ''}${store.changePercent.toFixed(1)}%
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;">
                            ${formatNumber(store.totalQty)}
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 1.2em;">${store.trend}</td>
                        <td style="padding: 12px; font-size: 0.85em; max-width: 200px;">${store.recommendation}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Store data for reference
            currentDrillState.data.stores = storeAnalysis;
            
            // Update SKU level summary cards
            const skuTopStores = storeAnalysis.filter(s => s.changePercent > 15);
            const skuLowStores = storeAnalysis.filter(s => s.changePercent < -15);
            const skuAvgFreq = storeAnalysis.length > 0 ? 
                storeAnalysis.reduce((sum, s) => sum + s.avgQty, 0) / storeAnalysis.length : 0;
            
            document.getElementById('skuActiveStoreCount').textContent = storeAnalysis.length;
            document.getElementById('skuAvgOrderFreq').textContent = skuAvgFreq.toFixed(1);
            document.getElementById('skuTopStoreCount').textContent = skuTopStores.length;
            document.getElementById('skuLowStoreCount').textContent = skuLowStores.length;
            
            // Create store chart
            const chartData = storeAnalysis.slice(0, 15).map(store => [store.store, { 
                revenue: store.totalQty * 1500, // Approximate revenue per unit
                quantity: store.totalQty 
            }]);
            
            createSKUChart(chartData, 'store', 'storeAnalysisChart');
            console.log('‚úÖ Created store analysis chart with', chartData.length, 'stores');
        }

        // Navigation functions
        function backToDrillOverview() {
            document.getElementById('orderFrequencyDrillModal').style.display = 'none';
            currentDrillState.level = 'overview';
            currentDrillState.systemName = null;
            currentDrillState.skuName = null;
        }

        function closeOrderFrequencyDrill() {
            document.getElementById('orderFrequencyDrillModal').style.display = 'none';
            currentDrillState.level = 'overview';
            currentDrillState.systemName = null;
            currentDrillState.skuName = null;
        }

        // ==========================================
        // SKU ANALYSIS FUNCTIONS
        // ==========================================
        
        let skuModalChart = null;
        
        // Show SKU analysis for selected system
        function showSystemDrillDown(systemName, overrideData) {
            console.log('showSystemDrillDown called with:', systemName);
            // ∆Øu ti√™n d·ªØ li·ªáu ƒë∆∞·ª£c truy·ªÅn tr·ª±c ti·∫øp (v√≠ d·ª•: yearData, monthData, brandData)
            // Sau ƒë√≥ t·ªõi currentDrillDownContext (year / month / brand / product)
            // Cu·ªëi c√πng m·ªõi t·ªõi currentFilteredData ho·∫∑c allData
            let baseData = overrideData;

            if (!baseData && currentDrillDownContext && currentDrillDownContext.baseData && currentDrillDownContext.baseData.length) {
                const ctxType = currentDrillDownContext.type;
                if (ctxType === 'year' || ctxType === 'month' || ctxType === 'brand' || ctxType === 'product') {
                    baseData = currentDrillDownContext.baseData;
                }
            }

            if (!baseData || baseData.length === 0) {
                baseData = currentFilteredData.length > 0 ? currentFilteredData : allData;
            }

            // √Åp th√™m c√°c r√†ng bu·ªôc theo context (nƒÉm / nh√£n h√†ng / s·∫£n ph·∫©m) n·∫øu c√≥
            if (currentDrillDownContext) {
                if (currentDrillDownContext.type === 'year' && currentDrillDownContext.year) {
                    baseData = baseData.filter(row => row.year === currentDrillDownContext.year);
                }
                if (currentDrillDownContext.type === 'brand' && currentDrillDownContext.name) {
                    baseData = baseData.filter(row => row['NH√ÉN H√ÄNG'] === currentDrillDownContext.name);
                }
                if (currentDrillDownContext.type === 'product' && currentDrillDownContext.name) {
                    baseData = baseData.filter(row => shortenProductName(row['T√äN SP']) === currentDrillDownContext.name);
                }
            }

            // #region agent log
            console.log('[DEBUG showSystemDrillDown] baseData stats', {
                systemName,
                rows: baseData.length,
                years: [...new Set(baseData.map(d => d.year))],
                brands: [...new Set(baseData.map(d => d['NH√ÉN H√ÄNG']))],
                monthKeys: [...new Set(baseData.map(d => d.monthKey))].slice(0, 6),
                contextType: currentDrillDownContext ? currentDrillDownContext.type : null
            });
            // #endregion
            const systemData = {};
            
            // Collect all SKU data for this system
            baseData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG']?.trim();
                const product = row['T√äN SP']?.trim();
                const quantity = parseFloat(row.soLuong) || 0;
                const revenue = parseFloat(row.vat) || 0;
                
                if (system === systemName && product) {
                    if (!systemData[product]) {
                        systemData[product] = {
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    systemData[product].quantity += quantity;
                    systemData[product].revenue += revenue;
                }
            });
            
            console.log('systemData collected:', Object.keys(systemData).length, 'products');
            
            // Sort by revenue
            const sortedProducts = Object.entries(systemData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 20); // Top 20 SKUs
            
            console.log('sortedProducts:', sortedProducts.length, 'items');
            
            if (sortedProducts.length === 0) {
                alert(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu SKU cho h·ªá th·ªëng: ${systemName}`);
                return;
            }
            
            // Update modal title
            document.getElementById('skuModalTitle').textContent = `üè¢ SKU Trong H·ªá Th·ªëng: ${systemName}`;
            
            // Create chart
            createSKUChart(sortedProducts, 'system');
            
            // Populate table
            populateSKUTable(sortedProducts);
            
            // Show modal
            document.getElementById('skuAnalysisModal').style.display = 'block';
        }
        
        // Show SKU analysis for selected brand (duplicate function - using filtered data)
        function showBrandDrillDownSKU(brandName) {
            console.log('showBrandDrillDownSKU called with:', brandName);
            // Use current filtered data if available, otherwise use allData
            const baseData = currentFilteredData.length > 0 ? currentFilteredData : allData;
            const brandData = {};
            
            // Collect all SKU data for this brand
            baseData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG']?.trim();
                const product = row['T√äN SP']?.trim();
                const quantity = parseFloat(row.soLuong) || 0;
                const revenue = parseFloat(row.vat) || 0;
                
                if (brand === brandName && product) {
                    if (!brandData[product]) {
                        brandData[product] = {
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    brandData[product].quantity += quantity;
                    brandData[product].revenue += revenue;
            // Log systemData after collect
            console.log('systemData:', systemData);
                }
            });
            
            console.log('brandData collected:', Object.keys(brandData).length, 'products');
            
            // Sort by revenue
            const sortedProducts = Object.entries(brandData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 20); // Top 20 SKUs
            
            if (sortedProducts.length === 0) {
                alert(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu SKU cho nh√£n h√†ng: ${brandName}`);
                return;
            }
            
            // Update modal title
            document.getElementById('skuModalTitle').textContent = `üè∑Ô∏è SKU Trong Nh√£n H√†ng: ${brandName}`;
            
            // Create chart
            createSKUChart(sortedProducts, 'brand');
            
            // Populate table
            populateSKUTable(sortedProducts);
            
            // Show modal
            document.getElementById('skuAnalysisModal').style.display = 'block';
        }
        
        // Create SKU chart
        function createSKUChart(sortedProducts, type, canvasId = 'skuAnalysisChart') {
            console.log('createSKUChart called with:', sortedProducts.length, 'products, type:', type, 'canvas:', canvasId);
            console.log('createSKUChart input sortedProducts:', sortedProducts);
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas ${canvasId} not found!`);
                return;
            }
            const context = ctx.getContext('2d');

            // Destroy existing chart for this canvas
            if (skuModalChart && canvasId === 'skuAnalysisChart') {
                skuModalChart.destroy();
            } else if (window.skuSystemChart && canvasId === 'skuAnalysisSystemChart') {
                window.skuSystemChart.destroy();
            } else if (window.storeChart && canvasId === 'storeAnalysisChart') {
                window.storeChart.destroy();
            }

            // G·ªôp d·ªØ li·ªáu theo t√™n r√∫t g·ªçn
            const skuMap = new Map();
            sortedProducts.forEach(([name, info]) => {
                const shortName = shortenProductName(name);
                if (!skuMap.has(shortName)) {
                    skuMap.set(shortName, { quantity: 0, revenue: 0 });
                }
                skuMap.get(shortName).quantity += info.quantity;
                skuMap.get(shortName).revenue += info.revenue;
            });

            const chartType = (type === 'brand' || type === 'store' || type === 'system') ? 'bar' : 'doughnut';

            const colors = type === 'brand' ? 
                ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3',
                 '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#a8e6cf', '#dcedc1', '#ffd3a5', '#fd9853', '#c2e9fb', '#a1c4fd'] :
                ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3',
                 '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#a8e6cf', '#dcedc1', '#ffd3a5', '#fd9853', '#c2e9fb', '#a1c4fd'];

            const skuEntries = Array.from(skuMap.entries());

            const chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: skuEntries.map(([shortName]) => shortName),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: skuEntries.map(([_, info]) => info.revenue),
                        backgroundColor: chartType === 'bar' ? '#667eea' : colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: chartType === 'bar' ? 'y' : undefined,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0 && canvasId === 'skuAnalysisSystemChart') {
                            const index = activeElements[0].index;
                            const productName = sortedProducts[index][0];
                            console.log('SKU chart clicked:', productName);
                            // Trigger drill down to store level
                            drillDownToSKU(currentDrillState.systemName, productName);
                        }
                    },
                    plugins: {
                        legend: {
                            display: chartType === 'doughnut',
                            position: chartType === 'doughnut' ? 'right' : undefined
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    
                                    // L·∫•y gi√° tr·ªã numeric t·ª´ context.parsed (c√≥ th·ªÉ l√† object {x,y})
                                    let parsedValue = context.parsed;
                                    if (parsedValue && typeof parsedValue === 'object') {
                                        if (typeof parsedValue.x === 'number') {
                                            parsedValue = parsedValue.x;
                                        } else if (typeof parsedValue.y === 'number') {
                                            parsedValue = parsedValue.y;
                                        }
                                    }
                                    if (typeof parsedValue !== 'number' || !isFinite(parsedValue)) {
                                        parsedValue = 0;
                                    }

                                    const percentage = chartType === 'doughnut' && total > 0
                                        ? ` (${((parsedValue / total) * 100).toFixed(1)}%)`
                                        : '';

                                    const prefix = chartType === 'bar'
                                        ? 'Doanh s·ªë: '
                                        : context.label + ': ';

                                    return prefix + formatCurrency(parsedValue) + percentage;
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    } : undefined
                }
            });
            
            // Store chart reference based on canvas
            if (canvasId === 'skuAnalysisChart') {
                skuModalChart = chart;
            } else if (canvasId === 'skuAnalysisSystemChart') {
                window.skuSystemChart = chart;
            } else if (canvasId === 'storeAnalysisChart') {
                window.storeChart = chart;
            }
            
            console.log(`‚úÖ Chart created successfully for ${canvasId}`);
        }
        
        // Populate SKU table
        function populateSKUTable(sortedProducts) {
            console.log('populateSKUTable input sortedProducts:', sortedProducts);
            const tbody = document.getElementById('skuDetailTableBody');
            tbody.innerHTML = '';

            // G·ªôp c√°c s·∫£n ph·∫©m c√πng t√™n r√∫t g·ªçn
            const skuMap = new Map();
            sortedProducts.forEach(([name, info]) => {
                const shortName = shortenProductName(name);
                if (!skuMap.has(shortName)) {
                    skuMap.set(shortName, { quantity: 0, revenue: 0 });
                }
                skuMap.get(shortName).quantity += info.quantity;
                skuMap.get(shortName).revenue += info.revenue;
            });

            // T√≠nh t·ªïng doanh s·ªë sau khi g·ªôp
            const totalRevenue = Array.from(skuMap.values()).reduce((sum, p) => sum + p.revenue, 0);

            Array.from(skuMap.entries()).forEach(([shortName, info], index) => {
                const percentage = ((info.revenue / totalRevenue) * 100).toFixed(1);
                const row = `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 15px 12px; font-weight: 600; text-align: center;">${index + 1}</td>
                        <td style="padding: 15px 12px; max-width: 300px; word-wrap: break-word;">
                            <strong>${shortName}</strong>
                            <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                                SL: ${formatNumber(info.quantity)}
                            </div>
                        </td>
                        <td style="padding: 15px 12px; text-align: center; font-weight: 600;">
                            ${formatNumber(info.quantity)}
                        </td>
                        <td style="padding: 15px 12px; text-align: center; font-weight: 600; color: #059669;">
                            ${formatCurrency(info.revenue)}
                        </td>
                        <td style="padding: 15px 12px; text-align: center; font-weight: 600;">
                            ${percentage}%
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // Close SKU modal
        function closeSKUModal() {
            document.getElementById('skuAnalysisModal').style.display = 'none';
            if (skuModalChart) {
                skuModalChart.destroy();
                skuModalChart = null;
            }
        }

        // Show month drill-down details
        function showMonthDrillDownSKU(monthKey) {
            console.log('showMonthDrillDownSKU called with:', monthKey);
            // Use current filtered data if available, otherwise use allData
            const baseData = currentFilteredData.length > 0 ? currentFilteredData : allData;
            const monthData = {};
            
            // Collect all data for this month
            baseData.forEach(row => {
                const rowMonthKey = row.monthKey;
                if (rowMonthKey === monthKey) {
                    const system = row['H·ªÜ TH·ªêNG']?.trim();
                    const product = row['T√äN SP']?.trim();
                    const quantity = parseFloat(row.soLuong) || 0;
                    const revenue = parseFloat(row.vat) || 0;
                    
                    if (system && product && quantity > 0) {
                        if (!monthData[system]) {
                            monthData[system] = {};
                        }
                        if (!monthData[system][product]) {
                            monthData[system][product] = {
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        monthData[system][product].quantity += quantity;
                        monthData[system][product].revenue += revenue;
                    }
                }
            });
            
            // Create system summary
            const systemSummary = {};
            Object.keys(monthData).forEach(system => {
                systemSummary[system] = {
                    totalRevenue: 0,
                    totalProducts: 0
                };
                Object.keys(monthData[system]).forEach(product => {
                    systemSummary[system].totalRevenue += monthData[system][product].revenue;
                    systemSummary[system].totalProducts += 1;
                });
            });
            
            const sortedSystems = Object.entries(systemSummary)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue)
                .slice(0, 20);
            
            // Update modal title
            const [year, month] = monthKey.split('-');
            document.getElementById('skuModalTitle').textContent = `üìÖ Chi Ti·∫øt Th√°ng ${parseInt(month)}/${year}`;
            
            // Create chart showing top systems for this month
            createMonthSystemChart(sortedSystems);
            
            // Populate table with system details
            populateMonthTable(sortedSystems, systemSummary);
            
            // Show modal
            document.getElementById('skuAnalysisModal').style.display = 'block';
        }
        
        // Create month system chart
        function createMonthSystemChart(sortedSystems) {
            const ctx = document.getElementById('skuAnalysisChart').getContext('2d');
            
            // Destroy existing chart
            if (skuModalChart) {
                skuModalChart.destroy();
            }
            
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3',
                           '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#a8e6cf', '#dcedc1', '#ffd3a5', '#fd9853', '#c2e9fb', '#a1c4fd'];
            
            skuModalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedSystems.map(s => s[0]),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sortedSystems.map(s => s[1].totalRevenue),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const systemName = sortedSystems[index][0];
                            console.log('Month system clicked:', systemName);
                            // N·∫øu ƒëang c√≥ context drill-down (v√≠ d·ª•: m·ªôt th√°ng c·ª• th·ªÉ), ∆∞u ti√™n d√πng context ƒë√≥
                            const baseData = currentDrillDownContext && currentDrillDownContext.type === 'month'
                                ? currentDrillDownContext.baseData
                                : null;
                            showSystemDrillDown(systemName, baseData);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.parsed) + ` (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Populate month table
        function populateMonthTable(sortedSystems, systemSummary) {
            const tbody = document.getElementById('skuDetailTableBody');
            tbody.innerHTML = '';
            
            const totalRevenue = sortedSystems.reduce((sum, s) => sum + s[1].totalRevenue, 0);
            
            sortedSystems.forEach((system, index) => {
                const percentage = ((system[1].totalRevenue / totalRevenue) * 100).toFixed(1);
                const row = `
                    <tr style="border-bottom: 1px solid #e5e7eb; cursor: pointer;" 
                        onclick="showSystemDrillDown('${system[0].replace(/'/g, "\\'")}')"
                        onmouseover="this.style.backgroundColor='#f3f4f6'" 
                        onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 15px 12px; font-weight: 600; text-align: center;">${index + 1}</td>
                        <td style="padding: 15px 12px; max-width: 300px; word-wrap: break-word;">
                            <strong>${system[0]}</strong>
                            <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                                ${system[1].totalProducts} s·∫£n ph·∫©m
                            </div>
                        </td>
                        <td style="padding: 15px 12px; text-align: center; font-weight: 600;">
                            ${formatNumber(system[1].totalProducts)}
                        </td>
                        <td style="padding: 15px 12px; text-align: center; font-weight: 600; color: #059669;">
                            ${formatCurrency(system[1].totalRevenue)}
                        </td>
                        <td style="padding: 15px 12px; text-align: center; font-weight: 600;">
                            ${percentage}%
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Target Management
        let targetData = {}; // Store targets: { '2026-01': { total: 5000000000, brands: {...}, systems: {...}, userTargets: { 'username': { total: ..., stores: {...} } } } }
        
        // Get user-specific target (for sales users, return their target; for admin/supervisor, return total)
        function getUserTarget(monthKey) {
            if (!currentUser || !targetData[monthKey]) {
                return 0;
            }
            
            const monthTarget = targetData[monthKey];
            const perms = currentUser.permissions;
            
            // Admin and supervisor see total target
            if (perms.viewAll) {
                return monthTarget.total || 0;
            }
            
            // Sales users see their specific target
            if (monthTarget.userTargets && monthTarget.userTargets[currentUser.username]) {
                return monthTarget.userTargets[currentUser.username].total || 0;
            }
            
            // If no user-specific target, calculate from stores
            if (perms.stores && perms.stores.length > 0 && monthTarget.stores) {
                let userTotal = 0;
                const normalizedStores = perms.stores.map(s => normalizeStoreNameForCompare(s));
                Object.keys(monthTarget.stores || {}).forEach(store => {
                    if (normalizedStores.includes(normalizeStoreNameForCompare(store))) {
                        userTotal += monthTarget.stores[store] || 0;
                    }
                });
                return userTotal;
            }
            
            // Fallback: return 0 if no user-specific target
            return 0;
        }
        
        // Load targets from JSON file (GitHub) and merge with localStorage
        async function loadTargets() {
            try {
                // First, try to load from targets.json file (for GitHub Pages)
                try {
                    const response = await fetch('targets.json?v=' + Date.now());
                    console.log('üì• Fetching targets.json, status:', response.status, response.ok);
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:9018',message:'Fetching targets.json',data:{status:response.status,ok:response.ok,url:response.url},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T2'})}).catch(()=>{});
                    // #endregion
                    if (response.ok) {
                        const fileData = await response.json();
                        console.log('üì• targets.json content:', {
                            version: fileData.version,
                            lastUpdated: fileData.lastUpdated,
                            targetMonths: Object.keys(fileData.targets || {}).length,
                            sampleMonths: Object.keys(fileData.targets || {}).slice(0, 5)
                        });
                        // #region agent log
                        fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:9025',message:'targets.json parsed',data:{targetMonths:Object.keys(fileData.targets||{}).length,sampleMonths:Object.keys(fileData.targets||{}).slice(0,5)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T2'})}).catch(()=>{});
                        // #endregion
                        // Handle targets.json format: { version, lastUpdated, targets: {...} }
                        const fileTargets = fileData.targets || fileData.data || fileData;
                        if (fileTargets && typeof fileTargets === 'object' && !Array.isArray(fileTargets)) {
                            const fileMonthCount = Object.keys(fileTargets).length;
                            // Merge file data with existing targetData (keep local fields if present)
                            Object.keys(fileTargets).forEach(monthKey => {
                                targetData[monthKey] = targetData[monthKey]
                                    ? { ...fileTargets[monthKey], ...targetData[monthKey] }
                                    : fileTargets[monthKey];
                            });
                            console.log('‚úÖ Targets loaded from targets.json:', fileMonthCount, 'months');
                            if (fileMonthCount === 0) {
                                console.warn('‚ö†Ô∏è targets.json is empty - no targets found in file');
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è targets.json fetch failed:', response.status, response.statusText);
                    }
                } catch (fileError) {
                    console.log('‚ö†Ô∏è Could not load targets.json (normal if file does not exist yet):', fileError.message);
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:9036',message:'targets.json fetch error',data:{error:fileError.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T2'})}).catch(()=>{});
                    // #endregion
                }
                
                // Then, load from localStorage (user's local edits take priority)
                const saved = localStorage.getItem('salesTargets');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    const localMonthCount = Object.keys(parsed).length;
                    console.log('üì• Loading from localStorage:', localMonthCount, 'months');
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:9040',message:'Loading from localStorage',data:{localMonthCount,localMonths:Object.keys(parsed).slice(0,5)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T3'})}).catch(()=>{});
                    // #endregion
                    // Merge localStorage data (overwrites file data if exists)
                    Object.keys(parsed).forEach(monthKey => {
                        targetData[monthKey] = parsed[monthKey];
                    });
                    console.log('‚úÖ Targets loaded from localStorage:', localMonthCount, 'months');
                } else {
                    console.log('‚ÑπÔ∏è No targets in localStorage');
                }
                
                const monthCount = Object.keys(targetData).length;
                const totalCount = Object.values(targetData).filter(t => t && t.total > 0).length;
                const targetMonths = Object.keys(targetData).sort();
                console.log('üìä Total targets loaded:', monthCount, 'months,', totalCount, 'with targets');
                if (monthCount > 0) {
                    console.log('Target months:', targetMonths);
                    // Check for 2025 targets specifically
                    const targets2025 = targetMonths.filter(m => m.startsWith('2025-'));
                    console.log('üéØ 2025 targets:', targets2025.length, targets2025);
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:9055',message:'Total targets summary',data:{monthCount,totalCount,targets2025Count:targets2025.length,targets2025},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T3'})}).catch(()=>{});
                    // #endregion
                } else {
                    console.warn('‚ö†Ô∏è No targets loaded at all!');
                }
            } catch (e) {
                console.error('‚ùå Error loading targets:', e);
                targetData = {}; // Reset on error
            }
        }
        
        // Save targets to localStorage
        function saveTargets() {
            try {
                localStorage.setItem('salesTargets', JSON.stringify(targetData));
                console.log('üíæ Targets saved to localStorage:', Object.keys(targetData).length, 'months');
            } catch (e) {
                console.error('‚ùå Error saving targets:', e);
                // If storage is full, try to clear old data
                if (e.name === 'QuotaExceededError') {
                    alert('L∆∞u tr·ªØ ƒë·∫ßy. Vui l√≤ng x√≥a m·ªôt s·ªë target c≈© ho·∫∑c d·ªØ li·ªáu kh√°c.');
                }
            }
        }
        
        // Export target data to JSON file (for targets.json)
        async function exportTargetData() {
            try {
                // Ensure we have the latest data (from file and localStorage)
                await loadTargets();
                
                if (!targetData || Object.keys(targetData).length === 0) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu target ƒë·ªÉ export. Vui l√≤ng ƒë·∫∑t target tr∆∞·ªõc.');
                    return;
                }
                
                // Create export data in targets.json format
                const exportData = {
                    version: '1.0',
                    lastUpdated: new Date().toISOString(),
                    targets: targetData
                };
                
                // Convert to JSON string with pretty formatting
                const jsonString = JSON.stringify(exportData, null, 2);
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:exportTargetData',message:'export targets.json',data:{monthCount:Object.keys(targetData).length,totalCount:Object.values(targetData).filter(t=>t&&t.total>0).length,jsonBytes:jsonString.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T1'})}).catch(()=>{});
                // #endregion
                
                // Create blob and download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `targets.json`; // Use targets.json as filename
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                const monthCount = Object.keys(targetData).length;
                const totalCount = Object.values(targetData).filter(t => t && t.total > 0).length;
                alert(`‚úÖ Export th√†nh c√¥ng!\n\nüìä ${monthCount} th√°ng\nüéØ ${totalCount} th√°ng c√≥ target\n\nFile: targets.json\n\nüí° H∆∞·ªõng d·∫´n:\n1. Commit file targets.json l√™n GitHub\n2. M·ªçi ng∆∞·ªùi s·∫Ω th·∫•y target sau khi refresh trang`);
                
                console.log('‚úÖ Target data exported:', monthCount, 'months');
            } catch (e) {
                console.error('‚ùå Error exporting targets:', e);
                alert('L·ªói khi export target. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        
        // Import target data from JSON file
        function importTargetData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const imported = JSON.parse(content);
                    
                    // Handle multiple formats: targets.json format, export format, or direct targetData
                    let importedData;
                    if (imported.targets) {
                        // targets.json format: { version, lastUpdated, targets: {...} }
                        importedData = imported.targets;
                        console.log('üì• Importing from targets.json format');
                    } else if (imported.data) {
                        // Export format with metadata: { version, exportDate, data: {...} }
                        importedData = imported.data;
                        console.log('üì• Importing target data version:', imported.version || 'unknown');
                        console.log('üìÖ Export date:', imported.exportDate || 'unknown');
                    } else {
                        // Old format (direct targetData object)
                        importedData = imported;
                    }
                    
                    // Validate data structure
                    if (typeof importedData !== 'object' || Array.isArray(importedData)) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Validate each month's data structure
                    let validCount = 0;
                    let invalidCount = 0;
                    const invalidMonths = [];
                    
                    Object.keys(importedData).forEach(monthKey => {
                        const monthData = importedData[monthKey];
                        if (monthData && typeof monthData === 'object' && 
                            (monthData.total !== undefined || monthData.brands || monthData.systems)) {
                            validCount++;
                        } else {
                            invalidCount++;
                            invalidMonths.push(monthKey);
                        }
                    });
                    
                    if (validCount === 0) {
                        alert('File kh√¥ng ch·ª©a d·ªØ li·ªáu target h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i file.');
                        return;
                    }
                    
                    // Ask user for confirmation
                    const confirmMessage = `B·∫°n c√≥ mu·ªën import target data?\n\n` +
                        `‚úÖ ${validCount} th√°ng h·ª£p l·ªá\n` +
                        (invalidCount > 0 ? `‚ö†Ô∏è ${invalidCount} th√°ng kh√¥ng h·ª£p l·ªá\n` : '') +
                        `\nL∆∞u √Ω: D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c thay th·∫ø ho·∫∑c merge v·ªõi d·ªØ li·ªáu import.`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // Merge with existing data (keep existing if not in import, or replace if in import)
                    const beforeCount = Object.keys(targetData).length;
                    Object.keys(importedData).forEach(monthKey => {
                        const monthData = importedData[monthKey];
                        if (monthData && typeof monthData === 'object') {
                            // Merge all known fields (preserve userTargets/stores/etc.)
                            const existing = targetData[monthKey] || {};
                            targetData[monthKey] = {
                                ...existing,
                                ...monthData,
                                total: (monthData.total !== undefined ? monthData.total : existing.total) || 0,
                                brands: monthData.brands || existing.brands || {},
                                systems: monthData.systems || existing.systems || {},
                                stores: monthData.stores || existing.stores || {},
                                userTargets: monthData.userTargets || existing.userTargets || {}
                            };
                        }
                    });
                    
                    // Save to localStorage
                    saveTargets();
                    
                    const afterCount = Object.keys(targetData).length;
                    const newCount = afterCount - beforeCount;
                    
                    // Show success message
                    let message = `‚úÖ Import th√†nh c√¥ng!\n\n`;
                    message += `üìä T·ªïng s·ªë th√°ng: ${afterCount}\n`;
                    if (newCount > 0) {
                        message += `üÜï Th√°ng m·ªõi: ${newCount}\n`;
                    }
                    message += `üîÑ Th√°ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t: ${validCount - newCount}\n`;
                    if (invalidCount > 0) {
                        message += `\n‚ö†Ô∏è ${invalidCount} th√°ng kh√¥ng h·ª£p l·ªá ƒë√£ b·ªè qua:\n${invalidMonths.slice(0, 5).join(', ')}${invalidMonths.length > 5 ? '...' : ''}`;
                    }
                    
                    alert(message);
                    
                    // Refresh UI
                    updateForecastDisplayWithTargets();
                    
                    // Refresh target results if displayed
                    const monthInput = document.getElementById('targetVsActualMonth');
                    if (monthInput && monthInput.value) {
                        updateTargetVsActual();
                    }
                    
                    // Reset file input
                    event.target.value = '';
                    
                    console.log('‚úÖ Target data imported:', afterCount, 'months');
                } catch (e) {
                    console.error('‚ùå Error importing targets:', e);
                    alert('L·ªói khi import target. File c√≥ th·ªÉ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.\n\nChi ti·∫øt: ' + e.message);
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                alert('L·ªói khi ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // Set total target and auto-distribute
        function setTotalTarget() {
            const targetInput = document.getElementById('totalTargetInput');
            const monthInput = document.getElementById('totalTargetMonth');
            
            if (!targetInput.value || !monthInput.value) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß target v√† ch·ªçn th√°ng');
                return;
            }
            
            const target = parseFloat(targetInput.value);
            const monthKey = monthInput.value; // Format: YYYY-MM
            
            if (target <= 0) {
                alert('Target ph·∫£i l·ªõn h∆°n 0');
                return;
            }
            
            // Initialize month data if not exists
            if (!targetData[monthKey]) {
                targetData[monthKey] = { total: 0, brands: {}, systems: {} };
            }
            
            targetData[monthKey].total = target;
            
            // If brand targets exist, validate they don't exceed total
            const existingBrandTargets = targetData[monthKey].brands || {};
            const sumBrandTargets = Object.values(existingBrandTargets).reduce((sum, t) => sum + t, 0);
            
            if (sumBrandTargets > target) {
                // Adjust brand targets proportionally if they exceed new total
                Object.keys(existingBrandTargets).forEach(brand => {
                    existingBrandTargets[brand] = (existingBrandTargets[brand] / sumBrandTargets) * target;
                    // Re-distribute to systems
                    distributeBrandTarget(monthKey, brand, existingBrandTargets[brand]);
                });
                targetData[monthKey].brands = existingBrandTargets;
                alert(`Target T·ªïng m·ªõi nh·ªè h∆°n t·ªïng target nh√£n h√†ng hi·ªán t·∫°i. ƒê√£ ƒëi·ªÅu ch·ªânh t·ª∑ l·ªá c√°c target nh√£n h√†ng.`);
            } else {
                // Auto-distribute by historical proportions and growth potential
                distributeTotalTarget(monthKey, target);
            }
            
            // Save to localStorage
            saveTargets();
            
            // Show results
            displayTargetResults(monthKey);
            
            // Update forecast display with targets
            updateForecastDisplayWithTargets();
        }
        
        // Set brand target and auto-distribute to systems
        function setBrandTarget() {
            const brandSelect = document.getElementById('brandTargetSelect');
            const targetInput = document.getElementById('brandTargetInput');
            const monthInput = document.getElementById('brandTargetMonth');
            
            if (!brandSelect.value || !targetInput.value || !monthInput.value) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }
            
            const brand = brandSelect.value;
            const target = parseFloat(targetInput.value);
            const monthKey = monthInput.value;
            
            if (target <= 0) {
                alert('Target ph·∫£i l·ªõn h∆°n 0');
                return;
            }
            
            // Initialize month data if not exists
            if (!targetData[monthKey]) {
                targetData[monthKey] = { total: 0, brands: {}, systems: {} };
            }
            
            // Check if total target exists
            const totalTarget = targetData[monthKey].total;
            if (totalTarget <= 0) {
                alert('Vui l√≤ng ƒë·∫∑t Target T·ªïng tr∆∞·ªõc khi ƒë·∫∑t target cho nh√£n h√†ng');
                return;
            }
            
            // Calculate current sum of brand targets (excluding the brand being updated)
            const currentBrandTargets = { ...targetData[monthKey].brands };
            const oldBrandTarget = currentBrandTargets[brand] || 0;
            delete currentBrandTargets[brand];
            const sumOtherBrands = Object.values(currentBrandTargets).reduce((sum, t) => sum + t, 0);
            
            // Validate: new brand target + other brands <= total target
            if (sumOtherBrands + target > totalTarget) {
                const available = totalTarget - sumOtherBrands;
                alert(`Target nh√£n h√†ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° Target T·ªïng!\nTarget T·ªïng: ${formatCurrency(totalTarget)}\nƒê√£ ph√¢n b·ªï: ${formatCurrency(sumOtherBrands)}\nC√≤n l·∫°i: ${formatCurrency(available)}\n\nB·∫°n c√≥ th·ªÉ ƒë·∫∑t t·ªëi ƒëa: ${formatCurrency(available)}`);
                return;
            }
            
            targetData[monthKey].brands[brand] = target;
            
            // Auto-distribute brand target to systems by growth potential
            distributeBrandTarget(monthKey, brand, target);
            
            // Save to localStorage
            saveTargets();
            
            // Show results
            displayTargetResults(monthKey);
            
            // Update forecast display with targets
            updateForecastDisplayWithTargets();
        }
        
        // Distribute total target to brands and systems
        function distributeTotalTarget(monthKey, totalTarget) {
            // Get recent months data (last 3 months) for proportion calculation
            const sortedMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            const recentMonths = sortedMonths.slice(-3);
            const recentData = allData.filter(row => recentMonths.includes(row.monthKey));
            
            // Calculate brand proportions and growth rates
            const brandStats = {};
            recentData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brand) return;
                
                if (!brandStats[brand]) {
                    brandStats[brand] = { sales: 0, months: new Set() };
                }
                brandStats[brand].sales += row.vat;
                brandStats[brand].months.add(row.monthKey);
            });
            
            // Calculate growth rates (comparing last 2 months vs previous)
            const brandGrowth = {};
            Object.keys(brandStats).forEach(brand => {
                const brandData = allData.filter(r => r['NH√ÉN H√ÄNG'] === brand && recentMonths.includes(r.monthKey));
                const monthlySales = {};
                brandData.forEach(r => {
                    if (!monthlySales[r.monthKey]) monthlySales[r.monthKey] = 0;
                    monthlySales[r.monthKey] += r.vat;
                });
                
                const months = Object.keys(monthlySales).sort();
                if (months.length >= 2) {
                    const recent = monthlySales[months[months.length - 1]];
                    const previous = monthlySales[months[months.length - 2]];
                    brandGrowth[brand] = previous > 0 ? (recent - previous) / previous : 0;
                } else {
                    brandGrowth[brand] = 0;
                }
            });
            
            // Distribute to brands: base proportion + growth adjustment
            const totalRecentSales = Object.values(brandStats).reduce((sum, s) => sum + s.sales, 0);
            const brandTargets = {};
            
            Object.keys(brandStats).forEach(brand => {
                const baseProportion = brandStats[brand].sales / totalRecentSales;
                const growthFactor = 1 + (brandGrowth[brand] || 0) * 0.5; // Adjust by 50% of growth rate
                const adjustedProportion = baseProportion * growthFactor;
                brandTargets[brand] = totalTarget * adjustedProportion;
            });
            
            // Normalize to ensure total matches
            const currentTotal = Object.values(brandTargets).reduce((sum, t) => sum + t, 0);
            Object.keys(brandTargets).forEach(brand => {
                brandTargets[brand] = (brandTargets[brand] / currentTotal) * totalTarget;
            });
            
            // Store brand targets
            targetData[monthKey].brands = brandTargets;
            
            // Distribute each brand target to systems
            Object.keys(brandTargets).forEach(brand => {
                distributeBrandTarget(monthKey, brand, brandTargets[brand]);
            });
        }
        
        // Distribute brand target to systems by growth potential
        function distributeBrandTarget(monthKey, brand, brandTarget) {
            // Get recent months data for this brand
            const sortedMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            const recentMonths = sortedMonths.slice(-3);
            const brandData = allData.filter(row => 
                row['NH√ÉN H√ÄNG'] === brand && recentMonths.includes(row.monthKey)
            );
            
            // Calculate system proportions and growth rates
            const systemStats = {};
            brandData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!system) return;
                
                if (!systemStats[system]) {
                    systemStats[system] = { sales: 0, months: new Set() };
                }
                systemStats[system].sales += row.vat;
                systemStats[system].months.add(row.monthKey);
            });
            
            // Calculate growth rates per system
            const systemGrowth = {};
            Object.keys(systemStats).forEach(system => {
                const systemData = brandData.filter(r => r['H·ªÜ TH·ªêNG'] === system && recentMonths.includes(r.monthKey));
                const monthlySales = {};
                systemData.forEach(r => {
                    if (!monthlySales[r.monthKey]) monthlySales[r.monthKey] = 0;
                    monthlySales[r.monthKey] += r.vat;
                });
                
                const months = Object.keys(monthlySales).sort();
                if (months.length >= 2) {
                    const recent = monthlySales[months[months.length - 1]];
                    const previous = monthlySales[months[months.length - 2]];
                    systemGrowth[system] = previous > 0 ? (recent - previous) / previous : 0;
                } else {
                    systemGrowth[system] = 0;
                }
            });
            
            // Distribute: base proportion + growth adjustment
            const totalSystemSales = Object.values(systemStats).reduce((sum, s) => sum + s.sales, 0);
            const systemTargets = {};
            
            Object.keys(systemStats).forEach(system => {
                const baseProportion = systemStats[system].sales / totalSystemSales;
                const growthFactor = 1 + (systemGrowth[system] || 0) * 0.5;
                const adjustedProportion = baseProportion * growthFactor;
                systemTargets[system] = brandTarget * adjustedProportion;
            });
            
            // Normalize
            const currentTotal = Object.values(systemTargets).reduce((sum, t) => sum + t, 0);
            if (currentTotal > 0) {
                Object.keys(systemTargets).forEach(system => {
                    systemTargets[system] = (systemTargets[system] / currentTotal) * brandTarget;
                });
            }
            
            // Store system targets (by brand)
            if (!targetData[monthKey].systems[brand]) {
                targetData[monthKey].systems[brand] = {};
            }
            targetData[monthKey].systems[brand] = systemTargets;
        }
        
        // Display target distribution results
        function displayTargetResults(monthKey) {
            const resultsDiv = document.getElementById('targetResults');
            const contentDiv = document.getElementById('targetResultsContent');
            
            if (!targetData[monthKey]) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const data = targetData[monthKey];
            let html = '';
            
            if (data.total > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="color: #1f2937; margin-bottom: 10px;">üìä Target T·ªïng: ${formatCurrency(data.total)}</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">Nh√£n H√†ng</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Target</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">T·ª∑ L·ªá</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                const brands = Object.keys(data.brands).sort((a, b) => data.brands[b] - data.brands[a]);
                brands.forEach(brand => {
                    const target = data.brands[brand];
                    const percentage = (target / data.total * 100).toFixed(1);
                    html += `<tr>
                        <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${brand}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${formatCurrency(target)}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb;">${percentage}%</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div></div>`;
            }
            
            // Show system distribution for each brand
            Object.keys(data.systems).forEach(brand => {
                const systems = data.systems[brand];
                const brandTarget = data.brands[brand] || Object.values(systems).reduce((sum, t) => sum + t, 0);
                
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="color: #1f2937; margin-bottom: 10px;">üè∑Ô∏è ${brand} - Target: ${formatCurrency(brandTarget)}</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">H·ªá Th·ªëng</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Target</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">T·ª∑ L·ªá</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                const sortedSystems = Object.keys(systems).sort((a, b) => systems[b] - systems[a]);
                sortedSystems.forEach(system => {
                    const target = systems[system];
                    const percentage = (target / brandTarget * 100).toFixed(1);
                    html += `<tr>
                        <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${system}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${formatCurrency(target)}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb;">${percentage}%</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div></div>`;
            });
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // Initialize target brands when filters are initialized
        function initializeTargetBrands() {
            const select = document.getElementById('brandTargetSelect');
            if (!select || !allData || allData.length === 0) return;
            
            const brands = [...new Set(allData.map(d => d['NH√ÉN H√ÄNG']))].filter(Boolean).sort();
            select.innerHTML = '<option value="">-- Ch·ªçn nh√£n h√†ng --</option>' + 
                brands.map(b => `<option value="${b}">${b}</option>`).join('');
        }
        
        // Update forecast display with targets
        function updateForecastDisplayWithTargets() {
            // This will be called after forecast chart is created
            // The display is already updated in createForecastChart function
            // But we can refresh the chart if it exists
            // Use currentFilteredData (already filtered by permissions) instead of allData
            const dataToUse = currentFilteredData.length > 0 ? currentFilteredData : allData;
            console.log('üîÑ updateForecastDisplayWithTargets() - refreshing forecast with', dataToUse.length, 'rows');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:9705',message:'updateForecastDisplayWithTargets',data:{dataLength:dataToUse.length,usingFilteredData:currentFilteredData.length>0,hasCurrentUser:!!currentUser},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F3'})}).catch(()=>{});
            // #endregion
            if (charts.forecastChart && dataToUse && dataToUse.length > 0) {
                createForecastChart(dataToUse);
            }
        }
        
        // Hook into initializeFilters to also initialize target brands
        const originalInitFilters = initializeFilters;
        initializeFilters = function() {
            originalInitFilters();
            setTimeout(() => initializeTargetBrands(), 100);
        };
        
        // Load targets on page load
        loadTargets();
        
        // Bulk set targets for multiple months
        function setBulkTargets() {
            // Get target for December 2025 as reference (use total target, not user-specific)
            // This function is for admin to set targets, so we use total target
            let dec2025Target = targetData['2025-12']?.total || 0;
            
            // If December target doesn't exist, try to get from other recent months or use a default
            if (dec2025Target === 0) {
                // Try to find target from other 2025 months
                const months2025 = ['2025-11', '2025-10', '2025-09', '2025-08', '2025-07', '2025-06', '2025-05', '2025-04'];
                for (const month of months2025) {
                    const monthTarget = targetData[month]?.total || 0;
                    if (monthTarget > 0) {
                        dec2025Target = monthTarget;
                        console.log(`S·ª≠ d·ª•ng target t·ª´ ${month} cho c√°c th√°ng 4-11: ${formatCurrency(dec2025Target)}`);
                        break;
                    }
                }
                
                // If still no target found, ask user or use a reasonable default
                if (dec2025Target === 0) {
                    const userInput = prompt('Ch∆∞a c√≥ target cho th√°ng 12/2025. Nh·∫≠p target cho th√°ng 4-11 (VND) ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ d√πng 5 t·ª∑:', '5000000000');
                    if (userInput === null) {
                        return; // User cancelled
                    }
                    dec2025Target = parseFloat(userInput) || 5000000000;
                }
            }
            
            const targets = {
                '2025-01': 6000000000,  // 6 t·ª∑
                '2025-02': 4200000000,  // 4.2 t·ª∑
                '2025-03': 5000000000,  // 5 t·ª∑
                '2025-04': 5000000000,  // 5 t·ª∑
                '2025-05': dec2025Target, // Gi·ªëng th√°ng 12
                '2025-06': dec2025Target,
                '2025-07': dec2025Target,
                '2025-08': dec2025Target,
                '2025-09': dec2025Target,
                '2025-10': dec2025Target,
                '2025-11': dec2025Target
            };
            
            let successCount = 0;
            let errorMessages = [];
            
            Object.keys(targets).forEach(monthKey => {
                const target = targets[monthKey];
                
                // Initialize month data if not exists
                if (!targetData[monthKey]) {
                    targetData[monthKey] = { total: 0, brands: {}, systems: {} };
                }
                
                // Set total target
                targetData[monthKey].total = target;
                
                // Auto-distribute by historical proportions and growth potential
                try {
                    // Only distribute if we have data
                    if (allData && allData.length > 0) {
                        distributeTotalTarget(monthKey, target);
                    }
                    successCount++;
                } catch (error) {
                    console.error(`Error setting target for ${monthKey}:`, error);
                    errorMessages.push(`${monthKey}: ${error.message}`);
                }
            });
            
            // Save to localStorage
            saveTargets();
            
            // Show results
            let message = `‚úÖ ƒê√£ set target cho ${successCount}/${Object.keys(targets).length} th√°ng:\n\n`;
            Object.keys(targets).forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                message += `üìÖ Th√°ng ${parseInt(month)}/${year}: ${formatCurrency(targets[monthKey])}\n`;
            });
            
            if (errorMessages.length > 0) {
                message += `\n‚ö†Ô∏è L·ªói:\n${errorMessages.join('\n')}`;
            }
            
            message += `\n\nüíæ ƒê√£ l∆∞u v√†o localStorage.`;
            
            alert(message);
            
            // Update forecast display if needed
            updateForecastDisplayWithTargets();
            
            // Refresh target results if displayed
            const monthInput = document.getElementById('targetVsActualMonth');
            if (monthInput && monthInput.value) {
                updateTargetVsActual();
            }
        }
        
        // Set default month for target vs actual report
        function setDefaultTargetVsActualMonth() {
            const monthInput = document.getElementById('targetVsActualMonth');
            if (!monthInput) return;
            
            // Try to find the most recent month with target data
            const monthsWithTargets = Object.keys(targetData).sort().reverse();
            if (monthsWithTargets.length > 0) {
                monthInput.value = monthsWithTargets[0];
            } else {
                // Default to current month
                const today = new Date();
                const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = currentMonth;
            }
        }
        
        // Initialize default month after data loads
        // Note: loadAllData is already async, so we'll hook into the completion
        // We'll call setDefaultTargetVsActualMonth after loadAllData completes
        
        // Target vs Actual Performance Report
        async function updateTargetVsActual() {
            // Ensure targets are loaded (from file and localStorage)
            await loadTargets();
            
            const monthInput = document.getElementById('targetVsActualMonth');
            if (!monthInput.value) {
                alert('Vui l√≤ng ch·ªçn th√°ng');
                return;
            }
            
            const monthKey = monthInput.value; // Format: YYYY-MM
            
            // Debug: Log targetData to see what's available
            console.log('Checking target for month:', monthKey);
            console.log('Available target months:', Object.keys(targetData));
            console.log('Target data for this month:', targetData[monthKey]);
            
            const targetMonthData = targetData[monthKey];
            
            // Get user-specific target
            const totalTarget = getUserTarget(monthKey);
            
            if (!totalTarget || totalTarget <= 0) {
                const availableMonths = Object.keys(targetData).filter(k => getUserTarget(k) > 0);
                if (availableMonths.length > 0) {
                    alert(`Ch∆∞a c√≥ target cho th√°ng ${monthKey}.\n\nC√°c th√°ng ƒë√£ c√≥ target:\n${availableMonths.map(m => {
                        const [y, mo] = m.split('-');
                        return `- Th√°ng ${parseInt(mo)}/${y}`;
                    }).join('\n')}\n\nVui l√≤ng ƒë·∫∑t target cho th√°ng n√†y tr∆∞·ªõc.`);
                } else {
                    alert('Ch∆∞a c√≥ target cho th√°ng n√†y. Vui l√≤ng ƒë·∫∑t target tr∆∞·ªõc.');
                }
                return;
            }
            
            // Get actual sales data for this month (filtered by permissions)
            let monthData = allData.filter(row => row.monthKey === monthKey);
            monthData = filterDataByPermissions(monthData);
            
            if (monthData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ª±c t·∫ø cho th√°ng n√†y');
                return;
            }
            
            // Calculate totals
            const totalActual = monthData.reduce((sum, row) => sum + (row.vat || 0), 0);
            const achievementPercent = totalTarget > 0 ? (totalActual / totalTarget * 100).toFixed(1) : 0;
            
            // Update summary cards
            document.getElementById('summaryTotalTarget').textContent = formatCurrency(totalTarget);
            document.getElementById('summaryTotalActual').textContent = formatCurrency(totalActual);
            document.getElementById('summaryAchievement').textContent = `${achievementPercent}%`;
            
            // Build detailed table
            buildTargetVsActualTable(monthKey, monthData, targetMonthData);
            
            // Create visual chart using HTML progress bars (easier to read)
            createTargetVsActualVisualization(monthKey, monthData, targetMonthData);
            
            // Show content
            document.getElementById('targetVsActualContent').style.display = 'block';
        }
        
        // Build detailed table
        function buildTargetVsActualTable(monthKey, monthData, targetMonthData) {
            const thead = document.getElementById('targetVsActualTableHead');
            const tbody = document.getElementById('targetVsActualTableBody');
            
            // Get all brands that have targets
            const brandsWithTargets = Object.keys(targetMonthData.brands || {}).sort();
            
            // Build header
            let headerHTML = '<tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">';
            headerHTML += '<th style="padding: 12px; text-align: left; border-right: 1px solid #e5e7eb; position: sticky; left: 0; background: #f3f4f6; z-index: 11;">H·ªÜ TH·ªêNG</th>';
            headerHTML += '<th style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb;">T·ªîNG TARGET</th>';
            headerHTML += '<th style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb;">TH·ª∞C ƒê·∫†T</th>';
            headerHTML += '<th style="padding: 12px; text-align: center; border-right: 1px solid #e5e7eb;">%</th>';
            
            brandsWithTargets.forEach(brand => {
                headerHTML += `<th style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb; background: #fef3c7;">${brand}<br>TARGET</th>`;
                headerHTML += `<th style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb; background: #fef3c7;">${brand}<br>TH·ª∞C ƒê·∫†T</th>`;
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            // Group data by system
            const systemData = {};
            monthData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!system) return;
                
                if (!systemData[system]) {
                    systemData[system] = {
                        totalActual: 0,
                        brands: {}
                    };
                }
                
                systemData[system].totalActual += row.vat || 0;
                
                const brand = row['NH√ÉN H√ÄNG'];
                if (brand && brandsWithTargets.includes(brand)) {
                    if (!systemData[system].brands[brand]) {
                        systemData[system].brands[brand] = 0;
                    }
                    systemData[system].brands[brand] += row.vat || 0;
                }
            });
            
            // Build rows
            let bodyHTML = '';
            const sortedSystems = Object.keys(systemData).sort();
            
            sortedSystems.forEach(system => {
                const sysData = systemData[system];
                const systemTargets = targetMonthData.systems || {};
                
                // Calculate total target for this system (sum of all brand targets)
                let systemTotalTarget = 0;
                brandsWithTargets.forEach(brand => {
                    const brandSystems = systemTargets[brand] || {};
                    systemTotalTarget += brandSystems[system] || 0;
                });
                
                const systemPercent = systemTotalTarget > 0 ? (sysData.totalActual / systemTotalTarget * 100).toFixed(1) : '-';
                
                bodyHTML += '<tr style="border-bottom: 1px solid #e5e7eb;">';
                bodyHTML += `<td style="padding: 10px; border-right: 1px solid #e5e7eb; position: sticky; left: 0; background: white; z-index: 10; font-weight: 600;">${system}</td>`;
                bodyHTML += `<td style="padding: 10px; text-align: right; border-right: 1px solid #e5e7eb;">${systemTotalTarget > 0 ? formatCurrency(systemTotalTarget) : '-'}</td>`;
                bodyHTML += `<td style="padding: 10px; text-align: right; border-right: 1px solid #e5e7eb; font-weight: 600;">${formatCurrency(sysData.totalActual)}</td>`;
                bodyHTML += `<td style="padding: 10px; text-align: center; border-right: 1px solid #e5e7eb; font-weight: 600; color: ${systemPercent !== '-' && parseFloat(systemPercent) >= 100 ? '#10b981' : parseFloat(systemPercent) >= 80 ? '#f59e0b' : '#ef4444'};">${systemPercent}${systemPercent !== '-' ? '%' : ''}</td>`;
                
                brandsWithTargets.forEach(brand => {
                    const brandSystems = systemTargets[brand] || {};
                    const brandTarget = brandSystems[system] || 0;
                    const brandActual = sysData.brands[brand] || 0;
                    const brandPercent = brandTarget > 0 ? (brandActual / brandTarget * 100).toFixed(1) : '-';
                    
                    bodyHTML += `<td style="padding: 10px; text-align: right; border-right: 1px solid #e5e7eb;">${brandTarget > 0 ? formatCurrency(brandTarget) : '-'}</td>`;
                    bodyHTML += `<td style="padding: 10px; text-align: right; border-right: 1px solid #e5e7eb; color: ${brandPercent !== '-' && parseFloat(brandPercent) >= 100 ? '#10b981' : parseFloat(brandPercent) >= 80 ? '#f59e0b' : '#ef4444'};">${brandActual > 0 ? formatCurrency(brandActual) : '-'}</td>`;
                });
                
                bodyHTML += '</tr>';
            });
            
            // Add total row (use user-specific target)
            const totalActual = monthData.reduce((sum, row) => sum + (row.vat || 0), 0);
            const totalTarget = getUserTarget(monthKey);
            const totalPercent = (totalActual / totalTarget * 100).toFixed(1);
            
            bodyHTML += '<tr style="background: #f9fafb; border-top: 2px solid #1f2937; font-weight: 700;">';
            bodyHTML += '<td style="padding: 12px; border-right: 1px solid #e5e7eb; position: sticky; left: 0; background: #f9fafb; z-index: 10;">T·ªîNG</td>';
            bodyHTML += `<td style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb;">${formatCurrency(totalTarget)}</td>`;
            bodyHTML += `<td style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb;">${formatCurrency(totalActual)}</td>`;
            bodyHTML += `<td style="padding: 12px; text-align: center; border-right: 1px solid #e5e7eb; color: ${parseFloat(totalPercent) >= 100 ? '#10b981' : parseFloat(totalPercent) >= 80 ? '#f59e0b' : '#ef4444'};">${totalPercent}%</td>`;
            
            brandsWithTargets.forEach(brand => {
                const brandTarget = targetMonthData.brands[brand] || 0;
                const brandActual = monthData
                    .filter(row => row['NH√ÉN H√ÄNG'] === brand)
                    .reduce((sum, row) => sum + (row.vat || 0), 0);
                const brandPercent = brandTarget > 0 ? (brandActual / brandTarget * 100).toFixed(1) : '-';
                
                bodyHTML += `<td style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb;">${formatCurrency(brandTarget)}</td>`;
                bodyHTML += `<td style="padding: 12px; text-align: right; border-right: 1px solid #e5e7eb; color: ${brandPercent !== '-' && parseFloat(brandPercent) >= 100 ? '#10b981' : parseFloat(brandPercent) >= 80 ? '#f59e0b' : '#ef4444'};">${formatCurrency(brandActual)}</td>`;
            });
            
            bodyHTML += '</tr>';
            tbody.innerHTML = bodyHTML;
        }
        
        // Create HTML-based visualization for target vs actual (easier to read)
        function createTargetVsActualVisualization(monthKey, monthData, targetMonthData) {
            const container = document.getElementById('targetVsActualChartContainer');
            if (!container) return;
            
            // Group by system (only systems user has access to)
            const systemData = {};
            monthData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!system) return;
                
                if (!systemData[system]) {
                    systemData[system] = { actual: 0, target: 0 };
                }
                systemData[system].actual += row.vat || 0;
            });
            
            // Get targets for each system (user-specific)
            const brandsWithTargets = Object.keys(targetMonthData.brands || {});
            const systemTargets = targetMonthData.systems || {};
            
            // For sales users, only calculate targets for their stores
            const perms = currentUser?.permissions || {};
            const normalizedStores = perms.stores && perms.stores.length > 0 
                ? perms.stores.map(s => normalizeStoreNameForCompare(s))
                : [];
            
            Object.keys(systemData).forEach(system => {
                let systemTarget = 0;
                brandsWithTargets.forEach(brand => {
                    const brandSystems = systemTargets[brand] || {};
                    // For sales users, only count stores they have access to
                    if (normalizedStores.length > 0) {
                        // Calculate target based on stores in this system that user can access
                        const systemStores = monthData
                            .filter(row => row['H·ªÜ TH·ªêNG'] === system)
                            .map(row => normalizeStoreNameForCompare(row['C·ª¨A H√ÄNG']));
                        const userStoresInSystem = systemStores.filter(s => normalizedStores.includes(s));
                        if (userStoresInSystem.length > 0) {
                            // Estimate target proportionally based on stores
                            const totalStoresInSystem = new Set(systemStores).size;
                            const userStoreRatio = userStoresInSystem.length / totalStoresInSystem;
                            systemTarget += (brandSystems[system] || 0) * userStoreRatio;
                        }
                    } else {
                        // Admin/supervisor: use full target
                        systemTarget += brandSystems[system] || 0;
                    }
                });
                systemData[system].target = systemTarget;
            });
            
            // Sort by target descending, take top 20
            const sortedSystems = Object.keys(systemData)
                .filter(s => systemData[s].target > 0) // Only show systems with targets
                .sort((a, b) => systemData[b].target - systemData[a].target)
                .slice(0, 20);
            
            if (sortedSystems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Ch∆∞a c√≥ target cho c√°c h·ªá th·ªëng trong th√°ng n√†y.</p>';
                return;
            }
            
            // Create HTML visualization
            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            sortedSystems.forEach(system => {
                const actual = systemData[system].actual;
                const target = systemData[system].target;
                const percent = target > 0 ? ((actual / target) * 100) : 0;
                const percentText = percent.toFixed(1);
                
                // Determine color based on achievement
                let barColor = '#ef4444'; // Red
                let statusIcon = '‚ö†Ô∏è';
                if (percent >= 100) {
                    barColor = percent > 100 ? '#f59e0b' : '#10b981'; // Orange if exceeded, green if exactly 100%
                    statusIcon = percent > 100 ? 'üéâ' : '‚úÖ';
                } else if (percent >= 80) {
                    barColor = '#fbbf24'; // Yellow
                    statusIcon = 'üìä';
                }
                
                const gap = Math.abs(actual - target);
                const gapText = actual > target 
                    ? `V∆∞·ª£t: +${formatCurrency(gap)}`
                    : `Thi·∫øu: -${formatCurrency(gap)}`;
                
                html += `
                    <div style="background: #f9fafb; padding: 18px; border-radius: 10px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 5px 0; color: #1f2937; font-size: 15px; font-weight: 700;">${system}</h4>
                                <div style="display: flex; gap: 20px; font-size: 13px; color: #6b7280;">
                                    <span>üéØ Target: <strong style="color: #3b82f6;">${formatCurrency(target)}</strong></span>
                                    <span>üí∞ Th·ª±c T·∫ø: <strong style="color: #1f2937;">${formatCurrency(actual)}</strong></span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: 700; color: ${barColor}; margin-bottom: 5px;">
                                    ${statusIcon} ${percentText}%
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">${gapText}</div>
                            </div>
                        </div>
                        <div style="position: relative; height: 40px; background: #e5e7eb; border-radius: 8px; overflow: hidden; border: 2px solid #d1d5db;">
                            <!-- Target background -->
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(59, 130, 246, 0.15); border-radius: 6px;"></div>
                            <!-- Actual progress bar -->
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${Math.min(percent, 100)}%; background: ${barColor}; border-radius: 6px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;">
                                ${percent > 5 ? `<span style="color: white; font-weight: 700; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${percentText}%</span>` : ''}
                            </div>
                            ${percent > 100 ? `
                                <div style="position: absolute; top: 0; left: 100%; height: 100%; width: ${percent - 100}%; background: #f59e0b; border-radius: 0 6px 6px 0; display: flex; align-items: center; padding-left: 10px;">
                                    <span style="color: white; font-weight: 700; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">+${(percent - 100).toFixed(1)}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Legacy chart function (kept for compatibility but not used)
        function createTargetVsActualChart(monthKey, monthData, targetMonthData) {
            const ctx = document.getElementById('targetVsActualChart');
            if (!ctx) return;
            
            // Group by system
            const systemData = {};
            monthData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!system) return;
                
                if (!systemData[system]) {
                    systemData[system] = { actual: 0, target: 0 };
                }
                systemData[system].actual += row.vat || 0;
            });
            
            // Get targets for each system
            const brandsWithTargets = Object.keys(targetMonthData.brands || {});
            const systemTargets = targetMonthData.systems || {};
            
            Object.keys(systemData).forEach(system => {
                let systemTarget = 0;
                brandsWithTargets.forEach(brand => {
                    const brandSystems = systemTargets[brand] || {};
                    systemTarget += brandSystems[system] || 0;
                });
                systemData[system].target = systemTarget;
            });
            
            // Sort by target descending, take top 15
            const sortedSystems = Object.keys(systemData)
                .sort((a, b) => systemData[b].target - systemData[a].target)
                .slice(0, 15);
            
            const labels = sortedSystems;
            const targetValues = sortedSystems.map(s => systemData[s].target);
            const actualValues = sortedSystems.map(s => systemData[s].actual);
            
            // Destroy existing chart if exists
            if (charts.targetVsActual) {
                charts.targetVsActual.destroy();
            }
            
            // Create a cleaner visualization: Target as background, Actual as foreground with % labels
            charts.targetVsActual = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Target',
                            data: targetValues,
                            backgroundColor: 'rgba(229, 231, 235, 0.6)',
                            borderColor: 'rgba(156, 163, 175, 0.8)',
                            borderWidth: 1,
                            barThickness: 50,
                            order: 2,
                            categoryPercentage: 0.5,
                            barPercentage: 1.0
                        },
                        {
                            label: 'Th·ª±c T·∫ø',
                            data: actualValues,
                            backgroundColor: function(context) {
                                const index = context.dataIndex;
                                const actual = actualValues[index];
                                const target = targetValues[index];
                                if (target > 0) {
                                    const percent = (actual / target) * 100;
                                    if (percent >= 100) {
                                        return percent > 100 ? 'rgba(245, 158, 11, 0.95)' : 'rgba(16, 185, 129, 0.95)';
                                    } else if (percent >= 80) {
                                        return 'rgba(251, 191, 36, 0.95)';
                                    } else {
                                        return 'rgba(239, 68, 68, 0.95)';
                                    }
                                }
                                return 'rgba(16, 185, 129, 0.95)';
                            },
                            borderColor: function(context) {
                                const index = context.dataIndex;
                                const actual = actualValues[index];
                                const target = targetValues[index];
                                if (target > 0) {
                                    const percent = (actual / target) * 100;
                                    if (percent >= 100) {
                                        return percent > 100 ? '#f59e0b' : '#10b981';
                                    } else if (percent >= 80) {
                                        return '#fbbf24';
                                    } else {
                                        return '#ef4444';
                                    }
                                }
                                return '#10b981';
                            },
                            borderWidth: 2,
                            barThickness: 35,
                            order: 1,
                            categoryPercentage: 0.5,
                            barPercentage: 0.7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    layout: {
                        padding: {
                            left: 0,
                            right: 50,
                            top: 15,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 25,
                                padding: 15,
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `üìä ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const datasetLabel = context.dataset.label;
                                    const index = context.dataIndex;
                                    
                                    if (datasetLabel === 'Target') {
                                        return `üéØ Target: ${formatCurrency(value)}`;
                                    } else {
                                        const target = targetValues[index];
                                        const percent = target > 0 ? ((value / target) * 100).toFixed(1) : '-';
                                        return `üí∞ Th·ª±c T·∫ø: ${formatCurrency(value)}`;
                                    }
                                },
                                footer: function(tooltipItems) {
                                    if (tooltipItems.length > 0) {
                                        const index = tooltipItems[0].dataIndex;
                                        const actual = actualValues[index];
                                        const target = targetValues[index];
                                        const percent = target > 0 ? ((actual / target) * 100).toFixed(1) : '0';
                                        const gap = target > 0 ? Math.abs(actual - target) : 0;
                                        let status = '';
                                        if (target > 0) {
                                            if (actual >= target) {
                                                status = actual > target ? 'üéâ V∆∞·ª£t Target' : '‚úÖ ƒê·∫°t Target';
                                            } else {
                                                status = '‚ö†Ô∏è Ch∆∞a ƒê·∫°t';
                                            }
                                        }
                                        const gapText = actual > target 
                                            ? `V∆∞·ª£t: +${formatCurrency(gap)}`
                                            : `Thi·∫øu: -${formatCurrency(gap)}`;
                                        return `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n${status}\nüìà ${percent}% | ${gapText}`;
                                    }
                                    return '';
                                }
                            },
                            padding: 16,
                            titleFont: {
                                size: 16,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 14
                            },
                            backgroundColor: 'rgba(31, 41, 55, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            cornerRadius: 8
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: function(context) {
                                const index = context.dataIndex;
                                const actual = actualValues[index];
                                const target = targetValues[index];
                                if (target > 0) {
                                    const percent = (actual / target) * 100;
                                    if (percent >= 100) {
                                        return percent > 100 ? '#f59e0b' : '#10b981';
                                    } else if (percent >= 80) {
                                        return '#fbbf24';
                                    } else {
                                        return '#ef4444';
                                    }
                                }
                                return '#10b981';
                            },
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                const index = context.dataIndex;
                                const actual = actualValues[index];
                                const target = targetValues[index];
                                if (target > 0) {
                                    const percent = ((actual / target) * 100).toFixed(1);
                                    return percent + '%';
                                }
                                return '';
                            },
                            display: function(context) {
                                return context.datasetIndex === 1; // Only show on Actual dataset
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000000) {
                                        return (value / 1000000000).toFixed(1) + 'B';
                                    } else if (value >= 1000000) {
                                        return (value / 1000000).toFixed(0) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                },
                                maxRotation: 0,
                                minRotation: 0,
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                padding: 12,
                                color: '#6b7280'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.06)',
                                drawBorder: false,
                                lineWidth: 1
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                padding: 15,
                                color: '#1f2937',
                                maxRotation: 0
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 600,
                        easing: 'easeOutCubic'
                    }
                }
            });
        }

        // Initialize authentication first, then load data
        (async function() {
            console.log('üöÄ Initializing authentication...');
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:10045',message:'Initializing auth',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            
            await initializeAuth();
            if (currentUser) {
                console.log('‚úÖ User authenticated:', currentUser.name, '- Loading data...');
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/1f1282d2-a842-4ba8-9d4b-8fe5505363b4',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'sales_dashboard.html:10050',message:'User authenticated, calling loadAllData',data:{currentUserName:currentUser.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
                // #endregion
                loadAllData();
            } else {
                console.log('‚ö†Ô∏è No user authenticated, waiting for login...');
            }
        })();
    </script>
    <!-- Chart Fullscreen Modal -->
    <div id="chartFullscreenModal" class="chart-fullscreen-modal">
        <div class="chart-fullscreen-content">
            <div class="chart-fullscreen-header">
                <h2 id="chartFullscreenTitle"></h2>
                <button class="chart-fullscreen-close" onclick="closeChartFullscreen()">‚úï ƒê√≥ng</button>
            </div>
            <div class="chart-fullscreen-canvas-container">
                <canvas id="chartFullscreenCanvas"></canvas>
                <div id="chartFullscreenHTML" style="width: 100%; height: 100%; overflow: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // Chart Fullscreen Functions
        let fullscreenChart = null;
        let originalChartId = null;
        let landscapeMeta = null;
        
        function openChartFullscreen(chartId, title, isHTML = false) {
            const modal = document.getElementById('chartFullscreenModal');
            const titleEl = document.getElementById('chartFullscreenTitle');
            const canvasContainer = document.querySelector('.chart-fullscreen-canvas-container');
            const canvas = document.getElementById('chartFullscreenCanvas');
            const htmlContainer = document.getElementById('chartFullscreenHTML');
            
            originalChartId = chartId;
            titleEl.textContent = title;
            modal.classList.add('active');
            
            // Lock orientation to landscape on mobile
            if (window.innerWidth <= 768) {
                lockLandscapeOrientation();
            }
            
            if (isHTML) {
                // For HTML-based visualizations (like targetVsActual)
                canvas.style.display = 'none';
                htmlContainer.style.display = 'block';
                const originalContent = document.getElementById(chartId);
                if (originalContent) {
                    htmlContainer.innerHTML = originalContent.innerHTML;
                }
            } else {
                // For Chart.js charts
                canvas.style.display = 'block';
                htmlContainer.style.display = 'none';
                
                // Find the original chart
                const originalCanvas = document.getElementById(chartId);
                if (!originalCanvas) return;
                
                // Get chart instance from charts object
                let chartInstance = null;
                const chartKeys = Object.keys(charts);
                for (let key of chartKeys) {
                    if (charts[key] && charts[key].canvas && charts[key].canvas.id === chartId) {
                        chartInstance = charts[key];
                        break;
                    }
                }
                
                if (chartInstance && chartInstance.config) {
                    // Clone chart configuration
                    const config = JSON.parse(JSON.stringify(chartInstance.config));
                    
                    // Ensure options object exists
                    if (!config.options) {
                        config.options = {};
                    }
                    
                    // Update canvas reference
                    config.options.responsive = true;
                    config.options.maintainAspectRatio = false;
                    
                    // Destroy existing fullscreen chart if any
                    if (fullscreenChart) {
                        fullscreenChart.destroy();
                    }
                    
                    // Create new chart in fullscreen modal
                    try {
                        fullscreenChart = new Chart(canvas, config);
                        
                        // Resize chart to fit container
                        setTimeout(() => {
                            if (fullscreenChart) {
                                fullscreenChart.resize();
                            }
                        }, 100);
                    } catch (error) {
                        console.error('Error creating fullscreen chart:', error);
                        alert('Kh√¥ng th·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì fullscreen. Vui l√≤ng th·ª≠ l·∫°i.');
                        closeChartFullscreen();
                    }
                } else {
                    console.error('Chart instance not found for:', chartId);
                    alert('Kh√¥ng t√¨m th·∫•y bi·ªÉu ƒë·ªì. Vui l√≤ng th·ª≠ l·∫°i.');
                    closeChartFullscreen();
                }
            }
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        function closeChartFullscreen() {
            const modal = document.getElementById('chartFullscreenModal');
            modal.classList.remove('active');
            
            // Unlock orientation
            unlockLandscapeOrientation();
            
            // Destroy fullscreen chart
            if (fullscreenChart) {
                fullscreenChart.destroy();
                fullscreenChart = null;
            }
            
            // Restore body scroll
            document.body.style.overflow = '';
            
            originalChartId = null;
        }
        
        function lockLandscapeOrientation() {
            // Remove existing orientation meta if any
            unlockLandscapeOrientation();
            
            // Create new meta tag for landscape
            landscapeMeta = document.createElement('meta');
            landscapeMeta.name = 'viewport';
            landscapeMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape';
            document.getElementsByTagName('head')[0].appendChild(landscapeMeta);
            
            // Try to lock screen orientation (if supported)
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    // Lock failed, but meta tag will help
                });
            }
        }
        
        function unlockLandscapeOrientation() {
            // Remove landscape meta tag
            if (landscapeMeta && landscapeMeta.parentNode) {
                landscapeMeta.parentNode.removeChild(landscapeMeta);
                landscapeMeta = null;
            }
            
            // Restore original viewport
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.content = 'width=device-width, initial-scale=1.0';
            }
            
            // Unlock screen orientation (if supported)
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock();
            }
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('chartFullscreenModal');
                if (modal.classList.contains('active')) {
                    closeChartFullscreen();
                }
            }
        });
        
        // Close modal on background click
        document.getElementById('chartFullscreenModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChartFullscreen();
            }
        });
        
        // Handle window resize for fullscreen chart
        window.addEventListener('resize', function() {
            if (fullscreenChart) {
                setTimeout(() => {
                    fullscreenChart.resize();
                }, 100);
            }
        });
    </script>

    </body>
</html>
