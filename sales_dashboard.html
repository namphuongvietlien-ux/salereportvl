<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Doanh S·ªë 2023-2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }

        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            border-color: #cbd5e1;
        }

        .kpi-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #0f172a;
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 0.9em;
            color: #22c55e;
        }

        .kpi-change.negative {
            color: #ef4444;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="month"] {
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        select:hover, input[type="month"]:hover {
            border-color: #94a3b8;
        }

        select:focus, input[type="month"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h2 {
            color: #1e293b;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
        }
        
        .timeline-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .timeline-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
            color: #667eea;
        }
        
        .timeline-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.tall {
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #64748b;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: #f8fafc;
            color: #1e293b;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .forecast-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .forecast-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 10000;
            overflow: auto;
        }

        .forecast-modal-content {
            background: white;
            margin: 30px auto;
            max-width: 95%;
            width: 1600px;
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .forecast-modal-header {
            padding: 25px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .forecast-modal-body {
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .detail-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .detail-section h3 {
            color: #1e293b;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-timeline-btn {
            padding: 6px 14px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 8px;
        }
        
        .modal-timeline-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
            color: #667eea;
        }
        
        .modal-timeline-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.95em;
            }
            
            .kpi-container {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .kpi-card {
                padding: 15px;
            }
            
            .kpi-card h3 {
                font-size: 0.75em;
            }
            
            .kpi-value {
                font-size: 1.3em;
            }
            
            .filters {
                padding: 15px;
                gap: 12px;
            }
            
            .filter-group label {
                font-size: 0.8em;
            }
            
            select, input[type="month"] {
                padding: 12px 10px;
                font-size: 16px;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .chart-card h2 {
                font-size: 1.1em;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-container.tall {
                height: 350px;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            /* C·∫£i thi·ªán button tr√™n mobile */
            button {
                padding: 12px 20px !important;
                font-size: 1em !important;
                min-height: 44px;
            }
            
            /* TƒÉng k√≠ch th∆∞·ªõc clickable area */
            [onclick] {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            /* When printing modal, hide everything except modal */
            body.printing-modal #dashboard,
            body.printing-modal .header,
            body.printing-modal #loading {
                display: none !important;
            }
            
            body.printing-modal .forecast-modal {
                display: block !important;
            }
            
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                text-align: center;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Hide non-essential elements */
            .filter-group,
            button[onclick*="export"],
            button[onclick*="print"],
            button[onclick*="close"],
            .loading {
                display: none !important;
            }
            
            /* Page breaks */
            .chart-card,
            .kpi-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .chart-card.full-width {
                page-break-before: auto;
                page-break-after: auto;
            }
            
            /* Better spacing for print */
            .chart-card {
                margin-bottom: 30px;
            }
            
            /* Modal print styles */
            .forecast-modal {
                position: static !important;
                background: white !important;
            }
            
            .forecast-modal-content {
                max-width: 100% !important;
                max-height: 100% !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .forecast-modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Preserve colors */
            .kpi-card,
            .chart-card {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Table styles for print */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }
            
            /* Footer for print */
            @page {
                margin: 1.5cm;
                @bottom-right {
                    content: "Trang " counter(page) " / " counter(pages);
                }
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1 data-i18n="title">üìä B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë</h1>
            <p data-i18n="subtitle">Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë theo H·ªá th·ªëng, Nh√£n h√†ng v√† M√£ h√†ng (2023 - 2025)</p>
        </div>

        <div class="loading" id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

        <div id="dashboard" style="display: none;">
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3 data-i18n="totalRevenue">T·ªïng Doanh S·ªë</h3>
                    <div class="kpi-value" id="totalSales">0 ‚Ç´</div>
                    <div class="kpi-change" id="salesChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="yoyGrowth">TƒÉng Tr∆∞·ªüng YoY</h3>
                    <div class="kpi-value" id="yoyGrowth" style="font-size: 2em;">0%</div>
                    <div class="kpi-change" id="yoyTrend">--</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="topDriver">ƒê·ªông L·ª±c TƒÉng Tr∆∞·ªüng</h3>
                    <div class="kpi-value" id="topDriver" style="font-size: 1.3em; line-height: 1.2;">--</div>
                    <div class="kpi-change" id="driverContribution">--</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="totalOrders">T·ªïng S·ªë ƒê∆°n H√†ng</h3>
                    <div class="kpi-value" id="totalOrders">0</div>
                    <div class="kpi-change" id="ordersChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="avgOrderValue">Gi√° Tr·ªã TB/ƒê∆°n</h3>
                    <div class="kpi-value" id="avgOrderValue">0 ‚Ç´</div>
                    <div class="kpi-change" id="avgChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="momGrowth">TƒÉng Tr∆∞·ªüng MoM</h3>
                    <div class="kpi-value" id="momGrowth" style="font-size: 2em;">0%</div>
                    <div class="kpi-change" id="momTrend">--</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="totalProducts">S·ªë S·∫£n Ph·∫©m (L·ªçc)</h3>
                    <div class="kpi-value" id="totalProducts">0</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">T·ªïng: <span id="totalProductsAll">0</span></div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="activeStores">C·ª≠a H√†ng Ho·∫°t ƒê·ªông</h3>
                    <div class="kpi-value" id="activeStores">0</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;"><span data-i18n="average">Trung b√¨nh</span>: <span id="avgOrdersPerStore">0</span> <span data-i18n="orders">ƒë∆°n</span></div>
                </div>
            </div>

            <!-- Key Insights Section -->
            <div class="chart-card full-width" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 25px;">
                <h2 style="color: white; margin-bottom: 20px;" data-i18n="keyInsights">üí° Th√¥ng Tin Quan Tr·ªçng</h2>
                <div id="keyInsights" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="strategicFocus">üéØ Tr·ªçng T√¢m Chi·∫øn L∆∞·ª£c</h3>
                        <p id="strategicFocus" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="marketTrend">üìä Xu H∆∞·ªõng Th·ªã Tr∆∞·ªùng</h3>
                        <p id="marketTrend" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="riskAlert">‚ö†Ô∏è C·∫£nh B√°o R·ªßi Ro</h3>
                        <p id="riskAlert" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <h3 style="font-size: 1em; margin-bottom: 10px; opacity: 0.9;" data-i18n="growthOpportunity">üöÄ C∆° H·ªôi TƒÉng Tr∆∞·ªüng</h3>
                        <p id="growthOpportunity" style="font-size: 1.1em; font-weight: 600; margin: 0;">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label data-i18n="fromMonth">T·ª´ th√°ng</label>
                    <input type="month" id="startMonth" value="2023-01">
                </div>
                <div class="filter-group">
                    <label data-i18n="toMonth">ƒê·∫øn th√°ng</label>
                    <input type="month" id="endMonth" value="2025-12">
                </div>
                <div class="filter-group">
                    <label>Timeline nhanh</label>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="setQuickTimeline('1M')" class="timeline-btn">1M</button>
                        <button onclick="setQuickTimeline('3M')" class="timeline-btn">3M</button>
                        <button onclick="setQuickTimeline('6M')" class="timeline-btn">6M</button>
                        <button onclick="setQuickTimeline('1Y')" class="timeline-btn">1Y</button>
                        <button onclick="setQuickTimeline('ALL')" class="timeline-btn active">T·∫•t c·∫£</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label data-i18n="system">H·ªá th·ªëng</label>
                    <select id="systemFilter">
                        <option value="all" data-i18n="allSystems">T·∫•t c·∫£ h·ªá th·ªëng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label data-i18n="brand">Nh√£n h√†ng</label>
                    <select id="brandFilter">
                        <option value="all" data-i18n="allBrands">T·∫•t c·∫£ nh√£n h√†ng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>S·∫£n ph·∫©m</label>
                    <select id="productFilter" style="min-width: 250px;">
                        <option value="all">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                    </select>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <label>&nbsp;</label>
                    <button onclick="printDashboard()" style="
                        padding: 10px 20px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 0.95em;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-right: 10px;
                    ">
                        <span style="font-size: 1.2em;">üñ®Ô∏è</span>
                        In B√°o C√°o
                    </button>
                    <button onclick="exportToPowerPoint()" style="
                        padding: 10px 20px;
                        background: #dc2626;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.95em;
                        font-weight: 600;
                        transition: background 0.3s ease;
                        min-height: 44px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                        <span style="font-size: 1.2em;">üìä</span>
                        <span data-i18n="exportPPT">T·∫£i PowerPoint</span>
                    </button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <select id="languageSelector" onchange="switchLanguage(this.value)" style="
                        padding: 10px 15px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 0.95em;
                        background: white;
                        cursor: pointer;
                        min-height: 44px;
                        font-weight: 600;
                    ">
                        <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>
            </div>

            <div class="chart-grid">
                <div class="filter-group">
                    <label>H·ªá th·ªëng</label>
                    <select id="systemFilter">
                        <option value="all">T·∫•t c·∫£ h·ªá th·ªëng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Nh√£n h√†ng</label>
                    <select id="brandFilter">
                        <option value="all">T·∫•t c·∫£ nh√£n h√†ng</option>
                    </select>
                </div>
            </div>

            <div class="chart-grid">
                <!-- Forecast Section -->
                <div class="chart-card full-width">
                    <h2>üîÆ D·ª± ƒêo√°n Doanh S·ªë & S·ªë L∆∞·ª£ng</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o t·ª´ng d·ª± ƒëo√°n ƒë·ªÉ xem chi ti·∫øt theo h·ªá th·ªëng v√† s·∫£n ph·∫©m</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="forecast-card" onclick="showForecastDetail('currentMonth')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üî• D·ª± ƒêo√°n Th√°ng N√†y</h3>
                            <p id="currentMonthForecast" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="currentMonthQtyForecast" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div class="forecast-card" onclick="showForecastDetail('nextMonth')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üìÖ D·ª± ƒêo√°n Th√°ng Ti·∫øp Theo</h3>
                            <p id="nextMonthForecast" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="nextMonthQtyForecast" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div class="forecast-card" onclick="showForecastDetail('currentQuarter')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üìä TB Th√°ng Qu√Ω N√†y</h3>
                            <p id="currentQuarterAvg" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="currentQuarterQtyAvg" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div class="forecast-card" onclick="showForecastDetail('nextQuarter')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üéØ TB Th√°ng Qu√Ω T·ªõi</h3>
                            <p id="nextQuarterForecast" style="font-size: 1.5em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="nextQuarterQtyForecast" style="font-size: 1.1em; margin-top: 8px; opacity: 0.9;">S·ªë l∆∞·ª£ng: ...</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px;">üîÑ Xu H∆∞·ªõng Chu K·ª≥</h3>
                            <p id="seasonalityTrend" style="font-size: 1.3em; font-weight: 700; margin: 0;">ƒêang t·∫£i...</p>
                            <p id="seasonalityDetail" style="font-size: 0.95em; margin-top: 8px; opacity: 0.9;">...</p>
                        </div>
                    </div>
                    <div class="chart-container tall">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="salesTrend">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o ƒëi·ªÉm d·ªØ li·ªáu ƒë·ªÉ xem chi ti·∫øt th√°ng</p>
                    <div class="chart-container tall">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="brandTrend">üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o ƒë∆∞·ªùng line ƒë·ªÉ xem chi ti·∫øt brand</p>
                    <div class="chart-container tall">
                        <canvas id="brandTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 data-i18n="systemSales">üè¢ Doanh S·ªë Theo H·ªá Th·ªëng</h2>
                    <p style="color: #666; font-size: 0.85em; margin-top: 5px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</p>
                    <div class="chart-container">
                        <canvas id="systemChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 data-i18n="brandSales">üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng</h2>
                    <p style="color: #666; font-size: 0.85em; margin-top: 5px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</p>
                    <div class="chart-container">
                        <canvas id="brandChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="yearComparison">üìä So S√°nh Doanh S·ªë Theo NƒÉm</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o c·ªôt nƒÉm ƒë·ªÉ xem chi ti·∫øt theo h·ªá th·ªëng v√† th√°ng</p>
                    <div class="chart-container">
                        <canvas id="yearComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Year Drill-Down Modal -->
                <div id="yearDrillDownModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
                    <div style="background: white; margin: 50px auto; max-width: 95%; width: 1400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="drillDownTitle" style="margin: 0; color: #1f2937;">üìä Chi Ti·∫øt NƒÉm 2024</h2>
                            <button onclick="closeYearDrillDown()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                        </div>
                        <div style="padding: 30px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                                <div>
                                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Doanh S·ªë Theo Th√°ng</h3>
                                    <div style="height: 300px;">
                                        <canvas id="drillDownMonthlyChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <h3 style="color: #10b981; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng</h3>
                                    <div style="height: 300px;">
                                        <canvas id="drillDownSystemChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <h3 style="color: #6366f1; margin-bottom: 15px;">üìä B·∫£ng Chi Ti·∫øt: Doanh S·ªë Theo H·ªá Th·ªëng & Th√°ng</h3>
                            <div class="table-container" style="max-height: 500px; overflow: auto;">
                                <table id="drillDownTable" style="width: 100%; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: white; z-index: 20;">
                                        <tr>
                                            <th style="position: sticky; left: 0; background: white; z-index: 21; text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">#</th>
                                            <th style="position: sticky; left: 50px; background: white; z-index: 21; text-align: left; padding: 12px; border-bottom: 2px solid #e5e7eb; box-shadow: 2px 0 5px rgba(0,0,0,0.05); min-width: 200px;">H·ªá Th·ªëng</th>
                                            <th style="position: sticky; left: 250px; background: white; z-index: 21; text-align: right; padding: 12px; border-bottom: 2px solid #e5e7eb; box-shadow: 2px 0 5px rgba(0,0,0,0.05); min-width: 150px;">T·ªïng NƒÉm</th>
                                            <th style="text-align: center; padding: 12px; border-bottom: 2px solid #e5e7eb;" colspan="12">Doanh S·ªë Theo Th√°ng</th>
                                        </tr>
                                        <tr id="monthHeaderRow" style="background: #f9fafb;">
                                            <th style="position: sticky; left: 0; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>
                                            <th style="position: sticky; left: 50px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>
                                            <th style="position: sticky; left: 250px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="drillDownTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Universal Drill-Down Modal -->
                <div id="drillDownModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
                    <div style="background: white; margin: 50px auto; max-width: 95%; width: 1400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="modalTitle" style="margin: 0; color: #1f2937;">üìä Chi Ti·∫øt</h2>
                            <button onclick="closeDrillDownModal()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                        </div>
                        <div id="modalContent" style="padding: 30px;">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="topProducts">üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y</h2>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">üëÜ Click v√†o s·∫£n ph·∫©m ƒë·ªÉ xem doanh s·ªë theo th√°ng</p>
                    <div class="chart-container tall">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="storePerformance">üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng</h2>
                    <div class="chart-container">
                        <canvas id="storeActivityChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="topStores">üèÜ Top 30 C·ª≠a H√†ng Theo T·∫ßn Su·∫•t ƒê·∫∑t H√†ng</h2>
                    <div class="table-container">
                        <table id="storeFrequencyTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>C·ª≠a H√†ng</th>
                                    <th class="number">S·ªë L·∫ßn ƒê·∫∑t</th>
                                    <th class="number">T·ªïng ƒê∆°n H√†ng</th>
                                    <th class="number">T·ªïng Doanh Thu</th>
                                    <th class="number">TB/ƒê∆°n</th>
                                </tr>
                            </thead>
                            <tbody id="storeFrequencyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="growthAnalysis">üìä Ph√¢n T√≠ch Nguy√™n Nh√¢n Thay ƒê·ªïi Doanh S·ªë (2024 vs 2025)</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #10b981; margin-bottom: 15px;" data-i18n="topGrowthSKU">üìà Top 10 M√£ H√†ng TƒÉng Tr∆∞·ªüng M·∫°nh Nh·∫•t</h3>
                            <div class="table-container">
                                <table id="topGrowthSKUTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>M√£ H√†ng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">TƒÉng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topGrowthSKUTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #ef4444; margin-bottom: 15px;" data-i18n="topDeclineSKU">üìâ Top 10 M√£ H√†ng Gi·∫£m Nhi·ªÅu Nh·∫•t</h3>
                            <div class="table-container">
                                <table id="topDeclineSKUTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>M√£ H√†ng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">Gi·∫£m</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topDeclineSKUTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
                        <div>
                            <h3 style="color: #3b82f6; margin-bottom: 15px;" data-i18n="topGrowthSystem">üè¢ Top H·ªá Th·ªëng TƒÉng Tr∆∞·ªüng</h3>
                            <div class="table-container">
                                <table id="topGrowthSystemTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">TƒÉng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topGrowthSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #f59e0b; margin-bottom: 15px;" data-i18n="topDeclineSystem">üè¢ Top H·ªá Th·ªëng Gi·∫£m</h3>
                            <div class="table-container">
                                <table id="topDeclineSystemTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">Gi·∫£m</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topDeclineSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; flex: 1; min-width: 200px;">üìä Ph√¢n T√≠ch S·∫£n Ph·∫©m Theo NƒÉm & D·ª± ƒêo√°n (S·ªë L∆∞·ª£ng)</h2>
                        <button id="toggleYearlyTable" onclick="toggleYearlyProductTable()" style="
                            padding: 10px 20px;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.95em;
                            transition: background 0.3s ease;
                            min-height: 44px;
                            font-weight: 600;
                        ">
                        ">
                            <span id="toggleIcon">‚ñº</span> Thu g·ªçn
                        </button>
                    </div>
                    <div id="yearlyTableContainer" class="table-container" style="transition: all 0.3s ease; overflow: hidden;">
                        <table id="yearlyProductTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nh√£n H√†ng</th>
                                    <th>NƒÉm</th>
                                    <th class="number">S·ªë L∆∞·ª£ng</th>
                                    <th class="number">T·ªïng Doanh Thu (VAT)</th>
                                    <th class="number">TƒÉng Tr∆∞·ªüng</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyProductTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forecast Detail Modal -->
        <div id="forecastDetailModal" class="forecast-modal">
            <div class="forecast-modal-content">
                <div class="forecast-modal-header">
                    <h2 id="forecastModalTitle">üìä Chi Ti·∫øt D·ª± ƒêo√°n</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="printForecastDetail()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">üñ®Ô∏è In</button>
                        <button onclick="closeForecastDetail()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;">‚úï ƒê√≥ng</button>
                    </div>
                </div>
                <div class="forecast-modal-body">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="color: #1e40af; margin: 0;">üìà T·ªïng Quan D·ª± ƒêo√°n</h3>
                            <button id="stockoutAnalysisBtn" onclick="analyzeStockouts()" style="
                                padding: 8px 16px;
                                background: #ef4444;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.9em;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                üîç Ph√¢n T√≠ch ƒê·ª©t H√†ng
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmin(200px, 1fr)); gap: 15px;">
                            <div>
                                <p style="color: #64748b; font-size: 0.85em; margin: 0;">T·ªïng Doanh S·ªë</p>
                                <p id="forecastTotalSales" style="font-size: 1.4em; font-weight: 700; color: #1e40af; margin: 5px 0 0 0;">0 ‚Ç´</p>
                            </div>
                            <div>
                                <p style="color: #64748b; font-size: 0.85em; margin: 0;">T·ªïng S·ªë L∆∞·ª£ng</p>
                                <p id="forecastTotalQty" style="font-size: 1.4em; font-weight: 700; color: #10b981; margin: 5px 0 0 0;">0</p>
                            </div>
                            <div id="stockoutAdjustment" style="display: none;">
                                <p style="color: #64748b; font-size: 0.85em; margin: 0;">ƒêi·ªÅu Ch·ªânh ƒê·ª©t H√†ng</p>
                                <p id="stockoutAdjustmentValue" style="font-size: 1.4em; font-weight: 700; margin: 5px 0 0 0;">0 ‚Ç´</p>
                            </div>
                        </div>
                    </div>

                    <div id="stockoutAnalysisSection" style="display: none; background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #92400e; margin: 0;">‚ö†Ô∏è Ph√¢n T√≠ch S·∫£n Ph·∫©m ƒê·ª©t H√†ng</h3>
                            <button onclick="clearAllStockoutProducts()" style="
                                padding: 8px 16px;
                                background: #dc2626;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-size: 0.9em;
                                font-weight: 600;
                                cursor: pointer;
                            ">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
                        </div>
                        <div id="stockoutContent"></div>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-section">
                            <h3>üè¢ Chi Ti·∫øt Theo H·ªá Th·ªëng</h3>
                            <div class="table-container" style="max-height: 500px;">
                                <table id="forecastSystemTable" style="font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">S·ªë L∆∞·ª£ng</th>
                                            <th class="number">Doanh S·ªë</th>
                                            <th class="number" style="background: #fef3c7;">ƒê·ª©t H√†ng</th>
                                            <th class="number">% T·ªïng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="forecastSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>üè∑Ô∏è Chi Ti·∫øt Theo Nh√£n H√†ng (Top 20)</h3>
                            <div class="table-container" style="max-height: 500px;">
                                <table id="forecastBrandTable" style="font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Nh√£n H√†ng</th>
                                            <th class="number">S·ªë L∆∞·ª£ng</th>
                                            <th class="number">Doanh S·ªë</th>
                                            <th class="number" style="background: #fef3c7;">ƒê·ª©t H√†ng</th>
                                            <th class="number">% T·ªïng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="forecastBrandTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section" style="margin-top: 25px;">
                        <h3>üì¶ Chi Ti·∫øt Theo S·∫£n Ph·∫©m (Top 50)</h3>
                        <div class="table-container" style="max-height: 600px;">
                            <table id="forecastProductTable" style="font-size: 0.85em;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>T√™n R√∫t G·ªçn SP</th>
                                        <th>Nh√£n H√†ng</th>
                                        <th class="number">S·ªë L∆∞·ª£ng</th>
                                        <th class="number">Doanh S·ªë</th>
                                        <th class="number" style="background: #fef3c7;">ƒê·ª©t H√†ng</th>
                                        <th class="number">% T·ªïng</th>
                                    </tr>
                                </thead>
                                <tbody id="forecastProductTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};
        let forecastDetailsData = {}; // Store forecast details

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format number
        function formatNumber(value) {
            return new Intl.NumberFormat('vi-VN').format(value);
        }

        // Shorten product name for better display
        function shortenProductName(fullName) {
            if (!fullName) return 'N/A';
            
            // Check lookup table first
            const trimmedName = fullName.trim();
            if (productNameLookup[trimmedName]) {
                return productNameLookup[trimmedName];
            }
            
            // Fallback: Remove content in parentheses (product codes)
            let name = fullName.replace(/\s*\([^)]*\)\s*/g, ' ');
            
            // Remove extra whitespace
            name = name.replace(/\s+/g, ' ').trim();
            
            // If still too long, take first 50 characters
            if (name.length > 50) {
                name = name.substring(0, 47) + '...';
            }
            
            return name;
        }

        // Parse date from filename
        function parseFilename(filename) {
            const match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return new Date(match[1], parseInt(match[2]) - 1, match[3]);
            }
            return null;
        }

        // Load product name lookup table
        let productNameLookup = {};
        let productBrandLookup = {}; // Th√™m lookup cho NHAN (brand)
        async function loadProductNameLookup() {
            return new Promise((resolve) => {
                Papa.parse('ten_sp_nhan.csv', {
                    download: true,
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        results.data.forEach(row => {
                            const tenSP = (row['TEN SP'] || '').trim();
                            const tenRutGon = (row['TEN RUT GON'] || '').trim();
                            const nhan = (row['NHAN'] || '').trim();
                            if (tenSP && tenRutGon) {
                                productNameLookup[tenSP] = tenRutGon;
                                productBrandLookup[tenSP] = nhan || 'N/A';
                            }
                        });
                        console.log('Loaded', Object.keys(productNameLookup).length, 'product name mappings with brands');
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error loading product lookup:', error);
                        resolve(); // Continue even if lookup fails
                    }
                });
            });
        }

        // ==========================================
        // DANH S√ÅCH M√É H√ÄNG LO·∫†I TR·ª™ KH·ªéI D·ª∞ KI·∫æN 2026
        // Th√™m/b·ªõt m√£ h√†ng v√†o danh s√°ch n√†y ƒë·ªÉ lo·∫°i tr·ª´ kh·ªèi forecast
        // ==========================================
        const EXCLUDED_SKUS_FROM_FORECAST = [
            '1.81 KG',
            'R03(4B)AAA',
            'LR03(4B)AAA',
            'LR03(2B)AAA',
            'LR6(8B)AA',
            'LR03(6B)AAA',
            'LR03(8B)AAA',
            'R6(4S)F-GP-AA(8117)',
            'KHAC_Xe ƒë·ªì ch∆°i - FBG74',
            'R14(2B)',
            'NUOC HOA PURE GAME',
            'NUOC HOA GET READY'
        ];
        
        // T·ª∑ l·ªá tƒÉng tr∆∞·ªüng ƒë·∫∑c bi·ªát cho t·ª´ng th∆∞∆°ng hi·ªáu (ghi ƒë√® t√≠nh to√°n t·ª± ƒë·ªông)
        const BRAND_CUSTOM_GROWTH = {
            'COLEMAN': 0.30  // Coleman tƒÉng tr∆∞·ªüng 30%
        };

        // ==========================================
        // TRANSLATIONS / NG√îN NG·ªÆ
        // ==========================================
        const translations = {
            vi: {
                title: 'üìä B√°o C√°o Doanh S·ªë  Vi·ªát Li√™n',
                subtitle: 'Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë b√°n h√†ng t·ª´ 2023-2025',
                totalRevenue: 'T·ªïng Doanh Thu',
                totalOrders: 'S·ªë ƒê∆°n H√†ng',
                avgOrderValue: 'Gi√° Tr·ªã TB/ƒê∆°n',
                totalProducts: 'S·∫£n Ph·∫©m',
                activeStores: 'C·ª≠a H√†ng Ho·∫°t ƒê·ªông',
                average: 'Trung b√¨nh',
                orders: 'ƒë∆°n',
                fromMonth: 'T·ª´ th√°ng',
                toMonth: 'ƒê·∫øn th√°ng',
                system: 'H·ªá th·ªëng',
                brand: 'Nh√£n h√†ng',
                allSystems: 'T·∫•t c·∫£ h·ªá th·ªëng',
                allBrands: 'T·∫•t c·∫£ nh√£n h√†ng',
                exportPPT: 'T·∫£i PowerPoint',
                salesTrend: 'üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng',
                brandTrend: 'üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng',
                systemSales: 'üè¢ Doanh S·ªë Theo H·ªá Th·ªëng',
                brandSales: 'üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng',
                yearComparison: 'üìä So S√°nh Doanh S·ªë Theo NƒÉm',
                topProducts: 'üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y',
                storePerformance: 'üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng',
                topStores: 'üèÜ Top 30 C·ª≠a H√†ng Theo T·∫ßn Su·∫•t ƒê·∫∑t H√†ng',
                growthAnalysis: 'üìä Ph√¢n T√≠ch Nguy√™n Nh√¢n Thay ƒê·ªïi Doanh S·ªë (2024 vs 2025)',
                topGrowthSKU: 'üìà Top 10 M√£ H√†ng TƒÉng Tr∆∞·ªüng M·∫°nh Nh·∫•t',
                topDeclineSKU: 'üìâ Top 10 M√£ H√†ng Gi·∫£m Nhi·ªÅu Nh·∫•t',
                topGrowthSystem: 'üè¢ Top H·ªá Th·ªëng TƒÉng Tr∆∞·ªüng',
                topDeclineSystem: 'üè¢ Top H·ªá Th·ªëng Gi·∫£m',
                brandYearComparison: 'üìä So S√°nh Doanh S·ªë Theo NƒÉm (Nh√£n H√†ng)',
                yoyGrowth: 'TƒÉng Tr∆∞·ªüng YoY',
                momGrowth: 'TƒÉng Tr∆∞·ªüng MoM',
                topDriver: 'ƒê·ªông L·ª±c TƒÉng Tr∆∞·ªüng',
                keyInsights: 'üí° Th√¥ng Tin Quan Tr·ªçng',
                strategicFocus: 'üéØ Tr·ªçng T√¢m Chi·∫øn L∆∞·ª£c',
                marketTrend: 'üìä Xu H∆∞·ªõng Th·ªã Tr∆∞·ªùng',
                riskAlert: '‚ö†Ô∏è C·∫£nh B√°o R·ªßi Ro',
                growthOpportunity: 'üöÄ C∆° H·ªôi TƒÉng Tr∆∞·ªüng'
            },
            en: {
                title: 'üìä Sales Report - Viet Lien',
                subtitle: 'Detailed sales analysis from 2023-2025',
                totalRevenue: 'Total Revenue',
                totalOrders: 'Total Orders',
                avgOrderValue: 'Avg Order Value',
                totalProducts: 'Products',
                activeStores: 'Active Stores',
                average: 'Average',
                orders: 'orders',
                fromMonth: 'From month',
                toMonth: 'To month',
                system: 'System',
                brand: 'Brand',
                allSystems: 'All systems',
                allBrands: 'All brands',
                exportPPT: 'Export PowerPoint',
                salesTrend: 'üìà Monthly Sales Trend',
                brandTrend: 'üè∑Ô∏è Sales Trend by Brand',
                systemSales: 'üè¢ Sales by System',
                brandSales: 'üè∑Ô∏è Sales by Brand',
                yearComparison: 'üìä Year-over-Year Comparison',
                topProducts: 'üîù Top 20 Best-Selling Products',
                storePerformance: 'üè™ Store Performance - Active Stores by Month',
                topStores: 'üèÜ Top 30 Stores by Order Frequency',
                growthAnalysis: 'üìä Sales Change Analysis (2024 vs 2025)',
                topGrowthSKU: 'üìà Top 10 Growing SKUs',
                topDeclineSKU: 'üìâ Top 10 Declining SKUs',
                topGrowthSystem: 'üè¢ Top Growing Systems',
                topDeclineSystem: 'üè¢ Top Declining Systems',
                brandYearComparison: 'üìä Year-over-Year Comparison (By Brand)',
                yoyGrowth: 'YoY Growth',
                momGrowth: 'MoM Growth',
                topDriver: 'Top Growth Driver',
                keyInsights: 'üí° Key Insights',
                strategicFocus: 'üéØ Strategic Focus',
                marketTrend: 'üìä Market Trend',
                riskAlert: '‚ö†Ô∏è Risk Alert',
                growthOpportunity: 'üöÄ Growth Opportunity'
            }
        };

        let currentLanguage = localStorage.getItem('dashboardLanguage') || 'vi';

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('dashboardLanguage', lang);
            document.documentElement.lang = lang;
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update select options
            const systemFilter = document.getElementById('systemFilter');
            if (systemFilter && systemFilter.options[0]) {
                systemFilter.options[0].textContent = translations[lang].allSystems;
            }
            
            const brandFilter = document.getElementById('brandFilter');
            if (brandFilter && brandFilter.options[0]) {
                brandFilter.options[0].textContent = translations[lang].allBrands;
            }
            
            // Re-render charts with new language
            updateDashboard();
        }

        function initLanguage() {
            const selector = document.getElementById('languageSelector');
            if (selector) {
                selector.value = currentLanguage;
            }
            switchLanguage(currentLanguage);
        }

        // Load CUSTOMERS lookup table
        let customersLookup = {};
        async function loadCustomers() {
            return new Promise((resolve) => {
                Papa.parse('CUSTOMERS.csv', {
                    download: true,
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        results.data.forEach(row => {
                            const nam = parseInt(row['NAM']);
                            const systemCode = (row['SYSTEM CODE'] || '').trim();
                            const heThong = (row['HE THONG'] || '').trim();
                            if (nam && systemCode && heThong) {
                                const key = `${nam}_${systemCode}`;
                                customersLookup[key] = heThong;
                            }
                        });
                        console.log('Loaded', Object.keys(customersLookup).length, 'customer system mappings');
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error loading customers:', error);
                        resolve(); // Continue even if lookup fails
                    }
                });
            });
        }

        // Load all CSV files
        async function loadAllData() {
            // Load lookup tables first
            await loadProductNameLookup();
            await loadCustomers();
            await loadProductNameLookup();
            // CH·ªà L·∫§Y FILE CU·ªêI TH√ÅNG (lo·∫°i b·ªè file trung gian ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
            const files = [
                '2023-01-31_DS_31.01.2023.csv', '2023-02-28_DS_28.02.23.csv', '2023-03-31_DS_31.03.2023.csv',
                '2023-04-30_DS_30.04.2023.csv', '2023-05-27_DS_27.05.2023.csv', '2023-06-30_DS_30.06.2023.csv',
                '2023-07-31_DS_31.07.2023.csv', '2023-08-31_DS_31.08.2023.csv', '2023-09-30_DS_30.09.2023.csv',
                '2023-10-31_DS_31.10.2023.csv', '2023-11-30_DS_30.11.2023.csv', '2023-12-31_DS_31.12.2023.csv',
                '2024-01-31_DS_31.01.2024.csv', '2024-02-29_DS_29.02.24.csv', '2024-03-30_DS_30.03.2024.csv',
                '2024-04-30_DS_30.04.2024.csv', '2024-05-31_DS_31.05.2024.csv', '2024-06-30_DS_30.06.2024.csv',
                '2024-07-31_DS_31.07.2024.csv', '2024-08-31_DS_31.08.2024.csv', '2024-09-30_DS_30.09.2024.csv',
                '2024-10-31_DS_31.10.2024.csv', '2024-11-30_DS_30.11.2024.csv', '2024-12-31_DS_31.12.2024.csv',
                '2025-01-24_DS_24.01.25.csv', '2025-02-28_DS_28.02.25.csv', '2025-03-31_DS_31.03.25.csv',
                '2025-04-30_DS_30.4.25.csv', '2025-05-31_DS_31.05.25.csv', '2025-06-30_DS_30.06.25.csv',
                '2025-07-28_DS_28.07.25.csv', '2025-08-31_DS_31.08.25.csv', '2025-09-30_DS_30.09.25 .csv',
                '2025-10-31_DS_31.10.25 .csv', 
                // Th√°ng 11: Ch·ªâ l·∫•y file 30/11 (b·ªè file 22/11)
                '2025-11-30_DS_30.11.25.csv',
                // Th√°ng 12: Ch·ªâ l·∫•y file 31/12 (b·ªè file 15/12 v√† 22/12)
                '2025-12-31_DS_31.12.25.csv'
            ];

            const promises = files.map(filename => {
                return new Promise((resolve, reject) => {
                    const date = parseFilename(filename);
                    // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi + cache buster
                    const filePath = 'CSV_Output_Latest_Only/' + filename + '?v=' + Date.now();
                    
                    Papa.parse(filePath, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        encoding: 'UTF-8',
                        complete: function(results) {
                            // Debug: log t√™n c·ªôt ƒë·ªÉ ki·ªÉm tra
                            if (results.data.length > 0 && filename.includes('2025-11-30')) {
                                console.log('Column names in CSV:', Object.keys(results.data[0]));
                            }
                            
                            const data = results.data
                                // B∆∞·ªõc 1: L·ªçc b·ªè header rows (NGAY = "NGAY")
                                .filter(row => row.NGAY && row.NGAY !== 'NGAY')
                                // B∆∞·ªõc 2: Map v√† merge v·ªõi lookups (gi·ªëng Excel Power Query)
                                .map(row => {
                                    const sl = parseFloat(row.SL) || 0;
                                    const donGia = parseFloat(row['ƒê∆†N GI√Å']) || 0;
                                    // C√¥ng th·ª©c Power Query: VAT = SL * ƒê∆†N GI√Å * 1.1
                                    const calculatedVAT = sl * donGia * 1.1;
                                    
                                    const tenSP = (row['T√äN SP'] || '').trim();
                                    const maKH = (row['MA KH'] || '').toString().trim();
                                    
                                    // QUAN TR·ªåNG: D√πng NHAN t·ª´ ten_sp_nhan (kh√¥ng d√πng NH√ÉN H√ÄNG t·ª´ CSV)
                                    const nhanHang = productBrandLookup[tenSP] || 'N/A';
                                    
                                    // Merge v·ªõi CUSTOMERS: NAM + MA KH -> HE THONG
                                    const customerKey = `${date.getFullYear()}_${maKH}`;
                                    const heThongFromCustomers = customersLookup[customerKey] || null;
                                    
                                    // L·∫•y M√É HH t·ª´ c·ªôt th·ª© 8 (index 7)
                                    const maHH = (row['M√É HH'] || row['MA HH'] || '').toString().trim();
                                    
                                    return {
                                        'SO HD': row['SO HD'],
                                        'NGAY': row.NGAY,
                                        'MA KH': maKH,
                                        'M√É HH': maHH,
                                        'T√äN SP': tenSP,
                                        'NH√ÉN H√ÄNG': nhanHang, // T·ª´ NHAN trong ten_sp_nhan
                                        'H·ªÜ TH·ªêNG': heThongFromCustomers, // T·ª´ CUSTOMERS, kh√¥ng ph·∫£i CSV g·ªëc
                                        'C·ª¨A H√ÄNG': row['C·ª¨A H√ÄNG'],
                                        month: date,
                                        monthKey: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                                        year: date.getFullYear(),
                                        vat: calculatedVAT,
                                        thanhTien: parseFloat(row['TH√ÄNH TI·ªÄN']) || 0,
                                        soLuong: sl,
                                        donGia: donGia,
                                        // Key ƒë·ªÉ dedup: SO HD + NGAY + M√É HH + T√äN SP + SL
                                        duplicateKey: `${row['SO HD']}_${row.NGAY}_${maHH}_${tenSP}_${sl}`
                                    };
                                });
                            resolve(data);
                        },
                        error: function(error) {
                            console.error(`Error loading ${filename}:`, error);
                            resolve([]);
                        }
                    });
                });
            });

            const results = await Promise.all(promises);
            const rawData = results.flat();
            
            console.log('Raw data loaded:', rawData.length, 'rows');
            
            // DEDUP theo Excel Power Query: Group by SO HD + NGAY + M√É HH + T√äN SP + SL
            // Gi·ªØ d√≤ng ƒê·∫¶U TI√äN (Table.FirstN(_,1))
            const uniqueMap = new Map();
            let duplicateCount = 0;
            rawData.forEach(row => {
                const key = row.duplicateKey;
                if (!uniqueMap.has(key)) {
                    uniqueMap.set(key, row);
                } else {
                    duplicateCount++;
                }
            });
            
            const afterDedup = Array.from(uniqueMap.values());
            console.log('After dedup:', afterDedup.length, 'rows (removed', duplicateCount, 'duplicates)');
            
            // L·ªåC H·ªÜ TH·ªêNG != null (t·ª´ CUSTOMERS)
            const afterSystemFilter = afterDedup.filter(row => row['H·ªÜ TH·ªêNG'] !== null);
            console.log('Filter H·ªÜ TH·ªêNG not null:', afterSystemFilter.length, 'rows');
            
            // L·ªåC B·ªé NH√ÉN H√ÄNG = "N/A"
            allData = afterSystemFilter.filter(row => row['NH√ÉN H√ÄNG'] !== 'N/A' && row['NH√ÉN H√ÄNG'] !== '');
            console.log('After filter NH√ÉN H√ÄNG:', allData.length, 'rows');
            
            // T√≠nh t·ªïng VAT ƒë·ªÉ debug
            const totalVAT = allData.reduce((sum, row) => sum + row.vat, 0);
            console.log('üí∞ Total VAT (all data):', totalVAT.toLocaleString('vi-VN'), 'VND');
            
            // Debug th√°ng 11/2025 c·ª• th·ªÉ
            const nov2025 = allData.filter(row => row.monthKey === '2025-11');
            const nov2025VAT = nov2025.reduce((sum, row) => sum + row.vat, 0);
            console.log('üìÖ Nov 2025:', nov2025.length, 'rows, VAT:', nov2025VAT.toLocaleString('vi-VN'), 'VND');
            
            // Debug th√°ng 4/2025 c·ª• th·ªÉ
            const apr2025Raw = rawData.filter(row => row.monthKey === '2025-04');
            const apr2025Final = allData.filter(row => row.monthKey === '2025-04');
            const apr2025VAT = apr2025Final.reduce((sum, row) => sum + row.vat, 0);
            console.log('üìÖ Apr 2025: Raw:', apr2025Raw.length, '‚Üí Final:', apr2025Final.length, 'rows, VAT:', apr2025VAT.toLocaleString('vi-VN'), 'VND');
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            initializeFilters();
            initLanguage();
            updateDashboard();
        }

        // Initialize filters
        function initializeFilters() {
            const systems = [...new Set(allData.map(d => d['H·ªÜ TH·ªêNG']))].filter(Boolean).sort();
            const brands = [...new Set(allData.map(d => d['NH√ÉN H√ÄNG']))].filter(Boolean).sort();
            
            // Get unique shortened product names
            const products = [...new Set(allData.map(d => shortenProductName(d['T√äN SP'])))].filter(Boolean).sort();

            const systemSelect = document.getElementById('systemFilter');
            systems.forEach(system => {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = system;
                systemSelect.appendChild(option);
            });

            const brandSelect = document.getElementById('brandFilter');
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            const productSelect = document.getElementById('productFilter');
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productSelect.appendChild(option);
            });

            // Add event listeners with cascading update
            document.getElementById('startMonth').addEventListener('change', updateDashboard);
            document.getElementById('endMonth').addEventListener('change', updateDashboard);
            document.getElementById('systemFilter').addEventListener('change', () => {
                updateCascadingFilters();
                updateDashboard();
            });
            document.getElementById('brandFilter').addEventListener('change', () => {
                updateCascadingFilters();
                updateDashboard();
            });
            document.getElementById('productFilter').addEventListener('change', updateDashboard);
        }

        // Update cascading filters based on current selection
        function updateCascadingFilters() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const selectedSystem = document.getElementById('systemFilter').value;
            const selectedBrand = document.getElementById('brandFilter').value;
            const selectedProduct = document.getElementById('productFilter').value;

            // Filter data based on current selections
            let filteredData = allData.filter(row => {
                if (startMonth && row.monthKey < startMonth) return false;
                if (endMonth && row.monthKey > endMonth) return false;
                if (selectedSystem !== 'all' && row['H·ªÜ TH·ªêNG'] !== selectedSystem) return false;
                if (selectedBrand !== 'all' && row['NH√ÉN H√ÄNG'] !== selectedBrand) return false;
                return true;
            });

            // Update brand dropdown based on selected system
            if (selectedSystem !== 'all') {
                const availableBrands = [...new Set(filteredData.map(d => d['NH√ÉN H√ÄNG']))].filter(Boolean).sort();
                const brandSelect = document.getElementById('brandFilter');
                const currentBrand = brandSelect.value;
                
                brandSelect.innerHTML = '<option value="all">T·∫•t c·∫£ nh√£n h√†ng</option>';
                availableBrands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    if (brand === currentBrand) option.selected = true;
                    brandSelect.appendChild(option);
                });
            }

            // Update product dropdown based on selected system and brand (using shortened names)
            const availableProducts = [...new Set(filteredData.map(d => shortenProductName(d['T√äN SP'])))].filter(Boolean).sort();
            const productSelect = document.getElementById('productFilter');
            const currentProduct = productSelect.value;
            
            productSelect.innerHTML = '<option value="all">T·∫•t c·∫£ s·∫£n ph·∫©m</option>';
            availableProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                if (product === currentProduct) option.selected = true;
                productSelect.appendChild(option);
            });
        }

        // Quick timeline filter
        function setQuickTimeline(period) {
            const latestDate = new Date('2025-12-01');
            let startDate;
            
            switch(period) {
                case '1M':
                    startDate = new Date(latestDate);
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate = new Date(latestDate);
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
                case '6M':
                    startDate = new Date(latestDate);
                    startDate.setMonth(startDate.getMonth() - 6);
                    break;
                case '1Y':
                    startDate = new Date(latestDate);
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case 'ALL':
                    startDate = new Date('2023-01-01');
                    break;
            }
            
            const startMonth = startDate.toISOString().substring(0, 7);
            const endMonth = '2025-12';
            
            document.getElementById('startMonth').value = startMonth;
            document.getElementById('endMonth').value = endMonth;
            
            // Update button states
            document.querySelectorAll('.timeline-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateDashboard();
        }

        // Filter data
        function filterData() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const system = document.getElementById('systemFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const product = document.getElementById('productFilter').value;

            return allData.filter(row => {
                if (startMonth && row.monthKey < startMonth) return false;
                if (endMonth && row.monthKey > endMonth) return false;
                if (system !== 'all' && row['H·ªÜ TH·ªêNG'] !== system) return false;
                if (brand !== 'all' && row['NH√ÉN H√ÄNG'] !== brand) return false;
                if (product !== 'all' && shortenProductName(row['T√äN SP']) !== product) return false;
                return true;
            });
        }

        // Update KPIs
        function updateKPIs(data) {
            const totalSales = data.reduce((sum, row) => sum + row.vat, 0);
            const uniqueOrders = new Set(data.map(d => d['SO HD']).filter(Boolean)).size;
            const avgOrder = uniqueOrders > 0 ? totalSales / uniqueOrders : 0;
            
            // ƒê·∫øm s·∫£n ph·∫©m unique theo filter hi·ªán t·∫°i
            console.log('Sample row keys:', data.length > 0 ? Object.keys(data[0]) : 'No data');
            console.log('Sample row M√É HH:', data.length > 0 ? data[0]['M√É HH'] : 'No data');
            
            const productCodes = data.map(d => d['M√É HH']).filter(Boolean);
            const uniqueProducts = new Set(productCodes).size;
            
            console.log('Product codes sample (first 10):', productCodes.slice(0, 10));
            console.log('Unique products:', uniqueProducts);
            
            // ƒê·∫øm t·ªïng s·∫£n ph·∫©m trong to√†n b·ªô d·ªØ li·ªáu (kh√¥ng filter)
            const allProductCodes = allData.map(d => d['M√É HH']).filter(Boolean);
            const totalAllProducts = new Set(allProductCodes).size;
            
            const systems = data.map(d => d['H·ªÜ TH·ªêNG'] || d.H·ªÜ_TH·ªêNG || d['HE THONG']).filter(Boolean);
            const uniqueSystems = new Set(systems).size;
            
            const brands = data.map(d => d['NH√ÉN H√ÄNG'] || d.NH√ÉN_H√ÄNG || d['NHAN HANG']).filter(Boolean);
            const uniqueBrands = new Set(brands).size;
            
            // Calculate unique stores
            const stores = data.map(d => d['C·ª¨A H√ÄNG']).filter(Boolean);
            const uniqueStores = new Set(stores).size;
            
            // Calculate average orders per store
            const avgOrdersPerStore = uniqueStores > 0 ? uniqueOrders / uniqueStores : 0;
            
            console.log('KPI Debug:', {
                totalRows: data.length,
                totalRowsAll: allData.length,
                uniqueProducts: uniqueProducts,
                totalAllProducts: totalAllProducts,
                sampleProduct: productCodes[0],
                uniqueSystems: uniqueSystems,
                uniqueBrands: uniqueBrands,
                uniqueStores: uniqueStores
            });

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalOrders').textContent = formatNumber(uniqueOrders);
            document.getElementById('avgOrderValue').textContent = formatCurrency(avgOrder);
            document.getElementById('totalProducts').textContent = formatNumber(uniqueProducts);
            document.getElementById('totalProductsAll').textContent = formatNumber(totalAllProducts);
            document.getElementById('activeStores').textContent = formatNumber(uniqueStores);
            document.getElementById('avgOrdersPerStore').textContent = formatNumber(Math.round(avgOrdersPerStore));

            // Calculate YoY growth and trends
            const currentYear = 2025;
            const previousYear = 2024;
            
            const currentYearData = allData.filter(d => d.year === currentYear);
            const previousYearData = allData.filter(d => d.year === previousYear);
            
            const currentSales = currentYearData.reduce((sum, row) => sum + row.vat, 0);
            const previousSales = previousYearData.reduce((sum, row) => sum + row.vat, 0);
            const yoyGrowth = previousSales > 0 ? ((currentSales - previousSales) / previousSales * 100) : 0;
            
            document.getElementById('yoyGrowth').textContent = `${yoyGrowth >= 0 ? '+' : ''}${yoyGrowth.toFixed(1)}%`;
            document.getElementById('yoyGrowth').style.color = yoyGrowth >= 0 ? '#10b981' : '#ef4444';
            document.getElementById('yoyTrend').textContent = `${formatCurrency(Math.abs(currentSales - previousSales))} ${yoyGrowth >= 0 ? 'tƒÉng' : 'gi·∫£m'}`;
            document.getElementById('yoyTrend').className = yoyGrowth >= 0 ? 'kpi-change' : 'kpi-change negative';
            
            // Calculate MoM growth (most recent 2 months)
            const allMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            if (allMonths.length >= 2) {
                const lastMonth = allMonths[allMonths.length - 1];
                const prevMonth = allMonths[allMonths.length - 2];
                
                const lastMonthSales = allData.filter(d => d.monthKey === lastMonth).reduce((sum, row) => sum + row.vat, 0);
                const prevMonthSales = allData.filter(d => d.monthKey === prevMonth).reduce((sum, row) => sum + row.vat, 0);
                const momGrowth = prevMonthSales > 0 ? ((lastMonthSales - prevMonthSales) / prevMonthSales * 100) : 0;
                
                document.getElementById('momGrowth').textContent = `${momGrowth >= 0 ? '+' : ''}${momGrowth.toFixed(1)}%`;
                document.getElementById('momGrowth').style.color = momGrowth >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('momTrend').textContent = `${lastMonth} vs ${prevMonth}`;
            }
            
            // Find top growth driver (brand or system)
            const brandGrowth = {};
            currentYearData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandGrowth[brand]) brandGrowth[brand] = 0;
                brandGrowth[brand] += row.vat;
            });
            previousYearData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandGrowth[brand]) brandGrowth[brand] = 0;
                brandGrowth[brand] -= row.vat;
            });
            
            const topGrowthBrand = Object.entries(brandGrowth)
                .filter(([brand, growth]) => growth > 0)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (topGrowthBrand) {
                document.getElementById('topDriver').textContent = topGrowthBrand[0];
                const contribution = currentSales > 0 ? (topGrowthBrand[1] / (currentSales - previousSales) * 100) : 0;
                document.getElementById('driverContribution').textContent = `+${formatCurrency(topGrowthBrand[1])} (${contribution.toFixed(0)}% ƒë√≥ng g√≥p)`;
                document.getElementById('driverContribution').className = 'kpi-change';
            }
            
            // Generate Key Insights for Leadership
            generateKeyInsights(allData);

            const salesChangeEl = document.getElementById('salesChange');
            salesChangeEl.textContent = `${yoyGrowth >= 0 ? '+' : ''}${yoyGrowth.toFixed(1)}% vs nƒÉm tr∆∞·ªõc`;
            salesChangeEl.className = yoyGrowth >= 0 ? 'kpi-change' : 'kpi-change negative';
        }
        
        // Generate actionable insights for leadership decisions
        function generateKeyInsights(data) {
            const current2025 = data.filter(d => d.year === 2025);
            const previous2024 = data.filter(d => d.year === 2024);
            
            // 1. Strategic Focus: Identify strongest growth segment
            const brandPerf = {};
            current2025.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandPerf[brand]) brandPerf[brand] = { current: 0, previous: 0 };
                brandPerf[brand].current += row.vat;
            });
            previous2024.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandPerf[brand]) brandPerf[brand] = { current: 0, previous: 0 };
                brandPerf[brand].previous += row.vat;
            });
            
            const brandGrowths = Object.entries(brandPerf)
                .map(([brand, perf]) => ({
                    brand,
                    growth: perf.previous > 0 ? ((perf.current - perf.previous) / perf.previous * 100) : 0,
                    value: perf.current
                }))
                .sort((a, b) => b.growth - a.growth);
            
            const topBrand = brandGrowths[0];
            const focusMessage = topBrand ? 
                `T·∫≠p trung v√†o ${topBrand.brand} (tƒÉng ${topBrand.growth.toFixed(0)}%, ƒë√≥ng g√≥p ${formatCurrency(topBrand.value)})` :
                'Ph√¢n t√≠ch th√™m ƒë·ªÉ x√°c ƒë·ªãnh tr·ªçng t√¢m';
            document.getElementById('strategicFocus').textContent = focusMessage;
            
            // 2. Market Trend: Month-over-month momentum
            const months = [...new Set(data.map(d => d.monthKey))].sort();
            const recentMonths = months.slice(-6);
            const monthlyGrowth = [];
            
            for (let i = 1; i < recentMonths.length; i++) {
                const currMonth = recentMonths[i];
                const prevMonth = recentMonths[i-1];
                const currSales = data.filter(d => d.monthKey === currMonth).reduce((s, r) => s + r.vat, 0);
                const prevSales = data.filter(d => d.monthKey === prevMonth).reduce((s, r) => s + r.vat, 0);
                const growth = prevSales > 0 ? ((currSales - prevSales) / prevSales * 100) : 0;
                monthlyGrowth.push(growth);
            }
            
            const avgMoMGrowth = monthlyGrowth.length > 0 ? 
                monthlyGrowth.reduce((a, b) => a + b, 0) / monthlyGrowth.length : 0;
            const trendDirection = avgMoMGrowth > 5 ? 'TƒÉng tr∆∞·ªüng m·∫°nh' : 
                                    avgMoMGrowth > 0 ? 'TƒÉng tr∆∞·ªüng ·ªïn ƒë·ªãnh' : 
                                    avgMoMGrowth > -5 ? 'Suy gi·∫£m nh·∫π' : 'Suy gi·∫£m nghi√™m tr·ªçng';
            const trendMessage = `${trendDirection} (TB MoM: ${avgMoMGrowth.toFixed(1)}%)`;
            document.getElementById('marketTrend').textContent = trendMessage;
            
            // 3. Risk Alert: Declining segments
            const decliningBrands = brandGrowths.filter(b => b.growth < -10).slice(0, 2);
            const riskMessage = decliningBrands.length > 0 ?
                `Ch√∫ √Ω: ${decliningBrands.map(b => `${b.brand} (${b.growth.toFixed(0)}%)`).join(', ')}` :
                'Kh√¥ng c√≥ c·∫£nh b√°o ƒë√°ng k·ªÉ';
            document.getElementById('riskAlert').textContent = riskMessage;
            
            // 4. Growth Opportunity: Underperforming with potential
            const systemPerf = {};
            current2025.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemPerf[system]) systemPerf[system] = { stores: new Set(), sales: 0 };
                systemPerf[system].stores.add(row['C·ª¨A H√ÄNG']);
                systemPerf[system].sales += row.vat;
            });
            
            const systemOpportunities = Object.entries(systemPerf)
                .map(([system, perf]) => ({
                    system,
                    avgPerStore: perf.sales / perf.stores.size,
                    sales: perf.sales,
                    stores: perf.stores.size
                }))
                .sort((a, b) => a.avgPerStore - b.avgPerStore)
                .slice(0, 2);
            
            const oppMessage = systemOpportunities.length > 0 ?
                `Ti·ªÅm nƒÉng t·∫°i ${systemOpportunities[0].system} (${formatCurrency(systemOpportunities[0].avgPerStore)}/c·ª≠a h√†ng)` :
                'ƒêang t·ªëi ∆∞u h√≥a to√†n b·ªô h·ªá th·ªëng';
            document.getElementById('growthOpportunity').textContent = oppMessage;
        }

        // Create Forecast Chart with predictions
        function createForecastChart(data) {
            // Group data by month
            const monthlyData = {};
            data.forEach(row => {
                const key = row.monthKey;
                if (!monthlyData[key]) {
                    monthlyData[key] = { vat: 0, qty: 0 };
                }
                monthlyData[key].vat += row.vat;
                monthlyData[key].qty += row.soLuong || 0;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const historicalSales = sortedMonths.map(m => monthlyData[m].vat);
            const historicalQty = sortedMonths.map(m => monthlyData[m].qty);

            // Calculate forecasts using moving average with trend
            const forecastMonths = 3; // Forecast next 3 months
            const movingAvgWindow = 3;
            
            // Calculate trend from last 6 months
            const recentMonths = Math.min(6, sortedMonths.length);
            const recentData = historicalSales.slice(-recentMonths);
            const recentQtyData = historicalQty.slice(-recentMonths);
            
            // Linear regression for trend
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumQtyY = 0, sumQtyXY = 0;
            for (let i = 0; i < recentData.length; i++) {
                sumX += i;
                sumY += recentData[i];
                sumXY += i * recentData[i];
                sumX2 += i * i;
                sumQtyY += recentQtyData[i];
                sumQtyXY += i * recentQtyData[i];
            }
            
            const n = recentData.length;
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const slopeQty = (n * sumQtyXY - sumX * sumQtyY) / (n * sumX2 - sumX * sumX);
            const interceptQty = (sumQtyY - slopeQty * sumX) / n;

            // Calculate seasonality (monthly patterns)
            const monthlyPattern = {};
            sortedMonths.forEach((monthKey, idx) => {
                const monthNum = new Date(monthKey + '-01').getMonth(); // 0-11
                if (!monthlyPattern[monthNum]) {
                    monthlyPattern[monthNum] = [];
                }
                monthlyPattern[monthNum].push(historicalSales[idx]);
            });

            // Average by month
            const seasonalityFactors = {};
            Object.keys(monthlyPattern).forEach(month => {
                const avg = monthlyPattern[month].reduce((a, b) => a + b, 0) / monthlyPattern[month].length;
                seasonalityFactors[month] = avg;
            });
            
            const overallAvg = Object.values(seasonalityFactors).reduce((a, b) => a + b, 0) / Object.keys(seasonalityFactors).length;
            Object.keys(seasonalityFactors).forEach(month => {
                seasonalityFactors[month] = seasonalityFactors[month] / overallAvg; // Normalize
            });

            // Generate forecast months
            const lastMonthKey = sortedMonths[sortedMonths.length - 1];
            const lastDate = new Date(lastMonthKey + '-01');
            const forecastLabels = [];
            const forecastSales = [];
            const forecastQty = [];
            
            for (let i = 1; i <= forecastMonths; i++) {
                const nextDate = new Date(lastDate);
                nextDate.setMonth(nextDate.getMonth() + i);
                const nextMonthKey = nextDate.toISOString().substring(0, 7);
                forecastLabels.push(nextMonthKey);
                
                // Trend forecast
                const trendValue = slope * (recentData.length - 1 + i) + intercept;
                const trendQtyValue = slopeQty * (recentQtyData.length - 1 + i) + interceptQty;
                
                // Apply seasonality
                const monthNum = nextDate.getMonth();
                const seasonalFactor = seasonalityFactors[monthNum] || 1;
                
                forecastSales.push(trendValue * seasonalFactor);
                forecastQty.push(trendQtyValue * seasonalFactor);
            }

            // Current month forecast (month 0 in forecast)
            const currentMonthForecastSales = forecastSales[0];
            const currentMonthForecastQty = forecastQty[0];
            
            // Update forecast KPIs - Current Month (new)
            document.getElementById('currentMonthForecast').textContent = formatCurrency(currentMonthForecastSales);
            document.getElementById('currentMonthQtyForecast').textContent = `S·ªë l∆∞·ª£ng: ${formatNumber(Math.round(currentMonthForecastQty))}`;
            
            // Update forecast KPIs - Next Month (month 1 in forecast)
            const nextMonthForecastSales = forecastSales[1] || forecastSales[0];
            const nextMonthForecastQty = forecastQty[1] || forecastQty[0];
            document.getElementById('nextMonthForecast').textContent = formatCurrency(nextMonthForecastSales);
            document.getElementById('nextMonthQtyForecast').textContent = `S·ªë l∆∞·ª£ng: ${formatNumber(Math.round(nextMonthForecastQty))}`;

            // Current quarter average
            const currentQuarterMonths = sortedMonths.slice(-3);
            const currentQuarterSales = currentQuarterMonths.map(m => monthlyData[m].vat);
            const currentQuarterQtyData = currentQuarterMonths.map(m => monthlyData[m].qty);
            const currentQtrAvg = currentQuarterSales.reduce((a, b) => a + b, 0) / currentQuarterSales.length;
            const currentQtrQtyAvg = currentQuarterQtyData.reduce((a, b) => a + b, 0) / currentQuarterQtyData.length;
            
            document.getElementById('currentQuarterAvg').textContent = formatCurrency(currentQtrAvg);
            document.getElementById('currentQuarterQtyAvg').textContent = `S·ªë l∆∞·ª£ng: ${formatNumber(Math.round(currentQtrQtyAvg))}`;

            // Next quarter forecast (average of next 3 forecast months)
            const nextQtrForecast = forecastSales.reduce((a, b) => a + b, 0) / forecastSales.length;
            const nextQtrQtyForecast = forecastQty.reduce((a, b) => a + b, 0) / forecastQty.length;
            
            document.getElementById('nextQuarterForecast').textContent = formatCurrency(nextQtrForecast);
            document.getElementById('nextQuarterQtyForecast').textContent = `S·ªë l∆∞·ª£ng: ${formatNumber(Math.round(nextQtrQtyForecast))}`;

            // Seasonality trend analysis
            const lastMonthSales = historicalSales[historicalSales.length - 1];
            const nextMonthForecast = forecastSales[0];
            const change = ((nextMonthForecast - lastMonthSales) / lastMonthSales) * 100;
            
            let trendIcon = '‚Üí';
            let trendText = '·ªîn ƒë·ªãnh';
            if (change > 5) {
                trendIcon = 'üìà';
                trendText = 'TƒÉng';
            } else if (change < -5) {
                trendIcon = 'üìâ';
                trendText = 'Gi·∫£m';
            }
            
            document.getElementById('seasonalityTrend').textContent = `${trendIcon} ${trendText}`;
            document.getElementById('seasonalityDetail').textContent = `D·ª± ki·∫øn ${change > 0 ? '+' : ''}${change.toFixed(1)}% so v·ªõi th√°ng hi·ªán t·∫°i`;

            // Calculate detailed forecasts by system, brand, and product
            calculateDetailedForecasts(data, sortedMonths, currentMonthForecastSales, currentMonthForecastQty, nextMonthForecastSales, nextMonthForecastQty, currentQtrAvg, currentQtrQtyAvg, nextQtrForecast, nextQtrQtyForecast);

            // Create chart
            const ctx = document.getElementById('forecastChart');
            if (charts.forecastChart) {
                charts.forecastChart.destroy();
            }

            const allLabels = [...sortedMonths, ...forecastLabels];
            const allSalesData = [...historicalSales, ...Array(forecastMonths).fill(null)];
            const forecastData = [...Array(sortedMonths.length).fill(null), historicalSales[historicalSales.length - 1], ...forecastSales];

            charts.forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Doanh S·ªë Th·ª±c T·∫ø',
                            data: allSalesData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'D·ª± ƒêo√°n',
                            data: forecastData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: true,
                            tension: 0.4,
                            pointStyle: 'triangle',
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const monthKey = sortedMonths[index];
                            showMonthDrillDown(monthKey);
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calculate detailed forecasts by system, brand, and product
        function calculateDetailedForecasts(data, sortedMonths, currentMonthForecastSales, currentMonthForecastQty, nextMonthForecastSales, nextMonthForecastQty, currentQtrAvg, currentQtrQtyAvg, nextQtrForecast, nextQtrQtyForecast) {
            // Get recent months data for proportion calculation
            const recentMonthsCount = Math.min(3, sortedMonths.length);
            const recentMonths = sortedMonths.slice(-recentMonthsCount);
            
            // Filter data for recent months
            const recentData = data.filter(row => recentMonths.includes(row.monthKey));
            
            // Calculate proportions by system
            const systemData = {};
            recentData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || 'Unknown';
                if (!systemData[system]) {
                    systemData[system] = { vat: 0, qty: 0 };
                }
                systemData[system].vat += row.vat;
                systemData[system].qty += row.soLuong || 0;
            });
            
            // Calculate proportions by brand
            const brandData = {};
            recentData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'] || 'Unknown';
                if (!brandData[brand]) {
                    brandData[brand] = { vat: 0, qty: 0 };
                }
                brandData[brand].vat += row.vat;
                brandData[brand].qty += row.soLuong || 0;
            });
            
            // Calculate proportions by product
            const productData = {};
            recentData.forEach(row => {
                const product = row['T√äN SP'] || 'Unknown';
                const brand = row['NH√ÉN H√ÄNG'] || 'Unknown';
                if (!productData[product]) {
                    productData[product] = { vat: 0, qty: 0, brand: brand };
                }
                productData[product].vat += row.vat;
                productData[product].qty += row.soLuong || 0;
            });
            
            // Get totals
            const totalRecentSales = Object.values(systemData).reduce((sum, item) => sum + item.vat, 0);
            const totalRecentQty = Object.values(systemData).reduce((sum, item) => sum + item.qty, 0);
            
            // Store detailed forecast data
            forecastDetailsData = {
                currentMonth: {
                    totalSales: currentMonthForecastSales,
                    totalQty: currentMonthForecastQty,
                    systems: {},
                    brands: {},
                    products: {}
                },
                nextMonth: {
                    totalSales: nextMonthForecastSales,
                    totalQty: nextMonthForecastQty,
                    systems: {},
                    brands: {},
                    products: {}
                },
                currentQuarter: {
                    totalSales: currentQtrAvg,
                    totalQty: currentQtrQtyAvg,
                    systems: {},
                    brands: {},
                    products: {}
                },
                nextQuarter: {
                    totalSales: nextQtrForecast,
                    totalQty: nextQtrQtyForecast,
                    systems: {},
                    brands: {},
                    products: {}
                }
            };
            
            // Calculate forecast for each entity using proportions
            ['currentMonth', 'nextMonth', 'currentQuarter', 'nextQuarter'].forEach(period => {
                const forecastSales = forecastDetailsData[period].totalSales;
                const forecastQty = forecastDetailsData[period].totalQty;
                
                // By system
                Object.keys(systemData).forEach(system => {
                    const proportion = systemData[system].vat / totalRecentSales;
                    const qtyProportion = systemData[system].qty / totalRecentQty;
                    forecastDetailsData[period].systems[system] = {
                        sales: forecastSales * proportion,
                        qty: forecastQty * qtyProportion
                    };
                });
                
                // By brand
                Object.keys(brandData).forEach(brand => {
                    const proportion = brandData[brand].vat / totalRecentSales;
                    const qtyProportion = brandData[brand].qty / totalRecentQty;
                    forecastDetailsData[period].brands[brand] = {
                        sales: forecastSales * proportion,
                        qty: forecastQty * qtyProportion
                    };
                });
                
                // By product
                Object.keys(productData).forEach(product => {
                    const proportion = productData[product].vat / totalRecentSales;
                    const qtyProportion = productData[product].qty / totalRecentQty;
                    forecastDetailsData[period].products[product] = {
                        sales: forecastSales * proportion,
                        qty: forecastQty * qtyProportion,
                        brand: productData[product].brand
                    };
                });
            });
        }

        // Apply manual adjustments from stockout and new products
        function applyManualAdjustments(periodType) {
            // Clone the original forecast data
            const detail = JSON.parse(JSON.stringify(forecastDetailsData[periodType]));
            
            // Initialize adjustment tracking
            detail.adjustments = {
                systems: {},
                brands: {},
                products: {}
            };
            
            // Only apply adjustments for currentMonth
            if (periodType !== 'currentMonth' || !manualStockoutProducts || manualStockoutProducts.length === 0) {
                return detail;
            }
            
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const surgeFactor = 1.25;
            
            // Helper function: Count working days (Mon-Sat, exclude Sunday) between two dates
            function countWorkingDays(startDay, endDay, year, month) {
                let workingDays = 0;
                for (let day = startDay; day <= endDay; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                    if (dayOfWeek !== 0) { // Exclude Sunday
                        workingDays++;
                    }
                }
                return workingDays;
            }
            
            // Count total working days in month (for proper proportion calculation)
            const totalWorkingDaysInMonth = countWorkingDays(1, daysInMonth, today.getFullYear(), today.getMonth());
            
            console.log(`üìÖ Working days calculation: ${totalWorkingDaysInMonth} working days in month`);
            console.log(`üìã Processing ${manualStockoutProducts.length} manual products`);
            
            // Process each manual product
            manualStockoutProducts.forEach(prod => {
                console.log(`üîç Processing product: ${prod.name}, isNew: ${prod.isNew}`);
                
                if (prod.isNew) {
                    // New products: only count working days after launch
                    const workingDaysAfterLaunch = countWorkingDays(prod.restockDay, daysInMonth, today.getFullYear(), today.getMonth());
                    const adjustedSales = (prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysAfterLaunch;
                    const adjustedQty = (prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysAfterLaunch;
                    
                    // Add to total
                    detail.totalSales += adjustedSales;
                    detail.totalQty += adjustedQty;
                    
                    // For new products, add to selected systems
                    prod.systems.forEach(sys => {
                        if (!detail.systems[sys.name]) {
                            detail.systems[sys.name] = { sales: 0, qty: 0 };
                        }
                        // Distribute proportionally to stores
                        const systemShare = adjustedSales * (sys.storeCount / prod.totalStores);
                        const systemQtyShare = adjustedQty * (sys.storeCount / prod.totalStores);
                        detail.systems[sys.name].sales += systemShare;
                        detail.systems[sys.name].qty += systemQtyShare;
                        
                        // Track adjustment
                        if (!detail.adjustments.systems[sys.name]) {
                            detail.adjustments.systems[sys.name] = { sales: 0, qty: 0 };
                        }
                        detail.adjustments.systems[sys.name].sales += systemShare;
                        detail.adjustments.systems[sys.name].qty += systemQtyShare;
                    });
                    
                    // Add to brand
                    if (!detail.brands[prod.brand]) {
                        detail.brands[prod.brand] = { sales: 0, qty: 0 };
                    }
                    detail.brands[prod.brand].sales += adjustedSales;
                    detail.brands[prod.brand].qty += adjustedQty;
                    
                    // Track brand adjustment
                    if (!detail.adjustments.brands[prod.brand]) {
                        detail.adjustments.brands[prod.brand] = { sales: 0, qty: 0 };
                    }
                    detail.adjustments.brands[prod.brand].sales += adjustedSales;
                    detail.adjustments.brands[prod.brand].qty += adjustedQty;
                    
                    // Add to product
                    if (!detail.products[prod.name]) {
                        detail.products[prod.name] = { sales: 0, qty: 0, brand: prod.brand };
                    }
                    detail.products[prod.name].sales += adjustedSales;
                    detail.products[prod.name].qty += adjustedQty;
                    
                    // Track product adjustment
                    if (!detail.adjustments.products[prod.name]) {
                        detail.adjustments.products[prod.name] = { sales: 0, qty: 0 };
                    }
                    detail.adjustments.products[prod.name].sales += adjustedSales;
                    detail.adjustments.products[prod.name].qty += adjustedQty;
                } else {
                    // For STOCKOUT products: Calculate net adjustment (working days only)
                    console.log(`üíî Stockout product: ${prod.name}`);
                    console.log(`üìä Product avgMonthlySales (TOTAL): ${prod.avgMonthlySales.toLocaleString()} VND`);
                    console.log(`üóìÔ∏è restockDay: ${prod.restockDay}, currentDay: ${currentDay}`);
                    
                    // 1. Lost sales during stockout (t·ª´ h√¥m nay ‚Üí ng√†y v·ªÅ h√†ng, ch·ªâ t√≠nh ng√†y l√†m vi·ªác)
                    const workingDaysLost = countWorkingDays(currentDay, prod.restockDay - 1, today.getFullYear(), today.getMonth());
                    const lostSales = -(prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysLost;
                    const lostQty = -(prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysLost;
                    
                    console.log(`üìâ Lost: ${workingDaysLost} working days = ${lostSales.toLocaleString()} VND`);
                    
                    // 2. Surge sales after restock (t·ª´ ng√†y v·ªÅ h√†ng ‚Üí cu·ªëi th√°ng, ch·ªâ t√≠nh ng√†y l√†m vi·ªác)
                    const workingDaysAfterRestock = countWorkingDays(prod.restockDay, daysInMonth, today.getFullYear(), today.getMonth());
                    const surgeSales = (prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysAfterRestock * surgeFactor;
                    const surgeQty = (prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysAfterRestock * surgeFactor;
                    
                    // 3. Normal sales for the remaining period (baseline, ch·ªâ t√≠nh ng√†y l√†m vi·ªác)
                    const normalSalesForPeriod = (prod.avgMonthlySales / totalWorkingDaysInMonth) * workingDaysAfterRestock;
                    const normalQtyForPeriod = (prod.avgMonthlyQty / totalWorkingDaysInMonth) * workingDaysAfterRestock;
                    
                    // 4. Net adjustment = Lost + (Surge - Normal)
                    // This represents: -lost during stockout + extra surge after restock
                    const adjustedSales = lostSales + (surgeSales - normalSalesForPeriod);
                    const adjustedQty = lostQty + (surgeQty - normalQtyForPeriod);
                    
                    console.log(`üìä Net adjustment: ${adjustedSales.toLocaleString()} VND (${adjustedSales < 0 ? 'LOSS' : 'GAIN'})`);
                    console.log(`üí° This adjustment will be DISTRIBUTED across systems based on actual sales data`);
                    
                    // Add to total
                    detail.totalSales += adjustedSales;
                    detail.totalQty += adjustedQty;
                    
                    // Find the product in existing forecast
                    console.log(`üîç Looking for product "${prod.name}" in forecast...`);
                    console.log(`üìã Available products:`, Object.keys(detail.products).slice(0, 5));
                    
                    if (detail.products[prod.name]) {
                        console.log(`‚úÖ Found product in forecast, applying adjustment...`);
                        detail.products[prod.name].sales += adjustedSales;
                        detail.products[prod.name].qty += adjustedQty;
                        
                        // Track product adjustment
                        if (!detail.adjustments.products[prod.name]) {
                            detail.adjustments.products[prod.name] = { sales: 0, qty: 0 };
                        }
                        detail.adjustments.products[prod.name].sales += adjustedSales;
                        detail.adjustments.products[prod.name].qty += adjustedQty;
                        
                        // Add to brand
                        const brand = detail.products[prod.name].brand;
                        if (detail.brands[brand]) {
                            detail.brands[brand].sales += adjustedSales;
                            detail.brands[brand].qty += adjustedQty;
                            
                            // Track brand adjustment
                            if (!detail.adjustments.brands[brand]) {
                                detail.adjustments.brands[brand] = { sales: 0, qty: 0 };
                            }
                            detail.adjustments.brands[brand].sales += adjustedSales;
                            detail.adjustments.brands[brand].qty += adjustedQty;
                        }
                        
                        // Distribute to systems based on product's current distribution
                        // Calculate product's system distribution from recent data
                        const productSystemDistribution = {};
                        let productTotalInSystems = 0;
                        
                        // Get recent months for distribution
                        const sortedMonths = [...new Set(allData.map(d => d.monthKey))].sort();
                        const recentMonths = sortedMonths.slice(-3);
                        
                        allData.forEach(row => {
                            if (recentMonths.includes(row.monthKey) && 
                                shortenProductName(row['T√äN SP']) === prod.name) {
                                const system = row['H·ªÜ TH·ªêNG'];
                                if (system) {
                                    if (!productSystemDistribution[system]) {
                                        productSystemDistribution[system] = 0;
                                    }
                                    productSystemDistribution[system] += row.vat || 0;
                                    productTotalInSystems += row.vat || 0;
                                }
                            }
                        });
                        
                        console.log(`üìä System distribution for ${prod.name}:`, productSystemDistribution);
                        console.log(`üí∞ Total in systems: ${productTotalInSystems}`);
                        
                        // Fallback: if no recent data, use current forecast's system distribution
                        if (productTotalInSystems === 0) {
                            console.warn(`No recent system distribution for ${prod.name}, using forecast proportions`);
                            Object.entries(detail.systems).forEach(([system, sysData]) => {
                                productSystemDistribution[system] = sysData.sales;
                                productTotalInSystems += sysData.sales;
                            });
                        }
                        
                        // Distribute adjustment to systems proportionally
                        if (productTotalInSystems > 0) {
                            Object.entries(productSystemDistribution).forEach(([system, systemSales]) => {
                                const systemProportion = systemSales / productTotalInSystems;
                                const systemAdjustment = adjustedSales * systemProportion;
                                const systemQtyAdjustment = adjustedQty * systemProportion;
                                
                                if (detail.systems[system]) {
                                    detail.systems[system].sales += systemAdjustment;
                                    detail.systems[system].qty += systemQtyAdjustment;
                                    
                                    // Track system adjustment
                                    if (!detail.adjustments.systems[system]) {
                                        detail.adjustments.systems[system] = { sales: 0, qty: 0 };
                                    }
                                    detail.adjustments.systems[system].sales += systemAdjustment;
                                    detail.adjustments.systems[system].qty += systemQtyAdjustment;
                                }
                            });
                        } else {
                            console.error(`Cannot distribute adjustment for ${prod.name}: no system data found`);
                        }
                    } else {
                        console.warn(`‚ùå Product "${prod.name}" not found in forecast. Creating new entry...`);
                        // Create new product entry if not exists
                        detail.products[prod.name] = {
                            sales: adjustedSales,
                            qty: adjustedQty,
                            brand: prod.brand
                        };
                        
                        // Track product adjustment
                        detail.adjustments.products[prod.name] = {
                            sales: adjustedSales,
                            qty: adjustedQty
                        };
                        
                        // Add to brand
                        if (!detail.brands[prod.brand]) {
                            detail.brands[prod.brand] = { sales: 0, qty: 0 };
                        }
                        detail.brands[prod.brand].sales += adjustedSales;
                        detail.brands[prod.brand].qty += adjustedQty;
                        
                        // Track brand adjustment
                        if (!detail.adjustments.brands[prod.brand]) {
                            detail.adjustments.brands[prod.brand] = { sales: 0, qty: 0 };
                        }
                        detail.adjustments.brands[prod.brand].sales += adjustedSales;
                        detail.adjustments.brands[prod.brand].qty += adjustedQty;
                        
                        // Distribute to all systems proportionally (since product not in forecast)
                        const totalSystemSales = Object.values(detail.systems).reduce((sum, sys) => sum + sys.sales, 0);
                        if (totalSystemSales > 0) {
                            Object.entries(detail.systems).forEach(([system, sysData]) => {
                                const proportion = sysData.sales / totalSystemSales;
                                const systemAdjustment = adjustedSales * proportion;
                                const systemQtyAdjustment = adjustedQty * proportion;
                                
                                detail.systems[system].sales += systemAdjustment;
                                detail.systems[system].qty += systemQtyAdjustment;
                                
                                if (!detail.adjustments.systems[system]) {
                                    detail.adjustments.systems[system] = { sales: 0, qty: 0 };
                                }
                                detail.adjustments.systems[system].sales += systemAdjustment;
                                detail.adjustments.systems[system].qty += systemQtyAdjustment;
                            });
                        }
                    }
                }
            });
            
            return detail;
        }
        
        // Clear all stockout products
        function clearAllStockoutProducts() {
            if (manualStockoutProducts.length === 0) {
                alert('Danh s√°ch ƒë√£ tr·ªëng');
                return;
            }
            
            if (confirm(`X√≥a t·∫•t c·∫£ ${manualStockoutProducts.length} s·∫£n ph·∫©m trong danh s√°ch?`)) {
                manualStockoutProducts = [];
                
                // Re-render the list
                const today = new Date();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                renderStockoutProductsList(today.getDate(), daysInMonth);
                
                // Refresh modal if open
                refreshForecastModalIfOpen();
            }
        }

        // Show forecast detail modal
        function showForecastDetail(type) {
            if (!forecastDetailsData || !forecastDetailsData[type]) {
                alert('D·ªØ li·ªáu d·ª± ƒëo√°n ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i!');
                return;
            }
            
            // Store current type for refresh
            currentForecastType = type;
            
            // Apply manual adjustments (stockout and new products)
            const detail = applyManualAdjustments(type);
            
            // Set title based on type
            const titles = {
                'currentMonth': 'üî• Chi Ti·∫øt D·ª± ƒêo√°n Th√°ng N√†y (Th√°ng 1/2026)',
                'nextMonth': 'üìÖ Chi Ti·∫øt D·ª± ƒêo√°n Th√°ng Ti·∫øp Theo',
                'currentQuarter': 'üìä Chi Ti·∫øt TB Th√°ng Qu√Ω N√†y (3 th√°ng)',
                'nextQuarter': 'üéØ Chi Ti·∫øt TB Th√°ng Qu√Ω T·ªõi (d·ª± ƒëo√°n)'
            };
            document.getElementById('forecastModalTitle').textContent = titles[type];
            
            // Update summary
            document.getElementById('forecastTotalSales').textContent = formatCurrency(detail.totalSales);
            document.getElementById('forecastTotalQty').textContent = formatNumber(Math.round(detail.totalQty));
            
            // Calculate total adjustment
            let totalAdjustment = 0;
            if (detail.adjustments) {
                Object.values(detail.adjustments.products).forEach(adj => {
                    totalAdjustment += adj.sales;
                });
            }
            
            // Show/hide adjustment
            const adjustmentDiv = document.getElementById('stockoutAdjustment');
            const adjustmentValueDiv = document.getElementById('stockoutAdjustmentValue');
            if (Math.abs(totalAdjustment) > 1000) {
                adjustmentDiv.style.display = 'block';
                const color = totalAdjustment > 0 ? '#10b981' : '#ef4444';
                const sign = totalAdjustment > 0 ? '+' : '';
                adjustmentValueDiv.style.color = color;
                adjustmentValueDiv.textContent = `${sign}${formatCurrency(totalAdjustment)}`;
            } else {
                adjustmentDiv.style.display = 'none';
            }
            
            // Populate system table
            const systemTableBody = document.getElementById('forecastSystemTableBody');
            systemTableBody.innerHTML = '';
            const sortedSystems = Object.entries(detail.systems).sort((a, b) => b[1].sales - a[1].sales);
            sortedSystems.forEach(([system, data], idx) => {
                const percentage = (data.sales / detail.totalSales * 100).toFixed(1);
                const adjustment = detail.adjustments?.systems?.[system]?.sales || 0;
                console.log(`üè¢ System ${system}: adjustment = ${adjustment}`);
                const adjustmentDisplay = adjustment > 0 ? 
                    `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(adjustment)}</span>` : 
                    adjustment < 0 ?
                    `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(adjustment)}</span>` :
                    '<span style="color: #9ca3af;">-</span>';
                const row = `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${system}</td>
                        <td class="number">${formatNumber(Math.round(data.qty))}</td>
                        <td class="number">${formatCurrency(data.sales)}</td>
                        <td class="number" style="background: #fffbeb;">${adjustmentDisplay}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
                systemTableBody.innerHTML += row;
            });
            
            // Populate brand table (top 20)
            const brandTableBody = document.getElementById('forecastBrandTableBody');
            brandTableBody.innerHTML = '';
            const sortedBrands = Object.entries(detail.brands).sort((a, b) => b[1].sales - a[1].sales).slice(0, 20);
            sortedBrands.forEach(([brand, data], idx) => {
                const percentage = (data.sales / detail.totalSales * 100).toFixed(1);
                const adjustment = detail.adjustments?.brands?.[brand]?.sales || 0;
                const adjustmentDisplay = adjustment > 0 ? 
                    `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(adjustment)}</span>` : 
                    adjustment < 0 ?
                    `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(adjustment)}</span>` :
                    '<span style="color: #9ca3af;">-</span>';
                const row = `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${brand}</td>
                        <td class="number">${formatNumber(Math.round(data.qty))}</td>
                        <td class="number">${formatCurrency(data.sales)}</td>
                        <td class="number" style="background: #fffbeb;">${adjustmentDisplay}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
                brandTableBody.innerHTML += row;
            });
            
            // Populate product table (top 50)
            const productTableBody = document.getElementById('forecastProductTableBody');
            productTableBody.innerHTML = '';
            const sortedProducts = Object.entries(detail.products).sort((a, b) => b[1].sales - a[1].sales).slice(0, 50);
            sortedProducts.forEach(([product, data], idx) => {
                const percentage = (data.sales / detail.totalSales * 100).toFixed(1);
                const adjustment = detail.adjustments?.products?.[product]?.sales || 0;
                const adjustmentDisplay = adjustment > 0 ? 
                    `<span style="color: #10b981; font-weight: 600;">+${formatCurrency(adjustment)}</span>` : 
                    adjustment < 0 ?
                    `<span style="color: #ef4444; font-weight: 600;">${formatCurrency(adjustment)}</span>` :
                    '<span style="color: #9ca3af;">-</span>';
                const row = `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${product}</td>
                        <td>${data.brand}</td>
                        <td class="number">${formatNumber(Math.round(data.qty))}</td>
                        <td class="number">${formatCurrency(data.sales)}</td>
                        <td class="number" style="background: #fffbeb;">${adjustmentDisplay}</td>
                        <td class="number">${percentage}%</td>
                    </tr>
                `;
                productTableBody.innerHTML += row;
            });
            
            // Show modal
            document.getElementById('forecastDetailModal').style.display = 'block';
        }

        // Close forecast detail modal
        function closeForecastDetail() {
            document.getElementById('forecastDetailModal').style.display = 'none';
            // Reset stockout analysis
            document.getElementById('stockoutAnalysisSection').style.display = 'none';
            document.getElementById('stockoutAdjustment').style.display = 'none';
            manualStockoutProducts = []; // Clear the list
            currentForecastType = null; // Clear current type
        }

        // Global variable for stockout products list
        let manualStockoutProducts = [];
        let availableProducts = [];

        // Analyze stockouts (product gaps) - MANUAL SELECTION
        function analyzeStockouts() {
            if (!allData || allData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch');
                return;
            }
            
            // Get current month info
            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            const sortedMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            const recentMonths = sortedMonths.slice(-6, -1); // Last 5 months
            
            // Get all available products with their average sales
            const productData = {};
            
            allData.forEach(row => {
                const product = row['T√äN SP'];
                const month = row.monthKey;
                
                if (!product || !recentMonths.includes(month)) return;
                
                const shortName = shortenProductName(product);
                
                if (!productData[shortName]) {
                    productData[shortName] = {
                        name: shortName,
                        fullName: product,
                        brand: row['NH√ÉN H√ÄNG'],
                        system: row['H·ªÜ TH·ªêNG'],
                        monthsWithSales: new Set(),
                        totalSales: 0,
                        totalQty: 0
                    };
                }
                
                productData[shortName].monthsWithSales.add(month);
                productData[shortName].totalSales += row.vat || 0;
                productData[shortName].totalQty += row.soLuong || 0;
            });
            
            // Calculate averages and prepare product list
            availableProducts = Object.values(productData).map(prod => {
                const monthsCount = prod.monthsWithSales.size;
                const avgMonthlySales = prod.totalSales / monthsCount;
                const avgMonthlyQty = prod.totalQty / monthsCount;
                
                // For stockout products, we'll use the TOTAL sales (distributed across systems)
                // The distribution will be calculated later based on actual system sales data
                return {
                    name: prod.name,
                    fullName: prod.fullName,
                    brand: prod.brand,
                    system: prod.system,
                    avgMonthlySales: avgMonthlySales, // Total monthly sales across all systems
                    avgMonthlyQty: avgMonthlyQty,     // Total monthly qty across all systems
                    systemData: null // Will be populated when needed
                };
            }).filter(p => p.avgMonthlySales > 500000) // Min 500K VND total
            .sort((a, b) => b.avgMonthlySales - a.avgMonthlySales);
            
            // Display manual input form
            displayStockoutForm(currentDay, daysInMonth, currentMonthKey);
        }
        
        // Display form to manually add stockout products
        function displayStockoutForm(currentDay, daysInMonth, currentMonthKey) {
            const content = document.getElementById('stockoutContent');
            const today = new Date();
            const minDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
            const maxDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            
            content.innerHTML = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0 0 10px 0; color: #1e40af;"><strong>üìù Th√™m S·∫£n Ph·∫©m ƒê·ª©t H√†ng Th·ªß C√¥ng</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #1e3a8a;">
                        Ch·ªçn m√£ s·∫£n ph·∫©m v√† ng√†y d·ª± ki·∫øn v·ªÅ h√†ng ƒë·ªÉ h·ªá th·ªëng t√≠nh to√°n l·∫°i d·ª± ƒëo√°n doanh s·ªë th√°ng n√†y.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ch·ªçn S·∫£n Ph·∫©m</label>
                            <select id="stockoutProductSelect" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                                <option value="">-- Ch·ªçn m√£ s·∫£n ph·∫©m --</option>
                                ${availableProducts.map(p => 
                                    `<option value="${p.name}" data-brand="${p.brand}" data-sales="${p.avgMonthlySales}" data-qty="${p.avgMonthlyQty}">
                                        ${p.name} - ${p.brand} (TB: ${formatCurrency(p.avgMonthlySales)}/th√°ng)
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ng√†y V·ªÅ H√†ng</label>
                            <input type="date" id="stockoutRestockDate" 
                                   min="${minDate}" 
                                   max="${maxDate}" 
                                   value="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-20"
                                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div>
                            <button onclick="addStockoutProduct()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                ‚ûï Th√™m
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0 0 10px 0; color: #92400e;"><strong>üÜï Th√™m M√£ H√†ng M·ªõi</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #78350f;">
                        D·ª± ƒëo√°n doanh s·ªë n·∫øu v·ªÅ th√™m m√£ h√†ng m·ªõi cho c√°c h·ªá th·ªëng.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">T√™n S·∫£n Ph·∫©m M·ªõi</label>
                                <input type="text" id="newProductName" placeholder="Nh·∫≠p t√™n m√£ h√†ng m·ªõi..." 
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Nh√£n H√†ng</label>
                                <input type="text" id="newProductBrand" placeholder="Nh·∫≠p nh√£n h√†ng..." 
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">SL TB/C·ª≠a H√†ng</label>
                                <input type="number" id="newProductAvgQty" placeholder="S·ªë l∆∞·ª£ng..." value="10" min="1"
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Gi√° B√°n (VND)</label>
                                <input type="number" id="newProductPrice" placeholder="Gi√°..." value="50000" min="0"
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Ng√†y Ra M·∫Øt</label>
                                <input type="date" id="newProductLaunchDate" 
                                       min="${minDate}" 
                                       max="${maxDate}" 
                                       value="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-15"
                                       style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Ch·ªçn H·ªá Th·ªëng B√°n H√†ng</label>
                            <div id="systemCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="addNewProduct()" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1em;">
                                ‚ûï Th√™m M√£ M·ªõi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="stockoutProductsList"></div>
            `;
            
            // Populate system checkboxes
            populateSystemCheckboxes();
            
            // Show section
            document.getElementById('stockoutAnalysisSection').style.display = 'block';
            
            // Render existing products if any
            renderStockoutProductsList(currentDay, daysInMonth);
        }
        
        // Populate system checkboxes with store counts
        function populateSystemCheckboxes() {
            const container = document.getElementById('systemCheckboxes');
            
            if (!allData || allData.length === 0) {
                container.innerHTML = '<p style="color: #ef4444; padding: 10px;">‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc.</p>';
                return;
            }
            
            // Get unique systems and their store counts from the most recent month
            const systemStores = {};
            const sortedMonths = [...new Set(allData.map(d => d.monthKey))].sort();
            const recentMonth = sortedMonths[sortedMonths.length - 1];
            
            allData.forEach(row => {
                // Only use recent month data for accurate store counts
                if (row.monthKey !== recentMonth) return;
                
                const system = row['H·ªÜ TH·ªêNG'];
                const store = row['C·ª¨A H√ÄNG']; // FIX: Use 'C·ª¨A H√ÄNG' column name
                
                if (!system || !store) return;
                
                if (!systemStores[system]) {
                    systemStores[system] = new Set();
                }
                systemStores[system].add(store);
            });
            
            // Check if we got any systems
            if (Object.keys(systemStores).length === 0) {
                container.innerHTML = '<p style="color: #ef4444; padding: 10px;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h·ªá th·ªëng n√†o trong d·ªØ li·ªáu.</p>';
                console.error('No systems found. Sample data:', allData[0]);
                return;
            }
            
            // Sort by store count
            const sortedSystems = Object.entries(systemStores)
                .map(([system, stores]) => ({ system, storeCount: stores.size }))
                .sort((a, b) => b.storeCount - a.storeCount);
            
            // Render checkboxes
            container.innerHTML = sortedSystems.map(({ system, storeCount }) => `
                <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 4px; cursor: pointer; border: 1px solid #e5e7eb; transition: background 0.2s;" 
                       onmouseover="this.style.background='#f3f4f6'" 
                       onmouseout="this.style.background='white'">
                    <input type="checkbox" value="${system}" data-stores="${storeCount}" 
                           style="margin-right: 8px; cursor: pointer; width: 18px; height: 18px;">
                    <span style="flex: 1; font-size: 0.9em;">
                        <strong>${system}</strong>
                        <span style="color: #6b7280; font-size: 0.85em; margin-left: 5px;">(${storeCount} CH)</span>
                    </span>
                </label>
            `).join('');
            
            console.log('Populated', sortedSystems.length, 'systems with checkboxes');
        }
        
        // Add new product to forecast
        function addNewProduct() {
            const nameInput = document.getElementById('newProductName');
            const brandInput = document.getElementById('newProductBrand');
            const avgQtyInput = document.getElementById('newProductAvgQty');
            const priceInput = document.getElementById('newProductPrice');
            const launchDateInput = document.getElementById('newProductLaunchDate');
            const checkboxes = document.querySelectorAll('#systemCheckboxes input[type="checkbox"]:checked');
            
            // Validation
            if (!nameInput.value.trim()) {
                alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
                return;
            }
            
            if (!brandInput.value.trim()) {
                alert('Vui l√≤ng nh·∫≠p nh√£n h√†ng');
                return;
            }
            
            if (!avgQtyInput.value || avgQtyInput.value <= 0) {
                alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng trung b√¨nh/c·ª≠a h√†ng');
                return;
            }
            
            if (!priceInput.value || priceInput.value <= 0) {
                alert('Vui l√≤ng nh·∫≠p gi√° b√°n');
                return;
            }
            
            if (checkboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ªá th·ªëng');
                return;
            }
            
            if (!launchDateInput.value) {
                alert('Vui l√≤ng ch·ªçn ng√†y ra m·∫Øt');
                return;
            }
            
            // Calculate total stores and forecast
            let totalStores = 0;
            const selectedSystems = [];
            
            checkboxes.forEach(cb => {
                const storeCount = parseInt(cb.getAttribute('data-stores'));
                totalStores += storeCount;
                selectedSystems.push({
                    name: cb.value,
                    storeCount: storeCount
                });
            });
            
            const avgQty = parseFloat(avgQtyInput.value);
            const price = parseFloat(priceInput.value);
            const launchDate = new Date(launchDateInput.value);
            
            // Calculate based on remaining days in month
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const remainingDays = Math.max(0, daysInMonth - launchDate.getDate() + 1);
            
            // Total quantity = stores √ó avg qty/store
            const totalQty = totalStores * avgQty;
            const totalSales = totalQty * price;
            
            // Pro-rate for remaining days (assuming monthly sales)
            const avgMonthlyQty = totalQty;
            const avgMonthlySales = totalSales;
            
            // Check if already added
            if (manualStockoutProducts.find(p => p.name === nameInput.value.trim() && p.isNew)) {
                alert('S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong danh s√°ch');
                return;
            }
            
            // Add to list with special flag for new products
            manualStockoutProducts.push({
                name: nameInput.value.trim(),
                brand: brandInput.value.trim(),
                avgMonthlySales: avgMonthlySales,
                avgMonthlyQty: avgMonthlyQty,
                restockDate: launchDate,
                restockDay: launchDate.getDate(),
                isNew: true,
                systems: selectedSystems,
                totalStores: totalStores,
                avgQtyPerStore: avgQty,
                price: price
            });
            
            // Re-render list
            const currentDay = today.getDate();
            renderStockoutProductsList(currentDay, daysInMonth);
            
            // Refresh forecast modal if it's open
            refreshForecastModalIfOpen();
            
            // Reset form
            nameInput.value = '';
            brandInput.value = '';
            avgQtyInput.value = '10';
            priceInput.value = '50000';
            launchDateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-15`;
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Add product to stockout list
        function addStockoutProduct() {
            const select = document.getElementById('stockoutProductSelect');
            const dateInput = document.getElementById('stockoutRestockDate');
            
            if (!select.value) {
                alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m');
                return;
            }
            
            if (!dateInput.value) {
                alert('Vui l√≤ng ch·ªçn ng√†y v·ªÅ h√†ng');
                return;
            }
            
            const productName = select.value;
            const option = select.options[select.selectedIndex];
            const brand = option.getAttribute('data-brand');
            const avgSales = parseFloat(option.getAttribute('data-sales'));
            const avgQty = parseFloat(option.getAttribute('data-qty'));
            const restockDate = new Date(dateInput.value);
            
            // Check if already added
            if (manualStockoutProducts.find(p => p.name === productName)) {
                alert('S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong danh s√°ch');
                return;
            }
            
            // Add to list
            manualStockoutProducts.push({
                name: productName,
                brand: brand,
                avgMonthlySales: avgSales,
                avgMonthlyQty: avgQty,
                restockDate: restockDate,
                restockDay: restockDate.getDate()
            });
            
            // Get current day info
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            // Re-render list
            renderStockoutProductsList(currentDay, daysInMonth);
            
            // Refresh forecast modal if it's open
            refreshForecastModalIfOpen();
            
            // Reset form
            select.value = '';
            dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-20`;
        }
        
        // Remove product from stockout list
        function removeStockoutProduct(index) {
            manualStockoutProducts.splice(index, 1);
            
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            renderStockoutProductsList(currentDay, daysInMonth);
            
            // Refresh forecast modal if it's open
            refreshForecastModalIfOpen();
        }
        
        // Refresh forecast modal if currently open
        let currentForecastType = null;
        
        function refreshForecastModalIfOpen() {
            const modal = document.getElementById('forecastDetailModal');
            if (modal && modal.style.display === 'block' && currentForecastType) {
                // Re-render the modal with updated data
                showForecastDetail(currentForecastType);
            }
        }
        
        // Render stockout products list with calculations
        function renderStockoutProductsList(currentDay, daysInMonth) {
            const listDiv = document.getElementById('stockoutProductsList');
            
            if (manualStockoutProducts.length === 0) {
                listDiv.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #9ca3af; background: #f9fafb; border-radius: 8px; border: 2px dashed #e5e7eb;">
                        <p style="margin: 0; font-size: 1.1em;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong danh s√°ch</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em;">Ch·ªçn s·∫£n ph·∫©m v√† ng√†y v·ªÅ h√†ng ·ªü tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    </div>
                `;
                document.getElementById('stockoutAdjustment').style.display = 'none';
                return;
            }
            
            // Calculate for each product
            const surgeFactor = 1.25; // 25% increase
            let totalAdjustedSales = 0;
            let totalAdjustedQty = 0;
            let totalMissedSales = 0;
            
            const productsWithCalc = manualStockoutProducts.map(prod => {
                const remainingDays = Math.max(0, daysInMonth - prod.restockDay + 1);
                const daysPassed = Math.min(currentDay, prod.restockDay);
                
                const missedSales = (prod.avgMonthlySales / daysInMonth) * daysPassed;
                const adjustedSales = (prod.avgMonthlySales / daysInMonth) * remainingDays * surgeFactor;
                const adjustedQty = (prod.avgMonthlyQty / daysInMonth) * remainingDays * surgeFactor;
                
                totalMissedSales += missedSales;
                totalAdjustedSales += adjustedSales;
                totalAdjustedQty += adjustedQty;
                
                return {
                    ...prod,
                    remainingDays,
                    daysPassed,
                    missedSales,
                    adjustedSales,
                    adjustedQty
                };
            });
            
            const today = new Date();
            const currentMonthName = today.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' });
            
            // Separate new products from stockout products
            const stockoutProds = productsWithCalc.filter(p => !p.isNew);
            const newProds = productsWithCalc.filter(p => p.isNew);
            
            listDiv.innerHTML = `
                ${manualStockoutProducts.some(p => !p.isNew) ? `
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0 0 10px 0; color: #92400e;"><strong>‚ö†Ô∏è Danh s√°ch ${stockoutProds.length} s·∫£n ph·∫©m ƒë·ª©t h√†ng ${currentMonthName}</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #78350f;">
                        üìÖ <strong>H√¥m nay:</strong> Ng√†y ${currentDay}/${today.getMonth() + 1}/${today.getFullYear()} 
                        (C√≤n ${daysInMonth - currentDay} ng√†y trong th√°ng)
                    </p>
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; color: #78350f;">
                        üìà <strong>H·ªá s·ªë tƒÉng:</strong> +25% (c·ª≠a h√†ng ƒë·∫∑t d·ªìn ƒë∆°n sau khi h·∫øt h√†ng)
                    </p>
                </div>
                ` : ''}
                
                ${manualStockoutProducts.some(p => p.isNew) ? `
                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                    <p style="margin: 0 0 10px 0; color: #065f46;"><strong>üÜï Danh s√°ch ${newProds.length} m√£ h√†ng m·ªõi d·ª± ki·∫øn ra m·∫Øt</strong></p>
                    <p style="margin: 0; font-size: 0.9em; color: #047857;">
                        üí° D·ª± ƒëo√°n d·ª±a tr√™n s·ªë l∆∞·ª£ng c·ª≠a h√†ng √ó SL trung b√¨nh/c·ª≠a h√†ng √ó gi√° b√°n
                    </p>
                </div>
                ` : ''}
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">Doanh s·ªë ƒë√£ m·∫•t</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #ef4444;">${formatCurrency(totalMissedSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">D·ª± ƒëo√°n c√≤n l·∫°i (+25%)</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #10b981;">${formatCurrency(totalAdjustedSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 5px;">S·ªë l∆∞·ª£ng ∆∞·ªõc t√≠nh</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #3b82f6;">${formatNumber(Math.round(totalAdjustedQty))}</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 400px; overflow: auto;">
                    <table style="width: 100%; background: white; font-size: 0.85em;">
                        <thead style="position: sticky; top: 0; background: white;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">#</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Lo·∫°i</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">S·∫£n Ph·∫©m</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Nh√£n</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">H·ªá Th·ªëng</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">ƒê√£ M·∫•t</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">Ra M·∫Øt/V·ªÅ</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">C√≤n L·∫°i</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">DS D·ª± ƒêo√°n</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">SL D·ª± ƒêo√°n</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">X√≥a</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsWithCalc.map((prod, idx) => {
                                const systemInfo = prod.isNew ? 
                                    prod.systems.map(s => `${s.name} (${s.storeCount})`).join(', ') : 
                                    '-';
                                const typeLabel = prod.isNew ? 
                                    '<span style="background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: 600;">M·ªöI</span>' :
                                    '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: 600;">ƒê·ª®T</span>';
                                    
                                return `
                                <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? '#fafafa' : 'white'};">
                                    <td style="padding: 8px;">${idx + 1}</td>
                                    <td style="padding: 8px;">${typeLabel}</td>
                                    <td style="padding: 8px; font-weight: 600; color: #1f2937;">${prod.name}</td>
                                    <td style="padding: 8px; color: #6b7280;">${prod.brand}</td>
                                    <td style="padding: 8px; font-size: 0.8em; color: #6b7280; max-width: 200px;" title="${systemInfo}">${prod.isNew ? `${prod.totalStores} CH` : '-'}</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444; font-weight: 600;">${prod.missedSales > 0 ? '-' + formatCurrency(prod.missedSales) : '-'}</td>
                                    <td style="padding: 8px; text-align: center; color: #059669;">${prod.restockDay}/${today.getMonth() + 1}</td>
                                    <td style="padding: 8px; text-align: center; color: #6b7280;">${prod.remainingDays}d</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 700; color: #10b981;">${formatCurrency(prod.adjustedSales)}</td>
                                    <td style="padding: 8px; text-align: right; color: #3b82f6;">${formatNumber(Math.round(prod.adjustedQty))}</td>
                                    <td style="padding: 8px; text-align: center;">
                                        <button onclick="removeStockoutProduct(${idx})" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #f0fdf4; border-radius: 8px; font-size: 0.85em; color: #166534;">
                    <strong>üí° Gi·∫£i th√≠ch:</strong> 
                    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                        <li><strong>ƒê·ª©t h√†ng:</strong> D·ª± ƒëo√°n doanh s·ªë ƒë∆∞·ª£c t√≠nh d·ª±a tr√™n trung b√¨nh 5 th√°ng g·∫ßn nh·∫•t, 
                        ƒëi·ªÅu ch·ªânh theo s·ªë ng√†y c√≤n l·∫°i sau khi v·ªÅ h√†ng, v√† tƒÉng th√™m 25% do c·ª≠a h√†ng c√≥ xu h∆∞·ªõng ƒë·∫∑t nhi·ªÅu h∆°n sau khi h·∫øt h√†ng.</li>
                        <li><strong>M√£ m·ªõi:</strong> D·ª± ƒëo√°n = S·ªë c·ª≠a h√†ng √ó SL TB/c·ª≠a h√†ng √ó Gi√° √ó (S·ªë ng√†y c√≤n l·∫°i / T·ªïng ng√†y trong th√°ng)</li>
                    </ul>
                </div>
            `;
            
            // Show adjustment in summary
            document.getElementById('stockoutAdjustment').style.display = 'block';
            document.getElementById('stockoutAdjustmentValue').textContent = '+' + formatCurrency(totalAdjustedSales);
        }

        // Print forecast detail
        function printForecastDetail() {
            // Mark body as printing modal only
            document.body.classList.add('printing-modal');
            
            // Hide buttons and other non-print elements temporarily
            const modal = document.getElementById('forecastDetailModal');
            const buttons = modal.querySelectorAll('button');
            const stockoutBtn = document.getElementById('stockoutAnalysisBtn');
            
            buttons.forEach(btn => btn.style.display = 'none');
            if (stockoutBtn) stockoutBtn.style.display = 'none';
            
            // Print
            window.print();
            
            // Restore everything
            setTimeout(() => {
                buttons.forEach(btn => btn.style.display = '');
                if (stockoutBtn) stockoutBtn.style.display = '';
                document.body.classList.remove('printing-modal');
            }, 100);
        }
        
        // Print dashboard
        function printDashboard() {
            // Add print timestamp
            const now = new Date();
            const timestamp = now.toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Create temporary print info
            const printInfo = document.createElement('div');
            printInfo.id = 'printInfo';
            printInfo.style.cssText = 'display: none; text-align: center; padding: 10px; font-size: 0.9em; color: #666;';
            printInfo.innerHTML = `<p>B√°o c√°o ƒë∆∞·ª£c in ng√†y: ${timestamp}</p>`;
            
            document.body.insertBefore(printInfo, document.body.firstChild);
            
            // Show print info only during print
            const printStyle = document.createElement('style');
            printStyle.id = 'printStyle';
            printStyle.textContent = '@media print { #printInfo { display: block !important; } }';
            document.head.appendChild(printStyle);
            
            // Print
            window.print();
            
            // Clean up
            setTimeout(() => {
                printInfo.remove();
                printStyle.remove();
            }, 100);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('forecastDetailModal');
            if (event.target === modal) {
                closeForecastDetail();
            }
        }

        // Create Sales Trend Chart
        function createSalesTrendChart(data) {
            const monthlyData = {};
            data.forEach(row => {
                const key = row.monthKey;
                if (!monthlyData[key]) {
                    monthlyData[key] = 0;
                }
                monthlyData[key] += row.vat;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const values = sortedMonths.map(month => monthlyData[month]);
            
            // T√≠nh trung b√¨nh
            const average = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            const averageData = new Array(values.length).fill(average);

            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (charts.salesTrend) {
                charts.salesTrend.destroy();
            }

            charts.salesTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        order: 2
                    },
                    {
                        label: 'Trung B√¨nh',
                        data: averageData,
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const monthKey = sortedMonths[index];
                            showMonthDrillDown(monthKey, data);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Trung B√¨nh') {
                                        return 'Trung b√¨nh: ' + formatCurrency(context.parsed.y);
                                    }
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create brand trend chart (multi-line chart for top brands)
        function createBrandTrendChart(data) {
            // Check if filtering by specific brand
            const brandFilter = document.getElementById('brandFilter').value;
            const isFilteredByBrand = brandFilter && brandFilter !== 'all';
            
            // Group by brand and month
            const brandMonthData = {};
            const allMonths = new Set();
            
            data.forEach(row => {
                const brand = (row['NH√ÉN H√ÄNG'] || 'N/A').trim();
                const monthKey = row.monthKey;
                const vat = row.vat || 0;
                
                if (!brand || brand === 'N/A') return;
                
                allMonths.add(monthKey);
                
                if (!brandMonthData[brand]) {
                    brandMonthData[brand] = {};
                }
                
                if (!brandMonthData[brand][monthKey]) {
                    brandMonthData[brand][monthKey] = 0;
                }
                
                brandMonthData[brand][monthKey] += vat;
            });
            
            // Calculate total per brand and get top 10
            const brandTotals = Object.entries(brandMonthData).map(([brand, months]) => {
                const total = Object.values(months).reduce((sum, val) => sum + val, 0);
                return { brand, months, total };
            }).sort((a, b) => b.total - a.total).slice(0, 10);
            
            // Sort months chronologically
            const sortedMonths = Array.from(allMonths).sort();
            
            // Color palette for brands
            const colors = [
                '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
                '#fee140', '#30cfd0', '#a8edea', '#ff6b6b', '#c44569'
            ];
            
            const datasets = brandTotals.map((brandData, index) => ({
                label: brandData.brand,
                data: sortedMonths.map(month => brandData.months[month] || 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                order: 2
            }));
            
            // Th√™m ƒë∆∞·ªùng trung b√¨nh n·∫øu ƒëang l·ªçc theo 1 brand c·ª• th·ªÉ
            if (isFilteredByBrand && brandTotals.length === 1) {
                const brandData = brandTotals[0];
                const values = sortedMonths.map(month => brandData.months[month] || 0);
                const average = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                const averageData = new Array(values.length).fill(average);
                
                datasets.push({
                    label: 'Trung B√¨nh',
                    data: averageData,
                    borderColor: '#ef4444',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: false,
                    order: 1
                });
            }
            
            const ctx = document.getElementById('brandTrendChart').getContext('2d');
            
            if (charts.brandTrend) {
                charts.brandTrend.destroy();
            }
            
            charts.brandTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            if (datasetIndex < brandTotals.length) {
                                const brandName = brandTotals[datasetIndex].brand;
                                showBrandDrillDown(brandName);
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Trung B√¨nh') {
                                        return 'Trung b√¨nh: ' + formatCurrency(context.parsed.y);
                                    }
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create System Chart
        function createSystemChart(data) {
            const systemData = {};
            data.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) {
                    systemData[system] = 0;
                }
                systemData[system] += row.vat;
            });

            const sorted = Object.entries(systemData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('systemChart').getContext('2d');
            
            if (charts.system) {
                charts.system.destroy();
            }

            charts.system = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                            '#a8edea', '#fed6e3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const systemName = sorted[index][0];
                            showSystemDrillDown(systemName);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Brand Chart
        function createBrandChart(data) {
            const brandData = {};
            data.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) {
                    brandData[brand] = 0;
                }
                brandData[brand] += row.vat;
            });

            const sorted = Object.entries(brandData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('brandChart').getContext('2d');
            
            if (charts.brand) {
                charts.brand.destroy();
            }

            charts.brand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const brandName = sorted[index][0];
                            showBrandDrillDown(brandName);
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Year Comparison Chart
        function createYearComparisonChart(data) {
            // Group data by year and brand
            const yearBrandData = {};
            const brands = new Set();
            
            data.forEach(row => {
                const year = row.year;
                const brand = row['NH√ÉN H√ÄNG'] || 'Kh√°c';
                
                brands.add(brand);
                
                if (!yearBrandData[year]) {
                    yearBrandData[year] = {};
                }
                if (!yearBrandData[year][brand]) {
                    yearBrandData[year][brand] = 0;
                }
                yearBrandData[year][brand] += row.vat;
            });

            const years = Object.keys(yearBrandData).sort();
            const brandArray = Array.from(brands).sort();
            
            // Generate colors for brands
            const brandColors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
                '#fa709a', '#fee140', '#30cfd0', '#330867', '#a8edea', '#fed6e3',
                '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f', '#ff6e7f', '#bfe9ff',
                '#fdcbf1', '#e6dee9', '#c1dfc4', '#deecdd', '#fbc2eb', '#a6c1ee'
            ];
            
            // Create datasets for each brand
            const datasets = brandArray.map((brand, idx) => {
                return {
                    label: brand,
                    data: years.map(year => yearBrandData[year][brand] || 0),
                    backgroundColor: brandColors[idx % brandColors.length],
                    borderWidth: 0
                };
            });

            const ctx = document.getElementById('yearComparisonChart').getContext('2d');
            
            if (charts.yearComparison) {
                charts.yearComparison.destroy();
            }

            charts.yearComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const selectedYear = parseInt(years[index]);
                            showYearDrillDown(selectedYear);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 11 },
                                padding: 10,
                                boxWidth: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = formatCurrency(context.parsed.y);
                                    return `${label}: ${value}`;
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(item => {
                                        total += item.parsed.y;
                                    });
                                    return 'T·ªïng: ' + formatCurrency(total);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Show Year Drill-Down Modal
        let drillDownCharts = {};
        function showYearDrillDown(year) {
            // Filter data for selected year
            const yearData = allData.filter(d => d.year === year);
            
            // Update title
            document.getElementById('drillDownTitle').textContent = `üìä Chi Ti·∫øt NƒÉm ${year}`;
            
            // 1. Create Monthly Chart
            const monthlyData = {};
            yearData.forEach(row => {
                const month = row.monthKey.substring(5, 7); // Get MM from YYYY-MM
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += row.vat;
            });
            
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            const monthlyValues = months.map(m => monthlyData[m] || 0);
            const monthLabels = months.map(m => `Th√°ng ${parseInt(m)}`);
            
            const monthCtx = document.getElementById('drillDownMonthlyChart').getContext('2d');
            if (drillDownCharts.monthly) drillDownCharts.monthly.destroy();
            drillDownCharts.monthly = new Chart(monthCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: monthlyValues,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });
            
            // 2. Create System Chart (Top 10)
            const systemData = {};
            yearData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = 0;
                systemData[system] += row.vat;
            });
            
            const sortedSystems = Object.entries(systemData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const systemCtx = document.getElementById('drillDownSystemChart').getContext('2d');
            if (drillDownCharts.system) drillDownCharts.system.destroy();
            drillDownCharts.system = new Chart(systemCtx, {
                type: 'bar',
                data: {
                    labels: sortedSystems.map(s => s[0]),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sortedSystems.map(s => s[1]),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.x)
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });
            
            // 3. Create Detailed Table (System x Month)
            const systemMonthData = {};
            yearData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                const month = row.monthKey.substring(5, 7);
                
                if (!systemMonthData[system]) {
                    systemMonthData[system] = { total: 0, months: {} };
                }
                if (!systemMonthData[system].months[month]) {
                    systemMonthData[system].months[month] = 0;
                }
                
                systemMonthData[system].months[month] += row.vat;
                systemMonthData[system].total += row.vat;
            });
            
            const sortedSystemsForTable = Object.entries(systemMonthData)
                .sort((a, b) => b[1].total - a[1].total);
            
            // Build month header
            let monthHeaderHTML = '<th style="position: sticky; left: 0; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>';
            monthHeaderHTML += '<th style="position: sticky; left: 50px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>';
            monthHeaderHTML += '<th style="position: sticky; left: 250px; background: #f9fafb; z-index: 21; box-shadow: 2px 0 5px rgba(0,0,0,0.05);"></th>';
            months.forEach(m => {
                monthHeaderHTML += `<th style="text-align: right; padding: 8px; border-bottom: 1px solid #e5e7eb; font-size: 0.85em; background: #f9fafb;">T${parseInt(m)}</th>`;
            });
            document.getElementById('monthHeaderRow').innerHTML = monthHeaderHTML;
            
            // Build table rows
            let tableHTML = '';
            sortedSystemsForTable.forEach((entry, index) => {
                const [system, data] = entry;
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="position: sticky; left: 0; background: white; z-index: 10; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${index + 1}</td>
                        <td style="position: sticky; left: 50px; background: white; z-index: 10; padding: 10px; font-weight: 600; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${system}</td>
                        <td style="position: sticky; left: 250px; background: white; z-index: 10; padding: 10px; text-align: right; font-weight: 600; color: #3b82f6; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${formatCurrency(data.total)}</td>
                `;
                
                months.forEach(m => {
                    const value = data.months[m] || 0;
                    const bgColor = value > 0 ? 'rgba(59, 130, 246, ' + Math.min(value / data.total, 0.3) + ')' : 'transparent';
                    tableHTML += `<td style="padding: 8px; text-align: right; font-size: 0.9em; background: ${bgColor};">${value > 0 ? formatCurrency(value) : '-'}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            document.getElementById('drillDownTableBody').innerHTML = tableHTML;
            
            // Show modal
            document.getElementById('yearDrillDownModal').style.display = 'block';
        }
        
        function closeYearDrillDown() {
            document.getElementById('yearDrillDownModal').style.display = 'none';
            if (drillDownCharts.monthly) drillDownCharts.monthly.destroy();
            if (drillDownCharts.system) drillDownCharts.system.destroy();
        }

        // Universal Drill-Down Modal Functions
        let modalCharts = {};
        let currentDrillDownContext = null; // Store current drill-down context for timeline filtering
        
        function closeDrillDownModal() {
            document.getElementById('drillDownModal').style.display = 'none';
            Object.values(modalCharts).forEach(chart => chart && chart.destroy());
            modalCharts = {};
            currentDrillDownContext = null;
        }
        
        // Apply timeline filter to drill-down
        function applyDrillDownTimeline(period) {
            if (!currentDrillDownContext) return;
            
            // Calculate date range
            const now = new Date();
            let startDate = null;
            
            if (period !== 'ALL') {
                startDate = new Date(now);
                switch(period) {
                    case '1M':
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case '3M':
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                    case '6M':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '1Y':
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                }
            }
            
            // Re-call the drill-down function with filtered data
            const ctx = currentDrillDownContext;
            let filteredData = ctx.baseData;
            
            if (startDate) {
                const startKey = startDate.toISOString().substring(0, 7);
                filteredData = filteredData.filter(d => d.monthKey >= startKey);
            }
            
            // Update active button
            document.querySelectorAll('.modal-timeline-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Re-render based on type
            switch(ctx.type) {
                case 'system':
                    renderSystemDrillDown(ctx.name, filteredData);
                    break;
                case 'brand':
                    renderBrandDrillDown(ctx.name, filteredData);
                    break;
                case 'product':
                    renderProductDrillDown(ctx.name, ctx.key, filteredData);
                    break;
                case 'store':
                    renderStoreDrillDown(ctx.name, filteredData);
                    break;
            }
        }
        
        // Month Drill-Down
        function showMonthDrillDown(monthKey, filteredData) {
            const monthData = filteredData.filter(d => d.monthKey === monthKey);
            const [year, month] = monthKey.split('-');
            const monthName = `Th√°ng ${parseInt(month)}/${year}`;
            
            document.getElementById('modalTitle').textContent = `üìä Chi Ti·∫øt ${monthName}`;
            
            // Top Systems
            const systemData = {};
            monthData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = 0;
                systemData[system] += row.vat;
            });
            const topSystems = Object.entries(systemData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Brands
            const brandData = {};
            monthData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += row.vat;
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Products
            const productData = {};
            monthData.forEach(row => {
                const product = shortenProductName(row['T√äN SP']);
                if (!productData[product]) productData[product] = { sales: 0, qty: 0 };
                productData[product].sales += row.vat;
                productData[product].qty += row.soLuong || 0;
            });
            const topProducts = Object.entries(productData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3 style="color: #3b82f6; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng</h3>
                        <div style="height: 300px;"><canvas id="modalChart1"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè∑Ô∏è Top 10 Nh√£n H√†ng</h3>
                        <div style="height: 300px;"><canvas id="modalChart2"></canvas></div>
                    </div>
                </div>
                <div>
                    <h3 style="color: #f59e0b; margin-bottom: 15px;">üîù Top 10 S·∫£n Ph·∫©m</h3>
                    <div class="table-container" style="max-height: 400px; overflow: auto;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr>
                                    <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb;">#</th>
                                    <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb;">S·∫£n Ph·∫©m</th>
                                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">S·ªë L∆∞·ª£ng</th>
                                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Doanh S·ªë</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topProducts.map((p, i) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;">${i + 1}</td>
                                        <td style="padding: 10px;">${p[0]}</td>
                                        <td style="padding: 10px; text-align: right;">${formatNumber(p[1].qty)}</td>
                                        <td style="padding: 10px; text-align: right; font-weight: 600; color: #3b82f6;">${formatCurrency(p[1].sales)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            // Create charts
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: topSystems.map(s => s[0]),
                        datasets: [{ data: topSystems.map(s => s[1]), backgroundColor: '#3b82f6' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
                
                const ctx2 = document.getElementById('modalChart2').getContext('2d');
                modalCharts.chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topBrands.map(b => b[0]),
                        datasets: [{ data: topBrands.map(b => b[1]), backgroundColor: '#10b981' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
            }, 100);
        }
        
        // System Drill-Down
        function showSystemDrillDown(systemName) {
            const systemData = allData.filter(d => d['H·ªÜ TH·ªêNG'] === systemName);
            currentDrillDownContext = {
                type: 'system',
                name: systemName,
                baseData: systemData
            };
            renderSystemDrillDown(systemName, systemData);
        }
        
        function renderSystemDrillDown(systemName, systemData) {
            document.getElementById('modalTitle').textContent = `üè¢ Chi Ti·∫øt: ${systemName}`;
            
            // Monthly trend
            const monthlyData = {};
            systemData.forEach(row => {
                if (!monthlyData[row.monthKey]) monthlyData[row.monthKey] = 0;
                monthlyData[row.monthKey] += row.vat;
            });
            const months = Object.keys(monthlyData).sort();
            
            // Top Brands
            const brandData = {};
            systemData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += row.vat;
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Stores
            const storeData = {};
            systemData.forEach(row => {
                const store = row['C·ª¨A H√ÄNG'];
                if (!storeData[store]) storeData[store] = { sales: 0, orders: new Set() };
                storeData[store].sales += row.vat;
                storeData[store].orders.add(row['SO HD']);
            });
            const topStores = Object.entries(storeData)
                .map(([store, data]) => [store, data.sales, data.orders.size])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h3>
                    <div style="height: 250px;"><canvas id="modalChart1"></canvas></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè∑Ô∏è Top 10 Nh√£n H√†ng</h3>
                        <div style="height: 300px;"><canvas id="modalChart2"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üè™ Top 10 C·ª≠a H√†ng</h3>
                        <div class="table-container" style="max-height: 300px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">C·ª≠a H√†ng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">ƒê∆°n</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">Doanh S·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topStores.map((s, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px;">${i + 1}</td>
                                            <td style="padding: 8px;">${s[0]}</td>
                                            <td style="padding: 8px; text-align: right;">${s[2]}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #3b82f6;">${formatCurrency(s[1])}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh S·ªë',
                            data: months.map(m => monthlyData[m] || 0),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.y) }}},
                        scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
                
                const ctx2 = document.getElementById('modalChart2').getContext('2d');
                modalCharts.chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topBrands.map(b => b[0]),
                        datasets: [{ data: topBrands.map(b => b[1]), backgroundColor: '#10b981' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
            }, 100);
        }
        
        // Brand Drill-Down
        function showBrandDrillDown(brandName) {
            const brandData = allData.filter(d => d['NH√ÉN H√ÄNG'] === brandName);
            currentDrillDownContext = {
                type: 'brand',
                name: brandName,
                baseData: brandData
            };
            renderBrandDrillDown(brandName, brandData);
        }
        
        function renderBrandDrillDown(brandName, brandData) {
            document.getElementById('modalTitle').textContent = `üè∑Ô∏è Chi Ti·∫øt: ${brandName}`;
            
            // Monthly trend
            const monthlyData = {};
            brandData.forEach(row => {
                if (!monthlyData[row.monthKey]) monthlyData[row.monthKey] = 0;
                monthlyData[row.monthKey] += row.vat;
            });
            const months = Object.keys(monthlyData).sort();
            
            // Top Systems
            const systemData = {};
            brandData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = 0;
                systemData[system] += row.vat;
            });
            const topSystems = Object.entries(systemData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Top Products
            const productData = {};
            brandData.forEach(row => {
                const product = shortenProductName(row['T√äN SP']);
                const sku = row['M√É HH'];
                const key = `${product} (${sku})`;
                if (!productData[key]) productData[key] = { sales: 0, qty: 0 };
                productData[key].sales += row.vat;
                productData[key].qty += row.soLuong || 0;
            });
            const topProducts = Object.entries(productData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 15);
            
            let html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h3>
                    <div style="height: 250px;"><canvas id="modalChart1"></canvas></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng</h3>
                        <div style="height: 300px;"><canvas id="modalChart2"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üîù Top 15 S·∫£n Ph·∫©m</h3>
                        <div class="table-container" style="max-height: 300px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">S·∫£n Ph·∫©m</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">Doanh S·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topProducts.map((p, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; font-size: 0.9em;">${i + 1}</td>
                                            <td style="padding: 8px; font-size: 0.9em;">${p[0]}</td>
                                            <td style="padding: 8px; text-align: right; font-size: 0.9em;">${formatNumber(p[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #3b82f6; font-size: 0.9em;">${formatCurrency(p[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh S·ªë',
                            data: months.map(m => monthlyData[m] || 0),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.y) }}},
                        scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
                
                const ctx2 = document.getElementById('modalChart2').getContext('2d');
                modalCharts.chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topSystems.map(s => s[0]),
                        datasets: [{ data: topSystems.map(s => s[1]), backgroundColor: '#10b981' }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) }}},
                        scales: { x: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) }}}
                    }
                });
            }, 100);
        }
        
        // Product Drill-Down
        function showProductDrillDown(productName, productKey) {
            // Filter data for this product (using shortened name)
            const productData = allData.filter(d => {
                const shortName = shortenProductName(d['T√äN SP']);
                return shortName === productName;
            });
            
            if (productData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu cho s·∫£n ph·∫©m n√†y');
                return;
            }
            
            currentDrillDownContext = {
                type: 'product',
                name: productName,
                key: productKey,
                baseData: productData
            };
            renderProductDrillDown(productName, productKey, productData);
        }
        
        function renderProductDrillDown(productName, productKey, productData) {
            document.getElementById('modalTitle').textContent = `üì¶ Chi Ti·∫øt: ${productName}`;
            
            // Get all SKUs for this product
            const skus = [...new Set(productData.map(d => d['M√É HH']))].filter(Boolean);
            const skuText = skus.length > 0 ? ` (SKU: ${skus.slice(0, 3).join(', ')}${skus.length > 3 ? '...' : ''})` : '';
            
            // Monthly trend
            const monthlyData = {};
            productData.forEach(row => {
                if (!monthlyData[row.monthKey]) monthlyData[row.monthKey] = { sales: 0, qty: 0 };
                monthlyData[row.monthKey].sales += row.vat;
                monthlyData[row.monthKey].qty += row.soLuong || 0;
            });
            const months = Object.keys(monthlyData).sort();
            
            // Top Systems buying this product
            const systemData = {};
            productData.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) systemData[system] = { sales: 0, qty: 0 };
                systemData[system].sales += row.vat;
                systemData[system].qty += row.soLuong || 0;
            });
            const topSystems = Object.entries(systemData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            // Top Stores
            const storeData = {};
            productData.forEach(row => {
                const store = row['C·ª¨A H√ÄNG'];
                if (!storeData[store]) storeData[store] = { sales: 0, qty: 0, orders: new Set() };
                storeData[store].sales += row.vat;
                storeData[store].qty += row.soLuong || 0;
                storeData[store].orders.add(row['SO HD']);
            });
            const topStores = Object.entries(storeData)
                .map(([store, data]) => [store, data.sales, data.qty, data.orders.size])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Calculate total stats
            const totalSales = productData.reduce((sum, row) => sum + row.vat, 0);
            const totalQty = productData.reduce((sum, row) => sum + (row.soLuong || 0), 0);
            const avgPrice = totalQty > 0 ? totalSales / totalQty : 0;
            const brand = productData[0]['NH√ÉN H√ÄNG'] || 'N/A';
            
            let html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Th∆∞∆°ng Hi·ªáu</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${brand}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng Doanh S·ªë</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(totalSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng S·ªë L∆∞·ª£ng</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatNumber(totalQty)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Gi√° TB</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(avgPrice)}</div>
                        </div>
                    </div>
                    ${skuText ? `<div style="font-size: 0.85em; margin-top: 10px; opacity: 0.8;">${skuText}</div>` : ''}
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Doanh S·ªë & S·ªë L∆∞·ª£ng Theo Th√°ng</h3>
                    <div style="height: 300px;"><canvas id="modalChart1"></canvas></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè¢ Top 10 H·ªá Th·ªëng Mua</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">H·ªá Th·ªëng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">Doanh S·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topSystems.map((s, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px;">${i + 1}</td>
                                            <td style="padding: 8px; font-weight: 600;">${s[0]}</td>
                                            <td style="padding: 8px; text-align: right;">${formatNumber(s[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #10b981;">${formatCurrency(s[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üèÜ Top 10 C·ª≠a H√†ng Mua</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">C·ª≠a H√†ng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">DS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topStores.map((s, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; font-size: 0.9em;">${i + 1}</td>
                                            <td style="padding: 8px; font-size: 0.9em;">${s[0]}</td>
                                            <td style="padding: 8px; text-align: right; font-size: 0.9em;">${formatNumber(s[2])}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #f59e0b; font-size: 0.9em;">${formatCurrency(s[1])}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Doanh S·ªë',
                                data: months.map(m => monthlyData[m].sales),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'S·ªë L∆∞·ª£ng',
                                data: months.map(m => monthlyData[m].qty),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.label === 'Doanh S·ªë') {
                                            return 'Doanh s·ªë: ' + formatCurrency(context.parsed.y);
                                        } else {
                                            return 'S·ªë l∆∞·ª£ng: ' + formatNumber(context.parsed.y);
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Doanh S·ªë (VNƒê)'
                                },
                                ticks: {
                                    callback: (v) => formatCurrency(v)
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'S·ªë L∆∞·ª£ng'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: (v) => formatNumber(v)
                                }
                            }
                        }
                    }
                });
            }, 100);
        }

        // Store Drill-Down
        function showStoreDrillDown(storeName) {
            const storeData = allData.filter(d => d['C·ª¨A H√ÄNG'] === storeName);
            
            if (storeData.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu cho c·ª≠a h√†ng n√†y');
                return;
            }
            
            currentDrillDownContext = {
                type: 'store',
                name: storeName,
                baseData: storeData
            };
            renderStoreDrillDown(storeName, storeData);
        }
        
        function renderStoreDrillDown(storeName, storeData) {
            document.getElementById('modalTitle').textContent = `üè™ Chi Ti·∫øt C·ª≠a H√†ng: ${storeName}`;
            
            // Calculate totals
            let totalSales = 0;
            let totalQty = 0;
            const uniqueOrders = new Set();
            
            storeData.forEach(row => {
                totalSales += row.vat || 0;
                totalQty += row.soLuong || 0;
                uniqueOrders.add(row['SO HD']);
            });
            
            const avgOrderValue = uniqueOrders.size > 0 ? totalSales / uniqueOrders.size : 0;
            
            // Monthly data
            const monthlyData = {};
            storeData.forEach(row => {
                const month = row.monthKey;
                if (!monthlyData[month]) {
                    monthlyData[month] = { sales: 0, qty: 0 };
                }
                monthlyData[month].sales += row.vat || 0;
                monthlyData[month].qty += row.soLuong || 0;
            });
            
            const months = Object.keys(monthlyData).sort();
            
            // Top brands
            const brandData = {};
            storeData.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'] || 'Unknown';
                if (!brandData[brand]) {
                    brandData[brand] = { sales: 0, qty: 0 };
                }
                brandData[brand].sales += row.vat || 0;
                brandData[brand].qty += row.soLuong || 0;
            });
            
            const topBrands = Object.entries(brandData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            // Top products
            const productData = {};
            storeData.forEach(row => {
                const product = row['T√äN SP'] || 'Unknown';
                if (!productData[product]) {
                    productData[product] = { sales: 0, qty: 0 };
                }
                productData[product].sales += row.vat || 0;
                productData[product].qty += row.soLuong || 0;
            });
            
            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            const html = `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1M')">1M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('3M')">3M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('6M')">6M</button>
                    <button class="modal-timeline-btn" onclick="applyDrillDownTimeline('1Y')">1Y</button>
                    <button class="modal-timeline-btn active" onclick="applyDrillDownTimeline('ALL')">T·∫•t c·∫£</button>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng Doanh S·ªë</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(totalSales)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">T·ªïng S·ªë L∆∞·ª£ng</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatNumber(totalQty)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">S·ªë ƒê∆°n H√†ng</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatNumber(uniqueOrders.size)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Gi√° TB/ƒê∆°n</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-top: 5px;">${formatCurrency(avgOrderValue)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Doanh S·ªë Theo Th√°ng</h3>
                    <div style="height: 300px;"><canvas id="modalChart1"></canvas></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 15px;">üè∑Ô∏è Top 10 Nh√£n H√†ng</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb;">Nh√£n H√†ng</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb;">DS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topBrands.map((b, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px;">${i + 1}</td>
                                            <td style="padding: 8px; font-weight: 600;">${b[0]}</td>
                                            <td style="padding: 8px; text-align: right;">${formatNumber(b[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #10b981;">${formatCurrency(b[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üì¶ Top 10 S·∫£n Ph·∫©m</h3>
                        <div class="table-container" style="max-height: 350px; overflow: auto;">
                            <table style="width: 100%;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">#</th>
                                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">S·∫£n Ph·∫©m</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">SL</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e7eb; font-size: 0.9em;">DS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topProducts.map((p, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; font-size: 0.9em;">${i + 1}</td>
                                            <td style="padding: 8px; font-size: 0.85em;">${p[0]}</td>
                                            <td style="padding: 8px; text-align: right; font-size: 0.9em;">${formatNumber(p[1].qty)}</td>
                                            <td style="padding: 8px; text-align: right; font-weight: 600; color: #f59e0b; font-size: 0.9em;">${formatCurrency(p[1].sales)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('drillDownModal').style.display = 'block';
            
            setTimeout(() => {
                const ctx1 = document.getElementById('modalChart1').getContext('2d');
                modalCharts.chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh S·ªë',
                            data: months.map(m => monthlyData[m].sales),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => 'Doanh s·ªë: ' + formatCurrency(context.parsed.y)
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (v) => formatCurrency(v)
                                }
                            }
                        }
                    }
                });
            }, 100);
        }

        // Create Top Products Chart
        function createTopProductsChart(data) {
            const productData = {};
            data.forEach(row => {
                const fullName = (row['T√äN SP'] || '').trim();
                const brand = (row['NH√ÉN H√ÄNG'] || '').trim();
                
                // Skip invalid records
                if (!fullName) {
                    return;
                }
                
                // Get shortened name for grouping
                const shortName = shortenProductName(fullName);
                
                // Group by T√äN R√öT G·ªåN (shortened name)
                if (!productData[shortName]) {
                    productData[shortName] = {
                        name: shortName,
                        brand: brand || 'N/A',
                        sales: 0,
                        quantity: 0
                    };
                }
                productData[shortName].sales += row.vat || 0;
                productData[shortName].quantity += row.soLuong || 0;
            });

            const sorted = Object.entries(productData)
                .filter(item => item[1].sales > 0)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 20);

            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }

            if (sorted.length === 0) {
                // Handle case when no data available
                ctx.canvas.parentNode.innerHTML = '<p style="text-align: center; padding: 50px; color: #666;">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
                return;
            }

            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[1].name), // Already shortened name
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sorted.map(s => s[1].sales),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const productInfo = sorted[index];
                            showProductDrillDown(productInfo[1].name, productInfo[0]);
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return sorted[index][1].name;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        'M√£: ' + sorted[index][0],
                                        'Doanh s·ªë: ' + formatCurrency(context.parsed.x),
                                        'S·ªë l∆∞·ª£ng: ' + formatNumber(sorted[index][1].quantity)
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Update yearly product analysis table
            updateYearlyProductTable(data);
            
            // Update store frequency table
            updateStoreFrequencyTable(data);
        }

        // Create Store Activity Chart (Active stores per month by system)
        function createStoreActivityChart(data) {
            // Group by month and system to count unique stores
            const monthStoreData = {}; // Total stores per month
            const systemMonthStoreData = {}; // Stores per month per system
            
            data.forEach(row => {
                const monthKey = row.monthKey;
                const store = (row['C·ª¨A H√ÄNG'] || '').trim();
                const system = (row['H·ªÜ TH·ªêNG'] || '').trim();
                
                if (!monthKey || !store) return;
                
                // Track total stores
                if (!monthStoreData[monthKey]) {
                    monthStoreData[monthKey] = new Set();
                }
                monthStoreData[monthKey].add(store);
                
                // Track stores per system
                if (system) {
                    if (!systemMonthStoreData[system]) {
                        systemMonthStoreData[system] = {};
                    }
                    if (!systemMonthStoreData[system][monthKey]) {
                        systemMonthStoreData[system][monthKey] = new Set();
                    }
                    systemMonthStoreData[system][monthKey].add(store);
                }
            });
            
            // Get sorted months
            const sortedMonths = Object.keys(monthStoreData).sort();
            
            // Prepare datasets
            const datasets = [];
            
            // Color palette for systems
            const systemColors = [
                { border: '#3b82f6', bg: '#3b82f640' },
                { border: '#10b981', bg: '#10b98140' },
                { border: '#f59e0b', bg: '#f59e0b40' },
                { border: '#ef4444', bg: '#ef444440' },
                { border: '#8b5cf6', bg: '#8b5cf640' },
                { border: '#ec4899', bg: '#ec489940' },
                { border: '#14b8a6', bg: '#14b8a640' },
                { border: '#f97316', bg: '#f9731640' }
            ];
            
            let colorIndex = 0;
            
            // Add system datasets
            Object.keys(systemMonthStoreData).sort().forEach(system => {
                const systemData = systemMonthStoreData[system];
                const storeCounts = sortedMonths.map(month => 
                    systemData[month] ? systemData[month].size : 0
                );
                
                const color = systemColors[colorIndex % systemColors.length];
                colorIndex++;
                
                datasets.push({
                    label: system,
                    data: storeCounts,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                });
            });
            
            // Add total dataset (thicker line, always on top)
            const totalStoreCounts = sortedMonths.map(month => monthStoreData[month].size);
            datasets.push({
                label: 'T·ªïng c·ª≠a h√†ng',
                data: totalStoreCounts,
                borderColor: '#1e293b',
                backgroundColor: '#1e293b20',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderDash: [5, 5]
            });
            
            const ctx = document.getElementById('storeActivityChart').getContext('2d');
            
            if (charts.storeActivity) {
                charts.storeActivity.destroy();
            }
            
            charts.storeActivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' c·ª≠a h√†ng';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Update Store Frequency Table
        function updateStoreFrequencyTable(data) {
            // Group by store
            const storeData = {};
            
            data.forEach(row => {
                const store = (row['C·ª¨A H√ÄNG'] || '').trim();
                const soHD = row['SO HD'];
                const vat = row.vat || 0;
                
                if (!store) return;
                
                if (!storeData[store]) {
                    storeData[store] = {
                        store: store,
                        orderDates: new Set(), // Count unique order dates/times
                        totalOrders: new Set(), // Count unique SO HD
                        totalSales: 0
                    };
                }
                
                // Count frequency by unique (SO HD + NGAY) combinations
                const dateKey = row.monthKey + '_' + soHD;
                storeData[store].orderDates.add(dateKey);
                storeData[store].totalOrders.add(soHD);
                storeData[store].totalSales += vat;
            });
            
            // Convert to array and sort by order frequency
            const sorted = Object.values(storeData)
                .map(s => ({
                    store: s.store,
                    frequency: s.orderDates.size, // Number of unique orders
                    totalOrders: s.totalOrders.size,
                    totalSales: s.totalSales,
                    avgPerOrder: s.totalOrders.size > 0 ? s.totalSales / s.totalOrders.size : 0
                }))
                .sort((a, b) => b.frequency - a.frequency)
                .slice(0, 30);
            
            const tbody = document.getElementById('storeFrequencyTableBody');
            tbody.innerHTML = '';
            
            sorted.forEach((storeInfo, index) => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showStoreDrillDown(storeInfo.store);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${storeInfo.store}</td>
                    <td class="number" style="font-weight: 600; color: #667eea;">${formatNumber(storeInfo.frequency)}</td>
                    <td class="number">${formatNumber(storeInfo.totalOrders)}</td>
                    <td class="number" style="background: #fffbeb; color: #d97706;">${formatCurrency(storeInfo.totalSales)}</td>
                    <td class="number">${formatCurrency(storeInfo.avgPerOrder)}</td>
                `;
                row.title = 'Click ƒë·ªÉ xem chi ti·∫øt c·ª≠a h√†ng';
            });
        }

        // Analyze growth contributors and detractors (2024 vs 2025)
        let systemSKUDetails = {}; // Store SKU details per system for expansion
        
        function analyzeGrowthDrivers(data) {
            // Filter data for 2024 and 2025
            const data2024 = data.filter(row => row.year === 2024);
            const data2025 = data.filter(row => row.year === 2025);
            
            // Analyze by SKU
            const skuData2024 = {};
            const skuData2025 = {};
            
            data2024.forEach(row => {
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!sku) return;
                if (!skuData2024[sku]) skuData2024[sku] = 0;
                skuData2024[sku] += row.vat || 0;
            });
            
            data2025.forEach(row => {
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!sku) return;
                if (!skuData2025[sku]) skuData2025[sku] = 0;
                skuData2025[sku] += row.vat || 0;
            });
            
            // Calculate SKU changes
            const skuChanges = [];
            const allSkus = new Set([...Object.keys(skuData2024), ...Object.keys(skuData2025)]);
            
            allSkus.forEach(sku => {
                const val2024 = skuData2024[sku] || 0;
                const val2025 = skuData2025[sku] || 0;
                const change = val2025 - val2024;
                const changePercent = val2024 > 0 ? ((change / val2024) * 100) : 0;
                
                if (Math.abs(change) > 1000000) { // Only significant changes > 1M
                    skuChanges.push({
                        sku: sku,
                        val2024: val2024,
                        val2025: val2025,
                        change: change,
                        changePercent: changePercent
                    });
                }
            });
            
            // Top growth and decline SKUs
            const topGrowth = skuChanges.filter(s => s.change > 0).sort((a, b) => b.change - a.change).slice(0, 10);
            const topDecline = skuChanges.filter(s => s.change < 0).sort((a, b) => a.change - b.change).slice(0, 10);
            
            // Analyze by System WITH SKU DETAILS
            const systemData2024 = {};
            const systemData2025 = {};
            const systemSKUData2024 = {}; // Track SKUs per system
            const systemSKUData2025 = {};
            
            data2024.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || '';
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!system || !sku) return;
                
                if (!systemData2024[system]) systemData2024[system] = 0;
                systemData2024[system] += row.vat || 0;
                
                if (!systemSKUData2024[system]) systemSKUData2024[system] = {};
                if (!systemSKUData2024[system][sku]) systemSKUData2024[system][sku] = 0;
                systemSKUData2024[system][sku] += row.vat || 0;
            });
            
            data2025.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || '';
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!system || !sku) return;
                
                if (!systemData2025[system]) systemData2025[system] = 0;
                systemData2025[system] += row.vat || 0;
                
                if (!systemSKUData2025[system]) systemSKUData2025[system] = {};
                if (!systemSKUData2025[system][sku]) systemSKUData2025[system][sku] = 0;
                systemSKUData2025[system][sku] += row.vat || 0;
            });
            
            // Calculate System changes with SKU breakdown
            const systemChanges = [];
            const allSystems = new Set([...Object.keys(systemData2024), ...Object.keys(systemData2025)]);
            
            systemSKUDetails = {}; // Reset
            
            allSystems.forEach(system => {
                const val2024 = systemData2024[system] || 0;
                const val2025 = systemData2025[system] || 0;
                const change = val2025 - val2024;
                const changePercent = val2024 > 0 ? ((change / val2024) * 100) : 0;
                
                // Calculate SKU changes within this system
                const skuChangesInSystem = [];
                const systemSkus2024 = systemSKUData2024[system] || {};
                const systemSkus2025 = systemSKUData2025[system] || {};
                const allSystemSkus = new Set([...Object.keys(systemSkus2024), ...Object.keys(systemSkus2025)]);
                
                allSystemSkus.forEach(sku => {
                    const skuVal2024 = systemSkus2024[sku] || 0;
                    const skuVal2025 = systemSkus2025[sku] || 0;
                    const skuChange = skuVal2025 - skuVal2024;
                    const skuChangePercent = skuVal2024 > 0 ? ((skuChange / skuVal2024) * 100) : 0;
                    
                    if (Math.abs(skuChange) > 500000) { // Significant change > 500K
                        skuChangesInSystem.push({
                            sku: sku,
                            val2024: skuVal2024,
                            val2025: skuVal2025,
                            change: skuChange,
                            changePercent: skuChangePercent
                        });
                    }
                });
                
                // Sort and store top SKUs for this system
                systemSKUDetails[system] = skuChangesInSystem.sort((a, b) => Math.abs(b.change) - Math.abs(a.change)).slice(0, 10);
                
                systemChanges.push({
                    system: system,
                    val2024: val2024,
                    val2025: val2025,
                    change: change,
                    changePercent: changePercent
                });
            });
            
            const topGrowthSystem = systemChanges.filter(s => s.change > 0).sort((a, b) => b.change - a.change).slice(0, 5);
            const topDeclineSystem = systemChanges.filter(s => s.change < 0).sort((a, b) => a.change - b.change).slice(0, 5);
            
            // Update tables
            updateGrowthTable('topGrowthSKUTableBody', topGrowth, 'sku', null);
            updateGrowthTable('topDeclineSKUTableBody', topDecline, 'sku', null);
            updateGrowthTable('topGrowthSystemTableBody', topGrowthSystem, 'system', true);
            updateGrowthTable('topDeclineSystemTableBody', topDeclineSystem, 'system', true);
        }
        
        function updateGrowthTable(tableBodyId, data, type, expandable) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #94a3b8; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td>';
                return;
            }
            
            data.forEach((item, index) => {
                const name = type === 'sku' ? item.sku : item.system;
                const changePercent = item.changePercent;
                const isPositive = item.change > 0;
                const percentColor = isPositive ? '#10b981' : '#ef4444';
                const percentIcon = isPositive ? '‚Üë' : '‚Üì';
                
                const systemId = type === 'system' ? name.replace(/[^a-zA-Z0-9]/g, '_') : null;
                const expandIcon = expandable && systemSKUDetails[name] && systemSKUDetails[name].length > 0 
                    ? `<span id="icon_${systemId}" style="cursor: pointer; display: inline-block; width: 16px; margin-right: 5px;" onclick="toggleSystemSKUs('${systemId}', '${tableBodyId}')">‚ñ∂</span>` 
                    : '';
                
                const row = tbody.insertRow();
                row.setAttribute('data-system-row', systemId);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align: left; font-weight: 500;">${expandIcon}${name}</td>
                    <td class="number" style="color: #64748b;">${formatCurrency(item.val2024)}</td>
                    <td class="number" style="color: #1e293b; font-weight: 600;">${formatCurrency(item.val2025)}</td>
                    <td class="number" style="color: ${percentColor}; font-weight: 700;">
                        ${percentIcon} ${formatCurrency(Math.abs(item.change))}
                        <br><span style="font-size: 0.85em;">(${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%)</span>
                    </td>
                `;
                
                // Add SKU detail rows (hidden by default)
                if (expandable && systemSKUDetails[name] && systemSKUDetails[name].length > 0) {
                    systemSKUDetails[name].forEach(skuData => {
                        const skuRow = tbody.insertRow();
                        skuRow.setAttribute('data-system-sku', systemId);
                        skuRow.style.display = 'none';
                        
                        const skuIsPositive = skuData.change > 0;
                        const skuPercentColor = skuIsPositive ? '#10b981' : '#ef4444';
                        const skuPercentIcon = skuIsPositive ? '‚Üë' : '‚Üì';
                        
                        skuRow.innerHTML = `
                            <td style="background: #f9fafb;"></td>
                            <td style="padding-left: 30px; background: #f9fafb; color: #666; font-size: 0.9em; text-align: left;">${skuData.sku}</td>
                            <td class="number" style="background: #f9fafb; color: #94a3b8; font-size: 0.85em;">${formatCurrency(skuData.val2024)}</td>
                            <td class="number" style="background: #f9fafb; color: #64748b; font-size: 0.85em;">${formatCurrency(skuData.val2025)}</td>
                            <td class="number" style="background: #f9fafb; color: ${skuPercentColor}; font-size: 0.85em;">
                                ${skuPercentIcon} ${formatCurrency(Math.abs(skuData.change))}
                                <br><span style="font-size: 0.9em;">(${skuData.changePercent >= 0 ? '+' : ''}${skuData.changePercent.toFixed(1)}%)</span>
                            </td>
                        `;
                    });
                }
            });
        }
        
        // Toggle system SKU details
        function toggleSystemSKUs(systemId, tableBodyId) {
            const icon = document.getElementById(`icon_${systemId}`);
            const tbody = document.getElementById(tableBodyId);
            const skuRows = tbody.querySelectorAll(`tr[data-system-sku="${systemId}"]`);
            
            if (icon.textContent === '‚ñ∂') {
                // Expand
                icon.textContent = '‚ñº';
                skuRows.forEach(row => row.style.display = '');
            } else {
                // Collapse
                icon.textContent = '‚ñ∂';
                skuRows.forEach(row => row.style.display = 'none');
            }
        }

        // Update Yearly Product Analysis Table with Forecast
        function updateYearlyProductTable(data) {
            // Group by Brand > Year > SKU to get detailed breakdown
            const brandYearData = {};
            
            data.forEach(row => {
                const brand = (row['NH√ÉN H√ÄNG'] || 'N/A').trim();
                const year = row.year;
                const vat = row.vat || 0;
                const quantity = row.soLuong || 0;
                const fullName = (row['T√äN SP'] || '').trim();
                const sku = shortenProductName(fullName);
                
                if (year < 2023 || year > 2025 || !sku) return;
                
                if (!brandYearData[brand]) {
                    brandYearData[brand] = {
                        brand: brand,
                        years: { 
                            2023: { vat: 0, qty: 0, skus: {} }, 
                            2024: { vat: 0, qty: 0, skus: {} }, 
                            2025: { vat: 0, qty: 0, skus: {} } 
                        }
                    };
                }
                
                brandYearData[brand].years[year].vat += vat;
                brandYearData[brand].years[year].qty += quantity;
                
                // Track SKU details
                if (!brandYearData[brand].years[year].skus[sku]) {
                    brandYearData[brand].years[year].skus[sku] = { vat: 0, qty: 0 };
                }
                brandYearData[brand].years[year].skus[sku].vat += vat;
                brandYearData[brand].years[year].skus[sku].qty += quantity;
            });
            
            // Create rows: each brand gets 3 years + forecast (2026)
            const brandRows = [];
            Object.values(brandYearData).forEach(brandData => {
                const years = [2023, 2024, 2025];
                const yearRows = [];
                let totalVAT = 0;
                
                years.forEach(year => {
                    const yearData = brandData.years[year];
                    const vat = yearData.vat;
                    const qty = yearData.qty;
                    
                    if (vat === 0) return; // Skip years with no data
                    
                    totalVAT += vat;
                    
                    // Calculate growth vs previous year
                    let growthRate = null;
                    let growthText = '-';
                    if (year > 2023) {
                        const prevYear = year - 1;
                        const prevVat = brandData.years[prevYear].vat;
                        if (prevVat > 0) {
                            growthRate = ((vat - prevVat) / prevVat) * 100;
                            const growthIcon = growthRate > 0 ? 'üìà' : 'üìâ';
                            const growthColor = growthRate > 0 ? '#10b981' : '#ef4444';
                            growthText = `<span style="color: ${growthColor}; font-weight: 600;">${growthIcon} ${growthRate.toFixed(1)}%</span>`;
                        }
                    }
                    
                    yearRows.push({
                        brand: brandData.brand,
                        year: year,
                        vat: vat,
                        qty: qty,
                        growthText: growthText,
                        growthRate: growthRate || 0,
                        isForecast: false,
                        skus: yearData.skus // Include SKU details
                    });
                });
                
                // Calculate 2026 forecast if we have at least 2 years of data
                if (yearRows.length >= 2) {
                    const growthRates = [];
                    for (let i = 1; i < yearRows.length; i++) {
                        const prev = yearRows[i-1];
                        const curr = yearRows[i];
                        if (prev.vat > 0) {
                            growthRates.push((curr.vat - prev.vat) / prev.vat);
                        }
                    }
                    
                    if (growthRates.length > 0) {
                        // Check if brand has custom growth rate
                        let avgGrowth = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                        let isCustomGrowth = false;
                        
                        if (BRAND_CUSTOM_GROWTH[brandData.brand] !== undefined) {
                            avgGrowth = BRAND_CUSTOM_GROWTH[brandData.brand];
                            isCustomGrowth = true;
                        }
                        
                        const lastYear = yearRows[yearRows.length - 1];
                        const forecast2026VAT = lastYear.vat * (1 + avgGrowth);
                        const forecast2026Qty = lastYear.qty * (1 + avgGrowth);
                        
                        // Calculate forecast for each SKU based on 2025 data (excluding locked SKUs)
                        const forecast2026SKUs = {};
                        let excludedVAT = 0; // Track excluded SKU values
                        let excludedQty = 0;
                        
                        if (lastYear.skus) {
                            Object.entries(lastYear.skus).forEach(([sku, skuData]) => {
                                // Check if SKU is in exclusion list
                                if (EXCLUDED_SKUS_FROM_FORECAST.includes(sku)) {
                                    // Keep 2025 values for excluded SKUs (no growth)
                                    forecast2026SKUs[sku] = {
                                        vat: skuData.vat,
                                        qty: skuData.qty,
                                        excluded: true // Mark as excluded
                                    };
                                    excludedVAT += skuData.vat;
                                    excludedQty += skuData.qty;
                                } else {
                                    // Apply growth for non-excluded SKUs
                                    forecast2026SKUs[sku] = {
                                        vat: skuData.vat * (1 + avgGrowth),
                                        qty: skuData.qty * (1 + avgGrowth),
                                        excluded: false
                                    };
                                }
                            });
                        }
                        
                        // Adjust brand total: only grow non-excluded portion
                        const nonExcludedVAT = lastYear.vat - excludedVAT;
                        const nonExcludedQty = lastYear.qty - excludedQty;
                        const adjustedForecast2026VAT = (nonExcludedVAT * (1 + avgGrowth)) + excludedVAT;
                        const adjustedForecast2026Qty = (nonExcludedQty * (1 + avgGrowth)) + excludedQty;
                        
                        // Create growth text
                        let growthDisplayText = `<span style="color: #667eea; font-weight: 600;">üîÆ ${(avgGrowth * 100).toFixed(1)}%</span>`;
                        if (isCustomGrowth) {
                            growthDisplayText += ' <span style="color: #f59e0b; font-size: 0.85em;">‚öôÔ∏è (t√πy ch·ªânh)</span>';
                        }
                        if (EXCLUDED_SKUS_FROM_FORECAST.length > 0) {
                            growthDisplayText += ` <span style="color: #94a3b8; font-size: 0.85em;">(lo·∫°i tr·ª´ ${EXCLUDED_SKUS_FROM_FORECAST.length} m√£)</span>`;
                        }
                        
                        yearRows.push({
                            brand: brandData.brand,
                            year: 2026,
                            vat: adjustedForecast2026VAT,
                            qty: adjustedForecast2026Qty,
                            growthText: growthDisplayText,
                            growthRate: avgGrowth * 100,
                            isForecast: true,
                            skus: forecast2026SKUs // Include forecasted SKUs
                        });
                    }
                }
                
                if (yearRows.length > 0) {
                    brandRows.push({
                        brand: brandData.brand,
                        totalVAT: totalVAT,
                        rows: yearRows
                    });
                }
            });
            
            // Sort by brand total VAT descending
            brandRows.sort((a, b) => b.totalVAT - a.totalVAT);
            
            const tbody = document.getElementById('yearlyProductTableBody');
            tbody.innerHTML = '';
            
            let rowIndex = 0;
            brandRows.forEach((brandGroup) => {
                const brandId = brandGroup.brand.replace(/[^a-zA-Z0-9]/g, '_');
                
                // First row: Brand header with total
                const headerRow = tbody.insertRow();
                headerRow.setAttribute('data-brand-header', brandId);
                rowIndex++;
                
                headerRow.innerHTML = `
                    <td>${rowIndex}</td>
                    <td colspan="5" style="font-weight: 700; color: #667eea; cursor: pointer;" onclick="toggleBrand('${brandId}')">
                        <span id="icon_${brandId}" style="display: inline-block; width: 20px;">‚ñº</span>
                        ${brandGroup.brand} 
                        <span style="color: #d97706; font-size: 0.9em;">(T·ªïng: ${formatCurrency(brandGroup.totalVAT)})</span>
                    </td>
                `;
                
                // Year rows
                brandGroup.rows.forEach((rowData) => {
                    const row = tbody.insertRow();
                    row.setAttribute('data-brand-row', brandId);
                    rowIndex++;
                    
                    const yearLabel = rowData.isForecast ? '2026 (D·ª± ki·∫øn)' : rowData.year;
                    const rowStyle = rowData.isForecast ? 'background: #f0f9ff; font-style: italic;' : '';
                    const yearId = `${brandId}_${rowData.year}`;
                    
                    // Add expand icon for years with SKU data
                    const hasSkus = rowData.skus && Object.keys(rowData.skus).length > 0;
                    const expandIcon = hasSkus ? `<span id="icon_${yearId}" style="cursor: pointer; display: inline-block; width: 16px;" onclick="toggleYearSkus('${yearId}'); event.stopPropagation();">‚ñ∂</span> ` : '';
                    
                    row.innerHTML = `
                        <td style="${rowStyle}">${rowIndex}</td>
                        <td style="padding-left: 30px; ${rowStyle}"></td>
                        <td style="${rowStyle}">${expandIcon}${yearLabel}</td>
                        <td class="number" style="${rowStyle}">${rowData.qty > 0 ? formatNumber(Math.round(rowData.qty)) : '-'}</td>
                        <td class="number" style="background: #fffbeb; font-weight: 600; color: #d97706;">${formatCurrency(rowData.vat)}</td>
                        <td class="number" style="${rowStyle}">${rowData.growthText}</td>
                    `;
                    
                    // Add SKU detail rows (hidden by default)
                    if (hasSkus) {
                        const skuArray = Object.entries(rowData.skus)
                            .map(([sku, data]) => ({ sku, ...data }))
                            .sort((a, b) => b.vat - a.vat);
                        
                        skuArray.forEach((skuData) => {
                            const skuRow = tbody.insertRow();
                            skuRow.setAttribute('data-year-sku', yearId);
                            skuRow.style.display = 'none';
                            rowIndex++;
                            
                            // Add lock icon for excluded SKUs
                            const lockIcon = skuData.excluded ? '<span style="color: #94a3b8; margin-right: 4px;" title="M√£ n√†y ƒë∆∞·ª£c lo·∫°i tr·ª´ kh·ªèi d·ª± ki·∫øn">üîí</span>' : '';
                            const skuStyle = skuData.excluded ? 'background: #f1f5f9;' : 'background: #f9fafb;';
                            const valueStyle = skuData.excluded ? 'background: #e2e8f0; color: #64748b;' : 'background: #fef3c7; color: #92400e;';
                            
                            skuRow.innerHTML = `
                                <td style="${skuStyle}">${rowIndex}</td>
                                <td style="padding-left: 50px; ${skuStyle} color: #666; font-size: 0.9em;" colspan="2">${lockIcon}${skuData.sku}</td>
                                <td class="number" style="${skuStyle} color: #666;">${formatNumber(Math.round(skuData.qty))}</td>
                                <td class="number" style="${valueStyle}">${formatCurrency(skuData.vat)}</td>
                                <td style="${skuStyle}">${skuData.excluded ? '<span style="color: #94a3b8; font-size: 0.85em;">Lo·∫°i tr·ª´</span>' : ''}</td>
                            `;
                        });
                    }
                });
            });
        }
        
        // Toggle year SKUs visibility
        function toggleYearSkus(yearId) {
            const icon = document.getElementById(`icon_${yearId}`);
            const skuRows = document.querySelectorAll(`tr[data-year-sku="${yearId}"]`);
            
            if (icon.textContent === '‚ñ∂') {
                // Expand
                icon.textContent = '‚ñº';
                skuRows.forEach(row => row.style.display = '');
            } else {
                // Collapse
                icon.textContent = '‚ñ∂';
                skuRows.forEach(row => row.style.display = 'none');
            }
        }
        
        // Toggle individual brand visibility
        function toggleBrand(brandId) {
            const icon = document.getElementById(`icon_${brandId}`);
            const rows = document.querySelectorAll(`tr[data-brand-row="${brandId}"]`);
            
            if (icon.textContent === '‚ñº') {
                // Collapse
                icon.textContent = '‚ñ∂';
                rows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                icon.textContent = '‚ñº';
                rows.forEach(row => row.style.display = '');
            }
        }

        // Toggle yearly product table visibility
        function toggleYearlyProductTable() {
            const container = document.getElementById('yearlyTableContainer');
            const icon = document.getElementById('toggleIcon');
            const button = document.getElementById('toggleYearlyTable');
            
            if (container.style.maxHeight === '0px') {
                // Expand
                container.style.maxHeight = '2000px';
                container.style.opacity = '1';
                icon.textContent = '‚ñº';
                button.innerHTML = '<span id="toggleIcon">‚ñº</span> Thu g·ªçn';
            } else {
                // Collapse
                container.style.maxHeight = '0px';
                container.style.opacity = '0';
                icon.textContent = '‚ñ∂';
                button.innerHTML = '<span id="toggleIcon">‚ñ∂</span> M·ªü r·ªông';
            }
        }

        // Update dashboard
        function updateDashboard() {
            const data = filterData();
            updateKPIs(data);
            createForecastChart(data);
            createSalesTrendChart(data);
            createBrandTrendChart(data);
            createSystemChart(data);
            createBrandChart(data);
            createYearComparisonChart(data);
            createTopProductsChart(data);
            createStoreActivityChart(data);
            analyzeGrowthDrivers(data);
        }

        // Export to PowerPoint
        async function exportToPowerPoint() {
            const pptx = new PptxGenJS();
            
            // Set presentation properties
            pptx.author = 'Sales Dashboard';
            pptx.company = 'Vi·ªát Li√™n';
            pptx.title = 'B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë 2023-2025';
            
            // Slide 1: Title
            const slide1 = pptx.addSlide();
            slide1.background = { color: '667eea' };
            slide1.addText('üìä B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë', {
                x: 0.5, y: 2.0, w: 9, h: 1,
                fontSize: 44, bold: true, color: 'FFFFFF', align: 'center'
            });
            slide1.addText('Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë theo H·ªá th·ªëng, Nh√£n h√†ng v√† M√£ h√†ng (2023 - 2025)', {
                x: 0.5, y: 3.2, w: 9, h: 0.5,
                fontSize: 18, color: 'FFFFFF', align: 'center'
            });
            slide1.addText(new Date().toLocaleDateString('vi-VN'), {
                x: 0.5, y: 4.5, w: 9, h: 0.3,
                fontSize: 14, color: 'FFFFFF', align: 'center', italic: true
            });
            
            // Slide 2: KPIs
            const slide2 = pptx.addSlide();
            slide2.addText('üìà T·ªïng Quan Doanh S·ªë', {
                x: 0.5, y: 0.3, w: 9, h: 0.5,
                fontSize: 32, bold: true, color: '1e293b'
            });
            
            const kpiData = [
                ['Ch·ªâ S·ªë', 'Gi√° Tr·ªã'],
                ['T·ªïng Doanh S·ªë', document.getElementById('totalSales').textContent],
                ['T·ªïng S·ªë ƒê∆°n H√†ng', document.getElementById('totalOrders').textContent],
                ['Gi√° Tr·ªã TB/ƒê∆°n', document.getElementById('avgOrderValue').textContent],
                ['S·ªë S·∫£n Ph·∫©m', document.getElementById('totalProducts').textContent],
                ['S·ªë H·ªá Th·ªëng', document.getElementById('totalSystems').textContent],
                ['S·ªë Nh√£n H√†ng', document.getElementById('totalBrands').textContent],
                ['C·ª≠a H√†ng Ho·∫°t ƒê·ªông', document.getElementById('activeStores').textContent]
            ];
            
            slide2.addTable(kpiData, {
                x: 1.0, y: 1.2, w: 8, h: 3.5,
                fontSize: 16,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' },
                fontFace: 'Arial'
            });
            
            // Slide 3: Sales Trend Chart
            if (charts.salesTrend) {
                const slide3 = pptx.addSlide();
                slide3.addText('üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.salesTrend.toBase64Image();
                slide3.addImage({ data: chartImage, x: 0.5, y: 1.0, w: 9, h: 4.5 });
            }
            
            // Slide 4: System Chart
            if (charts.system) {
                const slide4 = pptx.addSlide();
                slide4.addText('üè¢ Doanh S·ªë Theo H·ªá Th·ªëng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.system.toBase64Image();
                slide4.addImage({ data: chartImage, x: 1.5, y: 1.0, w: 7, h: 4.5 });
            }
            
            // Slide 5: Brand Trend Chart
            if (charts.brandTrend) {
                const slide5 = pptx.addSlide();
                slide5.addText('üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.brandTrend.toBase64Image();
                slide5.addImage({ data: chartImage, x: 0.5, y: 1.0, w: 9, h: 4.5 });
            }
            
            // Slide 6: Year Comparison
            if (charts.yearComparison) {
                const slide6 = pptx.addSlide();
                slide6.addText('üìä So S√°nh Doanh S·ªë Theo NƒÉm', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.yearComparison.toBase64Image();
                slide6.addImage({ data: chartImage, x: 1.0, y: 1.0, w: 8, h: 4.5 });
            }
            
            // Slide 7: Growth Analysis
            const slide7 = pptx.addSlide();
            slide7.addText('üìä Ph√¢n T√≠ch TƒÉng Tr∆∞·ªüng 2024 vs 2025', {
                x: 0.5, y: 0.3, w: 9, h: 0.5,
                fontSize: 28, bold: true, color: '1e293b'
            });
            
            // Top growth SKUs
            const growthSKURows = Array.from(document.getElementById('topGrowthSKUTableBody').rows).slice(0, 5);
            const growthSKUData = [['#', 'M√£ H√†ng', 'TƒÉng']];
            growthSKURows.forEach(row => {
                const cells = row.cells;
                if (cells.length >= 3) {
                    growthSKUData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[4].textContent.replace(/\n/g, ' ')
                    ]);
                }
            });
            
            slide7.addText('üìà Top 5 M√£ H√†ng TƒÉng Tr∆∞·ªüng', {
                x: 0.5, y: 1.0, w: 4.5, h: 0.3,
                fontSize: 14, bold: true, color: '10b981'
            });
            slide7.addTable(growthSKUData, {
                x: 0.5, y: 1.4, w: 4.5, h: 2.0,
                fontSize: 11,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' }
            });
            
            // Top decline SKUs
            const declineSKURows = Array.from(document.getElementById('topDeclineSKUTableBody').rows).slice(0, 5);
            const declineSKUData = [['#', 'M√£ H√†ng', 'Gi·∫£m']];
            declineSKURows.forEach(row => {
                const cells = row.cells;
                if (cells.length >= 3) {
                    declineSKUData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[4].textContent.replace(/\n/g, ' ')
                    ]);
                }
            });
            
            slide7.addText('üìâ Top 5 M√£ H√†ng Gi·∫£m', {
                x: 5.5, y: 1.0, w: 4.5, h: 0.3,
                fontSize: 14, bold: true, color: 'ef4444'
            });
            slide7.addTable(declineSKUData, {
                x: 5.5, y: 1.4, w: 4.5, h: 2.0,
                fontSize: 11,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' }
            });
            
            // Save the presentation
            const fileName = `BaoCao_DoanSo_${new Date().toISOString().slice(0,10)}.pptx`;
            await pptx.writeFile({ fileName: fileName });
            
            alert('‚úÖ ƒê√£ t·∫£i xu·ªëng file PowerPoint: ' + fileName);
        }

        // Initialize
        loadAllData();
    </script>
</body>
</html>
