<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Doanh S·ªë 2023-2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }

        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            border-color: #cbd5e1;
        }

        .kpi-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #0f172a;
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 0.9em;
            color: #22c55e;
        }

        .kpi-change.negative {
            color: #ef4444;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="month"] {
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        select:hover, input[type="month"]:hover {
            border-color: #94a3b8;
        }

        select:focus, input[type="month"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h2 {
            color: #1e293b;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.tall {
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #64748b;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: #f8fafc;
            color: #1e293b;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.95em;
            }
            
            .kpi-container {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .kpi-card {
                padding: 15px;
            }
            
            .kpi-card h3 {
                font-size: 0.75em;
            }
            
            .kpi-value {
                font-size: 1.3em;
            }
            
            .filters {
                padding: 15px;
                gap: 12px;
            }
            
            .filter-group label {
                font-size: 0.8em;
            }
            
            select, input[type="month"] {
                padding: 12px 10px;
                font-size: 16px;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .chart-card h2 {
                font-size: 1.1em;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-container.tall {
                height: 350px;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            /* C·∫£i thi·ªán button tr√™n mobile */
            button {
                padding: 12px 20px !important;
                font-size: 1em !important;
                min-height: 44px;
            }
            
            /* TƒÉng k√≠ch th∆∞·ªõc clickable area */
            [onclick] {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1 data-i18n="title">üìä B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë</h1>
            <p data-i18n="subtitle">Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë theo H·ªá th·ªëng, Nh√£n h√†ng v√† M√£ h√†ng (2023 - 2025)</p>
        </div>

        <div class="loading" id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

        <div id="dashboard" style="display: none;">
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3 data-i18n="totalRevenue">T·ªïng Doanh S·ªë</h3>
                    <div class="kpi-value" id="totalSales">0 ‚Ç´</div>
                    <div class="kpi-change" id="salesChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="totalOrders">T·ªïng S·ªë ƒê∆°n H√†ng</h3>
                    <div class="kpi-value" id="totalOrders">0</div>
                    <div class="kpi-change" id="ordersChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="avgOrderValue">Gi√° Tr·ªã TB/ƒê∆°n</h3>
                    <div class="kpi-value" id="avgOrderValue">0 ‚Ç´</div>
                    <div class="kpi-change" id="avgChange">0%</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="totalProducts">S·ªë S·∫£n Ph·∫©m (L·ªçc)</h3>
                    <div class="kpi-value" id="totalProducts">0</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">T·ªïng: <span id="totalProductsAll">0</span></div>
                </div>
                <div class="kpi-card">
                    <h3>S·ªë H·ªá Th·ªëng</h3>
                    <div class="kpi-value" id="totalSystems">0</div>
                </div>
                <div class="kpi-card">
                    <h3>S·ªë Nh√£n H√†ng</h3>
                    <div class="kpi-value" id="totalBrands">0</div>
                </div>
                <div class="kpi-card">
                    <h3 data-i18n="activeStores">C·ª≠a H√†ng Ho·∫°t ƒê·ªông</h3>
                    <div class="kpi-value" id="activeStores">0</div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;"><span data-i18n="average">Trung b√¨nh</span>: <span id="avgOrdersPerStore">0</span> <span data-i18n="orders">ƒë∆°n</span></div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label data-i18n="fromMonth">T·ª´ th√°ng</label>
                    <input type="month" id="startMonth" value="2023-01">
                </div>
                <div class="filter-group">
                    <label data-i18n="toMonth">ƒê·∫øn th√°ng</label>
                    <input type="month" id="endMonth" value="2025-12">
                </div>
                <div class="filter-group">
                    <label data-i18n="system">H·ªá th·ªëng</label>
                    <select id="systemFilter">
                        <option value="all" data-i18n="allSystems">T·∫•t c·∫£ h·ªá th·ªëng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label data-i18n="brand">Nh√£n h√†ng</label>
                    <select id="brandFilter">
                        <option value="all" data-i18n="allBrands">T·∫•t c·∫£ nh√£n h√†ng</option>
                    </select>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <label>&nbsp;</label>
                    <button onclick="exportToPowerPoint()" style="
                        padding: 10px 20px;
                        background: #dc2626;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.95em;
                        font-weight: 600;
                        transition: background 0.3s ease;
                        min-height: 44px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                        <span style="font-size: 1.2em;">üìä</span>
                        <span data-i18n="exportPPT">T·∫£i PowerPoint</span>
                    </button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <select id="languageSelector" onchange="switchLanguage(this.value)" style="
                        padding: 10px 15px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 0.95em;
                        background: white;
                        cursor: pointer;
                        min-height: 44px;
                        font-weight: 600;
                    ">
                        <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>
            </div>

            <div class="chart-grid">
                <div class="filter-group">
                    <label>H·ªá th·ªëng</label>
                    <select id="systemFilter">
                        <option value="all">T·∫•t c·∫£ h·ªá th·ªëng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Nh√£n h√†ng</label>
                    <select id="brandFilter">
                        <option value="all">T·∫•t c·∫£ nh√£n h√†ng</option>
                    </select>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card full-width">
                    <h2 data-i18n="salesTrend">üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng</h2>
                    <div class="chart-container tall">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="brandTrend">üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng</h2>
                    <div class="chart-container tall">
                        <canvas id="brandTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 data-i18n="systemSales">üè¢ Doanh S·ªë Theo H·ªá Th·ªëng</h2>
                    <div class="chart-container">
                        <canvas id="systemChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 data-i18n="brandSales">üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng</h2>
                    <div class="chart-container">
                        <canvas id="brandChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="yearComparison">üìä So S√°nh Doanh S·ªë Theo NƒÉm</h2>
                    <div class="chart-container">
                        <canvas id="yearComparisonChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="topProducts">üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y</h2>
                    <div class="chart-container tall">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="storePerformance">üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng</h2>
                    <div class="chart-container">
                        <canvas id="storeActivityChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="topStores">üèÜ Top 30 C·ª≠a H√†ng Theo T·∫ßn Su·∫•t ƒê·∫∑t H√†ng</h2>
                    <div class="table-container">
                        <table id="storeFrequencyTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>C·ª≠a H√†ng</th>
                                    <th class="number">S·ªë L·∫ßn ƒê·∫∑t</th>
                                    <th class="number">T·ªïng ƒê∆°n H√†ng</th>
                                    <th class="number">T·ªïng Doanh Thu</th>
                                    <th class="number">TB/ƒê∆°n</th>
                                </tr>
                            </thead>
                            <tbody id="storeFrequencyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 data-i18n="growthAnalysis">üìä Ph√¢n T√≠ch Nguy√™n Nh√¢n Thay ƒê·ªïi Doanh S·ªë (2024 vs 2025)</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #10b981; margin-bottom: 15px;" data-i18n="topGrowthSKU">üìà Top 10 M√£ H√†ng TƒÉng Tr∆∞·ªüng M·∫°nh Nh·∫•t</h3>
                            <div class="table-container">
                                <table id="topGrowthSKUTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>M√£ H√†ng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">TƒÉng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topGrowthSKUTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #ef4444; margin-bottom: 15px;" data-i18n="topDeclineSKU">üìâ Top 10 M√£ H√†ng Gi·∫£m Nhi·ªÅu Nh·∫•t</h3>
                            <div class="table-container">
                                <table id="topDeclineSKUTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>M√£ H√†ng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">Gi·∫£m</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topDeclineSKUTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
                        <div>
                            <h3 style="color: #3b82f6; margin-bottom: 15px;" data-i18n="topGrowthSystem">üè¢ Top H·ªá Th·ªëng TƒÉng Tr∆∞·ªüng</h3>
                            <div class="table-container">
                                <table id="topGrowthSystemTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">TƒÉng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topGrowthSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #f59e0b; margin-bottom: 15px;" data-i18n="topDeclineSystem">üè¢ Top H·ªá Th·ªëng Gi·∫£m</h3>
                            <div class="table-container">
                                <table id="topDeclineSystemTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>H·ªá Th·ªëng</th>
                                            <th class="number">2024</th>
                                            <th class="number">2025</th>
                                            <th class="number">Gi·∫£m</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topDeclineSystemTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin: 0; flex: 1; min-width: 200px;">üìä Ph√¢n T√≠ch S·∫£n Ph·∫©m Theo NƒÉm & D·ª± ƒêo√°n (S·ªë L∆∞·ª£ng)</h2>
                        <button id="toggleYearlyTable" onclick="toggleYearlyProductTable()" style="
                            padding: 10px 20px;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.95em;
                            transition: background 0.3s ease;
                            min-height: 44px;
                            font-weight: 600;
                        ">
                        ">
                            <span id="toggleIcon">‚ñº</span> Thu g·ªçn
                        </button>
                    </div>
                    <div id="yearlyTableContainer" class="table-container" style="transition: all 0.3s ease; overflow: hidden;">
                        <table id="yearlyProductTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nh√£n H√†ng</th>
                                    <th>NƒÉm</th>
                                    <th class="number">S·ªë L∆∞·ª£ng</th>
                                    <th class="number">T·ªïng Doanh Thu (VAT)</th>
                                    <th class="number">TƒÉng Tr∆∞·ªüng</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyProductTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format number
        function formatNumber(value) {
            return new Intl.NumberFormat('vi-VN').format(value);
        }

        // Shorten product name for better display
        function shortenProductName(fullName) {
            if (!fullName) return 'N/A';
            
            // Check lookup table first
            const trimmedName = fullName.trim();
            if (productNameLookup[trimmedName]) {
                return productNameLookup[trimmedName];
            }
            
            // Fallback: Remove content in parentheses (product codes)
            let name = fullName.replace(/\s*\([^)]*\)\s*/g, ' ');
            
            // Remove extra whitespace
            name = name.replace(/\s+/g, ' ').trim();
            
            // If still too long, take first 50 characters
            if (name.length > 50) {
                name = name.substring(0, 47) + '...';
            }
            
            return name;
        }

        // Parse date from filename
        function parseFilename(filename) {
            const match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return new Date(match[1], parseInt(match[2]) - 1, match[3]);
            }
            return null;
        }

        // Load product name lookup table
        let productNameLookup = {};
        let productBrandLookup = {}; // Th√™m lookup cho NHAN (brand)
        async function loadProductNameLookup() {
            return new Promise((resolve) => {
                Papa.parse('ten_sp_nhan.csv', {
                    download: true,
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        results.data.forEach(row => {
                            const tenSP = (row['TEN SP'] || '').trim();
                            const tenRutGon = (row['TEN RUT GON'] || '').trim();
                            const nhan = (row['NHAN'] || '').trim();
                            if (tenSP && tenRutGon) {
                                productNameLookup[tenSP] = tenRutGon;
                                productBrandLookup[tenSP] = nhan || 'N/A';
                            }
                        });
                        console.log('Loaded', Object.keys(productNameLookup).length, 'product name mappings with brands');
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error loading product lookup:', error);
                        resolve(); // Continue even if lookup fails
                    }
                });
            });
        }

        // ==========================================
        // DANH S√ÅCH M√É H√ÄNG LO·∫†I TR·ª™ KH·ªéI D·ª∞ KI·∫æN 2026
        // Th√™m/b·ªõt m√£ h√†ng v√†o danh s√°ch n√†y ƒë·ªÉ lo·∫°i tr·ª´ kh·ªèi forecast
        // ==========================================
        const EXCLUDED_SKUS_FROM_FORECAST = [
            '1.81 KG',
            'R03(4B)AAA',
            'LR03(4B)AAA',
            'LR03(2B)AAA',
            'LR6(8B)AA',
            'LR03(6B)AAA',
            'LR03(8B)AAA',
            'R6(4S)F-GP-AA(8117)',
            'KHAC_Xe ƒë·ªì ch∆°i - FBG74',
            'R14(2B)',
            'NUOC HOA PURE GAME',
            'NUOC HOA GET READY'
        ];
        
        // T·ª∑ l·ªá tƒÉng tr∆∞·ªüng ƒë·∫∑c bi·ªát cho t·ª´ng th∆∞∆°ng hi·ªáu (ghi ƒë√® t√≠nh to√°n t·ª± ƒë·ªông)
        const BRAND_CUSTOM_GROWTH = {
            'COLEMAN': 0.30  // Coleman tƒÉng tr∆∞·ªüng 30%
        };

        // ==========================================
        // TRANSLATIONS / NG√îN NG·ªÆ
        // ==========================================
        const translations = {
            vi: {
                title: 'üìä B√°o C√°o Doanh S·ªë  Vi·ªát Li√™n',
                subtitle: 'Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë b√°n h√†ng t·ª´ 2023-2025',
                totalRevenue: 'T·ªïng Doanh Thu',
                totalOrders: 'S·ªë ƒê∆°n H√†ng',
                avgOrderValue: 'Gi√° Tr·ªã TB/ƒê∆°n',
                totalProducts: 'S·∫£n Ph·∫©m',
                activeStores: 'C·ª≠a H√†ng Ho·∫°t ƒê·ªông',
                average: 'Trung b√¨nh',
                orders: 'ƒë∆°n',
                fromMonth: 'T·ª´ th√°ng',
                toMonth: 'ƒê·∫øn th√°ng',
                system: 'H·ªá th·ªëng',
                brand: 'Nh√£n h√†ng',
                allSystems: 'T·∫•t c·∫£ h·ªá th·ªëng',
                allBrands: 'T·∫•t c·∫£ nh√£n h√†ng',
                exportPPT: 'T·∫£i PowerPoint',
                salesTrend: 'üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng',
                brandTrend: 'üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng',
                systemSales: 'üè¢ Doanh S·ªë Theo H·ªá Th·ªëng',
                brandSales: 'üè∑Ô∏è Doanh S·ªë Theo Nh√£n H√†ng',
                yearComparison: 'üìä So S√°nh Doanh S·ªë Theo NƒÉm',
                topProducts: 'üîù Top 20 S·∫£n Ph·∫©m B√°n Ch·∫°y',
                storePerformance: 'üè™ Hi·ªáu Su·∫•t C·ª≠a H√†ng - S·ªë C·ª≠a H√†ng ƒê·∫∑t H√†ng Theo Th√°ng',
                topStores: 'üèÜ Top 30 C·ª≠a H√†ng Theo T·∫ßn Su·∫•t ƒê·∫∑t H√†ng',
                growthAnalysis: 'üìä Ph√¢n T√≠ch Nguy√™n Nh√¢n Thay ƒê·ªïi Doanh S·ªë (2024 vs 2025)',
                topGrowthSKU: 'üìà Top 10 M√£ H√†ng TƒÉng Tr∆∞·ªüng M·∫°nh Nh·∫•t',
                topDeclineSKU: 'üìâ Top 10 M√£ H√†ng Gi·∫£m Nhi·ªÅu Nh·∫•t',
                topGrowthSystem: 'üè¢ Top H·ªá Th·ªëng TƒÉng Tr∆∞·ªüng',
                topDeclineSystem: 'üè¢ Top H·ªá Th·ªëng Gi·∫£m',
                brandYearComparison: 'üìä So S√°nh Doanh S·ªë Theo NƒÉm (Nh√£n H√†ng)'
            },
            en: {
                title: 'üìä Sales Report - Viet Lien',
                subtitle: 'Detailed sales analysis from 2023-2025',
                totalRevenue: 'Total Revenue',
                totalOrders: 'Total Orders',
                avgOrderValue: 'Avg Order Value',
                totalProducts: 'Products',
                activeStores: 'Active Stores',
                average: 'Average',
                orders: 'orders',
                fromMonth: 'From month',
                toMonth: 'To month',
                system: 'System',
                brand: 'Brand',
                allSystems: 'All systems',
                allBrands: 'All brands',
                exportPPT: 'Export PowerPoint',
                salesTrend: 'üìà Monthly Sales Trend',
                brandTrend: 'üè∑Ô∏è Sales Trend by Brand',
                systemSales: 'üè¢ Sales by System',
                brandSales: 'üè∑Ô∏è Sales by Brand',
                yearComparison: 'üìä Year-over-Year Comparison',
                topProducts: 'üîù Top 20 Best-Selling Products',
                storePerformance: 'üè™ Store Performance - Active Stores by Month',
                topStores: 'üèÜ Top 30 Stores by Order Frequency',
                growthAnalysis: 'üìä Sales Change Analysis (2024 vs 2025)',
                topGrowthSKU: 'üìà Top 10 Growing SKUs',
                topDeclineSKU: 'üìâ Top 10 Declining SKUs',
                topGrowthSystem: 'üè¢ Top Growing Systems',
                topDeclineSystem: 'üè¢ Top Declining Systems',
                brandYearComparison: 'üìä Year-over-Year Comparison (By Brand)'
            }
        };

        let currentLanguage = localStorage.getItem('dashboardLanguage') || 'vi';

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('dashboardLanguage', lang);
            document.documentElement.lang = lang;
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update select options
            const systemFilter = document.getElementById('systemFilter');
            if (systemFilter && systemFilter.options[0]) {
                systemFilter.options[0].textContent = translations[lang].allSystems;
            }
            
            const brandFilter = document.getElementById('brandFilter');
            if (brandFilter && brandFilter.options[0]) {
                brandFilter.options[0].textContent = translations[lang].allBrands;
            }
            
            // Re-render charts with new language
            updateDashboard();
        }

        function initLanguage() {
            const selector = document.getElementById('languageSelector');
            if (selector) {
                selector.value = currentLanguage;
            }
            switchLanguage(currentLanguage);
        }

        // Load CUSTOMERS lookup table
        let customersLookup = {};
        async function loadCustomers() {
            return new Promise((resolve) => {
                Papa.parse('CUSTOMERS.csv', {
                    download: true,
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        results.data.forEach(row => {
                            const nam = parseInt(row['NAM']);
                            const systemCode = (row['SYSTEM CODE'] || '').trim();
                            const heThong = (row['HE THONG'] || '').trim();
                            if (nam && systemCode && heThong) {
                                const key = `${nam}_${systemCode}`;
                                customersLookup[key] = heThong;
                            }
                        });
                        console.log('Loaded', Object.keys(customersLookup).length, 'customer system mappings');
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error loading customers:', error);
                        resolve(); // Continue even if lookup fails
                    }
                });
            });
        }

        // Load all CSV files
        async function loadAllData() {
            // Load lookup tables first
            await loadProductNameLookup();
            await loadCustomers();
            await loadProductNameLookup();
            // CH·ªà L·∫§Y FILE CU·ªêI TH√ÅNG (lo·∫°i b·ªè file trung gian ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
            const files = [
                '2023-01-31_DS_31.01.2023.csv', '2023-02-28_DS_28.02.23.csv', '2023-03-31_DS_31.03.2023.csv',
                '2023-04-30_DS_30.04.2023.csv', '2023-05-27_DS_27.05.2023.csv', '2023-06-30_DS_30.06.2023.csv',
                '2023-07-31_DS_31.07.2023.csv', '2023-08-31_DS_31.08.2023.csv', '2023-09-30_DS_30.09.2023.csv',
                '2023-10-31_DS_31.10.2023.csv', '2023-11-30_DS_30.11.2023.csv', '2023-12-31_DS_31.12.2023.csv',
                '2024-01-31_DS_31.01.2024.csv', '2024-02-29_DS_29.02.24.csv', '2024-03-30_DS_30.03.2024.csv',
                '2024-04-30_DS_30.04.2024.csv', '2024-05-31_DS_31.05.2024.csv', '2024-06-30_DS_30.06.2024.csv',
                '2024-07-31_DS_31.07.2024.csv', '2024-08-31_DS_31.08.2024.csv', '2024-09-30_DS_30.09.2024.csv',
                '2024-10-31_DS_31.10.2024.csv', '2024-11-30_DS_30.11.2024.csv', '2024-12-31_DS_31.12.2024.csv',
                '2025-01-24_DS_24.01.25.csv', '2025-02-28_DS_28.02.25.csv', '2025-03-31_DS_31.03.25.csv',
                '2025-04-30_DS_30.4.25.csv', '2025-05-31_DS_31.05.25.csv', '2025-06-30_DS_30.06.25.csv',
                '2025-07-28_DS_28.07.25.csv', '2025-08-31_DS_31.08.25.csv', '2025-09-30_DS_30.09.25 .csv',
                '2025-10-31_DS_31.10.25 .csv', 
                // Th√°ng 11: Ch·ªâ l·∫•y file 30/11 (b·ªè file 22/11)
                '2025-11-30_DS_30.11.25.csv',
                // Th√°ng 12: Ch·ªâ l·∫•y file 31/12 (b·ªè file 15/12 v√† 22/12)
                '2025-12-31_DS_31.12.25.csv'
            ];

            const promises = files.map(filename => {
                return new Promise((resolve, reject) => {
                    const date = parseFilename(filename);
                    // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi + cache buster
                    const filePath = 'CSV_Output_Latest_Only/' + filename + '?v=' + Date.now();
                    
                    Papa.parse(filePath, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        encoding: 'UTF-8',
                        complete: function(results) {
                            // Debug: log t√™n c·ªôt ƒë·ªÉ ki·ªÉm tra
                            if (results.data.length > 0 && filename.includes('2025-11-30')) {
                                console.log('Column names in CSV:', Object.keys(results.data[0]));
                            }
                            
                            const data = results.data
                                // B∆∞·ªõc 1: L·ªçc b·ªè header rows (NGAY = "NGAY")
                                .filter(row => row.NGAY && row.NGAY !== 'NGAY')
                                // B∆∞·ªõc 2: Map v√† merge v·ªõi lookups (gi·ªëng Excel Power Query)
                                .map(row => {
                                    const sl = parseFloat(row.SL) || 0;
                                    const donGia = parseFloat(row['ƒê∆†N GI√Å']) || 0;
                                    // C√¥ng th·ª©c Power Query: VAT = SL * ƒê∆†N GI√Å * 1.1
                                    const calculatedVAT = sl * donGia * 1.1;
                                    
                                    const tenSP = (row['T√äN SP'] || '').trim();
                                    const maKH = (row['MA KH'] || '').toString().trim();
                                    
                                    // QUAN TR·ªåNG: D√πng NHAN t·ª´ ten_sp_nhan (kh√¥ng d√πng NH√ÉN H√ÄNG t·ª´ CSV)
                                    const nhanHang = productBrandLookup[tenSP] || 'N/A';
                                    
                                    // Merge v·ªõi CUSTOMERS: NAM + MA KH -> HE THONG
                                    const customerKey = `${date.getFullYear()}_${maKH}`;
                                    const heThongFromCustomers = customersLookup[customerKey] || null;
                                    
                                    // L·∫•y M√É HH t·ª´ c·ªôt th·ª© 8 (index 7)
                                    const maHH = (row['M√É HH'] || row['MA HH'] || '').toString().trim();
                                    
                                    return {
                                        'SO HD': row['SO HD'],
                                        'NGAY': row.NGAY,
                                        'MA KH': maKH,
                                        'M√É HH': maHH,
                                        'T√äN SP': tenSP,
                                        'NH√ÉN H√ÄNG': nhanHang, // T·ª´ NHAN trong ten_sp_nhan
                                        'H·ªÜ TH·ªêNG': heThongFromCustomers, // T·ª´ CUSTOMERS, kh√¥ng ph·∫£i CSV g·ªëc
                                        'C·ª¨A H√ÄNG': row['C·ª¨A H√ÄNG'],
                                        month: date,
                                        monthKey: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                                        year: date.getFullYear(),
                                        vat: calculatedVAT,
                                        thanhTien: parseFloat(row['TH√ÄNH TI·ªÄN']) || 0,
                                        soLuong: sl,
                                        donGia: donGia,
                                        // Key ƒë·ªÉ dedup: SO HD + NGAY + M√É HH + T√äN SP + SL
                                        duplicateKey: `${row['SO HD']}_${row.NGAY}_${maHH}_${tenSP}_${sl}`
                                    };
                                });
                            resolve(data);
                        },
                        error: function(error) {
                            console.error(`Error loading ${filename}:`, error);
                            resolve([]);
                        }
                    });
                });
            });

            const results = await Promise.all(promises);
            const rawData = results.flat();
            
            console.log('Raw data loaded:', rawData.length, 'rows');
            
            // DEDUP theo Excel Power Query: Group by SO HD + NGAY + M√É HH + T√äN SP + SL
            // Gi·ªØ d√≤ng ƒê·∫¶U TI√äN (Table.FirstN(_,1))
            const uniqueMap = new Map();
            let duplicateCount = 0;
            rawData.forEach(row => {
                const key = row.duplicateKey;
                if (!uniqueMap.has(key)) {
                    uniqueMap.set(key, row);
                } else {
                    duplicateCount++;
                }
            });
            
            const afterDedup = Array.from(uniqueMap.values());
            console.log('After dedup:', afterDedup.length, 'rows (removed', duplicateCount, 'duplicates)');
            
            // L·ªåC H·ªÜ TH·ªêNG != null (t·ª´ CUSTOMERS)
            const afterSystemFilter = afterDedup.filter(row => row['H·ªÜ TH·ªêNG'] !== null);
            console.log('Filter H·ªÜ TH·ªêNG not null:', afterSystemFilter.length, 'rows');
            
            // L·ªåC B·ªé NH√ÉN H√ÄNG = "N/A"
            allData = afterSystemFilter.filter(row => row['NH√ÉN H√ÄNG'] !== 'N/A' && row['NH√ÉN H√ÄNG'] !== '');
            console.log('After filter NH√ÉN H√ÄNG:', allData.length, 'rows');
            
            // T√≠nh t·ªïng VAT ƒë·ªÉ debug
            const totalVAT = allData.reduce((sum, row) => sum + row.vat, 0);
            console.log('üí∞ Total VAT (all data):', totalVAT.toLocaleString('vi-VN'), 'VND');
            
            // Debug th√°ng 11/2025 c·ª• th·ªÉ
            const nov2025 = allData.filter(row => row.monthKey === '2025-11');
            const nov2025VAT = nov2025.reduce((sum, row) => sum + row.vat, 0);
            console.log('üìÖ Nov 2025:', nov2025.length, 'rows, VAT:', nov2025VAT.toLocaleString('vi-VN'), 'VND');
            
            // Debug th√°ng 4/2025 c·ª• th·ªÉ
            const apr2025Raw = rawData.filter(row => row.monthKey === '2025-04');
            const apr2025Final = allData.filter(row => row.monthKey === '2025-04');
            const apr2025VAT = apr2025Final.reduce((sum, row) => sum + row.vat, 0);
            console.log('üìÖ Apr 2025: Raw:', apr2025Raw.length, '‚Üí Final:', apr2025Final.length, 'rows, VAT:', apr2025VAT.toLocaleString('vi-VN'), 'VND');
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            initializeFilters();
            initLanguage();
            updateDashboard();
        }

        // Initialize filters
        function initializeFilters() {
            const systems = [...new Set(allData.map(d => d['H·ªÜ TH·ªêNG']))].filter(Boolean).sort();
            const brands = [...new Set(allData.map(d => d['NH√ÉN H√ÄNG']))].filter(Boolean).sort();

            const systemSelect = document.getElementById('systemFilter');
            systems.forEach(system => {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = system;
                systemSelect.appendChild(option);
            });

            const brandSelect = document.getElementById('brandFilter');
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            // Add event listeners
            document.getElementById('startMonth').addEventListener('change', updateDashboard);
            document.getElementById('endMonth').addEventListener('change', updateDashboard);
            document.getElementById('systemFilter').addEventListener('change', updateDashboard);
            document.getElementById('brandFilter').addEventListener('change', updateDashboard);
        }

        // Filter data
        function filterData() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const system = document.getElementById('systemFilter').value;
            const brand = document.getElementById('brandFilter').value;

            return allData.filter(row => {
                if (startMonth && row.monthKey < startMonth) return false;
                if (endMonth && row.monthKey > endMonth) return false;
                if (system !== 'all' && row['H·ªÜ TH·ªêNG'] !== system) return false;
                if (brand !== 'all' && row['NH√ÉN H√ÄNG'] !== brand) return false;
                return true;
            });
        }

        // Update KPIs
        function updateKPIs(data) {
            const totalSales = data.reduce((sum, row) => sum + row.vat, 0);
            const uniqueOrders = new Set(data.map(d => d['SO HD']).filter(Boolean)).size;
            const avgOrder = uniqueOrders > 0 ? totalSales / uniqueOrders : 0;
            
            // ƒê·∫øm s·∫£n ph·∫©m unique theo filter hi·ªán t·∫°i
            console.log('Sample row keys:', data.length > 0 ? Object.keys(data[0]) : 'No data');
            console.log('Sample row M√É HH:', data.length > 0 ? data[0]['M√É HH'] : 'No data');
            
            const productCodes = data.map(d => d['M√É HH']).filter(Boolean);
            const uniqueProducts = new Set(productCodes).size;
            
            console.log('Product codes sample (first 10):', productCodes.slice(0, 10));
            console.log('Unique products:', uniqueProducts);
            
            // ƒê·∫øm t·ªïng s·∫£n ph·∫©m trong to√†n b·ªô d·ªØ li·ªáu (kh√¥ng filter)
            const allProductCodes = allData.map(d => d['M√É HH']).filter(Boolean);
            const totalAllProducts = new Set(allProductCodes).size;
            
            const systems = data.map(d => d['H·ªÜ TH·ªêNG'] || d.H·ªÜ_TH·ªêNG || d['HE THONG']).filter(Boolean);
            const uniqueSystems = new Set(systems).size;
            
            const brands = data.map(d => d['NH√ÉN H√ÄNG'] || d.NH√ÉN_H√ÄNG || d['NHAN HANG']).filter(Boolean);
            const uniqueBrands = new Set(brands).size;
            
            console.log('KPI Debug:', {
                totalRows: data.length,
                totalRowsAll: allData.length,
                uniqueProducts: uniqueProducts,
                totalAllProducts: totalAllProducts,
                sampleProduct: productCodes[0],
                uniqueSystems: uniqueSystems,
                uniqueBrands: uniqueBrands
            });

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalOrders').textContent = formatNumber(uniqueOrders);
            document.getElementById('avgOrderValue').textContent = formatCurrency(avgOrder);
            document.getElementById('totalProducts').textContent = formatNumber(uniqueProducts);
            document.getElementById('totalProductsAll').textContent = formatNumber(totalAllProducts);
            document.getElementById('totalSystems').textContent = formatNumber(uniqueSystems);
            document.getElementById('totalBrands').textContent = formatNumber(uniqueBrands);

            // Calculate changes (comparing with previous period)
            const currentYear = new Date().getFullYear();
            const currentData = data.filter(d => d.year === currentYear);
            const previousData = data.filter(d => d.year === currentYear - 1);
            
            const currentSales = currentData.reduce((sum, row) => sum + row.vat, 0);
            const previousSales = previousData.reduce((sum, row) => sum + row.vat, 0);
            const salesGrowth = previousSales > 0 ? ((currentSales - previousSales) / previousSales * 100) : 0;
            
            const salesChangeEl = document.getElementById('salesChange');
            salesChangeEl.textContent = `${salesGrowth >= 0 ? '+' : ''}${salesGrowth.toFixed(1)}% vs nƒÉm tr∆∞·ªõc`;
            salesChangeEl.className = salesGrowth >= 0 ? 'kpi-change' : 'kpi-change negative';
        }

        // Create Sales Trend Chart
        function createSalesTrendChart(data) {
            const monthlyData = {};
            data.forEach(row => {
                const key = row.monthKey;
                if (!monthlyData[key]) {
                    monthlyData[key] = 0;
                }
                monthlyData[key] += row.vat;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const values = sortedMonths.map(month => monthlyData[month]);
            
            // T√≠nh trung b√¨nh
            const average = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            const averageData = new Array(values.length).fill(average);

            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (charts.salesTrend) {
                charts.salesTrend.destroy();
            }

            charts.salesTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        order: 2
                    },
                    {
                        label: 'Trung B√¨nh',
                        data: averageData,
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Trung B√¨nh') {
                                        return 'Trung b√¨nh: ' + formatCurrency(context.parsed.y);
                                    }
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create brand trend chart (multi-line chart for top brands)
        function createBrandTrendChart(data) {
            // Check if filtering by specific brand
            const brandFilter = document.getElementById('brandFilter').value;
            const isFilteredByBrand = brandFilter && brandFilter !== 'all';
            
            // Group by brand and month
            const brandMonthData = {};
            const allMonths = new Set();
            
            data.forEach(row => {
                const brand = (row['NH√ÉN H√ÄNG'] || 'N/A').trim();
                const monthKey = row.monthKey;
                const vat = row.vat || 0;
                
                if (!brand || brand === 'N/A') return;
                
                allMonths.add(monthKey);
                
                if (!brandMonthData[brand]) {
                    brandMonthData[brand] = {};
                }
                
                if (!brandMonthData[brand][monthKey]) {
                    brandMonthData[brand][monthKey] = 0;
                }
                
                brandMonthData[brand][monthKey] += vat;
            });
            
            // Calculate total per brand and get top 10
            const brandTotals = Object.entries(brandMonthData).map(([brand, months]) => {
                const total = Object.values(months).reduce((sum, val) => sum + val, 0);
                return { brand, months, total };
            }).sort((a, b) => b.total - a.total).slice(0, 10);
            
            // Sort months chronologically
            const sortedMonths = Array.from(allMonths).sort();
            
            // Color palette for brands
            const colors = [
                '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
                '#fee140', '#30cfd0', '#a8edea', '#ff6b6b', '#c44569'
            ];
            
            const datasets = brandTotals.map((brandData, index) => ({
                label: brandData.brand,
                data: sortedMonths.map(month => brandData.months[month] || 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                order: 2
            }));
            
            // Th√™m ƒë∆∞·ªùng trung b√¨nh n·∫øu ƒëang l·ªçc theo 1 brand c·ª• th·ªÉ
            if (isFilteredByBrand && brandTotals.length === 1) {
                const brandData = brandTotals[0];
                const values = sortedMonths.map(month => brandData.months[month] || 0);
                const average = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                const averageData = new Array(values.length).fill(average);
                
                datasets.push({
                    label: 'Trung B√¨nh',
                    data: averageData,
                    borderColor: '#ef4444',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: false,
                    order: 1
                });
            }
            
            const ctx = document.getElementById('brandTrendChart').getContext('2d');
            
            if (charts.brandTrend) {
                charts.brandTrend.destroy();
            }
            
            charts.brandTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Trung B√¨nh') {
                                        return 'Trung b√¨nh: ' + formatCurrency(context.parsed.y);
                                    }
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create System Chart
        function createSystemChart(data) {
            const systemData = {};
            data.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'];
                if (!systemData[system]) {
                    systemData[system] = 0;
                }
                systemData[system] += row.vat;
            });

            const sorted = Object.entries(systemData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('systemChart').getContext('2d');
            
            if (charts.system) {
                charts.system.destroy();
            }

            charts.system = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                            '#a8edea', '#fed6e3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Brand Chart
        function createBrandChart(data) {
            const brandData = {};
            data.forEach(row => {
                const brand = row['NH√ÉN H√ÄNG'];
                if (!brandData[brand]) {
                    brandData[brand] = 0;
                }
                brandData[brand] += row.vat;
            });

            const sorted = Object.entries(brandData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('brandChart').getContext('2d');
            
            if (charts.brand) {
                charts.brand.destroy();
            }

            charts.brand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Year Comparison Chart
        function createYearComparisonChart(data) {
            const yearData = {};
            data.forEach(row => {
                const year = row.year;
                if (!yearData[year]) {
                    yearData[year] = 0;
                }
                yearData[year] += row.vat;
            });

            const years = Object.keys(yearData).sort();
            const values = years.map(year => yearData[year]);

            const ctx = document.getElementById('yearComparisonChart').getContext('2d');
            
            if (charts.yearComparison) {
                charts.yearComparison.destroy();
            }

            charts.yearComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: values,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh s·ªë: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Top Products Chart
        function createTopProductsChart(data) {
            const productData = {};
            data.forEach(row => {
                const fullName = (row['T√äN SP'] || '').trim();
                const brand = (row['NH√ÉN H√ÄNG'] || '').trim();
                
                // Skip invalid records
                if (!fullName) {
                    return;
                }
                
                // Get shortened name for grouping
                const shortName = shortenProductName(fullName);
                
                // Group by T√äN R√öT G·ªåN (shortened name)
                if (!productData[shortName]) {
                    productData[shortName] = {
                        name: shortName,
                        brand: brand || 'N/A',
                        sales: 0,
                        quantity: 0
                    };
                }
                productData[shortName].sales += row.vat || 0;
                productData[shortName].quantity += row.soLuong || 0;
            });

            const sorted = Object.entries(productData)
                .filter(item => item[1].sales > 0)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 20);

            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }

            if (sorted.length === 0) {
                // Handle case when no data available
                ctx.canvas.parentNode.innerHTML = '<p style="text-align: center; padding: 50px; color: #666;">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
                return;
            }

            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[1].name), // Already shortened name
                    datasets: [{
                        label: 'Doanh S·ªë',
                        data: sorted.map(s => s[1].sales),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return sorted[index][1].name;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        'M√£: ' + sorted[index][0],
                                        'Doanh s·ªë: ' + formatCurrency(context.parsed.x),
                                        'S·ªë l∆∞·ª£ng: ' + formatNumber(sorted[index][1].quantity)
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Update yearly product analysis table
            updateYearlyProductTable(data);
            
            // Update store frequency table
            updateStoreFrequencyTable(data);
        }

        // Create Store Activity Chart (Active stores per month by system)
        function createStoreActivityChart(data) {
            // Group by month and system to count unique stores
            const monthStoreData = {}; // Total stores per month
            const systemMonthStoreData = {}; // Stores per month per system
            
            data.forEach(row => {
                const monthKey = row.monthKey;
                const store = (row['C·ª¨A H√ÄNG'] || '').trim();
                const system = (row['H·ªÜ TH·ªêNG'] || '').trim();
                
                if (!monthKey || !store) return;
                
                // Track total stores
                if (!monthStoreData[monthKey]) {
                    monthStoreData[monthKey] = new Set();
                }
                monthStoreData[monthKey].add(store);
                
                // Track stores per system
                if (system) {
                    if (!systemMonthStoreData[system]) {
                        systemMonthStoreData[system] = {};
                    }
                    if (!systemMonthStoreData[system][monthKey]) {
                        systemMonthStoreData[system][monthKey] = new Set();
                    }
                    systemMonthStoreData[system][monthKey].add(store);
                }
            });
            
            // Get sorted months
            const sortedMonths = Object.keys(monthStoreData).sort();
            
            // Prepare datasets
            const datasets = [];
            
            // Color palette for systems
            const systemColors = [
                { border: '#3b82f6', bg: '#3b82f640' },
                { border: '#10b981', bg: '#10b98140' },
                { border: '#f59e0b', bg: '#f59e0b40' },
                { border: '#ef4444', bg: '#ef444440' },
                { border: '#8b5cf6', bg: '#8b5cf640' },
                { border: '#ec4899', bg: '#ec489940' },
                { border: '#14b8a6', bg: '#14b8a640' },
                { border: '#f97316', bg: '#f9731640' }
            ];
            
            let colorIndex = 0;
            
            // Add system datasets
            Object.keys(systemMonthStoreData).sort().forEach(system => {
                const systemData = systemMonthStoreData[system];
                const storeCounts = sortedMonths.map(month => 
                    systemData[month] ? systemData[month].size : 0
                );
                
                const color = systemColors[colorIndex % systemColors.length];
                colorIndex++;
                
                datasets.push({
                    label: system,
                    data: storeCounts,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                });
            });
            
            // Add total dataset (thicker line, always on top)
            const totalStoreCounts = sortedMonths.map(month => monthStoreData[month].size);
            datasets.push({
                label: 'T·ªïng c·ª≠a h√†ng',
                data: totalStoreCounts,
                borderColor: '#1e293b',
                backgroundColor: '#1e293b20',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderDash: [5, 5]
            });
            
            const ctx = document.getElementById('storeActivityChart').getContext('2d');
            
            if (charts.storeActivity) {
                charts.storeActivity.destroy();
            }
            
            charts.storeActivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' c·ª≠a h√†ng';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Update Store Frequency Table
        function updateStoreFrequencyTable(data) {
            // Group by store
            const storeData = {};
            
            data.forEach(row => {
                const store = (row['C·ª¨A H√ÄNG'] || '').trim();
                const soHD = row['SO HD'];
                const vat = row.vat || 0;
                
                if (!store) return;
                
                if (!storeData[store]) {
                    storeData[store] = {
                        store: store,
                        orderDates: new Set(), // Count unique order dates/times
                        totalOrders: new Set(), // Count unique SO HD
                        totalSales: 0
                    };
                }
                
                // Count frequency by unique (SO HD + NGAY) combinations
                const dateKey = row.monthKey + '_' + soHD;
                storeData[store].orderDates.add(dateKey);
                storeData[store].totalOrders.add(soHD);
                storeData[store].totalSales += vat;
            });
            
            // Convert to array and sort by order frequency
            const sorted = Object.values(storeData)
                .map(s => ({
                    store: s.store,
                    frequency: s.orderDates.size, // Number of unique orders
                    totalOrders: s.totalOrders.size,
                    totalSales: s.totalSales,
                    avgPerOrder: s.totalOrders.size > 0 ? s.totalSales / s.totalOrders.size : 0
                }))
                .sort((a, b) => b.frequency - a.frequency)
                .slice(0, 30);
            
            const tbody = document.getElementById('storeFrequencyTableBody');
            tbody.innerHTML = '';
            
            sorted.forEach((storeInfo, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${storeInfo.store}</td>
                    <td class="number" style="font-weight: 600; color: #667eea;">${formatNumber(storeInfo.frequency)}</td>
                    <td class="number">${formatNumber(storeInfo.totalOrders)}</td>
                    <td class="number" style="background: #fffbeb; color: #d97706;">${formatCurrency(storeInfo.totalSales)}</td>
                    <td class="number">${formatCurrency(storeInfo.avgPerOrder)}</td>
                `;
            });
        }

        // Analyze growth contributors and detractors (2024 vs 2025)
        let systemSKUDetails = {}; // Store SKU details per system for expansion
        
        function analyzeGrowthDrivers(data) {
            // Filter data for 2024 and 2025
            const data2024 = data.filter(row => row.year === 2024);
            const data2025 = data.filter(row => row.year === 2025);
            
            // Analyze by SKU
            const skuData2024 = {};
            const skuData2025 = {};
            
            data2024.forEach(row => {
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!sku) return;
                if (!skuData2024[sku]) skuData2024[sku] = 0;
                skuData2024[sku] += row.vat || 0;
            });
            
            data2025.forEach(row => {
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!sku) return;
                if (!skuData2025[sku]) skuData2025[sku] = 0;
                skuData2025[sku] += row.vat || 0;
            });
            
            // Calculate SKU changes
            const skuChanges = [];
            const allSkus = new Set([...Object.keys(skuData2024), ...Object.keys(skuData2025)]);
            
            allSkus.forEach(sku => {
                const val2024 = skuData2024[sku] || 0;
                const val2025 = skuData2025[sku] || 0;
                const change = val2025 - val2024;
                const changePercent = val2024 > 0 ? ((change / val2024) * 100) : 0;
                
                if (Math.abs(change) > 1000000) { // Only significant changes > 1M
                    skuChanges.push({
                        sku: sku,
                        val2024: val2024,
                        val2025: val2025,
                        change: change,
                        changePercent: changePercent
                    });
                }
            });
            
            // Top growth and decline SKUs
            const topGrowth = skuChanges.filter(s => s.change > 0).sort((a, b) => b.change - a.change).slice(0, 10);
            const topDecline = skuChanges.filter(s => s.change < 0).sort((a, b) => a.change - b.change).slice(0, 10);
            
            // Analyze by System WITH SKU DETAILS
            const systemData2024 = {};
            const systemData2025 = {};
            const systemSKUData2024 = {}; // Track SKUs per system
            const systemSKUData2025 = {};
            
            data2024.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || '';
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!system || !sku) return;
                
                if (!systemData2024[system]) systemData2024[system] = 0;
                systemData2024[system] += row.vat || 0;
                
                if (!systemSKUData2024[system]) systemSKUData2024[system] = {};
                if (!systemSKUData2024[system][sku]) systemSKUData2024[system][sku] = 0;
                systemSKUData2024[system][sku] += row.vat || 0;
            });
            
            data2025.forEach(row => {
                const system = row['H·ªÜ TH·ªêNG'] || '';
                const sku = shortenProductName(row['T√äN SP'] || '');
                if (!system || !sku) return;
                
                if (!systemData2025[system]) systemData2025[system] = 0;
                systemData2025[system] += row.vat || 0;
                
                if (!systemSKUData2025[system]) systemSKUData2025[system] = {};
                if (!systemSKUData2025[system][sku]) systemSKUData2025[system][sku] = 0;
                systemSKUData2025[system][sku] += row.vat || 0;
            });
            
            // Calculate System changes with SKU breakdown
            const systemChanges = [];
            const allSystems = new Set([...Object.keys(systemData2024), ...Object.keys(systemData2025)]);
            
            systemSKUDetails = {}; // Reset
            
            allSystems.forEach(system => {
                const val2024 = systemData2024[system] || 0;
                const val2025 = systemData2025[system] || 0;
                const change = val2025 - val2024;
                const changePercent = val2024 > 0 ? ((change / val2024) * 100) : 0;
                
                // Calculate SKU changes within this system
                const skuChangesInSystem = [];
                const systemSkus2024 = systemSKUData2024[system] || {};
                const systemSkus2025 = systemSKUData2025[system] || {};
                const allSystemSkus = new Set([...Object.keys(systemSkus2024), ...Object.keys(systemSkus2025)]);
                
                allSystemSkus.forEach(sku => {
                    const skuVal2024 = systemSkus2024[sku] || 0;
                    const skuVal2025 = systemSkus2025[sku] || 0;
                    const skuChange = skuVal2025 - skuVal2024;
                    const skuChangePercent = skuVal2024 > 0 ? ((skuChange / skuVal2024) * 100) : 0;
                    
                    if (Math.abs(skuChange) > 500000) { // Significant change > 500K
                        skuChangesInSystem.push({
                            sku: sku,
                            val2024: skuVal2024,
                            val2025: skuVal2025,
                            change: skuChange,
                            changePercent: skuChangePercent
                        });
                    }
                });
                
                // Sort and store top SKUs for this system
                systemSKUDetails[system] = skuChangesInSystem.sort((a, b) => Math.abs(b.change) - Math.abs(a.change)).slice(0, 10);
                
                systemChanges.push({
                    system: system,
                    val2024: val2024,
                    val2025: val2025,
                    change: change,
                    changePercent: changePercent
                });
            });
            
            const topGrowthSystem = systemChanges.filter(s => s.change > 0).sort((a, b) => b.change - a.change).slice(0, 5);
            const topDeclineSystem = systemChanges.filter(s => s.change < 0).sort((a, b) => a.change - b.change).slice(0, 5);
            
            // Update tables
            updateGrowthTable('topGrowthSKUTableBody', topGrowth, 'sku', null);
            updateGrowthTable('topDeclineSKUTableBody', topDecline, 'sku', null);
            updateGrowthTable('topGrowthSystemTableBody', topGrowthSystem, 'system', true);
            updateGrowthTable('topDeclineSystemTableBody', topDeclineSystem, 'system', true);
        }
        
        function updateGrowthTable(tableBodyId, data, type, expandable) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #94a3b8; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td>';
                return;
            }
            
            data.forEach((item, index) => {
                const name = type === 'sku' ? item.sku : item.system;
                const changePercent = item.changePercent;
                const isPositive = item.change > 0;
                const percentColor = isPositive ? '#10b981' : '#ef4444';
                const percentIcon = isPositive ? '‚Üë' : '‚Üì';
                
                const systemId = type === 'system' ? name.replace(/[^a-zA-Z0-9]/g, '_') : null;
                const expandIcon = expandable && systemSKUDetails[name] && systemSKUDetails[name].length > 0 
                    ? `<span id="icon_${systemId}" style="cursor: pointer; display: inline-block; width: 16px; margin-right: 5px;" onclick="toggleSystemSKUs('${systemId}', '${tableBodyId}')">‚ñ∂</span>` 
                    : '';
                
                const row = tbody.insertRow();
                row.setAttribute('data-system-row', systemId);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="text-align: left; font-weight: 500;">${expandIcon}${name}</td>
                    <td class="number" style="color: #64748b;">${formatCurrency(item.val2024)}</td>
                    <td class="number" style="color: #1e293b; font-weight: 600;">${formatCurrency(item.val2025)}</td>
                    <td class="number" style="color: ${percentColor}; font-weight: 700;">
                        ${percentIcon} ${formatCurrency(Math.abs(item.change))}
                        <br><span style="font-size: 0.85em;">(${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%)</span>
                    </td>
                `;
                
                // Add SKU detail rows (hidden by default)
                if (expandable && systemSKUDetails[name] && systemSKUDetails[name].length > 0) {
                    systemSKUDetails[name].forEach(skuData => {
                        const skuRow = tbody.insertRow();
                        skuRow.setAttribute('data-system-sku', systemId);
                        skuRow.style.display = 'none';
                        
                        const skuIsPositive = skuData.change > 0;
                        const skuPercentColor = skuIsPositive ? '#10b981' : '#ef4444';
                        const skuPercentIcon = skuIsPositive ? '‚Üë' : '‚Üì';
                        
                        skuRow.innerHTML = `
                            <td style="background: #f9fafb;"></td>
                            <td style="padding-left: 30px; background: #f9fafb; color: #666; font-size: 0.9em; text-align: left;">${skuData.sku}</td>
                            <td class="number" style="background: #f9fafb; color: #94a3b8; font-size: 0.85em;">${formatCurrency(skuData.val2024)}</td>
                            <td class="number" style="background: #f9fafb; color: #64748b; font-size: 0.85em;">${formatCurrency(skuData.val2025)}</td>
                            <td class="number" style="background: #f9fafb; color: ${skuPercentColor}; font-size: 0.85em;">
                                ${skuPercentIcon} ${formatCurrency(Math.abs(skuData.change))}
                                <br><span style="font-size: 0.9em;">(${skuData.changePercent >= 0 ? '+' : ''}${skuData.changePercent.toFixed(1)}%)</span>
                            </td>
                        `;
                    });
                }
            });
        }
        
        // Toggle system SKU details
        function toggleSystemSKUs(systemId, tableBodyId) {
            const icon = document.getElementById(`icon_${systemId}`);
            const tbody = document.getElementById(tableBodyId);
            const skuRows = tbody.querySelectorAll(`tr[data-system-sku="${systemId}"]`);
            
            if (icon.textContent === '‚ñ∂') {
                // Expand
                icon.textContent = '‚ñº';
                skuRows.forEach(row => row.style.display = '');
            } else {
                // Collapse
                icon.textContent = '‚ñ∂';
                skuRows.forEach(row => row.style.display = 'none');
            }
        }

        // Update Yearly Product Analysis Table with Forecast
        function updateYearlyProductTable(data) {
            // Group by Brand > Year > SKU to get detailed breakdown
            const brandYearData = {};
            
            data.forEach(row => {
                const brand = (row['NH√ÉN H√ÄNG'] || 'N/A').trim();
                const year = row.year;
                const vat = row.vat || 0;
                const quantity = row.soLuong || 0;
                const fullName = (row['T√äN SP'] || '').trim();
                const sku = shortenProductName(fullName);
                
                if (year < 2023 || year > 2025 || !sku) return;
                
                if (!brandYearData[brand]) {
                    brandYearData[brand] = {
                        brand: brand,
                        years: { 
                            2023: { vat: 0, qty: 0, skus: {} }, 
                            2024: { vat: 0, qty: 0, skus: {} }, 
                            2025: { vat: 0, qty: 0, skus: {} } 
                        }
                    };
                }
                
                brandYearData[brand].years[year].vat += vat;
                brandYearData[brand].years[year].qty += quantity;
                
                // Track SKU details
                if (!brandYearData[brand].years[year].skus[sku]) {
                    brandYearData[brand].years[year].skus[sku] = { vat: 0, qty: 0 };
                }
                brandYearData[brand].years[year].skus[sku].vat += vat;
                brandYearData[brand].years[year].skus[sku].qty += quantity;
            });
            
            // Create rows: each brand gets 3 years + forecast (2026)
            const brandRows = [];
            Object.values(brandYearData).forEach(brandData => {
                const years = [2023, 2024, 2025];
                const yearRows = [];
                let totalVAT = 0;
                
                years.forEach(year => {
                    const yearData = brandData.years[year];
                    const vat = yearData.vat;
                    const qty = yearData.qty;
                    
                    if (vat === 0) return; // Skip years with no data
                    
                    totalVAT += vat;
                    
                    // Calculate growth vs previous year
                    let growthRate = null;
                    let growthText = '-';
                    if (year > 2023) {
                        const prevYear = year - 1;
                        const prevVat = brandData.years[prevYear].vat;
                        if (prevVat > 0) {
                            growthRate = ((vat - prevVat) / prevVat) * 100;
                            const growthIcon = growthRate > 0 ? 'üìà' : 'üìâ';
                            const growthColor = growthRate > 0 ? '#10b981' : '#ef4444';
                            growthText = `<span style="color: ${growthColor}; font-weight: 600;">${growthIcon} ${growthRate.toFixed(1)}%</span>`;
                        }
                    }
                    
                    yearRows.push({
                        brand: brandData.brand,
                        year: year,
                        vat: vat,
                        qty: qty,
                        growthText: growthText,
                        growthRate: growthRate || 0,
                        isForecast: false,
                        skus: yearData.skus // Include SKU details
                    });
                });
                
                // Calculate 2026 forecast if we have at least 2 years of data
                if (yearRows.length >= 2) {
                    const growthRates = [];
                    for (let i = 1; i < yearRows.length; i++) {
                        const prev = yearRows[i-1];
                        const curr = yearRows[i];
                        if (prev.vat > 0) {
                            growthRates.push((curr.vat - prev.vat) / prev.vat);
                        }
                    }
                    
                    if (growthRates.length > 0) {
                        // Check if brand has custom growth rate
                        let avgGrowth = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                        let isCustomGrowth = false;
                        
                        if (BRAND_CUSTOM_GROWTH[brandData.brand] !== undefined) {
                            avgGrowth = BRAND_CUSTOM_GROWTH[brandData.brand];
                            isCustomGrowth = true;
                        }
                        
                        const lastYear = yearRows[yearRows.length - 1];
                        const forecast2026VAT = lastYear.vat * (1 + avgGrowth);
                        const forecast2026Qty = lastYear.qty * (1 + avgGrowth);
                        
                        // Calculate forecast for each SKU based on 2025 data (excluding locked SKUs)
                        const forecast2026SKUs = {};
                        let excludedVAT = 0; // Track excluded SKU values
                        let excludedQty = 0;
                        
                        if (lastYear.skus) {
                            Object.entries(lastYear.skus).forEach(([sku, skuData]) => {
                                // Check if SKU is in exclusion list
                                if (EXCLUDED_SKUS_FROM_FORECAST.includes(sku)) {
                                    // Keep 2025 values for excluded SKUs (no growth)
                                    forecast2026SKUs[sku] = {
                                        vat: skuData.vat,
                                        qty: skuData.qty,
                                        excluded: true // Mark as excluded
                                    };
                                    excludedVAT += skuData.vat;
                                    excludedQty += skuData.qty;
                                } else {
                                    // Apply growth for non-excluded SKUs
                                    forecast2026SKUs[sku] = {
                                        vat: skuData.vat * (1 + avgGrowth),
                                        qty: skuData.qty * (1 + avgGrowth),
                                        excluded: false
                                    };
                                }
                            });
                        }
                        
                        // Adjust brand total: only grow non-excluded portion
                        const nonExcludedVAT = lastYear.vat - excludedVAT;
                        const nonExcludedQty = lastYear.qty - excludedQty;
                        const adjustedForecast2026VAT = (nonExcludedVAT * (1 + avgGrowth)) + excludedVAT;
                        const adjustedForecast2026Qty = (nonExcludedQty * (1 + avgGrowth)) + excludedQty;
                        
                        // Create growth text
                        let growthDisplayText = `<span style="color: #667eea; font-weight: 600;">üîÆ ${(avgGrowth * 100).toFixed(1)}%</span>`;
                        if (isCustomGrowth) {
                            growthDisplayText += ' <span style="color: #f59e0b; font-size: 0.85em;">‚öôÔ∏è (t√πy ch·ªânh)</span>';
                        }
                        if (EXCLUDED_SKUS_FROM_FORECAST.length > 0) {
                            growthDisplayText += ` <span style="color: #94a3b8; font-size: 0.85em;">(lo·∫°i tr·ª´ ${EXCLUDED_SKUS_FROM_FORECAST.length} m√£)</span>`;
                        }
                        
                        yearRows.push({
                            brand: brandData.brand,
                            year: 2026,
                            vat: adjustedForecast2026VAT,
                            qty: adjustedForecast2026Qty,
                            growthText: growthDisplayText,
                            growthRate: avgGrowth * 100,
                            isForecast: true,
                            skus: forecast2026SKUs // Include forecasted SKUs
                        });
                    }
                }
                
                if (yearRows.length > 0) {
                    brandRows.push({
                        brand: brandData.brand,
                        totalVAT: totalVAT,
                        rows: yearRows
                    });
                }
            });
            
            // Sort by brand total VAT descending
            brandRows.sort((a, b) => b.totalVAT - a.totalVAT);
            
            const tbody = document.getElementById('yearlyProductTableBody');
            tbody.innerHTML = '';
            
            let rowIndex = 0;
            brandRows.forEach((brandGroup) => {
                const brandId = brandGroup.brand.replace(/[^a-zA-Z0-9]/g, '_');
                
                // First row: Brand header with total
                const headerRow = tbody.insertRow();
                headerRow.setAttribute('data-brand-header', brandId);
                rowIndex++;
                
                headerRow.innerHTML = `
                    <td>${rowIndex}</td>
                    <td colspan="5" style="font-weight: 700; color: #667eea; cursor: pointer;" onclick="toggleBrand('${brandId}')">
                        <span id="icon_${brandId}" style="display: inline-block; width: 20px;">‚ñº</span>
                        ${brandGroup.brand} 
                        <span style="color: #d97706; font-size: 0.9em;">(T·ªïng: ${formatCurrency(brandGroup.totalVAT)})</span>
                    </td>
                `;
                
                // Year rows
                brandGroup.rows.forEach((rowData) => {
                    const row = tbody.insertRow();
                    row.setAttribute('data-brand-row', brandId);
                    rowIndex++;
                    
                    const yearLabel = rowData.isForecast ? '2026 (D·ª± ki·∫øn)' : rowData.year;
                    const rowStyle = rowData.isForecast ? 'background: #f0f9ff; font-style: italic;' : '';
                    const yearId = `${brandId}_${rowData.year}`;
                    
                    // Add expand icon for years with SKU data
                    const hasSkus = rowData.skus && Object.keys(rowData.skus).length > 0;
                    const expandIcon = hasSkus ? `<span id="icon_${yearId}" style="cursor: pointer; display: inline-block; width: 16px;" onclick="toggleYearSkus('${yearId}'); event.stopPropagation();">‚ñ∂</span> ` : '';
                    
                    row.innerHTML = `
                        <td style="${rowStyle}">${rowIndex}</td>
                        <td style="padding-left: 30px; ${rowStyle}"></td>
                        <td style="${rowStyle}">${expandIcon}${yearLabel}</td>
                        <td class="number" style="${rowStyle}">${rowData.qty > 0 ? formatNumber(Math.round(rowData.qty)) : '-'}</td>
                        <td class="number" style="background: #fffbeb; font-weight: 600; color: #d97706;">${formatCurrency(rowData.vat)}</td>
                        <td class="number" style="${rowStyle}">${rowData.growthText}</td>
                    `;
                    
                    // Add SKU detail rows (hidden by default)
                    if (hasSkus) {
                        const skuArray = Object.entries(rowData.skus)
                            .map(([sku, data]) => ({ sku, ...data }))
                            .sort((a, b) => b.vat - a.vat);
                        
                        skuArray.forEach((skuData) => {
                            const skuRow = tbody.insertRow();
                            skuRow.setAttribute('data-year-sku', yearId);
                            skuRow.style.display = 'none';
                            rowIndex++;
                            
                            // Add lock icon for excluded SKUs
                            const lockIcon = skuData.excluded ? '<span style="color: #94a3b8; margin-right: 4px;" title="M√£ n√†y ƒë∆∞·ª£c lo·∫°i tr·ª´ kh·ªèi d·ª± ki·∫øn">üîí</span>' : '';
                            const skuStyle = skuData.excluded ? 'background: #f1f5f9;' : 'background: #f9fafb;';
                            const valueStyle = skuData.excluded ? 'background: #e2e8f0; color: #64748b;' : 'background: #fef3c7; color: #92400e;';
                            
                            skuRow.innerHTML = `
                                <td style="${skuStyle}">${rowIndex}</td>
                                <td style="padding-left: 50px; ${skuStyle} color: #666; font-size: 0.9em;" colspan="2">${lockIcon}${skuData.sku}</td>
                                <td class="number" style="${skuStyle} color: #666;">${formatNumber(Math.round(skuData.qty))}</td>
                                <td class="number" style="${valueStyle}">${formatCurrency(skuData.vat)}</td>
                                <td style="${skuStyle}">${skuData.excluded ? '<span style="color: #94a3b8; font-size: 0.85em;">Lo·∫°i tr·ª´</span>' : ''}</td>
                            `;
                        });
                    }
                });
            });
        }
        
        // Toggle year SKUs visibility
        function toggleYearSkus(yearId) {
            const icon = document.getElementById(`icon_${yearId}`);
            const skuRows = document.querySelectorAll(`tr[data-year-sku="${yearId}"]`);
            
            if (icon.textContent === '‚ñ∂') {
                // Expand
                icon.textContent = '‚ñº';
                skuRows.forEach(row => row.style.display = '');
            } else {
                // Collapse
                icon.textContent = '‚ñ∂';
                skuRows.forEach(row => row.style.display = 'none');
            }
        }
        
        // Toggle individual brand visibility
        function toggleBrand(brandId) {
            const icon = document.getElementById(`icon_${brandId}`);
            const rows = document.querySelectorAll(`tr[data-brand-row="${brandId}"]`);
            
            if (icon.textContent === '‚ñº') {
                // Collapse
                icon.textContent = '‚ñ∂';
                rows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                icon.textContent = '‚ñº';
                rows.forEach(row => row.style.display = '');
            }
        }

        // Toggle yearly product table visibility
        function toggleYearlyProductTable() {
            const container = document.getElementById('yearlyTableContainer');
            const icon = document.getElementById('toggleIcon');
            const button = document.getElementById('toggleYearlyTable');
            
            if (container.style.maxHeight === '0px') {
                // Expand
                container.style.maxHeight = '2000px';
                container.style.opacity = '1';
                icon.textContent = '‚ñº';
                button.innerHTML = '<span id="toggleIcon">‚ñº</span> Thu g·ªçn';
            } else {
                // Collapse
                container.style.maxHeight = '0px';
                container.style.opacity = '0';
                icon.textContent = '‚ñ∂';
                button.innerHTML = '<span id="toggleIcon">‚ñ∂</span> M·ªü r·ªông';
            }
        }

        // Update dashboard
        function updateDashboard() {
            const data = filterData();
            updateKPIs(data);
            createSalesTrendChart(data);
            createBrandTrendChart(data);
            createSystemChart(data);
            createBrandChart(data);
            createYearComparisonChart(data);
            createTopProductsChart(data);
            createStoreActivityChart(data);
            analyzeGrowthDrivers(data);
        }

        // Export to PowerPoint
        async function exportToPowerPoint() {
            const pptx = new PptxGenJS();
            
            // Set presentation properties
            pptx.author = 'Sales Dashboard';
            pptx.company = 'Vi·ªát Li√™n';
            pptx.title = 'B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë 2023-2025';
            
            // Slide 1: Title
            const slide1 = pptx.addSlide();
            slide1.background = { color: '667eea' };
            slide1.addText('üìä B√°o C√°o Ph√¢n T√≠ch Doanh S·ªë', {
                x: 0.5, y: 2.0, w: 9, h: 1,
                fontSize: 44, bold: true, color: 'FFFFFF', align: 'center'
            });
            slide1.addText('Ph√¢n t√≠ch chi ti·∫øt doanh s·ªë theo H·ªá th·ªëng, Nh√£n h√†ng v√† M√£ h√†ng (2023 - 2025)', {
                x: 0.5, y: 3.2, w: 9, h: 0.5,
                fontSize: 18, color: 'FFFFFF', align: 'center'
            });
            slide1.addText(new Date().toLocaleDateString('vi-VN'), {
                x: 0.5, y: 4.5, w: 9, h: 0.3,
                fontSize: 14, color: 'FFFFFF', align: 'center', italic: true
            });
            
            // Slide 2: KPIs
            const slide2 = pptx.addSlide();
            slide2.addText('üìà T·ªïng Quan Doanh S·ªë', {
                x: 0.5, y: 0.3, w: 9, h: 0.5,
                fontSize: 32, bold: true, color: '1e293b'
            });
            
            const kpiData = [
                ['Ch·ªâ S·ªë', 'Gi√° Tr·ªã'],
                ['T·ªïng Doanh S·ªë', document.getElementById('totalSales').textContent],
                ['T·ªïng S·ªë ƒê∆°n H√†ng', document.getElementById('totalOrders').textContent],
                ['Gi√° Tr·ªã TB/ƒê∆°n', document.getElementById('avgOrderValue').textContent],
                ['S·ªë S·∫£n Ph·∫©m', document.getElementById('totalProducts').textContent],
                ['S·ªë H·ªá Th·ªëng', document.getElementById('totalSystems').textContent],
                ['S·ªë Nh√£n H√†ng', document.getElementById('totalBrands').textContent],
                ['C·ª≠a H√†ng Ho·∫°t ƒê·ªông', document.getElementById('activeStores').textContent]
            ];
            
            slide2.addTable(kpiData, {
                x: 1.0, y: 1.2, w: 8, h: 3.5,
                fontSize: 16,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' },
                fontFace: 'Arial'
            });
            
            // Slide 3: Sales Trend Chart
            if (charts.salesTrend) {
                const slide3 = pptx.addSlide();
                slide3.addText('üìà Xu H∆∞·ªõng Doanh S·ªë Theo Th√°ng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.salesTrend.toBase64Image();
                slide3.addImage({ data: chartImage, x: 0.5, y: 1.0, w: 9, h: 4.5 });
            }
            
            // Slide 4: System Chart
            if (charts.system) {
                const slide4 = pptx.addSlide();
                slide4.addText('üè¢ Doanh S·ªë Theo H·ªá Th·ªëng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.system.toBase64Image();
                slide4.addImage({ data: chartImage, x: 1.5, y: 1.0, w: 7, h: 4.5 });
            }
            
            // Slide 5: Brand Trend Chart
            if (charts.brandTrend) {
                const slide5 = pptx.addSlide();
                slide5.addText('üè∑Ô∏è Xu H∆∞·ªõng Doanh S·ªë Theo Nh√£n H√†ng', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.brandTrend.toBase64Image();
                slide5.addImage({ data: chartImage, x: 0.5, y: 1.0, w: 9, h: 4.5 });
            }
            
            // Slide 6: Year Comparison
            if (charts.yearComparison) {
                const slide6 = pptx.addSlide();
                slide6.addText('üìä So S√°nh Doanh S·ªë Theo NƒÉm', {
                    x: 0.5, y: 0.3, w: 9, h: 0.5,
                    fontSize: 28, bold: true, color: '1e293b'
                });
                const chartImage = charts.yearComparison.toBase64Image();
                slide6.addImage({ data: chartImage, x: 1.0, y: 1.0, w: 8, h: 4.5 });
            }
            
            // Slide 7: Growth Analysis
            const slide7 = pptx.addSlide();
            slide7.addText('üìä Ph√¢n T√≠ch TƒÉng Tr∆∞·ªüng 2024 vs 2025', {
                x: 0.5, y: 0.3, w: 9, h: 0.5,
                fontSize: 28, bold: true, color: '1e293b'
            });
            
            // Top growth SKUs
            const growthSKURows = Array.from(document.getElementById('topGrowthSKUTableBody').rows).slice(0, 5);
            const growthSKUData = [['#', 'M√£ H√†ng', 'TƒÉng']];
            growthSKURows.forEach(row => {
                const cells = row.cells;
                if (cells.length >= 3) {
                    growthSKUData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[4].textContent.replace(/\n/g, ' ')
                    ]);
                }
            });
            
            slide7.addText('üìà Top 5 M√£ H√†ng TƒÉng Tr∆∞·ªüng', {
                x: 0.5, y: 1.0, w: 4.5, h: 0.3,
                fontSize: 14, bold: true, color: '10b981'
            });
            slide7.addTable(growthSKUData, {
                x: 0.5, y: 1.4, w: 4.5, h: 2.0,
                fontSize: 11,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' }
            });
            
            // Top decline SKUs
            const declineSKURows = Array.from(document.getElementById('topDeclineSKUTableBody').rows).slice(0, 5);
            const declineSKUData = [['#', 'M√£ H√†ng', 'Gi·∫£m']];
            declineSKURows.forEach(row => {
                const cells = row.cells;
                if (cells.length >= 3) {
                    declineSKUData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[4].textContent.replace(/\n/g, ' ')
                    ]);
                }
            });
            
            slide7.addText('üìâ Top 5 M√£ H√†ng Gi·∫£m', {
                x: 5.5, y: 1.0, w: 4.5, h: 0.3,
                fontSize: 14, bold: true, color: 'ef4444'
            });
            slide7.addTable(declineSKUData, {
                x: 5.5, y: 1.4, w: 4.5, h: 2.0,
                fontSize: 11,
                color: '1e293b',
                fill: { color: 'f8fafc' },
                border: { pt: 1, color: 'e5e7eb' }
            });
            
            // Save the presentation
            const fileName = `BaoCao_DoanSo_${new Date().toISOString().slice(0,10)}.pptx`;
            await pptx.writeFile({ fileName: fileName });
            
            alert('‚úÖ ƒê√£ t·∫£i xu·ªëng file PowerPoint: ' + fileName);
        }

        // Initialize
        loadAllData();
    </script>
</body>
</html>
